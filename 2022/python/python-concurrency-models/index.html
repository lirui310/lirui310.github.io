<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Orion K">
    
    <title>
        
            Python并发编程模型：线程、进程与异步IO的全面对比 |
        
        Orion K Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/logo.svg">
    
    
<link rel="stylesheet" href="/font/css/fontawesome.min.css">

    
<link rel="stylesheet" href="/font/css/regular.min.css">

    
<link rel="stylesheet" href="/font/css/solid.min.css">

    
<link rel="stylesheet" href="/font/css/brands.min.css">

    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"Orion K Blog","author":"Orion K","avatar":"/images/avatar.svg","logo":"/images/logo.svg","favicon":"/images/logo.svg"},"menu":{"home":"/                        || fa-solid fa-home","archives":"/archives            || fa-solid fa-box-archive","tags":"/tags                    || fa-solid fa-tags","categories":"/categories        || fa-solid fa-layer-group"},"first_screen":{"enable":false,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":false,"hide_header":true},"home":{"announcement":"欢迎来到 Orion K 的博客，这是一个分享互联网技术的博客。联系：wxmm686800@gmail.com","category":true,"tag":true,"post_datetime":"created"},"post":{"author_badge":{"enable":true,"level_badge":true,"custom_badge":["One","Two","Three"]},"word_count":{"wordcount":false,"min2read":false},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false,"reward":{"enable":false,"img_link":null,"text":null,"icon":null}},"code_block":{"tools":{"enable":false,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":false,"site_uv":false,"site_pv":false,"page_pv":false}},"local_search":{"enable":true,"preload":true},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.39"},"waline":{"server_url":null,"reaction":false,"version":"3.3.2"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":false},"lazyload":{"enable":false},"cdn":{"enable":false,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2025,"word_count":false,"site_deploy":{"enable":true,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.5"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/logo.svg">
                </a>
            
            <a class="site-name border-box" href="/">
               Orion K Blog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-home"></i>
                                
                                首页
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                
                                归档
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-tags"></i>
                                
                                标签
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-layer-group"></i>
                                
                                分类
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-home"></i>
                                </span>
                            
                            首页
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                </span>
                            
                            归档
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-tags"></i>
                                </span>
                            
                            标签
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-layer-group"></i>
                                </span>
                            
                            分类
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        Python并发编程模型：线程、进程与异步IO的全面对比
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/avatar.svg">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">Orion K</span>
                                
                                    <span class="author-badge">Lv6</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2022-05-25 11:30:00</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/python/">python</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">并发编程</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E5%A4%9A%E8%BF%9B%E7%A8%8B/">多进程</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E5%BC%82%E6%AD%A5IO/">异步IO</a></li>
                        
                    
                </ul>
            </span>
        

        
        
        
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <h1 id="Python并发编程模型：线程、进程与异步IO的全面对比"><a href="#Python并发编程模型：线程、进程与异步IO的全面对比" class="headerlink" title="Python并发编程模型：线程、进程与异步IO的全面对比"></a>Python并发编程模型：线程、进程与异步IO的全面对比</h1><p>在现代软件开发中，并发编程已经成为提高应用性能和响应能力的关键技术。Python提供了多种并发编程模型，包括多线程、多进程和异步IO。每种模型都有其独特的优势和适用场景。在这篇文章中，我将深入探讨这些并发模型，帮助你选择最适合自己项目的方案。</p>
<h2 id="Python并发编程的挑战：GIL"><a href="#Python并发编程的挑战：GIL" class="headerlink" title="Python并发编程的挑战：GIL"></a>Python并发编程的挑战：GIL</h2><p>在讨论Python并发模型之前，我们需要了解Python的全局解释器锁（Global Interpreter Lock，简称GIL）。GIL是CPython解释器的一个机制，它确保同一时刻只有一个线程执行Python字节码。这意味着在多核处理器上，Python的多线程无法实现真正的并行计算。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cpu_bound_task</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="comment"># CPU密集型任务：计算斐波那契数列</span></span><br><span class="line">    <span class="keyword">if</span> n &lt;= <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> n</span><br><span class="line">    <span class="keyword">return</span> cpu_bound_task(n-<span class="number">1</span>) + cpu_bound_task(n-<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_in_thread</span>():</span><br><span class="line">    result = cpu_bound_task(<span class="number">35</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;计算结果: <span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建两个线程</span></span><br><span class="line">t1 = threading.Thread(target=run_in_thread)</span><br><span class="line">t2 = threading.Thread(target=run_in_thread)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 记录开始时间</span></span><br><span class="line">start_time = time.time()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动线程</span></span><br><span class="line">t1.start()</span><br><span class="line">t2.start()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 等待线程完成</span></span><br><span class="line">t1.join()</span><br><span class="line">t2.join()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算总耗时</span></span><br><span class="line">elapsed = time.time() - start_time</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;总耗时: <span class="subst">&#123;elapsed:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>在上面的例子中，尽管我们使用了两个线程，但由于GIL的存在，这两个线程实际上是轮流执行的，总耗时可能比单线程执行两次任务的时间还要长（因为线程切换有开销）。</p>
<p>然而，GIL并不意味着Python无法有效地进行并发编程。接下来，我们将探讨如何在Python中实现真正的并发。</p>
<h2 id="多线程编程"><a href="#多线程编程" class="headerlink" title="多线程编程"></a>多线程编程</h2><p>尽管有GIL的限制，多线程在IO密集型任务中仍然非常有效，因为在等待IO操作时，线程会释放GIL，允许其他线程执行。</p>
<h3 id="使用threading模块"><a href="#使用threading模块" class="headerlink" title="使用threading模块"></a>使用threading模块</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_site</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;开始下载 <span class="subst">&#123;url&#125;</span>&quot;</span>)</span><br><span class="line">    response = requests.get(url)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;完成下载 <span class="subst">&#123;url&#125;</span>, 大小: <span class="subst">&#123;<span class="built_in">len</span>(response.content)&#125;</span> 字节&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_all_sites</span>(<span class="params">sites</span>):</span><br><span class="line">    threads = []</span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> sites:</span><br><span class="line">        thread = threading.Thread(target=download_site, args=(url,))</span><br><span class="line">        threads.append(thread)</span><br><span class="line">        thread.start()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待所有线程完成</span></span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">        thread.join()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    sites = [</span><br><span class="line">        <span class="string">&quot;https://www.example.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://www.python.org&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://www.github.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://www.stackoverflow.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://www.wikipedia.org&quot;</span>,</span><br><span class="line">    ] * <span class="number">5</span>  <span class="comment"># 重复5次，共25个URL</span></span><br><span class="line">    </span><br><span class="line">    start_time = time.time()</span><br><span class="line">    download_all_sites(sites)</span><br><span class="line">    elapsed = time.time() - start_time</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;下载 <span class="subst">&#123;<span class="built_in">len</span>(sites)&#125;</span> 个网站耗时: <span class="subst">&#123;elapsed:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="线程安全和同步"><a href="#线程安全和同步" class="headerlink" title="线程安全和同步"></a>线程安全和同步</h3><p>当多个线程访问共享资源时，需要使用同步机制来避免竞态条件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 共享资源</span></span><br><span class="line">counter = <span class="number">0</span></span><br><span class="line">counter_lock = threading.Lock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">increment_counter</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="keyword">global</span> counter</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        <span class="comment"># 获取锁</span></span><br><span class="line">        <span class="keyword">with</span> counter_lock:</span><br><span class="line">            counter += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建两个线程</span></span><br><span class="line">t1 = threading.Thread(target=increment_counter, args=(<span class="number">100000</span>,))</span><br><span class="line">t2 = threading.Thread(target=increment_counter, args=(<span class="number">100000</span>,))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动线程</span></span><br><span class="line">t1.start()</span><br><span class="line">t2.start()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 等待线程完成</span></span><br><span class="line">t1.join()</span><br><span class="line">t2.join()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;最终计数: <span class="subst">&#123;counter&#125;</span>&quot;</span>)  <span class="comment"># 应该是200000</span></span><br></pre></td></tr></table></figure>

<h3 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h3><p>对于大量线程任务，使用线程池可以更有效地管理线程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> concurrent.futures</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_site</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;开始下载 <span class="subst">&#123;url&#125;</span>&quot;</span>)</span><br><span class="line">    response = requests.get(url)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;完成下载 <span class="subst">&#123;url&#125;</span>, 大小: <span class="subst">&#123;<span class="built_in">len</span>(response.content)&#125;</span> 字节&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(response.content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_all_sites</span>(<span class="params">sites</span>):</span><br><span class="line">    <span class="keyword">with</span> concurrent.futures.ThreadPoolExecutor(max_workers=<span class="number">5</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        <span class="comment"># 提交所有任务并获取Future对象</span></span><br><span class="line">        future_to_url = &#123;executor.submit(download_site, url): url <span class="keyword">for</span> url <span class="keyword">in</span> sites&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 处理完成的任务</span></span><br><span class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> concurrent.futures.as_completed(future_to_url):</span><br><span class="line">            url = future_to_url[future]</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                data_size = future.result()</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;url&#125;</span> 下载完成，大小: <span class="subst">&#123;data_size&#125;</span> 字节&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;url&#125;</span> 下载失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    sites = [</span><br><span class="line">        <span class="string">&quot;https://www.example.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://www.python.org&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://www.github.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://www.stackoverflow.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://www.wikipedia.org&quot;</span>,</span><br><span class="line">    ] * <span class="number">5</span></span><br><span class="line">    </span><br><span class="line">    start_time = time.time()</span><br><span class="line">    download_all_sites(sites)</span><br><span class="line">    elapsed = time.time() - start_time</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;下载 <span class="subst">&#123;<span class="built_in">len</span>(sites)&#125;</span> 个网站耗时: <span class="subst">&#123;elapsed:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="多线程的优缺点"><a href="#多线程的优缺点" class="headerlink" title="多线程的优缺点"></a>多线程的优缺点</h3><p><strong>优点</strong>：</p>
<ul>
<li>轻量级，创建和切换成本低</li>
<li>共享内存，线程间通信简单</li>
<li>适合IO密集型任务</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>受GIL限制，无法实现真正的并行计算</li>
<li>线程安全问题复杂</li>
<li>调试困难</li>
<li>可能出现死锁、竞态条件等并发问题</li>
</ul>
<h2 id="多进程编程"><a href="#多进程编程" class="headerlink" title="多进程编程"></a>多进程编程</h2><p>多进程可以绕过GIL的限制，实现真正的并行计算，特别适合CPU密集型任务。</p>
<h3 id="使用multiprocessing模块"><a href="#使用multiprocessing模块" class="headerlink" title="使用multiprocessing模块"></a>使用multiprocessing模块</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cpu_bound_task</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="comment"># CPU密集型任务：计算斐波那契数列</span></span><br><span class="line">    <span class="keyword">if</span> n &lt;= <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> n</span><br><span class="line">    <span class="keyword">return</span> cpu_bound_task(n-<span class="number">1</span>) + cpu_bound_task(n-<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_in_process</span>():</span><br><span class="line">    result = cpu_bound_task(<span class="number">35</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;计算结果: <span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 创建两个进程</span></span><br><span class="line">    p1 = multiprocessing.Process(target=run_in_process)</span><br><span class="line">    p2 = multiprocessing.Process(target=run_in_process)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 记录开始时间</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 启动进程</span></span><br><span class="line">    p1.start()</span><br><span class="line">    p2.start()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待进程完成</span></span><br><span class="line">    p1.join()</span><br><span class="line">    p2.join()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 计算总耗时</span></span><br><span class="line">    elapsed = time.time() - start_time</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;总耗时: <span class="subst">&#123;elapsed:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="进程池"><a href="#进程池" class="headerlink" title="进程池"></a>进程池</h3><p>与线程池类似，进程池可以更有效地管理进程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> concurrent.futures</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cpu_bound_task</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="comment"># CPU密集型任务：计算斐波那契数列</span></span><br><span class="line">    <span class="keyword">if</span> n &lt;= <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> n</span><br><span class="line">    <span class="keyword">return</span> cpu_bound_task(n-<span class="number">1</span>) + cpu_bound_task(n-<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    numbers = [<span class="number">34</span>, <span class="number">35</span>, <span class="number">36</span>, <span class="number">37</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 使用进程池</span></span><br><span class="line">    <span class="keyword">with</span> concurrent.futures.ProcessPoolExecutor() <span class="keyword">as</span> executor:</span><br><span class="line">        results = executor.<span class="built_in">map</span>(cpu_bound_task, numbers)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> number, result <span class="keyword">in</span> <span class="built_in">zip</span>(numbers, results):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;fibonacci(<span class="subst">&#123;number&#125;</span>) = <span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    main()</span><br><span class="line">    elapsed = time.time() - start_time</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;总耗时: <span class="subst">&#123;elapsed:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="进程间通信"><a href="#进程间通信" class="headerlink" title="进程间通信"></a>进程间通信</h3><p>由于进程不共享内存，进程间通信需要特殊机制：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">producer</span>(<span class="params">queue</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;生产者进程开始&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        item = <span class="string">f&quot;项目-<span class="subst">&#123;i&#125;</span>&quot;</span></span><br><span class="line">        queue.put(item)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;生产: <span class="subst">&#123;item&#125;</span>&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    <span class="comment"># 发送结束信号</span></span><br><span class="line">    queue.put(<span class="literal">None</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;生产者进程结束&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">consumer</span>(<span class="params">queue</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;消费者进程开始&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        item = queue.get()</span><br><span class="line">        <span class="keyword">if</span> item <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;消费: <span class="subst">&#123;item&#125;</span>&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;消费者进程结束&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 创建进程间通信的队列</span></span><br><span class="line">    queue = multiprocessing.Queue()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建生产者和消费者进程</span></span><br><span class="line">    p1 = multiprocessing.Process(target=producer, args=(queue,))</span><br><span class="line">    p2 = multiprocessing.Process(target=consumer, args=(queue,))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 启动进程</span></span><br><span class="line">    p1.start()</span><br><span class="line">    p2.start()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待进程完成</span></span><br><span class="line">    p1.join()</span><br><span class="line">    p2.join()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;所有进程已完成&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="多进程的优缺点"><a href="#多进程的优缺点" class="headerlink" title="多进程的优缺点"></a>多进程的优缺点</h3><p><strong>优点</strong>：</p>
<ul>
<li>可以绕过GIL，实现真正的并行计算</li>
<li>进程间相互独立，一个进程崩溃不会影响其他进程</li>
<li>适合CPU密集型任务</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>创建和切换成本高</li>
<li>内存占用大</li>
<li>进程间通信复杂</li>
<li>启动时间较长</li>
</ul>
<h2 id="异步IO编程"><a href="#异步IO编程" class="headerlink" title="异步IO编程"></a>异步IO编程</h2><p>异步IO是一种单线程的并发模型，它通过事件循环和协程实现非阻塞操作，特别适合IO密集型任务。</p>
<h3 id="使用asyncio模块"><a href="#使用asyncio模块" class="headerlink" title="使用asyncio模块"></a>使用asyncio模块</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">download_site</span>(<span class="params">session, url</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;开始下载 <span class="subst">&#123;url&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> response:</span><br><span class="line">        content = <span class="keyword">await</span> response.read()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;完成下载 <span class="subst">&#123;url&#125;</span>, 大小: <span class="subst">&#123;<span class="built_in">len</span>(content)&#125;</span> 字节&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">download_all_sites</span>(<span class="params">sites</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        tasks = []</span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> sites:</span><br><span class="line">            task = asyncio.create_task(download_site(session, url))</span><br><span class="line">            tasks.append(task)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 等待所有任务完成</span></span><br><span class="line">        results = <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    sites = [</span><br><span class="line">        <span class="string">&quot;https://www.example.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://www.python.org&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://www.github.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://www.stackoverflow.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://www.wikipedia.org&quot;</span>,</span><br><span class="line">    ] * <span class="number">5</span></span><br><span class="line">    </span><br><span class="line">    start_time = time.time()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 运行异步任务</span></span><br><span class="line">    results = asyncio.run(download_all_sites(sites))</span><br><span class="line">    </span><br><span class="line">    elapsed = time.time() - start_time</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;下载 <span class="subst">&#123;<span class="built_in">len</span>(sites)&#125;</span> 个网站耗时: <span class="subst">&#123;elapsed:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;总下载大小: <span class="subst">&#123;<span class="built_in">sum</span>(results)&#125;</span> 字节&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="异步上下文管理器和异步迭代器"><a href="#异步上下文管理器和异步迭代器" class="headerlink" title="异步上下文管理器和异步迭代器"></a>异步上下文管理器和异步迭代器</h3><p>Python 3.7+提供了异步上下文管理器和异步迭代器的语法支持：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiofiles</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_large_file</span>():</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiofiles.<span class="built_in">open</span>(<span class="string">&#x27;large_file.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="comment"># 异步读取文件</span></span><br><span class="line">        contents = <span class="keyword">await</span> f.read()</span><br><span class="line">        <span class="keyword">return</span> contents</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">process_lines</span>():</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiofiles.<span class="built_in">open</span>(<span class="string">&#x27;large_file.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="comment"># 异步迭代文件行</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            <span class="keyword">await</span> process_line(line)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">process_line</span>(<span class="params">line</span>):</span><br><span class="line">    <span class="comment"># 处理单行数据</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">0.01</span>)  <span class="comment"># 模拟异步处理</span></span><br><span class="line">    <span class="keyword">return</span> line.upper()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行异步任务</span></span><br><span class="line">asyncio.run(read_large_file())</span><br><span class="line">asyncio.run(process_lines())</span><br></pre></td></tr></table></figure>

<h3 id="结合asyncio和其他并发模型"><a href="#结合asyncio和其他并发模型" class="headerlink" title="结合asyncio和其他并发模型"></a>结合asyncio和其他并发模型</h3><p>有时候，我们需要结合使用异步IO和其他并发模型：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> concurrent.futures</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cpu_bound_task</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="comment"># CPU密集型任务</span></span><br><span class="line">    time.sleep(n)  <span class="comment"># 模拟CPU密集操作</span></span><br><span class="line">    <span class="keyword">return</span> n * n</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 创建线程池</span></span><br><span class="line">    <span class="keyword">with</span> concurrent.futures.ThreadPoolExecutor() <span class="keyword">as</span> pool:</span><br><span class="line">        <span class="comment"># 在线程池中运行CPU密集型任务</span></span><br><span class="line">        loop = asyncio.get_running_loop()</span><br><span class="line">        tasks = [</span><br><span class="line">            loop.run_in_executor(pool, cpu_bound_task, i)</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">6</span>)</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 同时运行IO密集型任务</span></span><br><span class="line">        io_tasks = [io_bound_task(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">6</span>)]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 等待所有任务完成</span></span><br><span class="line">        all_results = <span class="keyword">await</span> asyncio.gather(*tasks, *io_tasks)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;所有结果: <span class="subst">&#123;all_results&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">io_bound_task</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="comment"># IO密集型任务</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(n)  <span class="comment"># 模拟IO操作</span></span><br><span class="line">    <span class="keyword">return</span> n * <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    asyncio.run(main())</span><br><span class="line">    elapsed = time.time() - start_time</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;总耗时: <span class="subst">&#123;elapsed:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="异步IO的优缺点"><a href="#异步IO的优缺点" class="headerlink" title="异步IO的优缺点"></a>异步IO的优缺点</h3><p><strong>优点</strong>：</p>
<ul>
<li>单线程模型，避免了多线程的复杂性</li>
<li>高效处理大量并发IO操作</li>
<li>代码结构清晰，使用<code>async/await</code>语法</li>
<li>内存占用低</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>不适合CPU密集型任务</li>
<li>需要特殊的异步库支持</li>
<li>调试可能复杂</li>
<li>所有异步代码需要使用<code>async/await</code>语法</li>
</ul>
<h2 id="三种并发模型的对比"><a href="#三种并发模型的对比" class="headerlink" title="三种并发模型的对比"></a>三种并发模型的对比</h2><p>让我们通过一个实际例子来对比这三种并发模型的性能差异：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> concurrent.futures</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试URL列表</span></span><br><span class="line">URLS = [</span><br><span class="line">    <span class="string">&quot;https://www.example.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://www.python.org&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://www.github.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://www.stackoverflow.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://www.wikipedia.org&quot;</span>,</span><br><span class="line">] * <span class="number">5</span>  <span class="comment"># 共25个URL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 串行下载</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_serial</span>():</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> URLS:</span><br><span class="line">        response = requests.get(url)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;串行: 下载 <span class="subst">&#123;url&#125;</span>, 大小: <span class="subst">&#123;<span class="built_in">len</span>(response.content)&#125;</span> 字节&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    elapsed = time.time() - start_time</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;串行下载耗时: <span class="subst">&#123;elapsed:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 多线程下载</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_threaded</span>():</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> concurrent.futures.ThreadPoolExecutor(max_workers=<span class="number">5</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        future_to_url = &#123;executor.submit(requests.get, url): url <span class="keyword">for</span> url <span class="keyword">in</span> URLS&#125;</span><br><span class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> concurrent.futures.as_completed(future_to_url):</span><br><span class="line">            url = future_to_url[future]</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                response = future.result()</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;多线程: 下载 <span class="subst">&#123;url&#125;</span>, 大小: <span class="subst">&#123;<span class="built_in">len</span>(response.content)&#125;</span> 字节&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;多线程: 下载 <span class="subst">&#123;url&#125;</span> 失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    elapsed = time.time() - start_time</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;多线程下载耗时: <span class="subst">&#123;elapsed:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 多进程下载</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_url</span>(<span class="params">url</span>):</span><br><span class="line">    response = requests.get(url)</span><br><span class="line">    <span class="keyword">return</span> url, <span class="built_in">len</span>(response.content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_multiprocess</span>():</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> concurrent.futures.ProcessPoolExecutor(max_workers=<span class="number">5</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        results = executor.<span class="built_in">map</span>(download_url, URLS)</span><br><span class="line">        <span class="keyword">for</span> url, size <span class="keyword">in</span> results:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;多进程: 下载 <span class="subst">&#123;url&#125;</span>, 大小: <span class="subst">&#123;size&#125;</span> 字节&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    elapsed = time.time() - start_time</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;多进程下载耗时: <span class="subst">&#123;elapsed:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 异步IO下载</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fetch</span>(<span class="params">session, url</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> response:</span><br><span class="line">        content = <span class="keyword">await</span> response.read()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;异步IO: 下载 <span class="subst">&#123;url&#125;</span>, 大小: <span class="subst">&#123;<span class="built_in">len</span>(content)&#125;</span> 字节&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">download_async</span>():</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        tasks = [fetch(session, url) <span class="keyword">for</span> url <span class="keyword">in</span> URLS]</span><br><span class="line">        <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line">    </span><br><span class="line">    elapsed = time.time() - start_time</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;异步IO下载耗时: <span class="subst">&#123;elapsed:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行所有测试</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;1. 开始串行下载测试...&quot;</span>)</span><br><span class="line">    download_serial()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n2. 开始多线程下载测试...&quot;</span>)</span><br><span class="line">    download_threaded()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n3. 开始多进程下载测试...&quot;</span>)</span><br><span class="line">    download_multiprocess()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n4. 开始异步IO下载测试...&quot;</span>)</span><br><span class="line">    asyncio.run(download_async())</span><br></pre></td></tr></table></figure>

<h3 id="性能对比结果分析"><a href="#性能对比结果分析" class="headerlink" title="性能对比结果分析"></a>性能对比结果分析</h3><p>在IO密集型任务（如网络请求）中：</p>
<ul>
<li><strong>串行执行</strong>：最慢，因为每个请求都会阻塞后续请求</li>
<li><strong>多线程</strong>：比串行快很多，因为在等待IO时可以切换到其他线程</li>
<li><strong>多进程</strong>：可能比多线程慢，因为进程创建和通信开销大</li>
<li><strong>异步IO</strong>：通常是最快的，因为它避免了线程切换的开销</li>
</ul>
<p>在CPU密集型任务中：</p>
<ul>
<li><strong>串行执行</strong>：简单但慢</li>
<li><strong>多线程</strong>：受GIL限制，可能比串行还慢（因为线程切换开销）</li>
<li><strong>多进程</strong>：通常是最快的，因为可以利用多核处理器</li>
<li><strong>异步IO</strong>：不适合CPU密集型任务，性能可能很差</li>
</ul>
<h2 id="选择合适的并发模型"><a href="#选择合适的并发模型" class="headerlink" title="选择合适的并发模型"></a>选择合适的并发模型</h2><p>根据任务类型选择合适的并发模型：</p>
<ol>
<li><p><strong>IO密集型任务</strong>（网络请求、文件操作等）：</p>
<ul>
<li>首选：<strong>异步IO</strong>（asyncio）</li>
<li>次选：<strong>多线程</strong>（threading）</li>
</ul>
</li>
<li><p><strong>CPU密集型任务</strong>（计算、数据处理等）：</p>
<ul>
<li>首选：<strong>多进程</strong>（multiprocessing）</li>
<li>次选：考虑使用C扩展或其他语言实现计算密集部分</li>
</ul>
</li>
<li><p><strong>混合型任务</strong>：</p>
<ul>
<li>考虑结合使用多种并发模型</li>
<li>例如：使用asyncio处理IO，使用ProcessPoolExecutor处理CPU密集计算</li>
</ul>
</li>
</ol>
<h2 id="实际应用案例"><a href="#实际应用案例" class="headerlink" title="实际应用案例"></a>实际应用案例</h2><h3 id="案例1：Web爬虫"><a href="#案例1：Web爬虫" class="headerlink" title="案例1：Web爬虫"></a>案例1：Web爬虫</h3><p>Web爬虫是典型的IO密集型任务，适合使用异步IO：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fetch_html</span>(<span class="params">session, url</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(url, timeout=<span class="number">10</span>) <span class="keyword">as</span> response:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> response.text()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;获取 <span class="subst">&#123;url&#125;</span> 失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">parse_and_extract_links</span>(<span class="params">html, base_url</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> html:</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    </span><br><span class="line">    soup = BeautifulSoup(html, <span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line">    links = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> a_tag <span class="keyword">in</span> soup.find_all(<span class="string">&#x27;a&#x27;</span>, href=<span class="literal">True</span>):</span><br><span class="line">        href = a_tag[<span class="string">&#x27;href&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> href.startswith(<span class="string">&#x27;http&#x27;</span>):</span><br><span class="line">            links.append(href)</span><br><span class="line">        <span class="keyword">elif</span> href.startswith(<span class="string">&#x27;/&#x27;</span>):</span><br><span class="line">            links.append(<span class="string">f&quot;<span class="subst">&#123;base_url&#125;</span><span class="subst">&#123;href&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> links</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">crawl</span>(<span class="params">start_url, max_depth=<span class="number">2</span>, max_urls=<span class="number">100</span></span>):</span><br><span class="line">    visited_urls = <span class="built_in">set</span>()</span><br><span class="line">    urls_to_visit = [(start_url, <span class="number">0</span>)]  <span class="comment"># (url, depth)</span></span><br><span class="line">    base_url = <span class="string">&#x27;/&#x27;</span>.join(start_url.split(<span class="string">&#x27;/&#x27;</span>)[:<span class="number">3</span>])  <span class="comment"># 提取基础URL</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">while</span> urls_to_visit <span class="keyword">and</span> <span class="built_in">len</span>(visited_urls) &lt; max_urls:</span><br><span class="line">            url, depth = urls_to_visit.pop(<span class="number">0</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> url <span class="keyword">in</span> visited_urls <span class="keyword">or</span> depth &gt; max_depth:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;爬取 (<span class="subst">&#123;depth&#125;</span>): <span class="subst">&#123;url&#125;</span>&quot;</span>)</span><br><span class="line">            visited_urls.add(url)</span><br><span class="line">            </span><br><span class="line">            html = <span class="keyword">await</span> fetch_html(session, url)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> html:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> depth &lt; max_depth:</span><br><span class="line">                links = <span class="keyword">await</span> parse_and_extract_links(html, base_url)</span><br><span class="line">                <span class="keyword">for</span> link <span class="keyword">in</span> links:</span><br><span class="line">                    <span class="keyword">if</span> link <span class="keyword">not</span> <span class="keyword">in</span> visited_urls:</span><br><span class="line">                        urls_to_visit.append((link, depth + <span class="number">1</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> visited_urls</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    urls = <span class="keyword">await</span> crawl(<span class="string">&quot;https://www.python.org&quot;</span>, max_depth=<span class="number">2</span>, max_urls=<span class="number">50</span>)</span><br><span class="line">    elapsed = time.time() - start_time</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n爬取完成! 共爬取 <span class="subst">&#123;<span class="built_in">len</span>(urls)&#125;</span> 个URL&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;总耗时: <span class="subst">&#123;elapsed:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    asyncio.run(main())</span><br></pre></td></tr></table></figure>

<h3 id="案例2：图像处理"><a href="#案例2：图像处理" class="headerlink" title="案例2：图像处理"></a>案例2：图像处理</h3><p>图像处理是典型的CPU密集型任务，适合使用多进程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageFilter</span><br><span class="line"><span class="keyword">import</span> concurrent.futures</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_image</span>(<span class="params">image_path, output_dir, blur_radius=<span class="number">2</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 打开图像</span></span><br><span class="line">        img = Image.<span class="built_in">open</span>(image_path)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 应用模糊滤镜</span></span><br><span class="line">        blurred_img = img.<span class="built_in">filter</span>(ImageFilter.GaussianBlur(blur_radius))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建输出路径</span></span><br><span class="line">        filename = os.path.basename(image_path)</span><br><span class="line">        output_path = os.path.join(output_dir, <span class="string">f&quot;blurred_<span class="subst">&#123;filename&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 保存处理后的图像</span></span><br><span class="line">        blurred_img.save(output_path)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> output_path</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;处理图像 <span class="subst">&#123;image_path&#125;</span> 失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_images_parallel</span>(<span class="params">image_dir, output_dir, max_workers=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="comment"># 确保输出目录存在</span></span><br><span class="line">    os.makedirs(output_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 获取所有图像文件</span></span><br><span class="line">    image_files = [</span><br><span class="line">        os.path.join(image_dir, f) <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(image_dir)</span><br><span class="line">        <span class="keyword">if</span> f.lower().endswith((<span class="string">&#x27;.png&#x27;</span>, <span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.jpeg&#x27;</span>, <span class="string">&#x27;.bmp&#x27;</span>, <span class="string">&#x27;.gif&#x27;</span>))</span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    start_time = time.time()</span><br><span class="line">    processed_files = []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 使用进程池处理图像</span></span><br><span class="line">    <span class="keyword">with</span> concurrent.futures.ProcessPoolExecutor(max_workers=max_workers) <span class="keyword">as</span> executor:</span><br><span class="line">        future_to_path = &#123;</span><br><span class="line">            executor.submit(process_image, path, output_dir): path</span><br><span class="line">            <span class="keyword">for</span> path <span class="keyword">in</span> image_files</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> concurrent.futures.as_completed(future_to_path):</span><br><span class="line">            path = future_to_path[future]</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                output_path = future.result()</span><br><span class="line">                <span class="keyword">if</span> output_path:</span><br><span class="line">                    processed_files.append(output_path)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;已处理: <span class="subst">&#123;path&#125;</span> -&gt; <span class="subst">&#123;output_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;处理 <span class="subst">&#123;path&#125;</span> 时出错: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    elapsed = time.time() - start_time</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n处理完成! 共处理 <span class="subst">&#123;<span class="built_in">len</span>(processed_files)&#125;</span> 个图像&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;总耗时: <span class="subst">&#123;elapsed:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> processed_files</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 替换为你的图像目录和输出目录</span></span><br><span class="line">    process_images_parallel(<span class="string">&quot;./images&quot;</span>, <span class="string">&quot;./processed_images&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="案例3：Web服务器"><a href="#案例3：Web服务器" class="headerlink" title="案例3：Web服务器"></a>案例3：Web服务器</h3><p>Web服务器需要处理大量并发请求，适合使用异步IO：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> aiohttp <span class="keyword">import</span> web</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiofiles</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟数据库操作</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fetch_from_db</span>(<span class="params">user_id</span>):</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">0.1</span>)  <span class="comment"># 模拟数据库查询延迟</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;id&quot;</span>: user_id, <span class="string">&quot;name&quot;</span>: <span class="string">f&quot;User <span class="subst">&#123;user_id&#125;</span>&quot;</span>, <span class="string">&quot;email&quot;</span>: <span class="string">f&quot;user<span class="subst">&#123;user_id&#125;</span>@example.com&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟外部API调用</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">call_external_api</span>(<span class="params">user_id</span>):</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">0.2</span>)  <span class="comment"># 模拟API调用延迟</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;active&quot;</span>, <span class="string">&quot;last_login&quot;</span>: <span class="string">&quot;2023-01-01&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 异步日志记录</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">log_request</span>(<span class="params">request_info</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiofiles.<span class="built_in">open</span>(<span class="string">&quot;server.log&quot;</span>, <span class="string">&quot;a&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        log_line = <span class="string">f&quot;<span class="subst">&#123;time.time()&#125;</span>,<span class="subst">&#123;request_info[<span class="string">&#x27;ip&#x27;</span>]&#125;</span>,<span class="subst">&#123;request_info[<span class="string">&#x27;path&#x27;</span>]&#125;</span>\n&quot;</span></span><br><span class="line">        <span class="keyword">await</span> f.write(log_line)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理用户请求的路由处理器</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_user</span>(<span class="params">request</span>):</span><br><span class="line">    user_id = request.match_info.get(<span class="string">&#x27;user_id&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 记录请求</span></span><br><span class="line">    <span class="keyword">await</span> log_request(&#123;</span><br><span class="line">        <span class="string">&quot;ip&quot;</span>: request.remote,</span><br><span class="line">        <span class="string">&quot;path&quot;</span>: request.path</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 并行获取用户数据和状态</span></span><br><span class="line">    user_data, user_status = <span class="keyword">await</span> asyncio.gather(</span><br><span class="line">        fetch_from_db(user_id),</span><br><span class="line">        call_external_api(user_id)</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 合并结果</span></span><br><span class="line">    result = &#123;**user_data, **user_status&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> web.json_response(result)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主页路由处理器</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_index</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">return</span> web.Response(text=<span class="string">&quot;Welcome to the Async Web Server!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建应用</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_app</span>():</span><br><span class="line">    app = web.Application()</span><br><span class="line">    app.router.add_get(<span class="string">&#x27;/&#x27;</span>, handle_index)</span><br><span class="line">    app.router.add_get(<span class="string">&#x27;/users/&#123;user_id&#125;&#x27;</span>, handle_user)</span><br><span class="line">    <span class="keyword">return</span> app</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    web.run_app(create_app())</span><br></pre></td></tr></table></figure>

<h2 id="高级并发模式"><a href="#高级并发模式" class="headerlink" title="高级并发模式"></a>高级并发模式</h2><h3 id="生产者-消费者模式"><a href="#生产者-消费者模式" class="headerlink" title="生产者-消费者模式"></a>生产者-消费者模式</h3><p>生产者-消费者是一种常见的并发模式，可以用多种方式实现：</p>
<h4 id="使用队列和线程"><a href="#使用队列和线程" class="headerlink" title="使用队列和线程"></a>使用队列和线程</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="comment"># 共享队列</span></span><br><span class="line">task_queue = queue.Queue(maxsize=<span class="number">10</span>)</span><br><span class="line">result_queue = queue.Queue()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生产者函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">producer</span>(<span class="params">num_tasks</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_tasks):</span><br><span class="line">        task = <span class="string">f&quot;Task-<span class="subst">&#123;i&#125;</span>&quot;</span></span><br><span class="line">        task_queue.put(task)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;生产者: 添加 <span class="subst">&#123;task&#125;</span>&quot;</span>)</span><br><span class="line">        time.sleep(random.uniform(<span class="number">0.1</span>, <span class="number">0.3</span>))  <span class="comment"># 随机延迟</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 添加结束标记</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):  <span class="comment"># 假设有3个消费者</span></span><br><span class="line">        task_queue.put(<span class="literal">None</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;生产者: 完成所有任务&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 消费者函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">consumer</span>(<span class="params">consumer_id</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        task = task_queue.get()</span><br><span class="line">        <span class="keyword">if</span> task <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;消费者-<span class="subst">&#123;consumer_id&#125;</span>: 收到结束信号&quot;</span>)</span><br><span class="line">            task_queue.task_done()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;消费者-<span class="subst">&#123;consumer_id&#125;</span>: 处理 <span class="subst">&#123;task&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># 模拟处理任务</span></span><br><span class="line">        time.sleep(random.uniform(<span class="number">0.5</span>, <span class="number">1.0</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 将结果放入结果队列</span></span><br><span class="line">        result = <span class="string">f&quot;Result of <span class="subst">&#123;task&#125;</span> by Consumer-<span class="subst">&#123;consumer_id&#125;</span>&quot;</span></span><br><span class="line">        result_queue.put(result)</span><br><span class="line">        </span><br><span class="line">        task_queue.task_done()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;消费者-<span class="subst">&#123;consumer_id&#125;</span>: 退出&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果处理函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">result_processor</span>():</span><br><span class="line">    results = []</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = result_queue.get(timeout=<span class="number">5</span>)</span><br><span class="line">            results.append(result)</span><br><span class="line">            result_queue.task_done()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;结果处理器: 收到 <span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> queue.Empty:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;结果处理器: 超时，退出&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;结果处理器: 共处理 <span class="subst">&#123;<span class="built_in">len</span>(results)&#125;</span> 个结果&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    num_tasks = <span class="number">20</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建并启动线程</span></span><br><span class="line">    producer_thread = threading.Thread(target=producer, args=(num_tasks,))</span><br><span class="line">    consumer_threads = [</span><br><span class="line">        threading.Thread(target=consumer, args=(i,))</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)</span><br><span class="line">    ]</span><br><span class="line">    result_thread = threading.Thread(target=result_processor)</span><br><span class="line">    </span><br><span class="line">    producer_thread.start()</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> consumer_threads:</span><br><span class="line">        t.start()</span><br><span class="line">    result_thread.start()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待所有线程完成</span></span><br><span class="line">    producer_thread.join()</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> consumer_threads:</span><br><span class="line">        t.join()</span><br><span class="line">    result_thread.join()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;所有线程已完成&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h4 id="使用asyncio"><a href="#使用asyncio" class="headerlink" title="使用asyncio"></a>使用asyncio</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">producer</span>(<span class="params">queue, num_tasks</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_tasks):</span><br><span class="line">        task = <span class="string">f&quot;Task-<span class="subst">&#123;i&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">await</span> queue.put(task)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;生产者: 添加 <span class="subst">&#123;task&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(random.uniform(<span class="number">0.1</span>, <span class="number">0.3</span>))  <span class="comment"># 随机延迟</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 添加结束标记</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):  <span class="comment"># 假设有3个消费者</span></span><br><span class="line">        <span class="keyword">await</span> queue.put(<span class="literal">None</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;生产者: 完成所有任务&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">consumer</span>(<span class="params">consumer_id, task_queue, result_queue</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        task = <span class="keyword">await</span> task_queue.get()</span><br><span class="line">        <span class="keyword">if</span> task <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;消费者-<span class="subst">&#123;consumer_id&#125;</span>: 收到结束信号&quot;</span>)</span><br><span class="line">            task_queue.task_done()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;消费者-<span class="subst">&#123;consumer_id&#125;</span>: 处理 <span class="subst">&#123;task&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># 模拟处理任务</span></span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(random.uniform(<span class="number">0.5</span>, <span class="number">1.0</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 将结果放入结果队列</span></span><br><span class="line">        result = <span class="string">f&quot;Result of <span class="subst">&#123;task&#125;</span> by Consumer-<span class="subst">&#123;consumer_id&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">await</span> result_queue.put(result)</span><br><span class="line">        </span><br><span class="line">        task_queue.task_done()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;消费者-<span class="subst">&#123;consumer_id&#125;</span>: 退出&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">result_processor</span>(<span class="params">queue</span>):</span><br><span class="line">    results = []</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = <span class="keyword">await</span> asyncio.wait_for(queue.get(), timeout=<span class="number">5</span>)</span><br><span class="line">            results.append(result)</span><br><span class="line">            queue.task_done()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;结果处理器: 收到 <span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> asyncio.TimeoutError:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;结果处理器: 超时，退出&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;结果处理器: 共处理 <span class="subst">&#123;<span class="built_in">len</span>(results)&#125;</span> 个结果&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    num_tasks = <span class="number">20</span></span><br><span class="line">    task_queue = asyncio.Queue()</span><br><span class="line">    result_queue = asyncio.Queue()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建任务</span></span><br><span class="line">    producer_task = asyncio.create_task(producer(task_queue, num_tasks))</span><br><span class="line">    consumer_tasks = [</span><br><span class="line">        asyncio.create_task(consumer(i, task_queue, result_queue))</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)</span><br><span class="line">    ]</span><br><span class="line">    result_task = asyncio.create_task(result_processor(result_queue))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待所有任务完成</span></span><br><span class="line">    <span class="keyword">await</span> producer_task</span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(*consumer_tasks)</span><br><span class="line">    results = <span class="keyword">await</span> result_task</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;所有任务已完成&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    asyncio.run(main())</span><br></pre></td></tr></table></figure>

<h3 id="线程池与进程池的高级用法"><a href="#线程池与进程池的高级用法" class="headerlink" title="线程池与进程池的高级用法"></a>线程池与进程池的高级用法</h3><h4 id="使用上下文变量"><a href="#使用上下文变量" class="headerlink" title="使用上下文变量"></a>使用上下文变量</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> concurrent.futures</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建线程本地存储</span></span><br><span class="line">thread_local = threading.local()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">initialize_worker</span>():</span><br><span class="line">    <span class="comment"># 初始化线程本地数据</span></span><br><span class="line">    thread_local.worker_id = threading.get_ident()</span><br><span class="line">    thread_local.start_time = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;初始化工作线程 <span class="subst">&#123;thread_local.worker_id&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_task</span>(<span class="params">task</span>):</span><br><span class="line">    <span class="comment"># 访问线程本地数据</span></span><br><span class="line">    worker_id = thread_local.worker_id</span><br><span class="line">    elapsed = time.time() - thread_local.start_time</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;工作线程 <span class="subst">&#123;worker_id&#125;</span> 处理任务 <span class="subst">&#123;task&#125;</span>，已运行 <span class="subst">&#123;elapsed:<span class="number">.2</span>f&#125;</span> 秒&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)  <span class="comment"># 模拟工作</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;任务 <span class="subst">&#123;task&#125;</span> 的结果&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    tasks = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">10</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> concurrent.futures.ThreadPoolExecutor(</span><br><span class="line">        max_workers=<span class="number">3</span>,</span><br><span class="line">        initializer=initialize_worker</span><br><span class="line">    ) <span class="keyword">as</span> executor:</span><br><span class="line">        results = <span class="built_in">list</span>(executor.<span class="built_in">map</span>(process_task, tasks))</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;所有任务完成:&quot;</span>, results)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h4 id="自定义线程池"><a href="#自定义线程池" class="headerlink" title="自定义线程池"></a>自定义线程池</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomThreadPool</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, num_workers</span>):</span><br><span class="line">        <span class="variable language_">self</span>.task_queue = queue.Queue()</span><br><span class="line">        <span class="variable language_">self</span>.workers = []</span><br><span class="line">        <span class="variable language_">self</span>.results = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.result_lock = threading.Lock()</span><br><span class="line">        <span class="variable language_">self</span>.task_counter = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.shutdown_flag = <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建工作线程</span></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_workers):</span><br><span class="line">            worker = threading.Thread(target=<span class="variable language_">self</span>._worker_loop)</span><br><span class="line">            worker.daemon = <span class="literal">True</span></span><br><span class="line">            worker.start()</span><br><span class="line">            <span class="variable language_">self</span>.workers.append(worker)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_worker_loop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> <span class="variable language_">self</span>.shutdown_flag:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                task_id, func, args, kwargs = <span class="variable language_">self</span>.task_queue.get(timeout=<span class="number">0.5</span>)</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    result = func(*args, **kwargs)</span><br><span class="line">                    <span class="keyword">with</span> <span class="variable language_">self</span>.result_lock:</span><br><span class="line">                        <span class="variable language_">self</span>.results[task_id] = (<span class="literal">True</span>, result)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="keyword">with</span> <span class="variable language_">self</span>.result_lock:</span><br><span class="line">                        <span class="variable language_">self</span>.results[task_id] = (<span class="literal">False</span>, e)</span><br><span class="line">                <span class="keyword">finally</span>:</span><br><span class="line">                    <span class="variable language_">self</span>.task_queue.task_done()</span><br><span class="line">            <span class="keyword">except</span> queue.Empty:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">submit</span>(<span class="params">self, func, *args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.shutdown_flag:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;线程池已关闭&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        task_id = <span class="variable language_">self</span>.task_counter</span><br><span class="line">        <span class="variable language_">self</span>.task_counter += <span class="number">1</span></span><br><span class="line">        <span class="variable language_">self</span>.task_queue.put((task_id, func, args, kwargs))</span><br><span class="line">        <span class="keyword">return</span> task_id</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_result</span>(<span class="params">self, task_id, timeout=<span class="literal">None</span></span>):</span><br><span class="line">        end_time = <span class="literal">None</span> <span class="keyword">if</span> timeout <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> time.time() + timeout</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="variable language_">self</span>.result_lock:</span><br><span class="line">                <span class="keyword">if</span> task_id <span class="keyword">in</span> <span class="variable language_">self</span>.results:</span><br><span class="line">                    success, result = <span class="variable language_">self</span>.results.pop(task_id)</span><br><span class="line">                    <span class="keyword">if</span> success:</span><br><span class="line">                        <span class="keyword">return</span> result</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">raise</span> result</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> end_time <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> time.time() &gt; end_time:</span><br><span class="line">                <span class="keyword">raise</span> TimeoutError(<span class="string">f&quot;任务 <span class="subst">&#123;task_id&#125;</span> 等待超时&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            time.sleep(<span class="number">0.01</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">shutdown</span>(<span class="params">self, wait=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.shutdown_flag = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> wait:</span><br><span class="line">            <span class="keyword">for</span> worker <span class="keyword">in</span> <span class="variable language_">self</span>.workers:</span><br><span class="line">                worker.join()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用自定义线程池</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">example_task</span>(<span class="params">n</span>):</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    <span class="keyword">return</span> n * n</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    pool = CustomThreadPool(num_workers=<span class="number">3</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 提交任务</span></span><br><span class="line">    task_ids = [pool.submit(example_task, i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 获取结果</span></span><br><span class="line">    results = [pool.get_result(task_id) <span class="keyword">for</span> task_id <span class="keyword">in</span> task_ids]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;结果:&quot;</span>, results)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 关闭线程池</span></span><br><span class="line">    pool.shutdown()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h3 id="异步迭代器和异步生成器"><a href="#异步迭代器和异步生成器" class="headerlink" title="异步迭代器和异步生成器"></a>异步迭代器和异步生成器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AsyncURLFetcher</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, urls</span>):</span><br><span class="line">        <span class="variable language_">self</span>.urls = urls</span><br><span class="line">        <span class="variable language_">self</span>.index = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__aiter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">__anext__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.index &gt;= <span class="built_in">len</span>(<span class="variable language_">self</span>.urls):</span><br><span class="line">            <span class="keyword">raise</span> StopAsyncIteration</span><br><span class="line">        </span><br><span class="line">        url = <span class="variable language_">self</span>.urls[<span class="variable language_">self</span>.index]</span><br><span class="line">        <span class="variable language_">self</span>.index += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> response:</span><br><span class="line">                <span class="keyword">return</span> url, <span class="keyword">await</span> response.text()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fetch_urls</span>():</span><br><span class="line">    urls = [</span><br><span class="line">        <span class="string">&quot;https://www.example.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://www.python.org&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://www.github.com&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    fetcher = AsyncURLFetcher(urls)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">for</span> url, html <span class="keyword">in</span> fetcher:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;获取 <span class="subst">&#123;url&#125;</span>, 内容长度: <span class="subst">&#123;<span class="built_in">len</span>(html)&#125;</span> 字节&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 异步生成器</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">async_range</span>(<span class="params">start, stop</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start, stop):</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">0.1</span>)</span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">use_async_generator</span>():</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">for</span> i <span class="keyword">in</span> async_range(<span class="number">1</span>, <span class="number">5</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;生成值: <span class="subst">&#123;i&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">await</span> fetch_urls()</span><br><span class="line">    <span class="keyword">await</span> use_async_generator()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    asyncio.run(main())</span><br></pre></td></tr></table></figure>

<h2 id="并发编程的常见陷阱和最佳实践"><a href="#并发编程的常见陷阱和最佳实践" class="headerlink" title="并发编程的常见陷阱和最佳实践"></a>并发编程的常见陷阱和最佳实践</h2><h3 id="常见陷阱"><a href="#常见陷阱" class="headerlink" title="常见陷阱"></a>常见陷阱</h3><ol>
<li><p><strong>死锁</strong>：两个或多个线程互相等待对方释放资源</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可能导致死锁的代码</span></span><br><span class="line">lock1 = threading.Lock()</span><br><span class="line">lock2 = threading.Lock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">thread1_function</span>():</span><br><span class="line">    <span class="keyword">with</span> lock1:</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)  <span class="comment"># 增加死锁可能性</span></span><br><span class="line">        <span class="keyword">with</span> lock2:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;线程1获取了两个锁&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">thread2_function</span>():</span><br><span class="line">    <span class="keyword">with</span> lock2:</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)  <span class="comment"># 增加死锁可能性</span></span><br><span class="line">        <span class="keyword">with</span> lock1:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;线程2获取了两个锁&quot;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>竞态条件</strong>：多个线程同时访问共享资源导致不一致</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 竞态条件示例</span></span><br><span class="line">counter = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">increment</span>():</span><br><span class="line">    <span class="keyword">global</span> counter</span><br><span class="line">    local_copy = counter</span><br><span class="line">    local_copy += <span class="number">1</span></span><br><span class="line">    time.sleep(<span class="number">0.001</span>)  <span class="comment"># 增加竞态条件可能性</span></span><br><span class="line">    counter = local_copy</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>GIL限制</strong>：在CPU密集型任务中使用多线程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 受GIL限制的多线程代码</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cpu_intensive</span>():</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000000</span>):</span><br><span class="line">        _ = <span class="number">1</span> + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">threads = [threading.Thread(target=cpu_intensive) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>资源泄漏</strong>：未正确关闭文件、连接等资源</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 资源泄漏示例</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_file</span>():</span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&quot;large_file.txt&quot;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line">    data = f.read()</span><br><span class="line">    <span class="comment"># 忘记关闭文件</span></span><br><span class="line">    <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>异步代码中的阻塞操作</strong>：在异步函数中使用阻塞调用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 错误的异步代码</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">bad_async_function</span>():</span><br><span class="line">    <span class="comment"># 这会阻塞事件循环</span></span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;完成&quot;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><ol>
<li><p><strong>使用上下文管理器</strong>：自动管理资源的获取和释放</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用上下文管理器</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;file.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义上下文管理器</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadPoolManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, max_workers</span>):</span><br><span class="line">        <span class="variable language_">self</span>.max_workers = max_workers</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__enter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.pool = concurrent.futures.ThreadPoolExecutor(max_workers=<span class="variable language_">self</span>.max_workers)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.pool</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__exit__</span>(<span class="params">self, exc_type, exc_val, exc_tb</span>):</span><br><span class="line">        <span class="variable language_">self</span>.pool.shutdown()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用自定义上下文管理器</span></span><br><span class="line"><span class="keyword">with</span> ThreadPoolManager(max_workers=<span class="number">5</span>) <span class="keyword">as</span> pool:</span><br><span class="line">    results = <span class="built_in">list</span>(pool.<span class="built_in">map</span>(process_item, items))</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>避免共享可变状态</strong>：尽量使用不可变数据或消息传递</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用队列而不是共享变量</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">producer</span>(<span class="params">queue</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        queue.put(i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">consumer</span>(<span class="params">queue</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        item = queue.get()</span><br><span class="line">        <span class="keyword">if</span> item <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        process_item(item)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>使用适当的同步原语</strong>：选择合适的锁、信号量等</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用RLock避免自锁死锁</span></span><br><span class="line">lock = threading.RLock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">recursive_function</span>():</span><br><span class="line">    <span class="keyword">with</span> lock:</span><br><span class="line">        <span class="comment"># 可以再次获取同一个锁</span></span><br><span class="line">        another_function()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">another_function</span>():</span><br><span class="line">    <span class="keyword">with</span> lock:</span><br><span class="line">        <span class="comment"># 不会死锁</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;安全的递归锁使用&quot;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>合理设置超时</strong>：避免无限等待</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置超时</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    result = queue.get(timeout=<span class="number">5</span>)</span><br><span class="line"><span class="keyword">except</span> queue.Empty:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;获取超时&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 异步超时</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    result = <span class="keyword">await</span> asyncio.wait_for(async_function(), timeout=<span class="number">5</span>)</span><br><span class="line"><span class="keyword">except</span> asyncio.TimeoutError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;异步操作超时&quot;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>使用线程&#x2F;进程池</strong>：避免无限制创建线程&#x2F;进程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用线程池</span></span><br><span class="line"><span class="keyword">with</span> concurrent.futures.ThreadPoolExecutor(max_workers=<span class="number">5</span>) <span class="keyword">as</span> executor:</span><br><span class="line">    results = <span class="built_in">list</span>(executor.<span class="built_in">map</span>(process_item, items))</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>正确处理异常</strong>：确保异常不会导致线程&#x2F;进程崩溃</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">worker</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 可能抛出异常的代码</span></span><br><span class="line">        process_data()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;捕获到异常: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>使用原子操作</strong>：避免需要锁的场景</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用Queue而不是手动同步的列表</span></span><br><span class="line">task_queue = Queue()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">producer</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        task_queue.put(i)</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">consumer</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            item = task_queue.get(timeout=<span class="number">1</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;处理项目: <span class="subst">&#123;item&#125;</span>&quot;</span>)</span><br><span class="line">            task_queue.task_done()</span><br><span class="line">        <span class="keyword">except</span> Queue.Empty:</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>Python提供了多种并发编程模型，每种模型都有其优势和适用场景：</p>
<ol>
<li><strong>多线程</strong>：适合IO密集型任务，但受GIL限制</li>
<li><strong>多进程</strong>：适合CPU密集型任务，可以绕过GIL，但有更高的资源开销</li>
<li><strong>异步IO</strong>：适合IO密集型任务，单线程模型避免了多线程的复杂性</li>
</ol>
<p>选择合适的并发模型应该基于任务的性质、性能需求和代码复杂度等因素。在实际应用中，有时候混合使用多种并发模型可能是最佳选择。</p>
<p>无论选择哪种并发模型，都需要注意避免常见的并发编程陷阱，如死锁、竞态条件和资源泄漏等。遵循最佳实践，如使用上下文管理器、避免共享可变状态、设置合理的超时等，可以帮助你编写更健壮、更高效的并发代码。</p>
<p>随着Python的发展，特别是异步IO功能的完善，Python的并发编程能力正在不断增强。掌握这些并发编程模型和技术，将使你能够充分利用现代硬件的性能，构建高效、可扩展的Python应用。</p>
<p>你有什么关于Python并发编程的问题或经验分享吗？欢迎在评论中讨论！</p>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">并发编程</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E5%A4%9A%E8%BF%9B%E7%A8%8B/">多进程</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E5%BC%82%E6%AD%A5IO/">异步IO</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2022/vue/vue-pinia-state-management-guide/"
                                   title="Vue 3 状态管理新选择：Pinia 完全指南"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">Vue 3 状态管理新选择：Pinia 完全指南</span>
                                        <span class="post-nav-item">上一篇</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2022/php/php81-fibers-async-programming/"
                                   title="PHP 8.1 纤程（Fibers）异步编程实战：协程的PHP实现"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">PHP 8.1 纤程（Fibers）异步编程实战：协程的PHP实现</span>
                                        <span class="post-nav-item">下一篇</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    






                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Python%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%9E%8B%EF%BC%9A%E7%BA%BF%E7%A8%8B%E3%80%81%E8%BF%9B%E7%A8%8B%E4%B8%8E%E5%BC%82%E6%AD%A5IO%E7%9A%84%E5%85%A8%E9%9D%A2%E5%AF%B9%E6%AF%94"><span class="nav-text">Python并发编程模型：线程、进程与异步IO的全面对比</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Python%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%9A%84%E6%8C%91%E6%88%98%EF%BC%9AGIL"><span class="nav-text">Python并发编程的挑战：GIL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B"><span class="nav-text">多线程编程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8threading%E6%A8%A1%E5%9D%97"><span class="nav-text">使用threading模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E5%92%8C%E5%90%8C%E6%AD%A5"><span class="nav-text">线程安全和同步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="nav-text">线程池</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-text">多线程的优缺点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%BC%96%E7%A8%8B"><span class="nav-text">多进程编程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8multiprocessing%E6%A8%A1%E5%9D%97"><span class="nav-text">使用multiprocessing模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E6%B1%A0"><span class="nav-text">进程池</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1"><span class="nav-text">进程间通信</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-text">多进程的优缺点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5IO%E7%BC%96%E7%A8%8B"><span class="nav-text">异步IO编程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8asyncio%E6%A8%A1%E5%9D%97"><span class="nav-text">使用asyncio模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E5%99%A8%E5%92%8C%E5%BC%82%E6%AD%A5%E8%BF%AD%E4%BB%A3%E5%99%A8"><span class="nav-text">异步上下文管理器和异步迭代器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E5%90%88asyncio%E5%92%8C%E5%85%B6%E4%BB%96%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B"><span class="nav-text">结合asyncio和其他并发模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5IO%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-text">异步IO的优缺点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E7%A7%8D%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%AF%B9%E6%AF%94"><span class="nav-text">三种并发模型的对比</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90"><span class="nav-text">性能对比结果分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%89%E6%8B%A9%E5%90%88%E9%80%82%E7%9A%84%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B"><span class="nav-text">选择合适的并发模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="nav-text">实际应用案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B1%EF%BC%9AWeb%E7%88%AC%E8%99%AB"><span class="nav-text">案例1：Web爬虫</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B2%EF%BC%9A%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86"><span class="nav-text">案例2：图像处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B3%EF%BC%9AWeb%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-text">案例3：Web服务器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E7%BA%A7%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%BC%8F"><span class="nav-text">高级并发模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="nav-text">生产者-消费者模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E9%98%9F%E5%88%97%E5%92%8C%E7%BA%BF%E7%A8%8B"><span class="nav-text">使用队列和线程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8asyncio"><span class="nav-text">使用asyncio</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B8%8E%E8%BF%9B%E7%A8%8B%E6%B1%A0%E7%9A%84%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95"><span class="nav-text">线程池与进程池的高级用法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E5%8F%98%E9%87%8F"><span class="nav-text">使用上下文变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="nav-text">自定义线程池</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E8%BF%AD%E4%BB%A3%E5%99%A8%E5%92%8C%E5%BC%82%E6%AD%A5%E7%94%9F%E6%88%90%E5%99%A8"><span class="nav-text">异步迭代器和异步生成器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%9A%84%E5%B8%B8%E8%A7%81%E9%99%B7%E9%98%B1%E5%92%8C%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-text">并发编程的常见陷阱和最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%99%B7%E9%98%B1"><span class="nav-text">常见陷阱</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-text">最佳实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA"><span class="nav-text">结论</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
    &copy;&nbsp;2025
    
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">Orion K</a>
        
    </div>


    
        
        <div class="deploy-info info-item">
            
            本站由 <span class="tooltip" data-tooltip-content="GitHub Pages"><img src="/images/brands/github.png"></span> 提供部署服务
            
        </div>
    

    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Python%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%9E%8B%EF%BC%9A%E7%BA%BF%E7%A8%8B%E3%80%81%E8%BF%9B%E7%A8%8B%E4%B8%8E%E5%BC%82%E6%AD%A5IO%E7%9A%84%E5%85%A8%E9%9D%A2%E5%AF%B9%E6%AF%94"><span class="nav-text">Python并发编程模型：线程、进程与异步IO的全面对比</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Python%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%9A%84%E6%8C%91%E6%88%98%EF%BC%9AGIL"><span class="nav-text">Python并发编程的挑战：GIL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B"><span class="nav-text">多线程编程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8threading%E6%A8%A1%E5%9D%97"><span class="nav-text">使用threading模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E5%92%8C%E5%90%8C%E6%AD%A5"><span class="nav-text">线程安全和同步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="nav-text">线程池</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-text">多线程的优缺点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%BC%96%E7%A8%8B"><span class="nav-text">多进程编程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8multiprocessing%E6%A8%A1%E5%9D%97"><span class="nav-text">使用multiprocessing模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E6%B1%A0"><span class="nav-text">进程池</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1"><span class="nav-text">进程间通信</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-text">多进程的优缺点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5IO%E7%BC%96%E7%A8%8B"><span class="nav-text">异步IO编程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8asyncio%E6%A8%A1%E5%9D%97"><span class="nav-text">使用asyncio模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E5%99%A8%E5%92%8C%E5%BC%82%E6%AD%A5%E8%BF%AD%E4%BB%A3%E5%99%A8"><span class="nav-text">异步上下文管理器和异步迭代器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E5%90%88asyncio%E5%92%8C%E5%85%B6%E4%BB%96%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B"><span class="nav-text">结合asyncio和其他并发模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5IO%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-text">异步IO的优缺点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E7%A7%8D%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%AF%B9%E6%AF%94"><span class="nav-text">三种并发模型的对比</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90"><span class="nav-text">性能对比结果分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%89%E6%8B%A9%E5%90%88%E9%80%82%E7%9A%84%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B"><span class="nav-text">选择合适的并发模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="nav-text">实际应用案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B1%EF%BC%9AWeb%E7%88%AC%E8%99%AB"><span class="nav-text">案例1：Web爬虫</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B2%EF%BC%9A%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86"><span class="nav-text">案例2：图像处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B3%EF%BC%9AWeb%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-text">案例3：Web服务器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E7%BA%A7%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%BC%8F"><span class="nav-text">高级并发模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="nav-text">生产者-消费者模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E9%98%9F%E5%88%97%E5%92%8C%E7%BA%BF%E7%A8%8B"><span class="nav-text">使用队列和线程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8asyncio"><span class="nav-text">使用asyncio</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B8%8E%E8%BF%9B%E7%A8%8B%E6%B1%A0%E7%9A%84%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95"><span class="nav-text">线程池与进程池的高级用法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E5%8F%98%E9%87%8F"><span class="nav-text">使用上下文变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="nav-text">自定义线程池</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E8%BF%AD%E4%BB%A3%E5%99%A8%E5%92%8C%E5%BC%82%E6%AD%A5%E7%94%9F%E6%88%90%E5%99%A8"><span class="nav-text">异步迭代器和异步生成器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%9A%84%E5%B8%B8%E8%A7%81%E9%99%B7%E9%98%B1%E5%92%8C%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-text">并发编程的常见陷阱和最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%99%B7%E9%98%B1"><span class="nav-text">常见陷阱</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-text">最佳实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA"><span class="nav-text">结论</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->

<script src="/js/utils.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/toggle-theme.js"></script>

<script src="/js/code-block.js"></script>

<script src="/js/main.js"></script>

<script src="/js/libs/anime.min.js"></script>


<!-- local search -->

    
<script src="/js/local-search.js"></script>



<!-- lazyload -->


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        
<script src="/js/post/post-helper.js"></script>


        <!-- toc -->
        
            
<script src="/js/post/toc.js"></script>

        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
