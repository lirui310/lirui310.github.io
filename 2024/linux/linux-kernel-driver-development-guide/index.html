<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="深入探讨Linux内核编程和驱动开发的核心技术，涵盖内核模块开发、字符设备驱动、平台驱动框架、中断处理、内存管理等关键知识点，提供完整的学习路径和实战案例。">
    <meta name="author" content="Orion K">
    
    <title>
        
            Linux内核编程与驱动开发实战指南：从入门到精通的完整学习路径 |
        
        Orion K Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/logo.svg">
    
    
<link rel="stylesheet" href="/font/css/fontawesome.min.css">

    
<link rel="stylesheet" href="/font/css/regular.min.css">

    
<link rel="stylesheet" href="/font/css/solid.min.css">

    
<link rel="stylesheet" href="/font/css/brands.min.css">

    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"Orion K Blog","author":"Orion K","avatar":"/images/avatar.svg","logo":"/images/logo.svg","favicon":"/images/logo.svg"},"menu":{"home":"/                        || fa-solid fa-home","archives":"/archives            || fa-solid fa-box-archive","tags":"/tags                    || fa-solid fa-tags","categories":"/categories        || fa-solid fa-layer-group"},"first_screen":{"enable":false,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":false,"hide_header":true},"home":{"announcement":"欢迎来到 Orion K 的博客，这是一个分享互联网技术的博客。联系：wxmm686800@gmail.com","category":true,"tag":true,"post_datetime":"created"},"post":{"author_badge":{"enable":true,"level_badge":true,"custom_badge":["One","Two","Three"]},"word_count":{"wordcount":false,"min2read":false},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false,"reward":{"enable":false,"img_link":null,"text":null,"icon":null}},"code_block":{"tools":{"enable":false,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":false,"site_uv":false,"site_pv":false,"page_pv":false}},"local_search":{"enable":true,"preload":true},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.39"},"waline":{"server_url":null,"reaction":false,"version":"3.3.2"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":false},"lazyload":{"enable":false},"cdn":{"enable":false,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2025,"word_count":false,"site_deploy":{"enable":true,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.5"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/logo.svg">
                </a>
            
            <a class="site-name border-box" href="/">
               Orion K Blog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-home"></i>
                                
                                首页
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                
                                归档
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-tags"></i>
                                
                                标签
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-layer-group"></i>
                                
                                分类
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-home"></i>
                                </span>
                            
                            首页
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                </span>
                            
                            归档
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-tags"></i>
                                </span>
                            
                            标签
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-layer-group"></i>
                                </span>
                            
                            分类
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        Linux内核编程与驱动开发实战指南：从入门到精通的完整学习路径
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/avatar.svg">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">Orion K</span>
                                
                                    <span class="author-badge">Lv6</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2024-10-15 14:30:00</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/linux/">linux</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/Linux%E5%86%85%E6%A0%B8/">Linux内核</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/">驱动开发</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%B3%BB%E7%BB%9F/">嵌入式系统</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B/">内核编程</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/">设备驱动</a></li>
                        
                    
                </ul>
            </span>
        

        
        
        
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <h1 id="Linux内核编程与驱动开发实战指南：从入门到精通的完整学习路径"><a href="#Linux内核编程与驱动开发实战指南：从入门到精通的完整学习路径" class="headerlink" title="Linux内核编程与驱动开发实战指南：从入门到精通的完整学习路径"></a>Linux内核编程与驱动开发实战指南：从入门到精通的完整学习路径</h1><p>Linux内核编程和驱动开发是系统级编程的核心技能，对于嵌入式开发、系统优化和硬件控制具有重要意义。<mcreference link="https://bbs.csdn.net/topics/390054341" index="1">1</mcreference> <mcreference link="https://blog.csdn.net/gitblog_00072/article/details/137708700" index="3">3</mcreference> 本文将系统性地介绍Linux内核编程的核心概念、驱动开发技术和实战经验，帮助开发者掌握这一重要技能。</p>
<h2 id="一、Linux内核编程基础"><a href="#一、Linux内核编程基础" class="headerlink" title="一、Linux内核编程基础"></a>一、Linux内核编程基础</h2><h3 id="1-1-内核架构概述"><a href="#1-1-内核架构概述" class="headerlink" title="1.1 内核架构概述"></a>1.1 内核架构概述</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Linux内核架构分析脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Linux内核架构分析 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 内核版本信息</span></span><br><span class="line"><span class="function"><span class="title">kernel_info</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. 内核版本信息&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 当前内核版本</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;当前内核版本:&quot;</span></span><br><span class="line">    <span class="built_in">uname</span> -r</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 内核编译信息</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;内核编译信息:&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> /proc/version</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 内核配置信息</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;内核配置文件位置:&quot;</span></span><br><span class="line">    <span class="built_in">ls</span> -la /boot/config-$(<span class="built_in">uname</span> -r) 2&gt;/dev/null || <span class="built_in">echo</span> <span class="string">&quot;配置文件不存在&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 内核模块目录</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;内核模块目录:&quot;</span></span><br><span class="line">    <span class="built_in">ls</span> /lib/modules/$(<span class="built_in">uname</span> -r)/</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内核子系统分析</span></span><br><span class="line"><span class="function"><span class="title">kernel_subsystems</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;2. 内核子系统分析&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 进程管理</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;进程管理信息:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;当前进程数: <span class="subst">$(ps aux | wc -l)</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;内核线程: <span class="subst">$(ps aux | grep &#x27;\[.*\]&#x27; | wc -l)</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 内存管理</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;内存管理信息:&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> /proc/meminfo | <span class="built_in">head</span> -10</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 文件系统</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;已挂载的文件系统:&quot;</span></span><br><span class="line">    mount | grep -E <span class="string">&#x27;^/dev&#x27;</span> | <span class="built_in">head</span> -5</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 网络子系统</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;网络接口信息:&quot;</span></span><br><span class="line">    ip <span class="built_in">link</span> show | grep -E <span class="string">&#x27;^[0-9]+:&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 设备管理</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;设备信息:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;字符设备数量: <span class="subst">$(ls /dev | grep -v &#x27;/&#x27; | wc -l)</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;块设备数量: <span class="subst">$(lsblk | wc -l)</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内核参数配置</span></span><br><span class="line"><span class="function"><span class="title">kernel_parameters</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;3. 内核参数配置&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 重要的内核参数</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;重要内核参数:&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 内存相关参数</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;内存相关参数:&quot;</span></span><br><span class="line">    sysctl vm.swappiness vm.dirty_ratio vm.dirty_background_ratio</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 网络相关参数</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;网络相关参数:&quot;</span></span><br><span class="line">    sysctl net.core.rmem_max net.core.wmem_max net.ipv4.tcp_congestion_control</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 文件系统相关参数</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;文件系统相关参数:&quot;</span></span><br><span class="line">    sysctl fs.file-max fs.inotify.max_user_watches</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 内核安全参数</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;安全相关参数:&quot;</span></span><br><span class="line">    sysctl kernel.randomize_va_space kernel.kptr_restrict</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kernel_info</span><br><span class="line">kernel_subsystems</span><br><span class="line">kernel_parameters</span><br></pre></td></tr></table></figure>

<h3 id="1-2-内核模块开发基础"><a href="#1-2-内核模块开发基础" class="headerlink" title="1.2 内核模块开发基础"></a>1.2 内核模块开发基础</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hello_module.c - 简单的内核模块示例</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/proc_fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块信息</span></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Your Name&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;A simple Linux kernel module&quot;</span>);</span><br><span class="line">MODULE_VERSION(<span class="string">&quot;1.0&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块参数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> debug_level = <span class="number">0</span>;</span><br><span class="line">module_param(debug_level, <span class="type">int</span>, <span class="number">0644</span>);</span><br><span class="line">MODULE_PARM_DESC(debug_level, <span class="string">&quot;Debug level (0=off, 1=info, 2=debug)&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *device_name = <span class="string">&quot;hello_device&quot;</span>;</span><br><span class="line">module_param(device_name, charp, <span class="number">0644</span>);</span><br><span class="line">MODULE_PARM_DESC(device_name, <span class="string">&quot;Device name&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// proc文件系统接口</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_dir_entry</span> *<span class="title">proc_entry</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * proc_read - proc文件读取函数</span></span><br><span class="line"><span class="comment"> * @file: 文件指针</span></span><br><span class="line"><span class="comment"> * @buffer: 用户空间缓冲区</span></span><br><span class="line"><span class="comment"> * @count: 读取字节数</span></span><br><span class="line"><span class="comment"> * @pos: 文件位置</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 读取的字节数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">proc_read</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">char</span> __user *buffer, </span></span><br><span class="line"><span class="params">                        <span class="type">size_t</span> count, <span class="type">loff_t</span> *pos)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *msg;</span><br><span class="line">    <span class="type">int</span> len;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (*pos &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 已经读取完毕</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    msg = kmalloc(<span class="number">256</span>, GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!msg) &#123;</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    len = <span class="built_in">snprintf</span>(msg, <span class="number">256</span>, </span><br><span class="line">                   <span class="string">&quot;Hello from kernel module!\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;Device name: %s\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;Debug level: %d\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;Module loaded at: %lu\n&quot;</span>,</span><br><span class="line">                   device_name, debug_level, jiffies);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (count &lt; len) &#123;</span><br><span class="line">        kfree(msg);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (copy_to_user(buffer, msg, len)) &#123;</span><br><span class="line">        kfree(msg);</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    *pos += len;</span><br><span class="line">    kfree(msg);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (debug_level &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;hello_module: proc_read called, returned %d bytes\n&quot;</span>, len);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * proc_write - proc文件写入函数</span></span><br><span class="line"><span class="comment"> * @file: 文件指针</span></span><br><span class="line"><span class="comment"> * @buffer: 用户空间缓冲区</span></span><br><span class="line"><span class="comment"> * @count: 写入字节数</span></span><br><span class="line"><span class="comment"> * @pos: 文件位置</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 写入的字节数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">proc_write</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">const</span> <span class="type">char</span> __user *buffer,</span></span><br><span class="line"><span class="params">                         <span class="type">size_t</span> count, <span class="type">loff_t</span> *pos)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *data;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">256</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    data = kmalloc(count + <span class="number">1</span>, GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!data) &#123;</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(data, buffer, count)) &#123;</span><br><span class="line">        kfree(data);</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    data[count] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (debug_level &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;hello_module: received data: %s\n&quot;</span>, data);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 简单的命令处理</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strncmp</span>(data, <span class="string">&quot;debug=&quot;</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> new_level;</span><br><span class="line">        <span class="keyword">if</span> (kstrtoint(data + <span class="number">6</span>, <span class="number">10</span>, &amp;new_level) == <span class="number">0</span>) &#123;</span><br><span class="line">            debug_level = new_level;</span><br><span class="line">            printk(KERN_INFO <span class="string">&quot;hello_module: debug level set to %d\n&quot;</span>, debug_level);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    kfree(data);</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// proc文件操作结构</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_ops</span> <span class="title">proc_fops</span> =</span> &#123;</span><br><span class="line">    .proc_read = proc_read,</span><br><span class="line">    .proc_write = proc_write,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * hello_init - 模块初始化函数</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 0表示成功，负值表示失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">hello_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;hello_module: Loading module...\n&quot;</span>);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;hello_module: Device name: %s\n&quot;</span>, device_name);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;hello_module: Debug level: %d\n&quot;</span>, debug_level);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建proc文件</span></span><br><span class="line">    proc_entry = proc_create(<span class="string">&quot;hello_module&quot;</span>, <span class="number">0666</span>, <span class="literal">NULL</span>, &amp;proc_fops);</span><br><span class="line">    <span class="keyword">if</span> (!proc_entry) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;hello_module: Failed to create proc entry\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;hello_module: Module loaded successfully\n&quot;</span>);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;hello_module: Use &#x27;cat /proc/hello_module&#x27; to read\n&quot;</span>);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;hello_module: Use &#x27;echo data &gt; /proc/hello_module&#x27; to write\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * hello_exit - 模块清理函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">hello_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;hello_module: Unloading module...\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 删除proc文件</span></span><br><span class="line">    <span class="keyword">if</span> (proc_entry) &#123;</span><br><span class="line">        proc_remove(proc_entry);</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;hello_module: Proc entry removed\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;hello_module: Module unloaded successfully\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册模块初始化和清理函数</span></span><br><span class="line">module_init(hello_init);</span><br><span class="line">module_exit(hello_exit);</span><br></pre></td></tr></table></figure>

<h3 id="1-3-内核模块编译和管理"><a href="#1-3-内核模块编译和管理" class="headerlink" title="1.3 内核模块编译和管理"></a>1.3 内核模块编译和管理</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Makefile for hello_module</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 内核模块对象</span></span><br><span class="line">obj-m := hello_module.o</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内核源码目录</span></span><br><span class="line">KDIR := /lib/modules/<span class="variable">$(<span class="built_in">shell</span> uname -r)</span>/build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当前目录</span></span><br><span class="line">PWD := <span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认目标</span></span><br><span class="line"><span class="section">all:</span></span><br><span class="line">	<span class="variable">$(MAKE)</span> -C <span class="variable">$(KDIR)</span> M=<span class="variable">$(PWD)</span> modules</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理目标</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(MAKE)</span> -C <span class="variable">$(KDIR)</span> M=<span class="variable">$(PWD)</span> clean</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装模块</span></span><br><span class="line"><span class="section">install:</span></span><br><span class="line">	<span class="variable">$(MAKE)</span> -C <span class="variable">$(KDIR)</span> M=<span class="variable">$(PWD)</span> modules_install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载模块</span></span><br><span class="line"><span class="section">load:</span></span><br><span class="line">	insmod hello_module.ko</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载模块</span></span><br><span class="line"><span class="section">unload:</span></span><br><span class="line">	rmmod hello_module</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看模块信息</span></span><br><span class="line"><span class="section">info:</span></span><br><span class="line">	modinfo hello_module.ko</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看内核日志</span></span><br><span class="line"><span class="section">log:</span></span><br><span class="line">	dmesg | tail -20</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: all clean install load unload info log</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 内核模块管理脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 内核模块管理工具 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模块编译函数</span></span><br><span class="line"><span class="function"><span class="title">compile_module</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. 编译内核模块&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [ ! -f <span class="string">&quot;Makefile&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;错误: 未找到Makefile&quot;</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;开始编译模块...&quot;</span></span><br><span class="line">    make clean</span><br><span class="line">    make</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;模块编译成功&quot;</span></span><br><span class="line">        <span class="built_in">ls</span> -la *.ko 2&gt;/dev/null</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;模块编译失败&quot;</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模块加载函数</span></span><br><span class="line"><span class="function"><span class="title">load_module</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> module_name=<span class="variable">$1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$module_name</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;用法: load_module &lt;模块名&gt;&quot;</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;2. 加载内核模块: <span class="variable">$module_name</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查模块文件是否存在</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -f <span class="string">&quot;<span class="variable">$&#123;module_name&#125;</span>.ko&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;错误: 模块文件 <span class="variable">$&#123;module_name&#125;</span>.ko 不存在&quot;</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查模块是否已加载</span></span><br><span class="line">    <span class="keyword">if</span> lsmod | grep -q <span class="string">&quot;^<span class="variable">$&#123;module_name&#125;</span> &quot;</span>; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;模块 <span class="variable">$module_name</span> 已经加载&quot;</span></span><br><span class="line">        <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 加载模块</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;正在加载模块 <span class="variable">$module_name</span>...&quot;</span></span><br><span class="line">    <span class="built_in">sudo</span> insmod <span class="string">&quot;<span class="variable">$&#123;module_name&#125;</span>.ko&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;模块加载成功&quot;</span></span><br><span class="line">        lsmod | grep <span class="string">&quot;^<span class="variable">$&#123;module_name&#125;</span> &quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;模块加载失败&quot;</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模块卸载函数</span></span><br><span class="line"><span class="function"><span class="title">unload_module</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> module_name=<span class="variable">$1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$module_name</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;用法: unload_module &lt;模块名&gt;&quot;</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;3. 卸载内核模块: <span class="variable">$module_name</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查模块是否已加载</span></span><br><span class="line">    <span class="keyword">if</span> ! lsmod | grep -q <span class="string">&quot;^<span class="variable">$&#123;module_name&#125;</span> &quot;</span>; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;模块 <span class="variable">$module_name</span> 未加载&quot;</span></span><br><span class="line">        <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 卸载模块</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;正在卸载模块 <span class="variable">$module_name</span>...&quot;</span></span><br><span class="line">    <span class="built_in">sudo</span> rmmod <span class="string">&quot;<span class="variable">$module_name</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;模块卸载成功&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;模块卸载失败&quot;</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模块信息查看</span></span><br><span class="line"><span class="function"><span class="title">module_info</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> module_name=<span class="variable">$1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$module_name</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;用法: module_info &lt;模块名&gt;&quot;</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;4. 模块信息查看: <span class="variable">$module_name</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 模块文件信息</span></span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$&#123;module_name&#125;</span>.ko&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;模块文件信息:&quot;</span></span><br><span class="line">        modinfo <span class="string">&quot;<span class="variable">$&#123;module_name&#125;</span>.ko&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 已加载模块信息</span></span><br><span class="line">    <span class="keyword">if</span> lsmod | grep -q <span class="string">&quot;^<span class="variable">$&#123;module_name&#125;</span> &quot;</span>; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;已加载模块信息:&quot;</span></span><br><span class="line">        lsmod | grep <span class="string">&quot;^<span class="variable">$&#123;module_name&#125;</span> &quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 模块参数</span></span><br><span class="line">        <span class="keyword">if</span> [ -d <span class="string">&quot;/sys/module/<span class="variable">$&#123;module_name&#125;</span>/parameters&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;模块参数:&quot;</span></span><br><span class="line">            <span class="built_in">ls</span> -la <span class="string">&quot;/sys/module/<span class="variable">$&#123;module_name&#125;</span>/parameters/&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内核日志查看</span></span><br><span class="line"><span class="function"><span class="title">view_kernel_log</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;5. 内核日志查看&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;最近的内核消息:&quot;</span></span><br><span class="line">    dmesg | <span class="built_in">tail</span> -20</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;模块相关消息:&quot;</span></span><br><span class="line">    dmesg | grep -i <span class="string">&quot;module\|insmod\|rmmod&quot;</span> | <span class="built_in">tail</span> -10</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主函数</span></span><br><span class="line"><span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">        <span class="string">&quot;compile&quot;</span>)</span><br><span class="line">            compile_module</span><br><span class="line">            ;;</span><br><span class="line">        <span class="string">&quot;load&quot;</span>)</span><br><span class="line">            load_module <span class="variable">$2</span></span><br><span class="line">            ;;</span><br><span class="line">        <span class="string">&quot;unload&quot;</span>)</span><br><span class="line">            unload_module <span class="variable">$2</span></span><br><span class="line">            ;;</span><br><span class="line">        <span class="string">&quot;info&quot;</span>)</span><br><span class="line">            module_info <span class="variable">$2</span></span><br><span class="line">            ;;</span><br><span class="line">        <span class="string">&quot;log&quot;</span>)</span><br><span class="line">            view_kernel_log</span><br><span class="line">            ;;</span><br><span class="line">        <span class="string">&quot;all&quot;</span>)</span><br><span class="line">            compile_module</span><br><span class="line">            load_module hello_module</span><br><span class="line">            module_info hello_module</span><br><span class="line">            view_kernel_log</span><br><span class="line">            ;;</span><br><span class="line">        *)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;用法: <span class="variable">$0</span> &#123;compile|load|unload|info|log|all&#125; [模块名]&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;示例:&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;  <span class="variable">$0</span> compile          # 编译模块&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;  <span class="variable">$0</span> load hello_module    # 加载模块&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;  <span class="variable">$0</span> unload hello_module  # 卸载模块&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;  <span class="variable">$0</span> info hello_module    # 查看模块信息&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;  <span class="variable">$0</span> log              # 查看内核日志&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;  <span class="variable">$0</span> all              # 执行完整流程&quot;</span></span><br><span class="line">            ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main <span class="variable">$@</span></span><br></pre></td></tr></table></figure>

<h2 id="二、字符设备驱动开发"><a href="#二、字符设备驱动开发" class="headerlink" title="二、字符设备驱动开发"></a>二、字符设备驱动开发</h2><h3 id="2-1-字符设备驱动框架"><a href="#2-1-字符设备驱动框架" class="headerlink" title="2.1 字符设备驱动框架"></a>2.1 字符设备驱动框架</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// char_device.c - 字符设备驱动示例</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/mutex.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块信息</span></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Your Name&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Character device driver example&quot;</span>);</span><br><span class="line">MODULE_VERSION(<span class="string">&quot;1.0&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设备相关定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE_NAME <span class="string">&quot;char_dev&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CLASS_NAME <span class="string">&quot;char_class&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 1024</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设备结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">char_device</span> &#123;</span></span><br><span class="line">    <span class="type">dev_t</span> dev_num;              <span class="comment">// 设备号</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span>           <span class="comment">// 字符设备结构</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="title">dev_class</span>;</span>    <span class="comment">// 设备类</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span>      <span class="comment">// 设备</span></span><br><span class="line">    <span class="type">char</span> *buffer;               <span class="comment">// 数据缓冲区</span></span><br><span class="line">    <span class="type">size_t</span> buffer_size;         <span class="comment">// 缓冲区大小</span></span><br><span class="line">    <span class="type">size_t</span> data_size;           <span class="comment">// 当前数据大小</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span>         <span class="comment">// 互斥锁</span></span><br><span class="line">    <span class="type">wait_queue_head_t</span> read_queue;   <span class="comment">// 读等待队列</span></span><br><span class="line">    <span class="type">wait_queue_head_t</span> write_queue;  <span class="comment">// 写等待队列</span></span><br><span class="line">    <span class="type">bool</span> data_available;        <span class="comment">// 数据可用标志</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">char_device</span> *<span class="title">char_dev</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * char_dev_open - 设备打开函数</span></span><br><span class="line"><span class="comment"> * @inode: inode结构指针</span></span><br><span class="line"><span class="comment"> * @file: 文件结构指针</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 0表示成功，负值表示失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">char_dev_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">char_device</span> *<span class="title">dev</span>;</span></span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;char_dev: Device opened\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取设备结构</span></span><br><span class="line">    dev = container_of(inode-&gt;i_cdev, <span class="keyword">struct</span> char_device, cdev);</span><br><span class="line">    file-&gt;private_data = dev;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * char_dev_release - 设备关闭函数</span></span><br><span class="line"><span class="comment"> * @inode: inode结构指针</span></span><br><span class="line"><span class="comment"> * @file: 文件结构指针</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 0表示成功</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">char_dev_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;char_dev: Device closed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * char_dev_read - 设备读取函数</span></span><br><span class="line"><span class="comment"> * @file: 文件结构指针</span></span><br><span class="line"><span class="comment"> * @buffer: 用户空间缓冲区</span></span><br><span class="line"><span class="comment"> * @count: 读取字节数</span></span><br><span class="line"><span class="comment"> * @pos: 文件位置指针</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 实际读取的字节数，负值表示错误</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">char_dev_read</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">char</span> __user *buffer,</span></span><br><span class="line"><span class="params">                            <span class="type">size_t</span> count, <span class="type">loff_t</span> *pos)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">char_device</span> *<span class="title">dev</span> =</span> file-&gt;private_data;</span><br><span class="line">    <span class="type">ssize_t</span> bytes_read = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;char_dev: Read request for %zu bytes\n&quot;</span>, count);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取互斥锁</span></span><br><span class="line">    <span class="keyword">if</span> (mutex_lock_interruptible(&amp;dev-&gt;mutex)) &#123;</span><br><span class="line">        <span class="keyword">return</span> -ERESTARTSYS;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 等待数据可用</span></span><br><span class="line">    <span class="keyword">while</span> (!dev-&gt;data_available) &#123;</span><br><span class="line">        mutex_unlock(&amp;dev-&gt;mutex);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (file-&gt;f_flags &amp; O_NONBLOCK) &#123;</span><br><span class="line">            <span class="keyword">return</span> -EAGAIN;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;char_dev: Waiting for data...\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (wait_event_interruptible(dev-&gt;read_queue, dev-&gt;data_available)) &#123;</span><br><span class="line">            <span class="keyword">return</span> -ERESTARTSYS;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (mutex_lock_interruptible(&amp;dev-&gt;mutex)) &#123;</span><br><span class="line">            <span class="keyword">return</span> -ERESTARTSYS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算实际读取字节数</span></span><br><span class="line">    bytes_read = min(count, dev-&gt;data_size);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 复制数据到用户空间</span></span><br><span class="line">    <span class="keyword">if</span> (copy_to_user(buffer, dev-&gt;buffer, bytes_read)) &#123;</span><br><span class="line">        mutex_unlock(&amp;dev-&gt;mutex);</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 更新缓冲区</span></span><br><span class="line">    <span class="keyword">if</span> (bytes_read &lt; dev-&gt;data_size) &#123;</span><br><span class="line">        memmove(dev-&gt;buffer, dev-&gt;buffer + bytes_read, </span><br><span class="line">                dev-&gt;data_size - bytes_read);</span><br><span class="line">        dev-&gt;data_size -= bytes_read;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dev-&gt;data_size = <span class="number">0</span>;</span><br><span class="line">        dev-&gt;data_available = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    mutex_unlock(&amp;dev-&gt;mutex);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 唤醒写等待队列</span></span><br><span class="line">    wake_up_interruptible(&amp;dev-&gt;write_queue);</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;char_dev: Read %zd bytes\n&quot;</span>, bytes_read);</span><br><span class="line">    <span class="keyword">return</span> bytes_read;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * char_dev_write - 设备写入函数</span></span><br><span class="line"><span class="comment"> * @file: 文件结构指针</span></span><br><span class="line"><span class="comment"> * @buffer: 用户空间缓冲区</span></span><br><span class="line"><span class="comment"> * @count: 写入字节数</span></span><br><span class="line"><span class="comment"> * @pos: 文件位置指针</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 实际写入的字节数，负值表示错误</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">char_dev_write</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">const</span> <span class="type">char</span> __user *buffer,</span></span><br><span class="line"><span class="params">                             <span class="type">size_t</span> count, <span class="type">loff_t</span> *pos)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">char_device</span> *<span class="title">dev</span> =</span> file-&gt;private_data;</span><br><span class="line">    <span class="type">ssize_t</span> bytes_written = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;char_dev: Write request for %zu bytes\n&quot;</span>, count);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取互斥锁</span></span><br><span class="line">    <span class="keyword">if</span> (mutex_lock_interruptible(&amp;dev-&gt;mutex)) &#123;</span><br><span class="line">        <span class="keyword">return</span> -ERESTARTSYS;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 等待缓冲区有空间</span></span><br><span class="line">    <span class="keyword">while</span> (dev-&gt;data_size &gt;= dev-&gt;buffer_size) &#123;</span><br><span class="line">        mutex_unlock(&amp;dev-&gt;mutex);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (file-&gt;f_flags &amp; O_NONBLOCK) &#123;</span><br><span class="line">            <span class="keyword">return</span> -EAGAIN;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;char_dev: Waiting for buffer space...\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (wait_event_interruptible(dev-&gt;write_queue, </span><br><span class="line">                                    dev-&gt;data_size &lt; dev-&gt;buffer_size)) &#123;</span><br><span class="line">            <span class="keyword">return</span> -ERESTARTSYS;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (mutex_lock_interruptible(&amp;dev-&gt;mutex)) &#123;</span><br><span class="line">            <span class="keyword">return</span> -ERESTARTSYS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算实际写入字节数</span></span><br><span class="line">    bytes_written = min(count, dev-&gt;buffer_size - dev-&gt;data_size);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 从用户空间复制数据</span></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(dev-&gt;buffer + dev-&gt;data_size, buffer, bytes_written)) &#123;</span><br><span class="line">        mutex_unlock(&amp;dev-&gt;mutex);</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 更新数据大小和状态</span></span><br><span class="line">    dev-&gt;data_size += bytes_written;</span><br><span class="line">    dev-&gt;data_available = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    mutex_unlock(&amp;dev-&gt;mutex);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 唤醒读等待队列</span></span><br><span class="line">    wake_up_interruptible(&amp;dev-&gt;read_queue);</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;char_dev: Written %zd bytes\n&quot;</span>, bytes_written);</span><br><span class="line">    <span class="keyword">return</span> bytes_written;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * char_dev_ioctl - 设备控制函数</span></span><br><span class="line"><span class="comment"> * @file: 文件结构指针</span></span><br><span class="line"><span class="comment"> * @cmd: 控制命令</span></span><br><span class="line"><span class="comment"> * @arg: 命令参数</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 0表示成功，负值表示失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">char_dev_ioctl</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">char_device</span> *<span class="title">dev</span> =</span> file-&gt;private_data;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;char_dev: IOCTL command: %u\n&quot;</span>, cmd);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>: <span class="comment">// 清空缓冲区</span></span><br><span class="line">        <span class="keyword">if</span> (mutex_lock_interruptible(&amp;dev-&gt;mutex)) &#123;</span><br><span class="line">            <span class="keyword">return</span> -ERESTARTSYS;</span><br><span class="line">        &#125;</span><br><span class="line">        dev-&gt;data_size = <span class="number">0</span>;</span><br><span class="line">        dev-&gt;data_available = <span class="literal">false</span>;</span><br><span class="line">        mutex_unlock(&amp;dev-&gt;mutex);</span><br><span class="line">        wake_up_interruptible(&amp;dev-&gt;write_queue);</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;char_dev: Buffer cleared\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>: <span class="comment">// 获取缓冲区大小</span></span><br><span class="line">        <span class="keyword">if</span> (copy_to_user((<span class="type">void</span> __user *)arg, &amp;dev-&gt;buffer_size, <span class="keyword">sizeof</span>(<span class="type">size_t</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>: <span class="comment">// 获取当前数据大小</span></span><br><span class="line">        <span class="keyword">if</span> (copy_to_user((<span class="type">void</span> __user *)arg, &amp;dev-&gt;data_size, <span class="keyword">sizeof</span>(<span class="type">size_t</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> -ENOTTY;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 文件操作结构</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">char_dev_fops</span> =</span> &#123;</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .open = char_dev_open,</span><br><span class="line">    .release = char_dev_release,</span><br><span class="line">    .read = char_dev_read,</span><br><span class="line">    .write = char_dev_write,</span><br><span class="line">    .unlocked_ioctl = char_dev_ioctl,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * char_dev_init - 模块初始化函数</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 0表示成功，负值表示失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">char_dev_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;char_dev: Initializing character device driver\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 分配设备结构</span></span><br><span class="line">    char_dev = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> char_device), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!char_dev) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;char_dev: Failed to allocate device structure\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 分配缓冲区</span></span><br><span class="line">    char_dev-&gt;buffer = kzalloc(BUFFER_SIZE, GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!char_dev-&gt;buffer) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;char_dev: Failed to allocate buffer\n&quot;</span>);</span><br><span class="line">        ret = -ENOMEM;</span><br><span class="line">        <span class="keyword">goto</span> err_buffer;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    char_dev-&gt;buffer_size = BUFFER_SIZE;</span><br><span class="line">    char_dev-&gt;data_size = <span class="number">0</span>;</span><br><span class="line">    char_dev-&gt;data_available = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化同步原语</span></span><br><span class="line">    mutex_init(&amp;char_dev-&gt;mutex);</span><br><span class="line">    init_waitqueue_head(&amp;char_dev-&gt;read_queue);</span><br><span class="line">    init_waitqueue_head(&amp;char_dev-&gt;write_queue);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 分配设备号</span></span><br><span class="line">    ret = alloc_chrdev_region(&amp;char_dev-&gt;dev_num, <span class="number">0</span>, <span class="number">1</span>, DEVICE_NAME);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;char_dev: Failed to allocate device number\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_chrdev;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;char_dev: Device number allocated: %d:%d\n&quot;</span>,</span><br><span class="line">           MAJOR(char_dev-&gt;dev_num), MINOR(char_dev-&gt;dev_num));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化字符设备</span></span><br><span class="line">    cdev_init(&amp;char_dev-&gt;cdev, &amp;char_dev_fops);</span><br><span class="line">    char_dev-&gt;cdev.owner = THIS_MODULE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加字符设备</span></span><br><span class="line">    ret = cdev_add(&amp;char_dev-&gt;cdev, char_dev-&gt;dev_num, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;char_dev: Failed to add character device\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_cdev;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建设备类</span></span><br><span class="line">    char_dev-&gt;dev_class = class_create(THIS_MODULE, CLASS_NAME);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(char_dev-&gt;dev_class)) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;char_dev: Failed to create device class\n&quot;</span>);</span><br><span class="line">        ret = PTR_ERR(char_dev-&gt;dev_class);</span><br><span class="line">        <span class="keyword">goto</span> err_class;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建设备文件</span></span><br><span class="line">    char_dev-&gt;device = device_create(char_dev-&gt;dev_class, <span class="literal">NULL</span>, </span><br><span class="line">                                    char_dev-&gt;dev_num, <span class="literal">NULL</span>, DEVICE_NAME);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(char_dev-&gt;device)) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;char_dev: Failed to create device\n&quot;</span>);</span><br><span class="line">        ret = PTR_ERR(char_dev-&gt;device);</span><br><span class="line">        <span class="keyword">goto</span> err_device;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;char_dev: Character device driver loaded successfully\n&quot;</span>);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;char_dev: Device file: /dev/%s\n&quot;</span>, DEVICE_NAME);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">err_device:</span><br><span class="line">    class_destroy(char_dev-&gt;dev_class);</span><br><span class="line">err_class:</span><br><span class="line">    cdev_del(&amp;char_dev-&gt;cdev);</span><br><span class="line">err_cdev:</span><br><span class="line">    unregister_chrdev_region(char_dev-&gt;dev_num, <span class="number">1</span>);</span><br><span class="line">err_chrdev:</span><br><span class="line">    kfree(char_dev-&gt;buffer);</span><br><span class="line">err_buffer:</span><br><span class="line">    kfree(char_dev);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * char_dev_exit - 模块清理函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">char_dev_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;char_dev: Unloading character device driver\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (char_dev) &#123;</span><br><span class="line">        <span class="comment">// 删除设备文件</span></span><br><span class="line">        <span class="keyword">if</span> (char_dev-&gt;device) &#123;</span><br><span class="line">            device_destroy(char_dev-&gt;dev_class, char_dev-&gt;dev_num);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 删除设备类</span></span><br><span class="line">        <span class="keyword">if</span> (char_dev-&gt;dev_class) &#123;</span><br><span class="line">            class_destroy(char_dev-&gt;dev_class);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 删除字符设备</span></span><br><span class="line">        cdev_del(&amp;char_dev-&gt;cdev);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 释放设备号</span></span><br><span class="line">        unregister_chrdev_region(char_dev-&gt;dev_num, <span class="number">1</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 释放缓冲区</span></span><br><span class="line">        <span class="keyword">if</span> (char_dev-&gt;buffer) &#123;</span><br><span class="line">            kfree(char_dev-&gt;buffer);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 释放设备结构</span></span><br><span class="line">        kfree(char_dev);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;char_dev: Character device driver unloaded\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(char_dev_init);</span><br><span class="line">module_exit(char_dev_exit);</span><br></pre></td></tr></table></figure>

<h3 id="2-2-设备测试程序"><a href="#2-2-设备测试程序" class="headerlink" title="2.2 设备测试程序"></a>2.2 设备测试程序</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test_char_dev.c - 字符设备测试程序</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE_PATH <span class="string">&quot;/dev/char_dev&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 1024</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 读取线程函数</span></span><br><span class="line"><span class="comment"> * @arg: 线程参数（文件描述符）</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: NULL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">read_thread</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd = *(<span class="type">int</span> *)arg;</span><br><span class="line">    <span class="type">char</span> buffer[BUFFER_SIZE];</span><br><span class="line">    <span class="type">ssize_t</span> bytes_read;</span><br><span class="line">    <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;读取线程启动\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (count &lt; <span class="number">5</span>) &#123;</span><br><span class="line">        bytes_read = read(fd, buffer, <span class="keyword">sizeof</span>(buffer) - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (bytes_read &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            buffer[bytes_read] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;读取线程: 读取了 %zd 字节: %s\n&quot;</span>, bytes_read, buffer);</span><br><span class="line">            count++;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bytes_read == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;读取线程: 到达文件末尾\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            perror(<span class="string">&quot;读取线程: 读取失败&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;读取线程结束\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 写入线程函数</span></span><br><span class="line"><span class="comment"> * @arg: 线程参数（文件描述符）</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: NULL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">write_thread</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd = *(<span class="type">int</span> *)arg;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">256</span>];</span><br><span class="line">    <span class="type">ssize_t</span> bytes_written;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;写入线程启动\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">snprintf</span>(buffer, <span class="keyword">sizeof</span>(buffer), <span class="string">&quot;消息 %d: 这是来自写入线程的测试数据\n&quot;</span>, i + <span class="number">1</span>);</span><br><span class="line">        </span><br><span class="line">        bytes_written = write(fd, buffer, <span class="built_in">strlen</span>(buffer));</span><br><span class="line">        <span class="keyword">if</span> (bytes_written &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;写入线程: 写入了 %zd 字节\n&quot;</span>, bytes_written);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            perror(<span class="string">&quot;写入线程: 写入失败&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;写入线程结束\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试基本读写功能</span></span><br><span class="line"><span class="comment"> * @fd: 设备文件描述符</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">test_basic_io</span><span class="params">(<span class="type">int</span> fd)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> write_buffer[] = <span class="string">&quot;Hello, Character Device!&quot;</span>;</span><br><span class="line">    <span class="type">char</span> read_buffer[BUFFER_SIZE];</span><br><span class="line">    <span class="type">ssize_t</span> bytes_written, bytes_read;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n=== 基本读写测试 ===\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 写入测试</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;写入数据: %s\n&quot;</span>, write_buffer);</span><br><span class="line">    bytes_written = write(fd, write_buffer, <span class="built_in">strlen</span>(write_buffer));</span><br><span class="line">    <span class="keyword">if</span> (bytes_written &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;成功写入 %zd 字节\n&quot;</span>, bytes_written);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        perror(<span class="string">&quot;写入失败&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 读取测试</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;读取数据...\n&quot;</span>);</span><br><span class="line">    bytes_read = read(fd, read_buffer, <span class="keyword">sizeof</span>(read_buffer) - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (bytes_read &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        read_buffer[bytes_read] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;成功读取 %zd 字节: %s\n&quot;</span>, bytes_read, read_buffer);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        perror(<span class="string">&quot;读取失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试IOCTL功能</span></span><br><span class="line"><span class="comment"> * @fd: 设备文件描述符</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">test_ioctl</span><span class="params">(<span class="type">int</span> fd)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> buffer_size, data_size;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n=== IOCTL测试 ===\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取缓冲区大小</span></span><br><span class="line">    ret = ioctl(fd, <span class="number">1</span>, &amp;buffer_size);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;缓冲区大小: %zu 字节\n&quot;</span>, buffer_size);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        perror(<span class="string">&quot;获取缓冲区大小失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取当前数据大小</span></span><br><span class="line">    ret = ioctl(fd, <span class="number">2</span>, &amp;data_size);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;当前数据大小: %zu 字节\n&quot;</span>, data_size);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        perror(<span class="string">&quot;获取数据大小失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清空缓冲区</span></span><br><span class="line">    ret = ioctl(fd, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;缓冲区已清空\n&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        perror(<span class="string">&quot;清空缓冲区失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 再次获取数据大小</span></span><br><span class="line">    ret = ioctl(fd, <span class="number">2</span>, &amp;data_size);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;清空后数据大小: %zu 字节\n&quot;</span>, data_size);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        perror(<span class="string">&quot;获取数据大小失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试多线程访问</span></span><br><span class="line"><span class="comment"> * @fd: 设备文件描述符</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">test_multithreaded</span><span class="params">(<span class="type">int</span> fd)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pthread_t</span> read_tid, write_tid;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n=== 多线程测试 ===\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建读取线程</span></span><br><span class="line">    ret = pthread_create(&amp;read_tid, <span class="literal">NULL</span>, read_thread, &amp;fd);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;创建读取线程失败: %s\n&quot;</span>, strerror(ret));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建写入线程</span></span><br><span class="line">    ret = pthread_create(&amp;write_tid, <span class="literal">NULL</span>, write_thread, &amp;fd);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;创建写入线程失败: %s\n&quot;</span>, strerror(ret));</span><br><span class="line">        pthread_cancel(read_tid);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 等待线程结束</span></span><br><span class="line">    pthread_join(write_tid, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(read_tid, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;多线程测试完成\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 主函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;字符设备驱动测试程序\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;设备路径: %s\n&quot;</span>, DEVICE_PATH);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 打开设备文件</span></span><br><span class="line">    fd = open(DEVICE_PATH, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;打开设备文件失败&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;请确保:\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;1. 内核模块已加载 (lsmod | grep char_dev)\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;2. 设备文件存在 (ls -l %s)\n&quot;</span>, DEVICE_PATH);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;3. 有足够的权限访问设备文件\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;设备文件打开成功\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行各种测试</span></span><br><span class="line">    test_basic_io(fd);</span><br><span class="line">    test_ioctl(fd);</span><br><span class="line">    test_multithreaded(fd);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 关闭设备文件</span></span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n测试完成，设备文件已关闭\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三、平台驱动框架"><a href="#三、平台驱动框架" class="headerlink" title="三、平台驱动框架"></a>三、平台驱动框架</h2><h3 id="3-1-Platform设备和驱动"><a href="#3-1-Platform设备和驱动" class="headerlink" title="3.1 Platform设备和驱动"></a>3.1 Platform设备和驱动</h3><p><mcreference link="https://blog.csdn.net/weixin_42509507/article/details/142307898" index="4">4</mcreference> <mcreference link="https://www.cnblogs.com/gq-z/p/18450763" index="5">5</mcreference> Platform驱动框架是Linux内核中用于管理不能被自动发现的设备的重要机制，特别适用于嵌入式系统中的片上设备。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// platform_driver.c - Platform驱动示例</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/interrupt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/clk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/regulator/consumer.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块信息</span></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Your Name&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Platform driver example&quot;</span>);</span><br><span class="line">MODULE_VERSION(<span class="string">&quot;1.0&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设备私有数据结构</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">my_platform_device</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> __iomem *base;         <span class="comment">// 内存映射基地址</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">clk</span> *<span class="title">clk</span>;</span>            <span class="comment">// 时钟</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">regulator</span> *<span class="title">regulator</span>;</span> <span class="comment">// 电源调节器</span></span><br><span class="line">    <span class="type">int</span> irq;                    <span class="comment">// 中断号</span></span><br><span class="line">    <span class="type">int</span> gpio_pin;               <span class="comment">// GPIO引脚</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span>         <span class="comment">// 设备指针</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * my_platform_irq_handler - 中断处理函数</span></span><br><span class="line"><span class="comment"> * @irq: 中断号</span></span><br><span class="line"><span class="comment"> * @dev_id: 设备ID</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: IRQ_HANDLED表示中断已处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">irqreturn_t</span> <span class="title function_">my_platform_irq_handler</span><span class="params">(<span class="type">int</span> irq, <span class="type">void</span> *dev_id)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">my_platform_device</span> *<span class="title">pdev</span> =</span> dev_id;</span><br><span class="line">    </span><br><span class="line">    dev_info(pdev-&gt;dev, <span class="string">&quot;Interrupt %d received\n&quot;</span>, irq);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 处理中断逻辑</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> IRQ_HANDLED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * my_platform_probe - 设备探测函数</span></span><br><span class="line"><span class="comment"> * @pdev: platform设备指针</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 0表示成功，负值表示失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_platform_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">my_platform_device</span> *<span class="title">my_dev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">res</span>;</span></span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    </span><br><span class="line">    dev_info(&amp;pdev-&gt;dev, <span class="string">&quot;Probing platform device\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 分配私有数据结构</span></span><br><span class="line">    my_dev = devm_kzalloc(&amp;pdev-&gt;dev, <span class="keyword">sizeof</span>(*my_dev), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!my_dev) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to allocate memory\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    my_dev-&gt;dev = &amp;pdev-&gt;dev;</span><br><span class="line">    platform_set_drvdata(pdev, my_dev);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取内存资源</span></span><br><span class="line">    res = platform_get_resource(pdev, IORESOURCE_MEM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;No memory resource found\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENODEV;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 映射内存</span></span><br><span class="line">    my_dev-&gt;base = devm_ioremap_resource(&amp;pdev-&gt;dev, res);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(my_dev-&gt;base)) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to map memory\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(my_dev-&gt;base);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    dev_info(&amp;pdev-&gt;dev, <span class="string">&quot;Memory mapped at 0x%px (physical: 0x%llx)\n&quot;</span>,</span><br><span class="line">             my_dev-&gt;base, (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)res-&gt;start);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取中断资源</span></span><br><span class="line">    my_dev-&gt;irq = platform_get_irq(pdev, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (my_dev-&gt;irq &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        ret = devm_request_irq(&amp;pdev-&gt;dev, my_dev-&gt;irq,</span><br><span class="line">                              my_platform_irq_handler,</span><br><span class="line">                              IRQF_TRIGGER_RISING,</span><br><span class="line">                              dev_name(&amp;pdev-&gt;dev), my_dev);</span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">            dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to request IRQ %d\n&quot;</span>, my_dev-&gt;irq);</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        dev_info(&amp;pdev-&gt;dev, <span class="string">&quot;IRQ %d registered\n&quot;</span>, my_dev-&gt;irq);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dev_info(&amp;pdev-&gt;dev, <span class="string">&quot;No IRQ resource found\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取时钟</span></span><br><span class="line">    my_dev-&gt;clk = devm_clk_get(&amp;pdev-&gt;dev, <span class="string">&quot;my_clk&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(my_dev-&gt;clk)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (PTR_ERR(my_dev-&gt;clk) == -EPROBE_DEFER) &#123;</span><br><span class="line">            dev_info(&amp;pdev-&gt;dev, <span class="string">&quot;Clock not ready, deferring probe\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> -EPROBE_DEFER;</span><br><span class="line">        &#125;</span><br><span class="line">        dev_warn(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to get clock: %ld\n&quot;</span>, PTR_ERR(my_dev-&gt;clk));</span><br><span class="line">        my_dev-&gt;clk = <span class="literal">NULL</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ret = clk_prepare_enable(my_dev-&gt;clk);</span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">            dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to enable clock\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        dev_info(&amp;pdev-&gt;dev, <span class="string">&quot;Clock enabled\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取电源调节器</span></span><br><span class="line">    my_dev-&gt;regulator = devm_regulator_get(&amp;pdev-&gt;dev, <span class="string">&quot;vdd&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(my_dev-&gt;regulator)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (PTR_ERR(my_dev-&gt;regulator) == -EPROBE_DEFER) &#123;</span><br><span class="line">            dev_info(&amp;pdev-&gt;dev, <span class="string">&quot;Regulator not ready, deferring probe\n&quot;</span>);</span><br><span class="line">            ret = -EPROBE_DEFER;</span><br><span class="line">            <span class="keyword">goto</span> err_clk;</span><br><span class="line">        &#125;</span><br><span class="line">        dev_warn(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to get regulator: %ld\n&quot;</span>, </span><br><span class="line">                PTR_ERR(my_dev-&gt;regulator));</span><br><span class="line">        my_dev-&gt;regulator = <span class="literal">NULL</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ret = regulator_enable(my_dev-&gt;regulator);</span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">            dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to enable regulator\n&quot;</span>);</span><br><span class="line">            <span class="keyword">goto</span> err_clk;</span><br><span class="line">        &#125;</span><br><span class="line">        dev_info(&amp;pdev-&gt;dev, <span class="string">&quot;Regulator enabled\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取GPIO</span></span><br><span class="line">    my_dev-&gt;gpio_pin = of_get_named_gpio(pdev-&gt;dev.of_node, <span class="string">&quot;control-gpios&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (gpio_is_valid(my_dev-&gt;gpio_pin)) &#123;</span><br><span class="line">        ret = devm_gpio_request_one(&amp;pdev-&gt;dev, my_dev-&gt;gpio_pin,</span><br><span class="line">                                   GPIOF_OUT_INIT_LOW, <span class="string">&quot;my_platform_gpio&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">            dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to request GPIO %d\n&quot;</span>, my_dev-&gt;gpio_pin);</span><br><span class="line">            <span class="keyword">goto</span> err_regulator;</span><br><span class="line">        &#125;</span><br><span class="line">        dev_info(&amp;pdev-&gt;dev, <span class="string">&quot;GPIO %d configured\n&quot;</span>, my_dev-&gt;gpio_pin);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dev_info(&amp;pdev-&gt;dev, <span class="string">&quot;No valid GPIO found\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设备初始化完成</span></span><br><span class="line">    dev_info(&amp;pdev-&gt;dev, <span class="string">&quot;Platform device probed successfully\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">err_regulator:</span><br><span class="line">    <span class="keyword">if</span> (my_dev-&gt;regulator)</span><br><span class="line">        regulator_disable(my_dev-&gt;regulator);</span><br><span class="line">err_clk:</span><br><span class="line">    <span class="keyword">if</span> (my_dev-&gt;clk)</span><br><span class="line">        clk_disable_unprepare(my_dev-&gt;clk);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * my_platform_remove - 设备移除函数</span></span><br><span class="line"><span class="comment"> * @pdev: platform设备指针</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 0表示成功</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_platform_remove</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">my_platform_device</span> *<span class="title">my_dev</span> =</span> platform_get_drvdata(pdev);</span><br><span class="line">    </span><br><span class="line">    dev_info(&amp;pdev-&gt;dev, <span class="string">&quot;Removing platform device\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 禁用GPIO</span></span><br><span class="line">    <span class="keyword">if</span> (gpio_is_valid(my_dev-&gt;gpio_pin)) &#123;</span><br><span class="line">        gpio_set_value(my_dev-&gt;gpio_pin, <span class="number">0</span>);</span><br><span class="line">        dev_info(&amp;pdev-&gt;dev, <span class="string">&quot;GPIO %d disabled\n&quot;</span>, my_dev-&gt;gpio_pin);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 禁用电源调节器</span></span><br><span class="line">    <span class="keyword">if</span> (my_dev-&gt;regulator) &#123;</span><br><span class="line">        regulator_disable(my_dev-&gt;regulator);</span><br><span class="line">        dev_info(&amp;pdev-&gt;dev, <span class="string">&quot;Regulator disabled\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 禁用时钟</span></span><br><span class="line">    <span class="keyword">if</span> (my_dev-&gt;clk) &#123;</span><br><span class="line">        clk_disable_unprepare(my_dev-&gt;clk);</span><br><span class="line">        dev_info(&amp;pdev-&gt;dev, <span class="string">&quot;Clock disabled\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    dev_info(&amp;pdev-&gt;dev, <span class="string">&quot;Platform device removed successfully\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设备树匹配表</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">my_platform_of_match</span>[] =</span> &#123;</span><br><span class="line">    &#123; .compatible = <span class="string">&quot;my-company,my-platform-device&quot;</span> &#125;,</span><br><span class="line">    &#123; .compatible = <span class="string">&quot;my-company,my-platform-device-v2&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="comment">/* sentinel */</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line">MODULE_DEVICE_TABLE(of, my_platform_of_match);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Platform驱动结构</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">my_platform_driver</span> =</span> &#123;</span><br><span class="line">    .probe = my_platform_probe,</span><br><span class="line">    .remove = my_platform_remove,</span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name = <span class="string">&quot;my-platform-driver&quot;</span>,</span><br><span class="line">        .of_match_table = my_platform_of_match,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * my_platform_init - 模块初始化函数</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 0表示成功，负值表示失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">my_platform_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_platform: Registering platform driver\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = platform_driver_register(&amp;my_platform_driver);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;my_platform: Failed to register platform driver\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_platform: Platform driver registered successfully\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * my_platform_exit - 模块清理函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">my_platform_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_platform: Unregistering platform driver\n&quot;</span>);</span><br><span class="line">    platform_driver_unregister(&amp;my_platform_driver);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_platform: Platform driver unregistered\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(my_platform_init);</span><br><span class="line">module_exit(my_platform_exit);</span><br></pre></td></tr></table></figure>

<h3 id="3-2-设备树配置"><a href="#3-2-设备树配置" class="headerlink" title="3.2 设备树配置"></a>3.2 设备树配置</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// my-platform-device.dts - 设备树配置示例</span></span><br><span class="line"><span class="keyword">/dts-v1/</span><span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">/</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">model</span> <span class="operator">=</span> <span class="string">&quot;My Platform Device Example&quot;</span><span class="punctuation">;</span></span><br><span class="line">    <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;my-company,my-board&quot;</span><span class="punctuation">;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 时钟定义</span></span><br><span class="line">    <span class="title class_">clocks</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="symbol">        my_clk:</span> <span class="title class_">my_clock</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;fixed-clock&quot;</span><span class="punctuation">;</span></span><br><span class="line">            <span class="meta">#clock-cells = &lt;0&gt;;</span></span><br><span class="line">            <span class="attr">clock-frequency</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">100000000</span>&gt;</span><span class="punctuation">;</span> <span class="comment">// 100MHz</span></span><br><span class="line">            <span class="attr">clock-output-names</span> <span class="operator">=</span> <span class="string">&quot;my_clk&quot;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="punctuation">&#125;;</span></span><br><span class="line">    <span class="punctuation">&#125;;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 电源调节器定义</span></span><br><span class="line">    <span class="title class_">regulators</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="symbol">        vdd_supply:</span> <span class="title class_">vdd_regulator</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;regulator-fixed&quot;</span><span class="punctuation">;</span></span><br><span class="line">            <span class="attr">regulator-name</span> <span class="operator">=</span> <span class="string">&quot;vdd&quot;</span><span class="punctuation">;</span></span><br><span class="line">            <span class="attr">regulator-min-microvolt</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">3300000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">            <span class="attr">regulator-max-microvolt</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">3300000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">            <span class="attr">regulator-always-on</span><span class="punctuation">;</span></span><br><span class="line">            <span class="attr">regulator-boot-on</span><span class="punctuation">;</span></span><br><span class="line">        <span class="punctuation">&#125;;</span></span><br><span class="line">    <span class="punctuation">&#125;;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 平台设备定义</span></span><br><span class="line"><span class="symbol">    my_platform_device:</span> <span class="title class_">my-device@40000000</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;my-company,my-platform-device&quot;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x40000000</span> <span class="number">0x1000</span>&gt;</span><span class="punctuation">;</span> <span class="comment">// 内存映射地址和大小</span></span><br><span class="line">        <span class="attr">interrupts</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0</span> <span class="number">32</span> <span class="number">4</span>&gt;</span><span class="punctuation">;</span>     <span class="comment">// 中断配置</span></span><br><span class="line">        <span class="attr">clocks</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;my_clk</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">clock-names</span> <span class="operator">=</span> <span class="string">&quot;my_clk&quot;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">vdd-supply</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;vdd_supply</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">control-gpios</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio1</span> <span class="number">10</span> <span class="number">0</span>&gt;</span><span class="punctuation">;</span> <span class="comment">// GPIO配置</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设备特定属性</span></span><br><span class="line">        <span class="attr">my-property</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">42</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">my-string-property</span> <span class="operator">=</span> <span class="string">&quot;example&quot;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">my-boolean-property</span><span class="punctuation">;</span></span><br><span class="line">        </span><br><span class="line">        <span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line">    <span class="punctuation">&#125;;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// GPIO控制器定义（示例）</span></span><br><span class="line"><span class="symbol">    gpio1:</span> <span class="title class_">gpio@40020000</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;my-company,gpio-controller&quot;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x40020000</span> <span class="number">0x1000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">gpio-controller</span><span class="punctuation">;</span></span><br><span class="line">        <span class="meta">#gpio-cells = &lt;2&gt;;</span></span><br><span class="line">        <span class="attr">ngpios</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">32</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">    <span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-设备树解析工具"><a href="#3-3-设备树解析工具" class="headerlink" title="3.3 设备树解析工具"></a>3.3 设备树解析工具</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 设备树分析和调试脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 设备树分析工具 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设备树信息查看</span></span><br><span class="line"><span class="function"><span class="title">device_tree_info</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. 设备树基本信息&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 设备树文件位置</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;设备树文件位置:&quot;</span></span><br><span class="line">    <span class="built_in">ls</span> -la /sys/firmware/devicetree/base/ 2&gt;/dev/null || <span class="built_in">echo</span> <span class="string">&quot;设备树不可用&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 设备树模型信息</span></span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="string">&quot;/sys/firmware/devicetree/base/model&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;设备模型: <span class="subst">$(cat /sys/firmware/devicetree/base/model)</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="string">&quot;/sys/firmware/devicetree/base/compatible&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;兼容性: <span class="subst">$(cat /sys/firmware/devicetree/base/compatible | tr &#x27;\0&#x27; &#x27; &#x27;)</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 内存信息</span></span><br><span class="line">    <span class="keyword">if</span> [ -d <span class="string">&quot;/sys/firmware/devicetree/base/memory&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;内存节点存在&quot;</span></span><br><span class="line">        find /sys/firmware/devicetree/base/memory* -name <span class="string">&quot;reg&quot;</span> -<span class="built_in">exec</span> xxd &#123;&#125; \;</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Platform设备查看</span></span><br><span class="line"><span class="function"><span class="title">platform_devices_info</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;2. Platform设备信息&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 已注册的platform设备</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;已注册的Platform设备:&quot;</span></span><br><span class="line">    <span class="built_in">ls</span> /sys/bus/platform/devices/ 2&gt;/dev/null | <span class="built_in">head</span> -10</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Platform驱动</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;已注册的Platform驱动:&quot;</span></span><br><span class="line">    <span class="built_in">ls</span> /sys/bus/platform/drivers/ 2&gt;/dev/null | <span class="built_in">head</span> -10</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 设备和驱动的绑定关系</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;设备驱动绑定关系:&quot;</span></span><br><span class="line">    <span class="keyword">for</span> device <span class="keyword">in</span> /sys/bus/platform/devices/*; <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> [ -L <span class="string">&quot;<span class="variable">$device</span>/driver&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            device_name=$(<span class="built_in">basename</span> <span class="string">&quot;<span class="variable">$device</span>&quot;</span>)</span><br><span class="line">            driver_name=$(<span class="built_in">basename</span> $(<span class="built_in">readlink</span> <span class="string">&quot;<span class="variable">$device</span>/driver&quot;</span>))</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;  <span class="variable">$device_name</span> -&gt; <span class="variable">$driver_name</span>&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span> | <span class="built_in">head</span> -5</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设备树属性查看</span></span><br><span class="line"><span class="function"><span class="title">device_tree_properties</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> device_path=<span class="variable">$1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$device_path</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;用法: device_tree_properties &lt;设备路径&gt;&quot;</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;3. 设备树属性查看: <span class="variable">$device_path</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [ ! -d <span class="string">&quot;<span class="variable">$device_path</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;错误: 设备路径不存在&quot;</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;设备属性:&quot;</span></span><br><span class="line">    <span class="keyword">for</span> prop <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$device_path</span>&quot;</span>/*; <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$prop</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            prop_name=$(<span class="built_in">basename</span> <span class="string">&quot;<span class="variable">$prop</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">echo</span> -n <span class="string">&quot;  <span class="variable">$prop_name</span>: &quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 尝试以字符串形式读取</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">cat</span> <span class="string">&quot;<span class="variable">$prop</span>&quot;</span> 2&gt;/dev/null | <span class="built_in">tr</span> -d <span class="string">&#x27;\0&#x27;</span> | grep -q <span class="string">&#x27;^[[:print:]]*$&#x27;</span>; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">cat</span> <span class="string">&quot;<span class="variable">$prop</span>&quot;</span> | <span class="built_in">tr</span> <span class="string">&#x27;\0&#x27;</span> <span class="string">&#x27; &#x27;</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;(binary data)&quot;</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">device_tree_info</span><br><span class="line">platform_devices_info</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;设备树属性查看函数已定义:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;device_tree_properties /sys/firmware/devicetree/base/&lt;设备名&gt;&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="四、中断处理与定时器"><a href="#四、中断处理与定时器" class="headerlink" title="四、中断处理与定时器"></a>四、中断处理与定时器</h2><h3 id="4-1-中断处理机制"><a href="#4-1-中断处理机制" class="headerlink" title="4.1 中断处理机制"></a>4.1 中断处理机制</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// interrupt_handler.c - 中断处理示例</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/interrupt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/timer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/workqueue.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/spinlock.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/atomic.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块信息</span></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Your Name&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Interrupt handling example&quot;</span>);</span><br><span class="line">MODULE_VERSION(<span class="string">&quot;1.0&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// GPIO引脚定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_PIN 18</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_LABEL <span class="string">&quot;interrupt_gpio&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 中断统计结构</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">interrupt_stats</span> &#123;</span></span><br><span class="line">    <span class="type">atomic_t</span> count;             <span class="comment">// 中断计数</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> last_jiffies; <span class="comment">// 最后中断时间</span></span><br><span class="line">    <span class="type">spinlock_t</span> lock;            <span class="comment">// 自旋锁</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span> <span class="title">timer</span>;</span>    <span class="comment">// 定时器</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">work</span>;</span>    <span class="comment">// 工作队列</span></span><br><span class="line">    <span class="type">bool</span> timer_active;          <span class="comment">// 定时器状态</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">interrupt_stats</span> <span class="title">irq_stats</span>;</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> irq_number;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * interrupt_work_handler - 工作队列处理函数</span></span><br><span class="line"><span class="comment"> * @work: 工作结构指针</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 在进程上下文中处理中断的后半部分工作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">interrupt_work_handler</span><span class="params">(<span class="keyword">struct</span> work_struct *work)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">interrupt_stats</span> *<span class="title">stats</span> =</span> container_of(work, <span class="keyword">struct</span> interrupt_stats, work);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line">    <span class="type">int</span> count;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取当前中断计数</span></span><br><span class="line">    count = <span class="type">atomic_read</span>(&amp;stats-&gt;count);</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;interrupt_handler: Work queue processing interrupt #%d\n&quot;</span>, count);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 模拟一些耗时的处理工作</span></span><br><span class="line">    msleep(<span class="number">10</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 在这里可以进行需要睡眠或分配内存的操作</span></span><br><span class="line">    <span class="comment">// 例如：与用户空间通信、文件操作等</span></span><br><span class="line">    </span><br><span class="line">    spin_lock_irqsave(&amp;stats-&gt;lock, flags);</span><br><span class="line">    <span class="comment">// 更新统计信息</span></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;interrupt_handler: Work completed for interrupt #%d\n&quot;</span>, count);</span><br><span class="line">    spin_unlock_irqrestore(&amp;stats-&gt;lock, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * interrupt_timer_handler - 定时器处理函数</span></span><br><span class="line"><span class="comment"> * @timer: 定时器结构指针</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 定时器到期时的处理函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">interrupt_timer_handler</span><span class="params">(<span class="keyword">struct</span> timer_list *timer)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">interrupt_stats</span> *<span class="title">stats</span> =</span> container_of(timer, <span class="keyword">struct</span> interrupt_stats, timer);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line">    <span class="type">int</span> count;</span><br><span class="line">    </span><br><span class="line">    spin_lock_irqsave(&amp;stats-&gt;lock, flags);</span><br><span class="line">    count = <span class="type">atomic_read</span>(&amp;stats-&gt;count);</span><br><span class="line">    stats-&gt;timer_active = <span class="literal">false</span>;</span><br><span class="line">    spin_unlock_irqrestore(&amp;stats-&gt;lock, flags);</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;interrupt_handler: Timer expired, total interrupts: %d\n&quot;</span>, count);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * gpio_interrupt_handler - GPIO中断处理函数</span></span><br><span class="line"><span class="comment"> * @irq: 中断号</span></span><br><span class="line"><span class="comment"> * @dev_id: 设备ID</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: IRQ_HANDLED表示中断已处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">irqreturn_t</span> <span class="title function_">gpio_interrupt_handler</span><span class="params">(<span class="type">int</span> irq, <span class="type">void</span> *dev_id)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">interrupt_stats</span> *<span class="title">stats</span> =</span> (<span class="keyword">struct</span> interrupt_stats *)dev_id;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> current_jiffies = jiffies;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 增加中断计数</span></span><br><span class="line">    <span class="type">atomic_inc</span>(&amp;stats-&gt;count);</span><br><span class="line">    </span><br><span class="line">    spin_lock_irqsave(&amp;stats-&gt;lock, flags);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查中断间隔，防止抖动</span></span><br><span class="line">    <span class="keyword">if</span> (time_after(current_jiffies, stats-&gt;last_jiffies + HZ/<span class="number">100</span>)) &#123; <span class="comment">// 10ms防抖</span></span><br><span class="line">        stats-&gt;last_jiffies = current_jiffies;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 启动定时器（如果未激活）</span></span><br><span class="line">        <span class="keyword">if</span> (!stats-&gt;timer_active) &#123;</span><br><span class="line">            mod_timer(&amp;stats-&gt;timer, jiffies + HZ); <span class="comment">// 1秒后到期</span></span><br><span class="line">            stats-&gt;timer_active = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 调度工作队列</span></span><br><span class="line">        schedule_work(&amp;stats-&gt;work);</span><br><span class="line">        </span><br><span class="line">        spin_unlock_irqrestore(&amp;stats-&gt;lock, flags);</span><br><span class="line">        </span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;interrupt_handler: GPIO interrupt #%d at jiffies %lu\n&quot;</span>,</span><br><span class="line">               <span class="type">atomic_read</span>(&amp;stats-&gt;count), current_jiffies);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> IRQ_HANDLED;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    spin_unlock_irqrestore(&amp;stats-&gt;lock, flags);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 忽略抖动中断</span></span><br><span class="line">    printk(KERN_DEBUG <span class="string">&quot;interrupt_handler: Debounced interrupt ignored\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> IRQ_HANDLED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * setup_gpio_interrupt - 设置GPIO中断</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 0表示成功，负值表示失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">setup_gpio_interrupt</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;interrupt_handler: Setting up GPIO interrupt\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查GPIO是否有效</span></span><br><span class="line">    <span class="keyword">if</span> (!gpio_is_valid(GPIO_PIN)) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;interrupt_handler: Invalid GPIO pin %d\n&quot;</span>, GPIO_PIN);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 请求GPIO</span></span><br><span class="line">    ret = gpio_request(GPIO_PIN, GPIO_LABEL);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;interrupt_handler: Failed to request GPIO %d\n&quot;</span>, GPIO_PIN);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置GPIO为输入</span></span><br><span class="line">    ret = gpio_direction_input(GPIO_PIN);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;interrupt_handler: Failed to set GPIO direction\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_gpio;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取中断号</span></span><br><span class="line">    irq_number = gpio_to_irq(GPIO_PIN);</span><br><span class="line">    <span class="keyword">if</span> (irq_number &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;interrupt_handler: Failed to get IRQ number\n&quot;</span>);</span><br><span class="line">        ret = irq_number;</span><br><span class="line">        <span class="keyword">goto</span> err_gpio;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;interrupt_handler: GPIO %d mapped to IRQ %d\n&quot;</span>, </span><br><span class="line">           GPIO_PIN, irq_number);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 请求中断</span></span><br><span class="line">    ret = request_irq(irq_number, gpio_interrupt_handler,</span><br><span class="line">                     IRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING,</span><br><span class="line">                     <span class="string">&quot;gpio_interrupt&quot;</span>, &amp;irq_stats);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;interrupt_handler: Failed to request IRQ %d\n&quot;</span>, irq_number);</span><br><span class="line">        <span class="keyword">goto</span> err_gpio;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;interrupt_handler: IRQ %d registered successfully\n&quot;</span>, irq_number);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">err_gpio:</span><br><span class="line">    gpio_free(GPIO_PIN);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * cleanup_gpio_interrupt - 清理GPIO中断</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">cleanup_gpio_interrupt</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;interrupt_handler: Cleaning up GPIO interrupt\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放中断</span></span><br><span class="line">    <span class="keyword">if</span> (irq_number &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        free_irq(irq_number, &amp;irq_stats);</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;interrupt_handler: IRQ %d freed\n&quot;</span>, irq_number);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放GPIO</span></span><br><span class="line">    gpio_free(GPIO_PIN);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;interrupt_handler: GPIO %d freed\n&quot;</span>, GPIO_PIN);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * interrupt_handler_init - 模块初始化函数</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 0表示成功，负值表示失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">interrupt_handler_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;interrupt_handler: Loading interrupt handler module\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化中断统计结构</span></span><br><span class="line">    <span class="type">atomic_set</span>(&amp;irq_stats.count, <span class="number">0</span>);</span><br><span class="line">    irq_stats.last_jiffies = <span class="number">0</span>;</span><br><span class="line">    spin_lock_init(&amp;irq_stats.lock);</span><br><span class="line">    irq_stats.timer_active = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化定时器</span></span><br><span class="line">    timer_setup(&amp;irq_stats.timer, interrupt_timer_handler, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化工作队列</span></span><br><span class="line">    INIT_WORK(&amp;irq_stats.work, interrupt_work_handler);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置GPIO中断</span></span><br><span class="line">    ret = setup_gpio_interrupt();</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;interrupt_handler: Failed to setup GPIO interrupt\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;interrupt_handler: Module loaded successfully\n&quot;</span>);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;interrupt_handler: Monitoring GPIO %d for interrupts\n&quot;</span>, GPIO_PIN);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * interrupt_handler_exit - 模块清理函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">interrupt_handler_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;interrupt_handler: Unloading interrupt handler module\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清理GPIO中断</span></span><br><span class="line">    cleanup_gpio_interrupt();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 删除定时器</span></span><br><span class="line">    del_timer_sync(&amp;irq_stats.timer);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 刷新工作队列</span></span><br><span class="line">    flush_work(&amp;irq_stats.work);</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;interrupt_handler: Final interrupt count: %d\n&quot;</span>,</span><br><span class="line">           <span class="type">atomic_read</span>(&amp;irq_stats.count));</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;interrupt_handler: Module unloaded successfully\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(interrupt_handler_init);</span><br><span class="line">module_exit(interrupt_handler_exit);</span><br></pre></td></tr></table></figure>

<h3 id="4-2-内核定时器和延迟工作"><a href="#4-2-内核定时器和延迟工作" class="headerlink" title="4.2 内核定时器和延迟工作"></a>4.2 内核定时器和延迟工作</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// timer_example.c - 内核定时器示例</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/timer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/jiffies.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/workqueue.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块信息</span></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Your Name&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Kernel timer and delayed work example&quot;</span>);</span><br><span class="line">MODULE_VERSION(<span class="string">&quot;1.0&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定时器和工作队列结构</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timer_example</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span> <span class="title">periodic_timer</span>;</span>  <span class="comment">// 周期性定时器</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span> <span class="title">oneshot_timer</span>;</span>   <span class="comment">// 单次定时器</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">delayed_work</span> <span class="title">delayed_work</span>;</span>  <span class="comment">// 延迟工作</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">workqueue_struct</span> *<span class="title">workqueue</span>;</span> <span class="comment">// 专用工作队列</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">kthread</span>;</span>       <span class="comment">// 内核线程</span></span><br><span class="line">    <span class="type">atomic_t</span> timer_count;              <span class="comment">// 定时器计数</span></span><br><span class="line">    <span class="type">atomic_t</span> work_count;               <span class="comment">// 工作计数</span></span><br><span class="line">    <span class="type">bool</span> thread_running;               <span class="comment">// 线程运行状态</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">timer_example</span> <span class="title">timer_ex</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * delayed_work_handler - 延迟工作处理函数</span></span><br><span class="line"><span class="comment"> * @work: 延迟工作结构指针</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">delayed_work_handler</span><span class="params">(<span class="keyword">struct</span> work_struct *work)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">delayed_work</span> *<span class="title">dwork</span> =</span> to_delayed_work(work);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timer_example</span> *<span class="title">tex</span> =</span> container_of(dwork, <span class="keyword">struct</span> timer_example, delayed_work);</span><br><span class="line">    <span class="type">int</span> count;</span><br><span class="line">    </span><br><span class="line">    count = atomic_inc_return(&amp;tex-&gt;work_count);</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;timer_example: Delayed work executed #%d at jiffies %lu\n&quot;</span>,</span><br><span class="line">           count, jiffies);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 模拟一些工作</span></span><br><span class="line">    msleep(<span class="number">100</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 重新调度延迟工作（每5秒执行一次）</span></span><br><span class="line">    <span class="keyword">if</span> (tex-&gt;thread_running) &#123;</span><br><span class="line">        queue_delayed_work(tex-&gt;workqueue, &amp;tex-&gt;delayed_work, <span class="number">5</span> * HZ);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * periodic_timer_handler - 周期性定时器处理函数</span></span><br><span class="line"><span class="comment"> * @timer: 定时器结构指针</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">periodic_timer_handler</span><span class="params">(<span class="keyword">struct</span> timer_list *timer)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timer_example</span> *<span class="title">tex</span> =</span> container_of(timer, <span class="keyword">struct</span> timer_example, periodic_timer);</span><br><span class="line">    <span class="type">int</span> count;</span><br><span class="line">    </span><br><span class="line">    count = atomic_inc_return(&amp;tex-&gt;timer_count);</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;timer_example: Periodic timer fired #%d at jiffies %lu\n&quot;</span>,</span><br><span class="line">           count, jiffies);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 重新设置定时器（每2秒触发一次）</span></span><br><span class="line">    <span class="keyword">if</span> (tex-&gt;thread_running) &#123;</span><br><span class="line">        mod_timer(&amp;tex-&gt;periodic_timer, jiffies + <span class="number">2</span> * HZ);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * oneshot_timer_handler - 单次定时器处理函数</span></span><br><span class="line"><span class="comment"> * @timer: 定时器结构指针</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">oneshot_timer_handler</span><span class="params">(<span class="keyword">struct</span> timer_list *timer)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timer_example</span> *<span class="title">tex</span> =</span> container_of(timer, <span class="keyword">struct</span> timer_example, oneshot_timer);</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;timer_example: One-shot timer fired at jiffies %lu\n&quot;</span>, jiffies);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 启动延迟工作</span></span><br><span class="line">    queue_delayed_work(tex-&gt;workqueue, &amp;tex-&gt;delayed_work, HZ);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * timer_thread - 内核线程函数</span></span><br><span class="line"><span class="comment"> * @data: 线程参数</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 0表示正常退出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">timer_thread</span><span class="params">(<span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timer_example</span> *<span class="title">tex</span> =</span> (<span class="keyword">struct</span> timer_example *)data;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> timeout;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;timer_example: Kernel thread started\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (!kthread_should_stop()) &#123;</span><br><span class="line">        <span class="comment">// 设置超时时间（10秒）</span></span><br><span class="line">        timeout = jiffies + <span class="number">10</span> * HZ;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 等待超时或停止信号</span></span><br><span class="line">        <span class="keyword">while</span> (time_before(jiffies, timeout) &amp;&amp; !kthread_should_stop()) &#123;</span><br><span class="line">            schedule_timeout_interruptible(HZ); <span class="comment">// 1秒检查一次</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!kthread_should_stop()) &#123;</span><br><span class="line">            printk(KERN_INFO <span class="string">&quot;timer_example: Thread periodic check at jiffies %lu\n&quot;</span>, jiffies);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 触发单次定时器</span></span><br><span class="line">            mod_timer(&amp;tex-&gt;oneshot_timer, jiffies + HZ/<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;timer_example: Kernel thread stopping\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * timer_example_init - 模块初始化函数</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 0表示成功，负值表示失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">timer_example_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;timer_example: Loading timer example module\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化计数器</span></span><br><span class="line">    <span class="type">atomic_set</span>(&amp;timer_ex.timer_count, <span class="number">0</span>);</span><br><span class="line">    <span class="type">atomic_set</span>(&amp;timer_ex.work_count, <span class="number">0</span>);</span><br><span class="line">    timer_ex.thread_running = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建专用工作队列</span></span><br><span class="line">    timer_ex.workqueue = create_singlethread_workqueue(<span class="string">&quot;timer_example_wq&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!timer_ex.workqueue) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;timer_example: Failed to create workqueue\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化定时器</span></span><br><span class="line">    timer_setup(&amp;timer_ex.periodic_timer, periodic_timer_handler, <span class="number">0</span>);</span><br><span class="line">    timer_setup(&amp;timer_ex.oneshot_timer, oneshot_timer_handler, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化延迟工作</span></span><br><span class="line">    INIT_DELAYED_WORK(&amp;timer_ex.delayed_work, delayed_work_handler);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 启动周期性定时器</span></span><br><span class="line">    mod_timer(&amp;timer_ex.periodic_timer, jiffies + HZ);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建内核线程</span></span><br><span class="line">    timer_ex.kthread = kthread_run(timer_thread, &amp;timer_ex, <span class="string">&quot;timer_example_thread&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(timer_ex.kthread)) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;timer_example: Failed to create kernel thread\n&quot;</span>);</span><br><span class="line">        del_timer_sync(&amp;timer_ex.periodic_timer);</span><br><span class="line">        destroy_workqueue(timer_ex.workqueue);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(timer_ex.kthread);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;timer_example: Module loaded successfully\n&quot;</span>);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;timer_example: Periodic timer started\n&quot;</span>);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;timer_example: Kernel thread created\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * timer_example_exit - 模块清理函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">timer_example_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;timer_example: Unloading timer example module\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 停止线程</span></span><br><span class="line">    timer_ex.thread_running = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (timer_ex.kthread) &#123;</span><br><span class="line">        kthread_stop(timer_ex.kthread);</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;timer_example: Kernel thread stopped\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 删除定时器</span></span><br><span class="line">    del_timer_sync(&amp;timer_ex.periodic_timer);</span><br><span class="line">    del_timer_sync(&amp;timer_ex.oneshot_timer);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;timer_example: Timers deleted\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 取消延迟工作并销毁工作队列</span></span><br><span class="line">    <span class="keyword">if</span> (timer_ex.workqueue) &#123;</span><br><span class="line">        cancel_delayed_work_sync(&amp;timer_ex.delayed_work);</span><br><span class="line">        destroy_workqueue(timer_ex.workqueue);</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;timer_example: Workqueue destroyed\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;timer_example: Final counts - Timer: %d, Work: %d\n&quot;</span>,</span><br><span class="line">           <span class="type">atomic_read</span>(&amp;timer_ex.timer_count), <span class="type">atomic_read</span>(&amp;timer_ex.work_count));</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;timer_example: Module unloaded successfully\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(timer_example_init);</span><br><span class="line">module_exit(timer_example_exit);</span><br></pre></td></tr></table></figure>

<h2 id="五、内存管理与同步机制"><a href="#五、内存管理与同步机制" class="headerlink" title="五、内存管理与同步机制"></a>五、内存管理与同步机制</h2><h3 id="5-1-内核内存分配"><a href="#5-1-内核内存分配" class="headerlink" title="5.1 内核内存分配"></a>5.1 内核内存分配</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// memory_management.c - 内核内存管理示例</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/vmalloc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/mm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gfp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/dma-mapping.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/proc_fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/seq_file.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块信息</span></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Your Name&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Kernel memory management example&quot;</span>);</span><br><span class="line">MODULE_VERSION(<span class="string">&quot;1.0&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 内存管理结构</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">memory_example</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> *kmalloc_ptr;          <span class="comment">// kmalloc分配的内存</span></span><br><span class="line">    <span class="type">void</span> *vmalloc_ptr;          <span class="comment">// vmalloc分配的内存</span></span><br><span class="line">    <span class="type">void</span> *dma_coherent_ptr;     <span class="comment">// DMA一致性内存</span></span><br><span class="line">    <span class="type">dma_addr_t</span> dma_handle;      <span class="comment">// DMA物理地址</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">cache</span>;</span>   <span class="comment">// slab缓存</span></span><br><span class="line">    <span class="type">void</span> *cache_obj;            <span class="comment">// 缓存对象</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">pages</span>;</span>         <span class="comment">// 页面分配</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> page_order;   <span class="comment">// 页面阶数</span></span><br><span class="line">    <span class="type">size_t</span> total_allocated;     <span class="comment">// 总分配内存</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">memory_example</span> <span class="title">mem_ex</span>;</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_dir_entry</span> *<span class="title">proc_entry</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义结构用于slab缓存</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">custom_object</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line">    <span class="type">char</span> name[<span class="number">32</span>];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> timestamp;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * cache_constructor - slab缓存构造函数</span></span><br><span class="line"><span class="comment"> * @obj: 对象指针</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">cache_constructor</span><span class="params">(<span class="type">void</span> *obj)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">custom_object</span> *<span class="title">custom</span> =</span> (<span class="keyword">struct</span> custom_object *)obj;</span><br><span class="line">    </span><br><span class="line">    custom-&gt;id = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(custom-&gt;name, <span class="number">0</span>, <span class="keyword">sizeof</span>(custom-&gt;name));</span><br><span class="line">    custom-&gt;timestamp = <span class="number">0</span>;</span><br><span class="line">    INIT_LIST_HEAD(&amp;custom-&gt;<span class="built_in">list</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * allocate_memory - 分配各种类型的内存</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 0表示成功，负值表示失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">allocate_memory</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;memory_example: Allocating memory\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. kmalloc分配 - 物理连续内存</span></span><br><span class="line">    mem_ex.kmalloc_ptr = kmalloc(<span class="number">4096</span>, GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!mem_ex.kmalloc_ptr) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;memory_example: kmalloc failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line">    mem_ex.total_allocated += <span class="number">4096</span>;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;memory_example: kmalloc allocated 4KB at %p\n&quot;</span>, mem_ex.kmalloc_ptr);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. vmalloc分配 - 虚拟连续内存</span></span><br><span class="line">    mem_ex.vmalloc_ptr = vmalloc(<span class="number">64</span> * <span class="number">1024</span>);</span><br><span class="line">    <span class="keyword">if</span> (!mem_ex.vmalloc_ptr) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;memory_example: vmalloc failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_vmalloc;</span><br><span class="line">    &#125;</span><br><span class="line">    mem_ex.total_allocated += <span class="number">64</span> * <span class="number">1024</span>;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;memory_example: vmalloc allocated 64KB at %p\n&quot;</span>, mem_ex.vmalloc_ptr);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. DMA一致性内存分配</span></span><br><span class="line">    mem_ex.dma_coherent_ptr = dma_alloc_coherent(<span class="literal">NULL</span>, PAGE_SIZE, </span><br><span class="line">                                                &amp;mem_ex.dma_handle, GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!mem_ex.dma_coherent_ptr) &#123;</span><br><span class="line">        printk(KERN_WARNING <span class="string">&quot;memory_example: DMA coherent allocation failed\n&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mem_ex.total_allocated += PAGE_SIZE;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;memory_example: DMA coherent allocated %lu bytes at %p (DMA: %pad)\n&quot;</span>,</span><br><span class="line">               PAGE_SIZE, mem_ex.dma_coherent_ptr, &amp;mem_ex.dma_handle);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 创建slab缓存</span></span><br><span class="line">    mem_ex.cache = kmem_cache_create(<span class="string">&quot;custom_object_cache&quot;</span>,</span><br><span class="line">                                    <span class="keyword">sizeof</span>(<span class="keyword">struct</span> custom_object),</span><br><span class="line">                                    <span class="number">0</span>, SLAB_HWCACHE_ALIGN,</span><br><span class="line">                                    cache_constructor);</span><br><span class="line">    <span class="keyword">if</span> (!mem_ex.cache) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;memory_example: Failed to create slab cache\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_cache;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;memory_example: Slab cache created\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. 从slab缓存分配对象</span></span><br><span class="line">    mem_ex.cache_obj = kmem_cache_alloc(mem_ex.cache, GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!mem_ex.cache_obj) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;memory_example: Failed to allocate from cache\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_cache_alloc;</span><br><span class="line">    &#125;</span><br><span class="line">    mem_ex.total_allocated += <span class="keyword">sizeof</span>(<span class="keyword">struct</span> custom_object);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;memory_example: Object allocated from cache at %p\n&quot;</span>, mem_ex.cache_obj);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. 页面分配</span></span><br><span class="line">    mem_ex.page_order = <span class="number">2</span>; <span class="comment">// 分配4个页面 (2^2)</span></span><br><span class="line">    mem_ex.pages = alloc_pages(GFP_KERNEL, mem_ex.page_order);</span><br><span class="line">    <span class="keyword">if</span> (!mem_ex.pages) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;memory_example: Failed to allocate pages\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_pages;</span><br><span class="line">    &#125;</span><br><span class="line">    mem_ex.total_allocated += PAGE_SIZE &lt;&lt; mem_ex.page_order;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;memory_example: Allocated %lu pages (order %lu) at %p\n&quot;</span>,</span><br><span class="line">           <span class="number">1UL</span> &lt;&lt; mem_ex.page_order, mem_ex.page_order, page_address(mem_ex.pages));</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;memory_example: Total allocated memory: %zu bytes\n&quot;</span>, mem_ex.total_allocated);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">err_pages:</span><br><span class="line">    kmem_cache_free(mem_ex.cache, mem_ex.cache_obj);</span><br><span class="line">err_cache_alloc:</span><br><span class="line">    kmem_cache_destroy(mem_ex.cache);</span><br><span class="line">err_cache:</span><br><span class="line">    <span class="keyword">if</span> (mem_ex.dma_coherent_ptr) &#123;</span><br><span class="line">        dma_free_coherent(<span class="literal">NULL</span>, PAGE_SIZE, mem_ex.dma_coherent_ptr, mem_ex.dma_handle);</span><br><span class="line">    &#125;</span><br><span class="line">    vfree(mem_ex.vmalloc_ptr);</span><br><span class="line">err_vmalloc:</span><br><span class="line">    kfree(mem_ex.kmalloc_ptr);</span><br><span class="line">    <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * free_memory - 释放所有分配的内存</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">free_memory</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;memory_example: Freeing memory\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放页面</span></span><br><span class="line">    <span class="keyword">if</span> (mem_ex.pages) &#123;</span><br><span class="line">        __free_pages(mem_ex.pages, mem_ex.page_order);</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;memory_example: Pages freed\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放slab缓存对象</span></span><br><span class="line">    <span class="keyword">if</span> (mem_ex.cache_obj) &#123;</span><br><span class="line">        kmem_cache_free(mem_ex.cache, mem_ex.cache_obj);</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;memory_example: Cache object freed\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 销毁slab缓存</span></span><br><span class="line">    <span class="keyword">if</span> (mem_ex.cache) &#123;</span><br><span class="line">        kmem_cache_destroy(mem_ex.cache);</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;memory_example: Slab cache destroyed\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放DMA一致性内存</span></span><br><span class="line">    <span class="keyword">if</span> (mem_ex.dma_coherent_ptr) &#123;</span><br><span class="line">        dma_free_coherent(<span class="literal">NULL</span>, PAGE_SIZE, mem_ex.dma_coherent_ptr, mem_ex.dma_handle);</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;memory_example: DMA coherent memory freed\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放vmalloc内存</span></span><br><span class="line">    <span class="keyword">if</span> (mem_ex.vmalloc_ptr) &#123;</span><br><span class="line">        vfree(mem_ex.vmalloc_ptr);</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;memory_example: vmalloc memory freed\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放kmalloc内存</span></span><br><span class="line">    <span class="keyword">if</span> (mem_ex.kmalloc_ptr) &#123;</span><br><span class="line">        kfree(mem_ex.kmalloc_ptr);</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;memory_example: kmalloc memory freed\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;memory_example: All memory freed\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * memory_proc_show - proc文件显示函数</span></span><br><span class="line"><span class="comment"> * @m: seq_file结构指针</span></span><br><span class="line"><span class="comment"> * @v: 私有数据</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 0表示成功</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">memory_proc_show</span><span class="params">(<span class="keyword">struct</span> seq_file *m, <span class="type">void</span> *v)</span></span><br><span class="line">&#123;</span><br><span class="line">    seq_printf(m, <span class="string">&quot;Memory Example Module Status\n&quot;</span>);</span><br><span class="line">    seq_printf(m, <span class="string">&quot;===========================\n&quot;</span>);</span><br><span class="line">    seq_printf(m, <span class="string">&quot;Total allocated: %zu bytes\n&quot;</span>, mem_ex.total_allocated);</span><br><span class="line">    seq_printf(m, <span class="string">&quot;\nMemory allocations:\n&quot;</span>);</span><br><span class="line">    seq_printf(m, <span class="string">&quot;  kmalloc:       %p (4KB)\n&quot;</span>, mem_ex.kmalloc_ptr);</span><br><span class="line">    seq_printf(m, <span class="string">&quot;  vmalloc:       %p (64KB)\n&quot;</span>, mem_ex.vmalloc_ptr);</span><br><span class="line">    seq_printf(m, <span class="string">&quot;  DMA coherent:  %p (%luB, DMA: %pad)\n&quot;</span>, </span><br><span class="line">               mem_ex.dma_coherent_ptr, PAGE_SIZE, &amp;mem_ex.dma_handle);</span><br><span class="line">    seq_printf(m, <span class="string">&quot;  Slab cache:    %p\n&quot;</span>, mem_ex.cache);</span><br><span class="line">    seq_printf(m, <span class="string">&quot;  Cache object:  %p\n&quot;</span>, mem_ex.cache_obj);</span><br><span class="line">    seq_printf(m, <span class="string">&quot;  Pages:         %p (order %lu)\n&quot;</span>, </span><br><span class="line">               mem_ex.pages ? page_address(mem_ex.pages) : <span class="literal">NULL</span>, mem_ex.page_order);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * memory_proc_open - proc文件打开函数</span></span><br><span class="line"><span class="comment"> * @inode: inode结构指针</span></span><br><span class="line"><span class="comment"> * @file: file结构指针</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 0表示成功，负值表示失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">memory_proc_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> single_open(file, memory_proc_show, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// proc文件操作结构</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_ops</span> <span class="title">memory_proc_ops</span> =</span> &#123;</span><br><span class="line">    .proc_open = memory_proc_open,</span><br><span class="line">    .proc_read = seq_read,</span><br><span class="line">    .proc_lseek = seq_lseek,</span><br><span class="line">    .proc_release = single_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * memory_example_init - 模块初始化函数</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 0表示成功，负值表示失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">memory_example_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;memory_example: Loading memory management module\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化内存管理结构</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;mem_ex, <span class="number">0</span>, <span class="keyword">sizeof</span>(mem_ex));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 分配内存</span></span><br><span class="line">    ret = allocate_memory();</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;memory_example: Failed to allocate memory\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建proc文件</span></span><br><span class="line">    proc_entry = proc_create(<span class="string">&quot;memory_example&quot;</span>, <span class="number">0444</span>, <span class="literal">NULL</span>, &amp;memory_proc_ops);</span><br><span class="line">    <span class="keyword">if</span> (!proc_entry) &#123;</span><br><span class="line">        printk(KERN_WARNING <span class="string">&quot;memory_example: Failed to create proc entry\n&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;memory_example: Created /proc/memory_example\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;memory_example: Module loaded successfully\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * memory_example_exit - 模块清理函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">memory_example_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;memory_example: Unloading memory management module\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 删除proc文件</span></span><br><span class="line">    <span class="keyword">if</span> (proc_entry) &#123;</span><br><span class="line">        proc_remove(proc_entry);</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;memory_example: Removed /proc/memory_example\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放内存</span></span><br><span class="line">    free_memory();</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;memory_example: Module unloaded successfully\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(memory_example_init);</span><br><span class="line">module_exit(memory_example_exit);</span><br></pre></td></tr></table></figure>

<h3 id="5-2-同步机制实现"><a href="#5-2-同步机制实现" class="headerlink" title="5.2 同步机制实现"></a>5.2 同步机制实现</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// synchronization.c - 内核同步机制示例</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/mutex.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/spinlock.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/rwlock.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/completion.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/atomic.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/random.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块信息</span></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Your Name&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Kernel synchronization mechanisms example&quot;</span>);</span><br><span class="line">MODULE_VERSION(<span class="string">&quot;1.0&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 同步机制结构</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sync_example</span> &#123;</span></span><br><span class="line">    <span class="comment">// 互斥锁</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 自旋锁</span></span><br><span class="line">    <span class="type">spinlock_t</span> spinlock;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 读写锁</span></span><br><span class="line">    <span class="type">rwlock_t</span> rwlock;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 信号量</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">semaphore</span> <span class="title">semaphore</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 完成量</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">completion</span> <span class="title">completion</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 原子变量</span></span><br><span class="line">    <span class="type">atomic_t</span> atomic_counter;</span><br><span class="line">    <span class="type">atomic_long_t</span> atomic_long_counter;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 共享数据</span></span><br><span class="line">    <span class="type">int</span> shared_data;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> shared_flags;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 线程控制</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">producer_thread</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">consumer_thread</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">reader_threads</span>[3];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">writer_thread</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">bool</span> threads_running;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">sync_example</span> <span class="title">sync_ex</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * producer_thread_fn - 生产者线程函数</span></span><br><span class="line"><span class="comment"> * @data: 线程参数</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 0表示正常退出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">producer_thread_fn</span><span class="params">(<span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sync_example</span> *<span class="title">sync</span> =</span> (<span class="keyword">struct</span> sync_example *)data;</span><br><span class="line">    <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;sync_example: Producer thread started\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (!kthread_should_stop() &amp;&amp; sync-&gt;threads_running) &#123;</span><br><span class="line">        <span class="comment">// 使用互斥锁保护共享数据</span></span><br><span class="line">        mutex_lock(&amp;sync-&gt;mutex);</span><br><span class="line">        </span><br><span class="line">        sync-&gt;shared_data = ++count;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;sync_example: Producer: shared_data = %d\n&quot;</span>, sync-&gt;shared_data);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 增加原子计数器</span></span><br><span class="line">        <span class="type">atomic_inc</span>(&amp;sync-&gt;atomic_counter);</span><br><span class="line">        </span><br><span class="line">        mutex_unlock(&amp;sync-&gt;mutex);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 通知完成量</span></span><br><span class="line">        complete(&amp;sync-&gt;completion);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 释放信号量</span></span><br><span class="line">        up(&amp;sync-&gt;semaphore);</span><br><span class="line">        </span><br><span class="line">        msleep(<span class="number">1000</span>); <span class="comment">// 1秒间隔</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;sync_example: Producer thread stopping\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * consumer_thread_fn - 消费者线程函数</span></span><br><span class="line"><span class="comment"> * @data: 线程参数</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 0表示正常退出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">consumer_thread_fn</span><span class="params">(<span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sync_example</span> *<span class="title">sync</span> =</span> (<span class="keyword">struct</span> sync_example *)data;</span><br><span class="line">    <span class="type">int</span> local_data;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;sync_example: Consumer thread started\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (!kthread_should_stop() &amp;&amp; sync-&gt;threads_running) &#123;</span><br><span class="line">        <span class="comment">// 等待信号量</span></span><br><span class="line">        <span class="keyword">if</span> (down_interruptible(&amp;sync-&gt;semaphore)) &#123;</span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">// 被信号中断</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 等待完成量</span></span><br><span class="line">        <span class="keyword">if</span> (wait_for_completion_interruptible(&amp;sync-&gt;completion)) &#123;</span><br><span class="line">            up(&amp;sync-&gt;semaphore); <span class="comment">// 恢复信号量</span></span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">// 被信号中断</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 使用互斥锁读取共享数据</span></span><br><span class="line">        mutex_lock(&amp;sync-&gt;mutex);</span><br><span class="line">        local_data = sync-&gt;shared_data;</span><br><span class="line">        mutex_unlock(&amp;sync-&gt;mutex);</span><br><span class="line">        </span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;sync_example: Consumer: read shared_data = %d, atomic = %d\n&quot;</span>,</span><br><span class="line">               local_data, <span class="type">atomic_read</span>(&amp;sync-&gt;atomic_counter));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;sync_example: Consumer thread stopping\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * reader_thread_fn - 读者线程函数</span></span><br><span class="line"><span class="comment"> * @data: 线程参数</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 0表示正常退出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">reader_thread_fn</span><span class="params">(<span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sync_example</span> *<span class="title">sync</span> =</span> (<span class="keyword">struct</span> sync_example *)data;</span><br><span class="line">    <span class="type">int</span> thread_id = (<span class="type">int</span>)(<span class="type">long</span>)data;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line">    <span class="type">int</span> local_data;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;sync_example: Reader thread %d started\n&quot;</span>, thread_id);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (!kthread_should_stop() &amp;&amp; sync-&gt;threads_running) &#123;</span><br><span class="line">        <span class="comment">// 使用读锁</span></span><br><span class="line">        read_lock_irqsave(&amp;sync-&gt;rwlock, flags);</span><br><span class="line">        </span><br><span class="line">        local_data = sync-&gt;shared_data;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 模拟读取操作</span></span><br><span class="line">        msleep(<span class="number">100</span>);</span><br><span class="line">        </span><br><span class="line">        read_unlock_irqrestore(&amp;sync-&gt;rwlock, flags);</span><br><span class="line">        </span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;sync_example: Reader %d: read data = %d\n&quot;</span>, thread_id, local_data);</span><br><span class="line">        </span><br><span class="line">        msleep(<span class="number">2000</span> + (thread_id * <span class="number">500</span>)); <span class="comment">// 不同的读取间隔</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;sync_example: Reader thread %d stopping\n&quot;</span>, thread_id);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * writer_thread_fn - 写者线程函数</span></span><br><span class="line"><span class="comment"> * @data: 线程参数</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 0表示正常退出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">writer_thread_fn</span><span class="params">(<span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sync_example</span> *<span class="title">sync</span> =</span> (<span class="keyword">struct</span> sync_example *)data;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line">    <span class="type">int</span> count = <span class="number">1000</span>;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;sync_example: Writer thread started\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (!kthread_should_stop() &amp;&amp; sync-&gt;threads_running) &#123;</span><br><span class="line">        <span class="comment">// 使用写锁</span></span><br><span class="line">        write_lock_irqsave(&amp;sync-&gt;rwlock, flags);</span><br><span class="line">        </span><br><span class="line">        sync-&gt;shared_data = ++count;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 模拟写入操作</span></span><br><span class="line">        msleep(<span class="number">50</span>);</span><br><span class="line">        </span><br><span class="line">        write_unlock_irqrestore(&amp;sync-&gt;rwlock, flags);</span><br><span class="line">        </span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;sync_example: Writer: wrote data = %d\n&quot;</span>, count);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 增加原子长整型计数器</span></span><br><span class="line">        atomic_long_inc(&amp;sync-&gt;atomic_long_counter);</span><br><span class="line">        </span><br><span class="line">        msleep(<span class="number">3000</span>); <span class="comment">// 3秒间隔</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;sync_example: Writer thread stopping\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * spinlock_test - 自旋锁测试函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">spinlock_test</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;sync_example: Testing spinlock\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        spin_lock_irqsave(&amp;sync_ex.spinlock, flags);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 临界区 - 快速操作</span></span><br><span class="line">        sync_ex.shared_flags |= (<span class="number">1</span> &lt;&lt; i);</span><br><span class="line">        </span><br><span class="line">        spin_unlock_irqrestore(&amp;sync_ex.spinlock, flags);</span><br><span class="line">        </span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;sync_example: Spinlock test %d, flags = 0x%lx\n&quot;</span>, </span><br><span class="line">               i, sync_ex.shared_flags);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * atomic_operations_test - 原子操作测试函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">atomic_operations_test</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> old_val, new_val;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;sync_example: Testing atomic operations\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 原子增加</span></span><br><span class="line">    <span class="type">atomic_add</span>(<span class="number">10</span>, &amp;sync_ex.atomic_counter);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;sync_example: After atomic_add(10): %d\n&quot;</span>, </span><br><span class="line">           <span class="type">atomic_read</span>(&amp;sync_ex.atomic_counter));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 原子减少</span></span><br><span class="line">    <span class="type">atomic_sub</span>(<span class="number">5</span>, &amp;sync_ex.atomic_counter);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;sync_example: After atomic_sub(5): %d\n&quot;</span>, </span><br><span class="line">           <span class="type">atomic_read</span>(&amp;sync_ex.atomic_counter));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 原子比较并交换</span></span><br><span class="line">    old_val = <span class="type">atomic_read</span>(&amp;sync_ex.atomic_counter);</span><br><span class="line">    new_val = old_val + <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">if</span> (atomic_cmpxchg(&amp;sync_ex.atomic_counter, old_val, new_val) == old_val) &#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;sync_example: atomic_cmpxchg succeeded: %d -&gt; %d\n&quot;</span>, </span><br><span class="line">               old_val, new_val);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 原子测试并设置位</span></span><br><span class="line">    <span class="keyword">if</span> (!test_and_set_bit(<span class="number">0</span>, &amp;sync_ex.shared_flags)) &#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;sync_example: Bit 0 was clear, now set\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 原子清除位</span></span><br><span class="line">    <span class="keyword">if</span> (test_and_clear_bit(<span class="number">1</span>, &amp;sync_ex.shared_flags)) &#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;sync_example: Bit 1 was set, now clear\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * sync_example_init - 模块初始化函数</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 0表示成功，负值表示失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">sync_example_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;sync_example: Loading synchronization example module\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化同步机制</span></span><br><span class="line">    mutex_init(&amp;sync_ex.mutex);</span><br><span class="line">    spin_lock_init(&amp;sync_ex.spinlock);</span><br><span class="line">    rwlock_init(&amp;sync_ex.rwlock);</span><br><span class="line">    sema_init(&amp;sync_ex.semaphore, <span class="number">0</span>); <span class="comment">// 初始值为0</span></span><br><span class="line">    init_completion(&amp;sync_ex.completion);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化原子变量</span></span><br><span class="line">    <span class="type">atomic_set</span>(&amp;sync_ex.atomic_counter, <span class="number">0</span>);</span><br><span class="line">    atomic_long_set(&amp;sync_ex.atomic_long_counter, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化共享数据</span></span><br><span class="line">    sync_ex.shared_data = <span class="number">0</span>;</span><br><span class="line">    sync_ex.shared_flags = <span class="number">0</span>;</span><br><span class="line">    sync_ex.threads_running = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 测试自旋锁和原子操作</span></span><br><span class="line">    spinlock_test();</span><br><span class="line">    atomic_operations_test();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建生产者线程</span></span><br><span class="line">    sync_ex.producer_thread = kthread_run(producer_thread_fn, &amp;sync_ex, <span class="string">&quot;sync_producer&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(sync_ex.producer_thread)) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;sync_example: Failed to create producer thread\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(sync_ex.producer_thread);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建消费者线程</span></span><br><span class="line">    sync_ex.consumer_thread = kthread_run(consumer_thread_fn, &amp;sync_ex, <span class="string">&quot;sync_consumer&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(sync_ex.consumer_thread)) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;sync_example: Failed to create consumer thread\n&quot;</span>);</span><br><span class="line">        kthread_stop(sync_ex.producer_thread);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(sync_ex.consumer_thread);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建读者线程</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">        sync_ex.reader_threads[i] = kthread_run(reader_thread_fn, (<span class="type">void</span> *)(<span class="type">long</span>)i, </span><br><span class="line">                                               <span class="string">&quot;sync_reader_%d&quot;</span>, i);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(sync_ex.reader_threads[i])) &#123;</span><br><span class="line">            printk(KERN_ERR <span class="string">&quot;sync_example: Failed to create reader thread %d\n&quot;</span>, i);</span><br><span class="line">            <span class="comment">// 清理已创建的线程</span></span><br><span class="line">            sync_ex.threads_running = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">while</span> (--i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                kthread_stop(sync_ex.reader_threads[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            kthread_stop(sync_ex.consumer_thread);</span><br><span class="line">            kthread_stop(sync_ex.producer_thread);</span><br><span class="line">            <span class="keyword">return</span> PTR_ERR(sync_ex.reader_threads[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建写者线程</span></span><br><span class="line">    sync_ex.writer_thread = kthread_run(writer_thread_fn, &amp;sync_ex, <span class="string">&quot;sync_writer&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(sync_ex.writer_thread)) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;sync_example: Failed to create writer thread\n&quot;</span>);</span><br><span class="line">        sync_ex.threads_running = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            kthread_stop(sync_ex.reader_threads[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        kthread_stop(sync_ex.consumer_thread);</span><br><span class="line">        kthread_stop(sync_ex.producer_thread);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(sync_ex.writer_thread);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;sync_example: Module loaded successfully\n&quot;</span>);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;sync_example: All threads created and running\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * sync_example_exit - 模块清理函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">sync_example_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;sync_example: Unloading synchronization example module\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 停止所有线程</span></span><br><span class="line">    sync_ex.threads_running = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 停止写者线程</span></span><br><span class="line">    <span class="keyword">if</span> (sync_ex.writer_thread) &#123;</span><br><span class="line">        kthread_stop(sync_ex.writer_thread);</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;sync_example: Writer thread stopped\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 停止读者线程</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sync_ex.reader_threads[i]) &#123;</span><br><span class="line">            kthread_stop(sync_ex.reader_threads[i]);</span><br><span class="line">            printk(KERN_INFO <span class="string">&quot;sync_example: Reader thread %d stopped\n&quot;</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 停止消费者线程</span></span><br><span class="line">    <span class="keyword">if</span> (sync_ex.consumer_thread) &#123;</span><br><span class="line">        <span class="comment">// 唤醒可能等待的消费者</span></span><br><span class="line">        complete(&amp;sync_ex.completion);</span><br><span class="line">        up(&amp;sync_ex.semaphore);</span><br><span class="line">        kthread_stop(sync_ex.consumer_thread);</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;sync_example: Consumer thread stopped\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 停止生产者线程</span></span><br><span class="line">    <span class="keyword">if</span> (sync_ex.producer_thread) &#123;</span><br><span class="line">        kthread_stop(sync_ex.producer_thread);</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;sync_example: Producer thread stopped\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;sync_example: Final atomic counter: %d\n&quot;</span>, </span><br><span class="line">           <span class="type">atomic_read</span>(&amp;sync_ex.atomic_counter));</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;sync_example: Final atomic long counter: %ld\n&quot;</span>, </span><br><span class="line">           atomic_long_read(&amp;sync_ex.atomic_long_counter));</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;sync_example: Final shared flags: 0x%lx\n&quot;</span>, sync_ex.shared_flags);</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;sync_example: Module unloaded successfully\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(sync_example_init);</span><br><span class="line">module_exit(sync_example_exit);</span><br></pre></td></tr></table></figure>

<h2 id="六、内核调试技巧与工具"><a href="#六、内核调试技巧与工具" class="headerlink" title="六、内核调试技巧与工具"></a>六、内核调试技巧与工具</h2><h3 id="6-1-内核调试方法"><a href="#6-1-内核调试方法" class="headerlink" title="6.1 内核调试方法"></a>6.1 内核调试方法</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># kernel_debug_tools.sh - 内核调试工具脚本</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 内核调试工具集合</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 内核日志分析</span></span><br><span class="line"><span class="function"><span class="title">kernel_log_analysis</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== 内核日志分析 ===&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查看内核环形缓冲区</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. 内核环形缓冲区 (dmesg):&quot;</span></span><br><span class="line">    dmesg | <span class="built_in">tail</span> -20</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查看系统日志</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;\n2. 系统日志:&quot;</span></span><br><span class="line">    journalctl -k --since <span class="string">&quot;1 hour ago&quot;</span> | <span class="built_in">tail</span> -10</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查看内核模块信息</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;\n3. 已加载的内核模块:&quot;</span></span><br><span class="line">    lsmod | <span class="built_in">head</span> -10</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查看内核版本和编译信息</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;\n4. 内核版本信息:&quot;</span></span><br><span class="line">    <span class="built_in">uname</span> -a</span><br><span class="line">    <span class="built_in">cat</span> /proc/version</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 内核符号表分析</span></span><br><span class="line"><span class="function"><span class="title">kernel_symbols_analysis</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== 内核符号表分析 ===&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查看内核符号表</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. 内核符号表 (部分):&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ -r /proc/kallsyms ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">head</span> -20 /proc/kallsyms</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;无法读取 /proc/kallsyms (需要root权限)&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查看模块符号</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;\n2. 模块符号信息:&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ -d /sys/module ]; <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">for</span> module <span class="keyword">in</span> /sys/module/*/; <span class="keyword">do</span></span><br><span class="line">            module_name=$(<span class="built_in">basename</span> <span class="string">&quot;<span class="variable">$module</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$module</span>/srcversion&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;  <span class="variable">$module_name</span>: <span class="subst">$(cat $module/srcversion 2&gt;/dev/null)</span>&quot;</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">done</span> | <span class="built_in">head</span> -5</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 内存调试信息</span></span><br><span class="line"><span class="function"><span class="title">memory_debug_info</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== 内存调试信息 ===&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 内存使用情况</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. 内存使用情况:&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> /proc/meminfo | grep -E <span class="string">&quot;(MemTotal|MemFree|MemAvailable|Buffers|Cached|Slab)&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># slab分配器信息</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;\n2. Slab分配器信息 (前10个):&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ -r /proc/slabinfo ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">head</span> -11 /proc/slabinfo</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;无法读取 /proc/slabinfo&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 虚拟内存统计</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;\n3. 虚拟内存统计:&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> /proc/vmstat | grep -E <span class="string">&quot;(nr_free_pages|nr_alloc_batch|nr_inactive|nr_active)&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 进程和调度信息</span></span><br><span class="line"><span class="function"><span class="title">process_debug_info</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== 进程和调度信息 ===&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 进程状态</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. 进程状态统计:&quot;</span></span><br><span class="line">    ps aux --no-headers | awk <span class="string">&#x27;&#123;print $8&#125;&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 内核线程</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;\n2. 内核线程 (前10个):&quot;</span></span><br><span class="line">    ps -eo pid,ppid,<span class="built_in">comm</span>,<span class="built_in">stat</span> | grep <span class="string">&quot;\[.*\]&quot;</span> | <span class="built_in">head</span> -10</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 调度信息</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;\n3. 调度统计:&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ -r /proc/schedstat ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">head</span> -5 /proc/schedstat</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;无法读取 /proc/schedstat&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 中断和软中断信息</span></span><br><span class="line"><span class="function"><span class="title">interrupt_debug_info</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== 中断调试信息 ===&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 硬件中断</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. 硬件中断统计:&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> /proc/interrupts | <span class="built_in">head</span> -10</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 软中断</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;\n2. 软中断统计:&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> /proc/softirqs | <span class="built_in">head</span> -5</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 中断负载</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;\n3. 中断负载 (每秒):&quot;</span></span><br><span class="line">    awk <span class="string">&#x27;/^cpu/ &#123;print $1, $6+$7&#125;&#x27;</span> /proc/stat</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 文件系统调试</span></span><br><span class="line"><span class="function"><span class="title">filesystem_debug_info</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== 文件系统调试信息 ===&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 挂载信息</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. 挂载的文件系统:&quot;</span></span><br><span class="line">    mount | grep -v tmpfs | <span class="built_in">head</span> -5</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 文件系统统计</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;\n2. 文件系统使用情况:&quot;</span></span><br><span class="line">    <span class="built_in">df</span> -h | <span class="built_in">head</span> -5</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># inode使用情况</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;\n3. inode使用情况:&quot;</span></span><br><span class="line">    <span class="built_in">df</span> -i | <span class="built_in">head</span> -5</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 网络调试信息</span></span><br><span class="line"><span class="function"><span class="title">network_debug_info</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== 网络调试信息 ===&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 网络接口统计</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. 网络接口统计:&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> /proc/net/dev | <span class="built_in">head</span> -5</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 网络连接</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;\n2. 网络连接统计:&quot;</span></span><br><span class="line">    ss -s</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 网络协议统计</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;\n3. 网络协议统计:&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> /proc/net/snmp | grep -E <span class="string">&quot;(Tcp|Udp|Ip):&quot;</span> | <span class="built_in">head</span> -4</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8. 内核配置检查</span></span><br><span class="line"><span class="function"><span class="title">kernel_config_check</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== 内核配置检查 ===&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查内核配置文件</span></span><br><span class="line">    <span class="keyword">if</span> [ -r /proc/config.gz ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;1. 内核配置可用 (/proc/config.gz)&quot;</span></span><br><span class="line">        zcat /proc/config.gz | grep -E <span class="string">&quot;CONFIG_(DEBUG|KASAN|LOCKDEP)&quot;</span> | <span class="built_in">head</span> -5</span><br><span class="line">    <span class="keyword">elif</span> [ -r <span class="string">&quot;/boot/config-<span class="subst">$(uname -r)</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;1. 内核配置可用 (/boot/config-<span class="subst">$(uname -r)</span>)&quot;</span></span><br><span class="line">        grep -E <span class="string">&quot;CONFIG_(DEBUG|KASAN|LOCKDEP)&quot;</span> <span class="string">&quot;/boot/config-<span class="subst">$(uname -r)</span>&quot;</span> | <span class="built_in">head</span> -5</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;1. 内核配置文件不可用&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查调试功能</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;\n2. 调试功能检查:&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ -d /sys/kernel/debug ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;  debugfs: 已挂载&quot;</span></span><br><span class="line">        <span class="built_in">ls</span> /sys/kernel/debug/ | <span class="built_in">head</span> -5</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;  debugfs: 未挂载&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 9. 性能分析工具</span></span><br><span class="line"><span class="function"><span class="title">performance_analysis</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== 性能分析工具 ===&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># CPU使用情况</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. CPU使用情况:&quot;</span></span><br><span class="line">    top -bn1 | <span class="built_in">head</span> -5</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 负载平均值</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;\n2. 系统负载:&quot;</span></span><br><span class="line">    <span class="built_in">uptime</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># I/O统计</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;\n3. I/O统计:&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">command</span> -v iostat &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">        iostat -x 1 1 | <span class="built_in">tail</span> -5</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;  iostat 未安装&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 10. 内核崩溃分析</span></span><br><span class="line"><span class="function"><span class="title">kernel_crash_analysis</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== 内核崩溃分析 ===&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查内核崩溃转储</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. 内核崩溃转储检查:&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ -d /var/crash ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;  崩溃转储目录存在: /var/crash&quot;</span></span><br><span class="line">        <span class="built_in">ls</span> -la /var/crash/ 2&gt;/dev/null | <span class="built_in">head</span> -5</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;  崩溃转储目录不存在&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查系统重启原因</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;\n2. 系统重启历史:&quot;</span></span><br><span class="line">    last reboot | <span class="built_in">head</span> -5</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查内核panic信息</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;\n3. 内核panic信息:&quot;</span></span><br><span class="line">    dmesg | grep -i <span class="string">&quot;panic\|oops\|bug&quot;</span> | <span class="built_in">tail</span> -3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主函数</span></span><br><span class="line"><span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Linux内核调试工具集&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;===================&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;开始时间: <span class="subst">$(date)</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    </span><br><span class="line">    kernel_log_analysis</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    kernel_symbols_analysis</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    memory_debug_info</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    process_debug_info</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    interrupt_debug_info</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    filesystem_debug_info</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    network_debug_info</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    kernel_config_check</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    performance_analysis</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    kernel_crash_analysis</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;调试信息收集完成: <span class="subst">$(date)</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果直接运行脚本</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;BASH_SOURCE[0]&#125;</span>&quot;</span> = <span class="string">&quot;<span class="variable">$&#123;0&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    main <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-GDB内核调试"><a href="#6-2-GDB内核调试" class="headerlink" title="6.2 GDB内核调试"></a>6.2 GDB内核调试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># gdb_kernel_debug.sh - GDB内核调试脚本</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GDB内核调试配置和使用</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 准备调试环境</span></span><br><span class="line"><span class="function"><span class="title">setup_debug_environment</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== 设置内核调试环境 ===&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查内核调试符号</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. 检查内核调试符号:&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="string">&quot;/usr/lib/debug/boot/vmlinux-<span class="subst">$(uname -r)</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;  调试符号文件存在: /usr/lib/debug/boot/vmlinux-<span class="subst">$(uname -r)</span>&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> [ -f <span class="string">&quot;/boot/vmlinux-<span class="subst">$(uname -r)</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;  内核镜像存在: /boot/vmlinux-<span class="subst">$(uname -r)</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;  警告: 未找到内核调试符号&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查GDB</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;\n2. 检查GDB版本:&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">command</span> -v gdb &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">        gdb --version | <span class="built_in">head</span> -1</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;  错误: GDB未安装&quot;</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查KGDB支持</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;\n3. 检查KGDB支持:&quot;</span></span><br><span class="line">    <span class="keyword">if</span> grep -q <span class="string">&quot;CONFIG_KGDB=y&quot;</span> <span class="string">&quot;/boot/config-<span class="subst">$(uname -r)</span>&quot;</span> 2&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;  KGDB: 已启用&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;  KGDB: 未启用或配置文件不可用&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 创建GDB脚本</span></span><br><span class="line"><span class="function"><span class="title">create_gdb_scripts</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== 创建GDB调试脚本 ===&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建基本的GDB脚本</span></span><br><span class="line">    <span class="built_in">cat</span> &gt; kernel_debug.gdb &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment"># GDB内核调试脚本</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置架构</span></span><br><span class="line"><span class="built_in">set</span> architecture i386:x86-64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接到内核</span></span><br><span class="line"><span class="comment"># target remote /dev/ttyS0  # 串口调试</span></span><br><span class="line"><span class="comment"># target remote localhost:1234  # QEMU调试</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 有用的内核调试命令</span></span><br><span class="line">define ps</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$tasks_off</span> = ((size_t)&amp;((struct task_struct *)<span class="number">0</span>)-&gt;tasks)</span><br><span class="line">    set <span class="variable">$pid_off</span> = ((size_t)&amp;((struct task_struct *)<span class="number">0</span>)-&gt;pid)</span><br><span class="line">    set <span class="variable">$comm_off</span> = ((size_t)&amp;((struct task_struct *)<span class="number">0</span>)-&gt;comm)</span><br><span class="line">    set <span class="variable">$init_t</span> = &amp;init_task</span><br><span class="line">    set <span class="variable">$next_t</span> = (struct task_struct *)((char *)(<span class="variable">$init_t</span>-&gt;tasks.next) - <span class="variable">$tasks_off</span>)</span><br><span class="line">    while (<span class="variable">$next_t</span> != <span class="variable">$init_t</span>)</span><br><span class="line">        printf &quot;PID: %d COMM: %s\n&quot;, *((int *)((char *)<span class="variable">$next_t</span> + <span class="variable">$pid_off</span>)), ((char *)<span class="variable">$next_t</span> + <span class="variable">$comm_off</span>)</span><br><span class="line">        set <span class="variable">$next_t</span> = (struct task_struct *)((char *)(<span class="variable">$next_t</span>-&gt;tasks.next) - <span class="variable">$tasks_off</span>)</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># 显示当前进程</span><br><span class="line">define current_task</span><br><span class="line">    p *((struct task_struct *)<span class="variable">$lx_current</span>())</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示内核栈</span></span><br><span class="line">define kstack</span><br><span class="line">    bt</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示寄存器</span></span><br><span class="line">define kregs</span><br><span class="line">    info registers</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内存映射</span></span><br><span class="line">define vmmap</span><br><span class="line">    info proc mappings</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;GDB脚本已创建: kernel_debug.gdb&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建内核模块调试脚本</span></span><br><span class="line">    <span class="built_in">cat</span> &gt; module_debug.gdb &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment"># 内核模块调试脚本</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载模块符号</span></span><br><span class="line">define load_module_symbols</span><br><span class="line">    <span class="keyword">if</span> <span class="variable">$argc</span> != 1</span><br><span class="line">        <span class="built_in">help</span> load_module_symbols</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        add-symbol-file <span class="variable">$arg0</span></span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">document load_module_symbols</span><br><span class="line">加载内核模块的调试符号</span><br><span class="line">用法: load_module_symbols &lt;module.ko&gt;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示模块信息</span></span><br><span class="line">define module_info</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$mod</span> = modules.next</span><br><span class="line">    <span class="keyword">while</span> (<span class="variable">$mod</span> != &amp;modules)</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$m</span> = (struct module *)<span class="variable">$mod</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&quot;Module: %s, State: %d, Base: 0x%lx\n&quot;</span>, <span class="variable">$m</span>-&gt;name, <span class="variable">$m</span>-&gt;state, <span class="variable">$m</span>-&gt;module_core</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$mod</span> = <span class="variable">$mod</span>-&gt;next</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;模块调试脚本已创建: module_debug.gdb&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. QEMU内核调试</span></span><br><span class="line"><span class="function"><span class="title">qemu_kernel_debug</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== QEMU内核调试设置 ===&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">QEMU内核调试步骤:</span><br><span class="line"></span><br><span class="line">1. 启动QEMU时添加调试选项:</span><br><span class="line">   qemu-system-x86_64 -kernel vmlinuz -initrd initrd.img \</span><br><span class="line">       -append <span class="string">&quot;console=ttyS0 kgdboc=ttyS0,115200 kgdbwait&quot;</span> \</span><br><span class="line">       -serial stdio -s -S</span><br><span class="line"></span><br><span class="line">2. 在另一个终端启动GDB:</span><br><span class="line">   gdb vmlinux</span><br><span class="line">   (gdb) target remote localhost:1234</span><br><span class="line">   (gdb) <span class="built_in">continue</span></span><br><span class="line"></span><br><span class="line">3. 常用调试命令:</span><br><span class="line">   (gdb) <span class="built_in">break</span> start_kernel     <span class="comment"># 在内核启动函数设置断点</span></span><br><span class="line">   (gdb) <span class="built_in">break</span> do_fork          <span class="comment"># 在进程创建函数设置断点</span></span><br><span class="line">   (gdb) info threads           <span class="comment"># 显示所有线程</span></span><br><span class="line">   (gdb) thread 2               <span class="comment"># 切换到线程2</span></span><br><span class="line">   (gdb) bt                     <span class="comment"># 显示调用栈</span></span><br><span class="line">   (gdb) info registers         <span class="comment"># 显示寄存器</span></span><br><span class="line">   (gdb) x/10i <span class="variable">$pc</span>              <span class="comment"># 显示当前指令</span></span><br><span class="line">   (gdb) watch variable         <span class="comment"># 监视变量变化</span></span><br><span class="line">EOF</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 内核模块调试</span></span><br><span class="line"><span class="function"><span class="title">module_debugging</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== 内核模块调试 ===&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">内核模块调试方法:</span><br><span class="line"></span><br><span class="line">1. 编译时启用调试信息:</span><br><span class="line">   EXTRA_CFLAGS += -g -DDEBUG</span><br><span class="line">   </span><br><span class="line">2. 使用printk调试:</span><br><span class="line">   printk(KERN_DEBUG <span class="string">&quot;Debug: %s\n&quot;</span>, __func__);</span><br><span class="line">   </span><br><span class="line">3. 使用动态调试:</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&#x27;module mymodule +p&#x27;</span> &gt; /sys/kernel/debug/dynamic_debug/control</span><br><span class="line">   </span><br><span class="line">4. 使用ftrace:</span><br><span class="line">   <span class="built_in">echo</span> <span class="keyword">function</span> &gt; /sys/kernel/debug/tracing/current_tracer</span><br><span class="line">   <span class="built_in">echo</span> mymodule_function &gt; /sys/kernel/debug/tracing/set_ftrace_filter</span><br><span class="line">   </span><br><span class="line">5. 使用kprobe:</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&#x27;p:myprobe mymodule_function&#x27;</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line">   <span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/kprobes/myprobe/enable</span><br><span class="line">EOF</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 内核崩溃调试</span></span><br><span class="line"><span class="function"><span class="title">crash_debugging</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== 内核崩溃调试 ===&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">内核崩溃调试工具:</span><br><span class="line"></span><br><span class="line">1. 使用crash工具分析vmcore:</span><br><span class="line">   crash /usr/lib/debug/boot/vmlinux-$(<span class="built_in">uname</span> -r) /var/crash/vmcore</span><br><span class="line">   </span><br><span class="line">2. crash常用命令:</span><br><span class="line">   crash&gt; bt              <span class="comment"># 显示调用栈</span></span><br><span class="line">   crash&gt; ps              <span class="comment"># 显示进程列表</span></span><br><span class="line">   crash&gt; <span class="built_in">log</span>             <span class="comment"># 显示内核日志</span></span><br><span class="line">   crash&gt; mod             <span class="comment"># 显示模块信息</span></span><br><span class="line">   crash&gt; files           <span class="comment"># 显示文件信息</span></span><br><span class="line">   crash&gt; net             <span class="comment"># 显示网络信息</span></span><br><span class="line">   crash&gt; vm              <span class="comment"># 显示虚拟内存信息</span></span><br><span class="line">   </span><br><span class="line">3. 分析oops信息:</span><br><span class="line">   - 查找RIP地址对应的函数</span><br><span class="line">   - 分析调用栈</span><br><span class="line">   - 检查寄存器状态</span><br><span class="line">   - 查看内存转储</span><br><span class="line">EOF</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主函数</span></span><br><span class="line"><span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;GDB内核调试指南&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;===============&quot;</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    </span><br><span class="line">    setup_debug_environment</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    create_gdb_scripts</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    qemu_kernel_debug</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    module_debugging</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    crash_debugging</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果直接运行脚本</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;BASH_SOURCE[0]&#125;</span>&quot;</span> = <span class="string">&quot;<span class="variable">$&#123;0&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    main <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h2 id="七、最佳实践与总结"><a href="#七、最佳实践与总结" class="headerlink" title="七、最佳实践与总结"></a>七、最佳实践与总结</h2><h3 id="7-1-内核编程最佳实践"><a href="#7-1-内核编程最佳实践" class="headerlink" title="7.1 内核编程最佳实践"></a>7.1 内核编程最佳实践</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// best_practices.c - 内核编程最佳实践示例</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/mutex.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/completion.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/workqueue.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块信息 - 必须包含</span></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);                    <span class="comment">// 许可证</span></span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Your Name &lt;email@domain.com&gt;&quot;</span>);  <span class="comment">// 作者</span></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Best practices example&quot;</span>);   <span class="comment">// 描述</span></span><br><span class="line">MODULE_VERSION(<span class="string">&quot;1.0.0&quot;</span>);                 <span class="comment">// 版本</span></span><br><span class="line">MODULE_ALIAS(<span class="string">&quot;best_practices&quot;</span>);          <span class="comment">// 别名</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 最佳实践1: 使用适当的错误码</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BP_SUCCESS          0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BP_ERROR_NOMEM      -ENOMEM</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BP_ERROR_INVALID    -EINVAL</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BP_ERROR_BUSY       -EBUSY</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 最佳实践2: 定义清晰的数据结构</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">best_practices_device</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">lock</span>;</span>              <span class="comment">// 互斥锁保护</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">completion</span> <span class="title">ready</span>;</span>        <span class="comment">// 完成量</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">workqueue_struct</span> *<span class="title">wq</span>;</span>    <span class="comment">// 工作队列</span></span><br><span class="line">    <span class="type">void</span> *buffer;                   <span class="comment">// 数据缓冲区</span></span><br><span class="line">    <span class="type">size_t</span> buffer_size;             <span class="comment">// 缓冲区大小</span></span><br><span class="line">    <span class="type">atomic_t</span> ref_count;             <span class="comment">// 引用计数</span></span><br><span class="line">    <span class="type">bool</span> initialized;               <span class="comment">// 初始化标志</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">best_practices_device</span> *<span class="title">bp_device</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 最佳实践3: 使用内联函数提高性能</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">bool</span> <span class="title function_">bp_device_is_ready</span><span class="params">(<span class="keyword">struct</span> best_practices_device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> dev &amp;&amp; dev-&gt;initialized;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">bp_device_get</span><span class="params">(<span class="keyword">struct</span> best_practices_device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (dev)</span><br><span class="line">        <span class="type">atomic_inc</span>(&amp;dev-&gt;ref_count);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">bp_device_put</span><span class="params">(<span class="keyword">struct</span> best_practices_device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (dev &amp;&amp; atomic_dec_and_test(&amp;dev-&gt;ref_count)) &#123;</span><br><span class="line">        <span class="comment">// 引用计数为0时的清理工作</span></span><br><span class="line">        complete(&amp;dev-&gt;ready);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 最佳实践4: 错误处理和资源清理</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * bp_allocate_buffer - 分配缓冲区</span></span><br><span class="line"><span class="comment"> * @dev: 设备结构指针</span></span><br><span class="line"><span class="comment"> * @size: 缓冲区大小</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 0表示成功，负值表示错误码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">bp_allocate_buffer</span><span class="params">(<span class="keyword">struct</span> best_practices_device *dev, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> *buffer;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 参数验证</span></span><br><span class="line">    <span class="keyword">if</span> (!dev || size == <span class="number">0</span> || size &gt; PAGE_SIZE * <span class="number">16</span>) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;bp: Invalid parameters for buffer allocation\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> BP_ERROR_INVALID;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查设备状态</span></span><br><span class="line">    <span class="keyword">if</span> (!bp_device_is_ready(dev)) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;bp: Device not ready\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> BP_ERROR_BUSY;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取锁</span></span><br><span class="line">    <span class="keyword">if</span> (mutex_lock_interruptible(&amp;dev-&gt;lock)) &#123;</span><br><span class="line">        pr_debug(<span class="string">&quot;bp: Buffer allocation interrupted\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ERESTARTSYS;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查是否已分配</span></span><br><span class="line">    <span class="keyword">if</span> (dev-&gt;buffer) &#123;</span><br><span class="line">        pr_warn(<span class="string">&quot;bp: Buffer already allocated\n&quot;</span>);</span><br><span class="line">        mutex_unlock(&amp;dev-&gt;lock);</span><br><span class="line">        <span class="keyword">return</span> BP_ERROR_BUSY;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 分配内存</span></span><br><span class="line">    buffer = kzalloc(size, GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!buffer) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;bp: Failed to allocate buffer of size %zu\n&quot;</span>, size);</span><br><span class="line">        mutex_unlock(&amp;dev-&gt;lock);</span><br><span class="line">        <span class="keyword">return</span> BP_ERROR_NOMEM;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置设备状态</span></span><br><span class="line">    dev-&gt;buffer = buffer;</span><br><span class="line">    dev-&gt;buffer_size = size;</span><br><span class="line">    </span><br><span class="line">    mutex_unlock(&amp;dev-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    pr_info(<span class="string">&quot;bp: Buffer allocated successfully, size: %zu\n&quot;</span>, size);</span><br><span class="line">    <span class="keyword">return</span> BP_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * bp_free_buffer - 释放缓冲区</span></span><br><span class="line"><span class="comment"> * @dev: 设备结构指针</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">bp_free_buffer</span><span class="params">(<span class="keyword">struct</span> best_practices_device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!dev)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    mutex_lock(&amp;dev-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (dev-&gt;buffer) &#123;</span><br><span class="line">        kfree(dev-&gt;buffer);</span><br><span class="line">        dev-&gt;buffer = <span class="literal">NULL</span>;</span><br><span class="line">        dev-&gt;buffer_size = <span class="number">0</span>;</span><br><span class="line">        pr_info(<span class="string">&quot;bp: Buffer freed\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    mutex_unlock(&amp;dev-&gt;lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 最佳实践5: 工作队列处理</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">bp_work_handler</span><span class="params">(<span class="keyword">struct</span> work_struct *work)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">best_practices_device</span> *<span class="title">dev</span> =</span> bp_device;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!bp_device_is_ready(dev)) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;bp: Device not ready in work handler\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    bp_device_get(dev);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行实际工作</span></span><br><span class="line">    pr_info(<span class="string">&quot;bp: Work handler executing\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 模拟一些工作</span></span><br><span class="line">    msleep(<span class="number">100</span>);</span><br><span class="line">    </span><br><span class="line">    bp_device_put(dev);</span><br><span class="line">    pr_info(<span class="string">&quot;bp: Work handler completed\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="title function_">DECLARE_WORK</span><span class="params">(bp_work, bp_work_handler)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 最佳实践6: 设备初始化和清理</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * bp_device_create - 创建设备</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 设备指针或错误指针</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> best_practices_device *<span class="title function_">bp_device_create</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">best_practices_device</span> *<span class="title">dev</span>;</span></span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 分配设备结构</span></span><br><span class="line">    dev = kzalloc(<span class="keyword">sizeof</span>(*dev), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!dev) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;bp: Failed to allocate device structure\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ERR_PTR(BP_ERROR_NOMEM);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化同步原语</span></span><br><span class="line">    mutex_init(&amp;dev-&gt;lock);</span><br><span class="line">    init_completion(&amp;dev-&gt;ready);</span><br><span class="line">    <span class="type">atomic_set</span>(&amp;dev-&gt;ref_count, <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建工作队列</span></span><br><span class="line">    dev-&gt;wq = create_singlethread_workqueue(<span class="string">&quot;bp_workqueue&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!dev-&gt;wq) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;bp: Failed to create workqueue\n&quot;</span>);</span><br><span class="line">        ret = BP_ERROR_NOMEM;</span><br><span class="line">        <span class="keyword">goto</span> err_free_dev;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 分配默认缓冲区</span></span><br><span class="line">    ret = bp_allocate_buffer(dev, PAGE_SIZE);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;bp: Failed to allocate default buffer\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_destroy_wq;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    dev-&gt;initialized = <span class="literal">true</span>;</span><br><span class="line">    complete(&amp;dev-&gt;ready);</span><br><span class="line">    </span><br><span class="line">    pr_info(<span class="string">&quot;bp: Device created successfully\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> dev;</span><br><span class="line">    </span><br><span class="line">err_destroy_wq:</span><br><span class="line">    destroy_workqueue(dev-&gt;wq);</span><br><span class="line">err_free_dev:</span><br><span class="line">    kfree(dev);</span><br><span class="line">    <span class="keyword">return</span> ERR_PTR(ret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * bp_device_destroy - 销毁设备</span></span><br><span class="line"><span class="comment"> * @dev: 设备结构指针</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">bp_device_destroy</span><span class="params">(<span class="keyword">struct</span> best_practices_device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!dev)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    pr_info(<span class="string">&quot;bp: Destroying device\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 标记设备为未初始化</span></span><br><span class="line">    dev-&gt;initialized = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 取消所有工作</span></span><br><span class="line">    <span class="keyword">if</span> (dev-&gt;wq) &#123;</span><br><span class="line">        cancel_work_sync(&amp;bp_work);</span><br><span class="line">        destroy_workqueue(dev-&gt;wq);</span><br><span class="line">        pr_info(<span class="string">&quot;bp: Workqueue destroyed\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放缓冲区</span></span><br><span class="line">    bp_free_buffer(dev);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 等待所有引用释放</span></span><br><span class="line">    bp_device_put(dev);</span><br><span class="line">    wait_for_completion(&amp;dev-&gt;ready);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放设备结构</span></span><br><span class="line">    kfree(dev);</span><br><span class="line">    pr_info(<span class="string">&quot;bp: Device destroyed\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 最佳实践7: 模块参数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> buffer_size = PAGE_SIZE;</span><br><span class="line">module_param(buffer_size, <span class="type">int</span>, <span class="number">0644</span>);</span><br><span class="line">MODULE_PARM_DESC(buffer_size, <span class="string">&quot;Default buffer size (default: PAGE_SIZE)&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> enable_work = <span class="literal">true</span>;</span><br><span class="line">module_param(enable_work, <span class="type">bool</span>, <span class="number">0644</span>);</span><br><span class="line">MODULE_PARM_DESC(enable_work, <span class="string">&quot;Enable work queue processing (default: true)&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * best_practices_init - 模块初始化函数</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值: 0表示成功，负值表示失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">best_practices_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    </span><br><span class="line">    pr_info(<span class="string">&quot;bp: Loading best practices module\n&quot;</span>);</span><br><span class="line">    pr_info(<span class="string">&quot;bp: Buffer size: %d, Enable work: %s\n&quot;</span>, </span><br><span class="line">            buffer_size, enable_work ? <span class="string">&quot;yes&quot;</span> : <span class="string">&quot;no&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 验证模块参数</span></span><br><span class="line">    <span class="keyword">if</span> (buffer_size &lt;= <span class="number">0</span> || buffer_size &gt; PAGE_SIZE * <span class="number">16</span>) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;bp: Invalid buffer size: %d\n&quot;</span>, buffer_size);</span><br><span class="line">        <span class="keyword">return</span> BP_ERROR_INVALID;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建设备</span></span><br><span class="line">    bp_device = bp_device_create();</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(bp_device)) &#123;</span><br><span class="line">        ret = PTR_ERR(bp_device);</span><br><span class="line">        pr_err(<span class="string">&quot;bp: Failed to create device: %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 调度工作（如果启用）</span></span><br><span class="line">    <span class="keyword">if</span> (enable_work) &#123;</span><br><span class="line">        queue_work(bp_device-&gt;wq, &amp;bp_work);</span><br><span class="line">        pr_info(<span class="string">&quot;bp: Work scheduled\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pr_info(<span class="string">&quot;bp: Module loaded successfully\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> BP_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * best_practices_exit - 模块清理函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">best_practices_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    pr_info(<span class="string">&quot;bp: Unloading best practices module\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 销毁设备</span></span><br><span class="line">    bp_device_destroy(bp_device);</span><br><span class="line">    bp_device = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    pr_info(<span class="string">&quot;bp: Module unloaded successfully\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 最佳实践8: 使用适当的初始化和清理宏</span></span><br><span class="line">module_init(best_practices_init);</span><br><span class="line">module_exit(best_practices_exit);</span><br></pre></td></tr></table></figure>

<h3 id="7-2-开发总结与建议"><a href="#7-2-开发总结与建议" class="headerlink" title="7.2 开发总结与建议"></a>7.2 开发总结与建议</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Linux内核编程开发总结</span></span><br><span class="line"></span><br><span class="line"><span class="section">## 核心要点</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 1. 安全编程原则</span></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**永远检查返回值**</span>: 所有函数调用都要检查返回值</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**正确的错误处理**</span>: 使用标准错误码，确保资源正确释放</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**边界检查**</span>: 防止缓冲区溢出和数组越界</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**空指针检查**</span>: 在解引用前检查指针有效性</span><br><span class="line"></span><br><span class="line"><span class="section">### 2. 内存管理</span></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**配对使用**</span>: kmalloc/kfree, vmalloc/vfree, get<span class="emphasis">_page/put_</span>page</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**避免内存泄漏**</span>: 确保所有分配的内存都被释放</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**使用合适的分配函数**</span>: 根据需求选择kmalloc、vmalloc或页面分配</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**DMA内存**</span>: 使用dma<span class="emphasis">_alloc_</span>coherent进行DMA内存分配</span><br><span class="line"></span><br><span class="line"><span class="section">### 3. 同步机制</span></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**选择合适的锁**</span>: 根据临界区大小选择自旋锁或互斥锁</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**避免死锁**</span>: 按固定顺序获取多个锁</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**最小化锁持有时间**</span>: 减少锁竞争</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**使用原子操作**</span>: 简单操作优先使用原子操作</span><br><span class="line"></span><br><span class="line"><span class="section">### 4. 中断处理</span></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**快速处理**</span>: 中断处理程序要尽可能快</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**使用工作队列**</span>: 耗时操作放到工作队列中</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**正确的中断标志**</span>: 使用IRQF<span class="emphasis">_SHARED等适当标志</span></span><br><span class="line"><span class="emphasis">- <span class="strong">**中断安全**</span>: 在中断上下文中不能睡眠</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">### 5. 调试技巧</span></span><br><span class="line"><span class="emphasis">- <span class="strong">**使用printk**</span>: 合理使用不同级别的printk</span></span><br><span class="line"><span class="emphasis">- <span class="strong">**动态调试**</span>: 利用dynamic debug功能</span></span><br><span class="line"><span class="emphasis">- <span class="strong">**内核调试器**</span>: 掌握GDB和crash工具</span></span><br><span class="line"><span class="emphasis">- <span class="strong">**静态分析**</span>: 使用sparse等静态分析工具</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">## 常见陷阱</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">### 1. 上下文错误</span></span><br><span class="line"><span class="emphasis">- 在原子上下文中调用可能睡眠的函数</span></span><br><span class="line"><span class="emphasis">- 在中断处理程序中使用GFP_</span>KERNEL</span><br><span class="line"><span class="bullet">-</span> 在持有自旋锁时调用schedule()</span><br><span class="line"></span><br><span class="line"><span class="section">### 2. 竞态条件</span></span><br><span class="line"><span class="bullet">-</span> 未正确保护共享数据</span><br><span class="line"><span class="bullet">-</span> 检查后使用(TOCTOU)问题</span><br><span class="line"><span class="bullet">-</span> 不正确的引用计数</span><br><span class="line"></span><br><span class="line"><span class="section">### 3. 资源泄漏</span></span><br><span class="line"><span class="bullet">-</span> 忘记释放分配的内存</span><br><span class="line"><span class="bullet">-</span> 未正确清理定时器和工作队列</span><br><span class="line"><span class="bullet">-</span> 中断未正确释放</span><br><span class="line"></span><br><span class="line"><span class="section">## 性能优化</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 1. 内存优化</span></span><br><span class="line"><span class="bullet">-</span> 使用slab分配器进行频繁的小对象分配</span><br><span class="line"><span class="bullet">-</span> 避免内存碎片</span><br><span class="line"><span class="bullet">-</span> 合理使用缓存对齐</span><br><span class="line"></span><br><span class="line"><span class="section">### 2. CPU优化</span></span><br><span class="line"><span class="bullet">-</span> 减少上下文切换</span><br><span class="line"><span class="bullet">-</span> 使用per-CPU变量</span><br><span class="line"><span class="bullet">-</span> 避免不必要的内存屏障</span><br><span class="line"></span><br><span class="line"><span class="section">### 3. I/O优化</span></span><br><span class="line"><span class="bullet">-</span> 使用异步I/O</span><br><span class="line"><span class="bullet">-</span> 批量处理请求</span><br><span class="line"><span class="bullet">-</span> 合理使用缓存</span><br><span class="line"></span><br><span class="line"><span class="section">## 代码质量</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 1. 编码规范</span></span><br><span class="line"><span class="bullet">-</span> 遵循Linux内核编码风格</span><br><span class="line"><span class="bullet">-</span> 使用有意义的变量和函数名</span><br><span class="line"><span class="bullet">-</span> 添加适当的注释</span><br><span class="line"></span><br><span class="line"><span class="section">### 2. 模块化设计</span></span><br><span class="line"><span class="bullet">-</span> 功能单一原则</span><br><span class="line"><span class="bullet">-</span> 清晰的接口定义</span><br><span class="line"><span class="bullet">-</span> 合理的抽象层次</span><br><span class="line"></span><br><span class="line"><span class="section">### 3. 测试</span></span><br><span class="line"><span class="bullet">-</span> 单元测试</span><br><span class="line"><span class="bullet">-</span> 压力测试</span><br><span class="line"><span class="bullet">-</span> 边界条件测试</span><br><span class="line"></span><br><span class="line"><span class="section">## 学习建议</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 1. 理论基础</span></span><br><span class="line"><span class="bullet">-</span> 深入理解操作系统原理</span><br><span class="line"><span class="bullet">-</span> 掌握计算机体系结构</span><br><span class="line"><span class="bullet">-</span> 学习并发编程理论</span><br><span class="line"></span><br><span class="line"><span class="section">### 2. 实践经验</span></span><br><span class="line"><span class="bullet">-</span> 阅读内核源码</span><br><span class="line"><span class="bullet">-</span> 参与开源项目</span><br><span class="line"><span class="bullet">-</span> 编写实际的驱动程序</span><br><span class="line"></span><br><span class="line"><span class="section">### 3. 持续学习</span></span><br><span class="line"><span class="bullet">-</span> 关注内核发展动态</span><br><span class="line"><span class="bullet">-</span> 学习新的内核特性</span><br><span class="line"><span class="bullet">-</span> 参加技术会议和讨论</span><br><span class="line"></span><br><span class="line"><span class="section">## 总结</span></span><br><span class="line"></span><br><span class="line">Linux内核编程是一个复杂而富有挑战性的领域，需要扎实的理论基础和丰富的实践经验。通过本指南的学习，你应该已经掌握了内核编程的基本概念、核心技术和最佳实践。</span><br><span class="line"></span><br><span class="line">记住，内核编程的关键在于：</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**安全第一**</span>: 确保代码的稳定性和安全性</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**性能优化**</span>: 追求高效的代码实现</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**代码质量**</span>: 编写可维护和可扩展的代码</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**持续学习**</span>: 跟上内核技术的发展步伐</span><br><span class="line"></span><br><span class="line">希望这个指南能够帮助你在Linux内核编程的道路上取得成功！</span><br></pre></td></tr></table></figure>

<hr>
<p>通过本文的学习，我们全面掌握了Linux内核编程与驱动开发的核心技能，从基础的内核模块开发到高级的同步机制，从设备驱动框架到调试技巧，为深入理解Linux内核奠定了坚实的基础。内核编程需要严谨的态度和持续的实践，希望这个完整的学习路径能够帮助你成为优秀的内核开发者。</p>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/Linux%E5%86%85%E6%A0%B8/">Linux内核</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/">驱动开发</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%B3%BB%E7%BB%9F/">嵌入式系统</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B/">内核编程</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/">设备驱动</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2024/laravel/laravel-performance-optimization-comprehensive-guide/"
                                   title="Laravel 性能优化全攻略：从源码剖析到实战实践"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">Laravel 性能优化全攻略：从源码剖析到实战实践</span>
                                        <span class="post-nav-item">上一篇</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2024/thinkphp/thinkphp8-api-security-guide/"
                                   title="ThinkPHP8 API开发与安全防护实战指南：JWT认证、XSS/CSRF防护全攻略"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">ThinkPHP8 API开发与安全防护实战指南：JWT认证、XSS/CSRF防护全攻略</span>
                                        <span class="post-nav-item">下一篇</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    






                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Linux%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B%E4%B8%8E%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97%EF%BC%9A%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A%E7%9A%84%E5%AE%8C%E6%95%B4%E5%AD%A6%E4%B9%A0%E8%B7%AF%E5%BE%84"><span class="nav-text">Linux内核编程与驱动开发实战指南：从入门到精通的完整学习路径</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81Linux%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80"><span class="nav-text">一、Linux内核编程基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%86%85%E6%A0%B8%E6%9E%B6%E6%9E%84%E6%A6%82%E8%BF%B0"><span class="nav-text">1.1 内核架构概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80"><span class="nav-text">1.2 内核模块开发基础</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91%E5%92%8C%E7%AE%A1%E7%90%86"><span class="nav-text">1.3 内核模块编译和管理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91"><span class="nav-text">二、字符设备驱动开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6"><span class="nav-text">2.1 字符设备驱动框架</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E8%AE%BE%E5%A4%87%E6%B5%8B%E8%AF%95%E7%A8%8B%E5%BA%8F"><span class="nav-text">2.2 设备测试程序</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E5%B9%B3%E5%8F%B0%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6"><span class="nav-text">三、平台驱动框架</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-Platform%E8%AE%BE%E5%A4%87%E5%92%8C%E9%A9%B1%E5%8A%A8"><span class="nav-text">3.1 Platform设备和驱动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E8%AE%BE%E5%A4%87%E6%A0%91%E9%85%8D%E7%BD%AE"><span class="nav-text">3.2 设备树配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E8%AE%BE%E5%A4%87%E6%A0%91%E8%A7%A3%E6%9E%90%E5%B7%A5%E5%85%B7"><span class="nav-text">3.3 设备树解析工具</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E4%B8%AD%E6%96%AD%E5%A4%84%E7%90%86%E4%B8%8E%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="nav-text">四、中断处理与定时器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E4%B8%AD%E6%96%AD%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6"><span class="nav-text">4.1 中断处理机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E5%86%85%E6%A0%B8%E5%AE%9A%E6%97%B6%E5%99%A8%E5%92%8C%E5%BB%B6%E8%BF%9F%E5%B7%A5%E4%BD%9C"><span class="nav-text">4.2 内核定时器和延迟工作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E4%B8%8E%E5%90%8C%E6%AD%A5%E6%9C%BA%E5%88%B6"><span class="nav-text">五、内存管理与同步机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E5%86%85%E6%A0%B8%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D"><span class="nav-text">5.1 内核内存分配</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E5%90%8C%E6%AD%A5%E6%9C%BA%E5%88%B6%E5%AE%9E%E7%8E%B0"><span class="nav-text">5.2 同步机制实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7%E4%B8%8E%E5%B7%A5%E5%85%B7"><span class="nav-text">六、内核调试技巧与工具</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95"><span class="nav-text">6.1 内核调试方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-GDB%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95"><span class="nav-text">6.2 GDB内核调试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%83%E3%80%81%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E6%80%BB%E7%BB%93"><span class="nav-text">七、最佳实践与总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-text">7.1 内核编程最佳实践</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93%E4%B8%8E%E5%BB%BA%E8%AE%AE"><span class="nav-text">7.2 开发总结与建议</span></a></li></ol></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
    &copy;&nbsp;2025
    
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">Orion K</a>
        
    </div>


    
        
        <div class="deploy-info info-item">
            
            本站由 <span class="tooltip" data-tooltip-content="GitHub Pages"><img src="/images/brands/github.png"></span> 提供部署服务
            
        </div>
    

    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Linux%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B%E4%B8%8E%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97%EF%BC%9A%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A%E7%9A%84%E5%AE%8C%E6%95%B4%E5%AD%A6%E4%B9%A0%E8%B7%AF%E5%BE%84"><span class="nav-text">Linux内核编程与驱动开发实战指南：从入门到精通的完整学习路径</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81Linux%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80"><span class="nav-text">一、Linux内核编程基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%86%85%E6%A0%B8%E6%9E%B6%E6%9E%84%E6%A6%82%E8%BF%B0"><span class="nav-text">1.1 内核架构概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80"><span class="nav-text">1.2 内核模块开发基础</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91%E5%92%8C%E7%AE%A1%E7%90%86"><span class="nav-text">1.3 内核模块编译和管理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91"><span class="nav-text">二、字符设备驱动开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6"><span class="nav-text">2.1 字符设备驱动框架</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E8%AE%BE%E5%A4%87%E6%B5%8B%E8%AF%95%E7%A8%8B%E5%BA%8F"><span class="nav-text">2.2 设备测试程序</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E5%B9%B3%E5%8F%B0%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6"><span class="nav-text">三、平台驱动框架</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-Platform%E8%AE%BE%E5%A4%87%E5%92%8C%E9%A9%B1%E5%8A%A8"><span class="nav-text">3.1 Platform设备和驱动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E8%AE%BE%E5%A4%87%E6%A0%91%E9%85%8D%E7%BD%AE"><span class="nav-text">3.2 设备树配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E8%AE%BE%E5%A4%87%E6%A0%91%E8%A7%A3%E6%9E%90%E5%B7%A5%E5%85%B7"><span class="nav-text">3.3 设备树解析工具</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E4%B8%AD%E6%96%AD%E5%A4%84%E7%90%86%E4%B8%8E%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="nav-text">四、中断处理与定时器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E4%B8%AD%E6%96%AD%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6"><span class="nav-text">4.1 中断处理机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E5%86%85%E6%A0%B8%E5%AE%9A%E6%97%B6%E5%99%A8%E5%92%8C%E5%BB%B6%E8%BF%9F%E5%B7%A5%E4%BD%9C"><span class="nav-text">4.2 内核定时器和延迟工作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E4%B8%8E%E5%90%8C%E6%AD%A5%E6%9C%BA%E5%88%B6"><span class="nav-text">五、内存管理与同步机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E5%86%85%E6%A0%B8%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D"><span class="nav-text">5.1 内核内存分配</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E5%90%8C%E6%AD%A5%E6%9C%BA%E5%88%B6%E5%AE%9E%E7%8E%B0"><span class="nav-text">5.2 同步机制实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7%E4%B8%8E%E5%B7%A5%E5%85%B7"><span class="nav-text">六、内核调试技巧与工具</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95"><span class="nav-text">6.1 内核调试方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-GDB%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95"><span class="nav-text">6.2 GDB内核调试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%83%E3%80%81%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E6%80%BB%E7%BB%93"><span class="nav-text">七、最佳实践与总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-text">7.1 内核编程最佳实践</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93%E4%B8%8E%E5%BB%BA%E8%AE%AE"><span class="nav-text">7.2 开发总结与建议</span></a></li></ol></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->

<script src="/js/utils.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/toggle-theme.js"></script>

<script src="/js/code-block.js"></script>

<script src="/js/main.js"></script>

<script src="/js/libs/anime.min.js"></script>


<!-- local search -->

    
<script src="/js/local-search.js"></script>



<!-- lazyload -->


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        
<script src="/js/post/post-helper.js"></script>


        <!-- toc -->
        
            
<script src="/js/post/toc.js"></script>

        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
