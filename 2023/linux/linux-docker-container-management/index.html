<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Orion K">
    
    <title>
        
            Linux容器化技术与Docker实战指南：从入门到生产环境的完整解决方案 |
        
        Orion K Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/logo.svg">
    
    
<link rel="stylesheet" href="/font/css/fontawesome.min.css">

    
<link rel="stylesheet" href="/font/css/regular.min.css">

    
<link rel="stylesheet" href="/font/css/solid.min.css">

    
<link rel="stylesheet" href="/font/css/brands.min.css">

    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"Orion K Blog","author":"Orion K","avatar":"/images/avatar.svg","logo":"/images/logo.svg","favicon":"/images/logo.svg"},"menu":{"home":"/                        || fa-solid fa-home","archives":"/archives            || fa-solid fa-box-archive","categories":"/categories        || fa-solid fa-layer-group"},"first_screen":{"enable":false,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":false,"hide_header":true},"home":{"announcement":"欢迎来到 Orion K 的博客，这是一个分享互联网技术的博客。联系：wxmm686800@gmail.com","category":true,"tag":true,"post_datetime":"created"},"post":{"author_badge":{"enable":true,"level_badge":true,"custom_badge":["One","Two","Three"]},"word_count":{"wordcount":false,"min2read":false},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false,"reward":{"enable":false,"img_link":null,"text":null,"icon":null}},"code_block":{"tools":{"enable":false,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":false,"site_uv":false,"site_pv":false,"page_pv":false}},"local_search":{"enable":true,"preload":true},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.39"},"waline":{"server_url":null,"reaction":false,"version":"3.3.2"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":false},"lazyload":{"enable":false},"cdn":{"enable":false,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2025,"word_count":false,"site_deploy":{"enable":true,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.5"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/logo.svg">
                </a>
            
            <a class="site-name border-box" href="/">
               Orion K Blog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-home"></i>
                                
                                首页
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                
                                归档
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-layer-group"></i>
                                
                                分类
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-home"></i>
                                </span>
                            
                            首页
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                </span>
                            
                            归档
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-layer-group"></i>
                                </span>
                            
                            分类
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        Linux容器化技术与Docker实战指南：从入门到生产环境的完整解决方案
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/avatar.svg">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">Orion K</span>
                                
                                    <span class="author-badge">Lv6</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2023-10-12 17:22:48</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/linux/">linux</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/Docker/">Docker</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E5%AE%B9%E5%99%A8%E5%8C%96/">容器化</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/">备份恢复</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/">数据管理</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/">虚拟化</a></li>
                        
                    
                </ul>
            </span>
        

        
        
        
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <h1 id="Linux容器化技术与Docker实战指南：从入门到生产环境的完整解决方案"><a href="#Linux容器化技术与Docker实战指南：从入门到生产环境的完整解决方案" class="headerlink" title="Linux容器化技术与Docker实战指南：从入门到生产环境的完整解决方案"></a>Linux容器化技术与Docker实战指南：从入门到生产环境的完整解决方案</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>随着云计算和微服务架构的快速发展，容器化技术已成为现代应用程序部署和管理的核心技术。Docker作为容器化技术的代表，以其轻量级、可移植性和一致性等优势，彻底改变了软件开发和运维的方式。本文将从Docker基础概念开始，深入探讨容器管理、数据备份恢复、网络配置、安全加固等实战技能，为您提供一套完整的Linux容器化解决方案。</p>
<h2 id="一、Docker基础概念与架构"><a href="#一、Docker基础概念与架构" class="headerlink" title="一、Docker基础概念与架构"></a>一、Docker基础概念与架构</h2><h3 id="1-1-Docker核心概念"><a href="#1-1-Docker核心概念" class="headerlink" title="1.1 Docker核心概念"></a>1.1 Docker核心概念</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Docker基础概念演示脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Docker基础概念演示 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 镜像(Image)概念</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;1. 镜像(Image) - 只读模板，用于创建容器&quot;</span></span><br><span class="line">docker images</span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器(Container)概念</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n2. 容器(Container) - 镜像的运行实例&quot;</span></span><br><span class="line">docker ps -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># 仓库(Repository)概念</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n3. 仓库(Repository) - 存储镜像的地方&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Docker Hub: https://hub.docker.com&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;私有仓库: Harbor, Nexus等&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Dockerfile概念</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n4. Dockerfile - 构建镜像的脚本&quot;</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment"># Dockerfile示例</span></span><br><span class="line">FROM ubuntu:20.04</span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y nginx</span><br><span class="line">COPY index.html /var/www/html/</span><br><span class="line">EXPOSE 80</span><br><span class="line">CMD [<span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;daemon off;&quot;</span>]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="1-2-Docker架构组件"><a href="#1-2-Docker架构组件" class="headerlink" title="1.2 Docker架构组件"></a>1.2 Docker架构组件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Docker架构组件检查脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Docker架构组件检查 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Docker守护进程状态</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;1. Docker守护进程状态:&quot;</span></span><br><span class="line">systemctl status docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># Docker版本信息</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n2. Docker版本信息:&quot;</span></span><br><span class="line">docker version</span><br><span class="line"></span><br><span class="line"><span class="comment"># Docker系统信息</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n3. Docker系统信息:&quot;</span></span><br><span class="line">docker system info</span><br><span class="line"></span><br><span class="line"><span class="comment"># Docker存储驱动</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n4. Docker存储驱动:&quot;</span></span><br><span class="line">docker info | grep <span class="string">&quot;Storage Driver&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Docker网络驱动</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n5. Docker网络列表:&quot;</span></span><br><span class="line">docker network <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Docker数据目录</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n6. Docker数据目录:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;默认数据目录: /var/lib/docker&quot;</span></span><br><span class="line"><span class="built_in">du</span> -sh /var/lib/docker 2&gt;/dev/null || <span class="built_in">echo</span> <span class="string">&quot;需要root权限查看&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="二、Docker安装与配置"><a href="#二、Docker安装与配置" class="headerlink" title="二、Docker安装与配置"></a>二、Docker安装与配置</h2><h3 id="2-1-Docker安装脚本"><a href="#2-1-Docker安装脚本" class="headerlink" title="2.1 Docker安装脚本"></a>2.1 Docker安装脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Docker自动安装脚本</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检测操作系统</span></span><br><span class="line"><span class="function"><span class="title">detect_os</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [ -f /etc/os-release ]; <span class="keyword">then</span></span><br><span class="line">        . /etc/os-release</span><br><span class="line">        OS=<span class="variable">$NAME</span></span><br><span class="line">        VER=<span class="variable">$VERSION_ID</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;无法检测操作系统&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;检测到操作系统: <span class="variable">$OS</span> <span class="variable">$VER</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装Docker - CentOS/RHEL</span></span><br><span class="line"><span class="function"><span class="title">install_docker_centos</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;在CentOS/RHEL上安装Docker...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 卸载旧版本</span></span><br><span class="line">    <span class="built_in">sudo</span> yum remove -y docker docker-client docker-client-latest \</span><br><span class="line">        docker-common docker-latest docker-latest-logrotate \</span><br><span class="line">        docker-logrotate docker-engine</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 安装依赖</span></span><br><span class="line">    <span class="built_in">sudo</span> yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 添加Docker仓库</span></span><br><span class="line">    <span class="built_in">sudo</span> yum-config-manager --add-repo \</span><br><span class="line">        https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 安装Docker CE</span></span><br><span class="line">    <span class="built_in">sudo</span> yum install -y docker-ce docker-ce-cli containerd.io</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 启动Docker服务</span></span><br><span class="line">    <span class="built_in">sudo</span> systemctl start docker</span><br><span class="line">    <span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> docker</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Docker安装完成&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装Docker - Ubuntu/Debian</span></span><br><span class="line"><span class="function"><span class="title">install_docker_ubuntu</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;在Ubuntu/Debian上安装Docker...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 卸载旧版本</span></span><br><span class="line">    <span class="built_in">sudo</span> apt-get remove -y docker docker-engine docker.io containerd runc</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 更新包索引</span></span><br><span class="line">    <span class="built_in">sudo</span> apt-get update</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 安装依赖</span></span><br><span class="line">    <span class="built_in">sudo</span> apt-get install -y apt-transport-https ca-certificates \</span><br><span class="line">        curl gnupg lsb-release</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 添加Docker GPG密钥</span></span><br><span class="line">    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | \</span><br><span class="line">        <span class="built_in">sudo</span> gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 添加Docker仓库</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] \</span></span><br><span class="line"><span class="string">        https://download.docker.com/linux/ubuntu <span class="subst">$(lsb_release -cs)</span> stable&quot;</span> | \</span><br><span class="line">        <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 安装Docker CE</span></span><br><span class="line">    <span class="built_in">sudo</span> apt-get update</span><br><span class="line">    <span class="built_in">sudo</span> apt-get install -y docker-ce docker-ce-cli containerd.io</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 启动Docker服务</span></span><br><span class="line">    <span class="built_in">sudo</span> systemctl start docker</span><br><span class="line">    <span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> docker</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Docker安装完成&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置Docker</span></span><br><span class="line"><span class="function"><span class="title">configure_docker</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;配置Docker...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 添加当前用户到docker组</span></span><br><span class="line">    <span class="built_in">sudo</span> usermod -aG docker <span class="variable">$USER</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 配置Docker守护进程</span></span><br><span class="line">    <span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://hub-mirror.c.163.com&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;log-driver&quot;</span>: <span class="string">&quot;json-file&quot;</span>,</span><br><span class="line">  <span class="string">&quot;log-opts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;max-size&quot;</span>: <span class="string">&quot;100m&quot;</span>,</span><br><span class="line">    <span class="string">&quot;max-file&quot;</span>: <span class="string">&quot;3&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;storage-driver&quot;</span>: <span class="string">&quot;overlay2&quot;</span>,</span><br><span class="line">  <span class="string">&quot;storage-opts&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;overlay2.override_kernel_check=true&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 重启Docker服务</span></span><br><span class="line">    <span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line">    <span class="built_in">sudo</span> systemctl restart docker</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Docker配置完成&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;请重新登录以使用户组变更生效&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证安装</span></span><br><span class="line"><span class="function"><span class="title">verify_installation</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;验证Docker安装...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查Docker版本</span></span><br><span class="line">    docker --version</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 运行测试容器</span></span><br><span class="line">    docker run --<span class="built_in">rm</span> hello-world</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Docker安装验证完成&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主安装流程</span></span><br><span class="line"><span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    detect_os</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$OS</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">        *<span class="string">&quot;CentOS&quot;</span>*|*<span class="string">&quot;Red Hat&quot;</span>*|*<span class="string">&quot;Rocky&quot;</span>*|*<span class="string">&quot;AlmaLinux&quot;</span>*)</span><br><span class="line">            install_docker_centos</span><br><span class="line">            ;;</span><br><span class="line">        *<span class="string">&quot;Ubuntu&quot;</span>*|*<span class="string">&quot;Debian&quot;</span>*)</span><br><span class="line">            install_docker_ubuntu</span><br><span class="line">            ;;</span><br><span class="line">        *)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;不支持的操作系统: <span class="variable">$OS</span>&quot;</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">            ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line">    </span><br><span class="line">    configure_docker</span><br><span class="line">    verify_installation</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查是否为root用户</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$EUID</span>&quot;</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;请不要使用root用户运行此脚本&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">main</span><br></pre></td></tr></table></figure>

<h3 id="2-2-Docker-Compose安装"><a href="#2-2-Docker-Compose安装" class="headerlink" title="2.2 Docker Compose安装"></a>2.2 Docker Compose安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Docker Compose安装脚本</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install_docker_compose</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;安装Docker Compose...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 获取最新版本号</span></span><br><span class="line">    COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | \</span><br><span class="line">        grep <span class="string">&#x27;tag_name&#x27;</span> | <span class="built_in">cut</span> -d<span class="string">&#x27;&quot;&#x27;</span> -f4)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;最新版本: <span class="variable">$COMPOSE_VERSION</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 下载Docker Compose</span></span><br><span class="line">    <span class="built_in">sudo</span> curl -L <span class="string">&quot;https://github.com/docker/compose/releases/download/<span class="variable">$&#123;COMPOSE_VERSION&#125;</span>/docker-compose-<span class="subst">$(uname -s)</span>-<span class="subst">$(uname -m)</span>&quot;</span> \</span><br><span class="line">        -o /usr/local/bin/docker-compose</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 添加执行权限</span></span><br><span class="line">    <span class="built_in">sudo</span> <span class="built_in">chmod</span> +x /usr/local/bin/docker-compose</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建软链接</span></span><br><span class="line">    <span class="built_in">sudo</span> <span class="built_in">ln</span> -sf /usr/local/bin/docker-compose /usr/bin/docker-compose</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 验证安装</span></span><br><span class="line">    docker-compose --version</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Docker Compose安装完成&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">install_docker_compose</span><br></pre></td></tr></table></figure>

<h2 id="三、容器生命周期管理"><a href="#三、容器生命周期管理" class="headerlink" title="三、容器生命周期管理"></a>三、容器生命周期管理</h2><h3 id="3-1-容器基本操作"><a href="#3-1-容器基本操作" class="headerlink" title="3.1 容器基本操作"></a>3.1 容器基本操作</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 容器生命周期管理脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 容器生命周期管理 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器创建和运行</span></span><br><span class="line"><span class="function"><span class="title">container_lifecycle</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. 容器创建和运行&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 运行简单容器</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;运行nginx容器:&quot;</span></span><br><span class="line">    docker run -d --name web-server -p 8080:80 nginx:latest</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查看运行中的容器</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;运行中的容器:&quot;</span></span><br><span class="line">    docker ps</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查看容器详细信息</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;容器详细信息:&quot;</span></span><br><span class="line">    docker inspect web-server</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查看容器日志</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;容器日志:&quot;</span></span><br><span class="line">    docker logs web-server</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 进入容器</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;进入容器(交互式):&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;docker exec -it web-server /bin/bash&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器状态管理</span></span><br><span class="line"><span class="function"><span class="title">container_state_management</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;2. 容器状态管理&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">local</span> container_name=<span class="string">&quot;test-container&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建容器但不启动</span></span><br><span class="line">    docker create --name <span class="variable">$container_name</span> ubuntu:20.04 <span class="built_in">sleep</span> 3600</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 启动容器</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;启动容器:&quot;</span></span><br><span class="line">    docker start <span class="variable">$container_name</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 暂停容器</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;暂停容器:&quot;</span></span><br><span class="line">    docker pause <span class="variable">$container_name</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 恢复容器</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;恢复容器:&quot;</span></span><br><span class="line">    docker unpause <span class="variable">$container_name</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 停止容器</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;停止容器:&quot;</span></span><br><span class="line">    docker stop <span class="variable">$container_name</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 重启容器</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;重启容器:&quot;</span></span><br><span class="line">    docker restart <span class="variable">$container_name</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 删除容器</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;删除容器:&quot;</span></span><br><span class="line">    docker <span class="built_in">rm</span> -f <span class="variable">$container_name</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器资源限制</span></span><br><span class="line"><span class="function"><span class="title">container_resource_limits</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;3. 容器资源限制&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># CPU限制</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;CPU限制示例:&quot;</span></span><br><span class="line">    docker run -d --name cpu-limited \</span><br><span class="line">        --cpus=<span class="string">&quot;1.5&quot;</span> \</span><br><span class="line">        --cpu-shares=1024 \</span><br><span class="line">        nginx:latest</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 内存限制</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;内存限制示例:&quot;</span></span><br><span class="line">    docker run -d --name memory-limited \</span><br><span class="line">        --memory=<span class="string">&quot;512m&quot;</span> \</span><br><span class="line">        --memory-swap=<span class="string">&quot;1g&quot;</span> \</span><br><span class="line">        nginx:latest</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 磁盘I/O限制</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;磁盘I/O限制示例:&quot;</span></span><br><span class="line">    docker run -d --name io-limited \</span><br><span class="line">        --device-read-bps /dev/sda:1mb \</span><br><span class="line">        --device-write-bps /dev/sda:1mb \</span><br><span class="line">        nginx:latest</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查看容器资源使用情况</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;容器资源使用情况:&quot;</span></span><br><span class="line">    docker stats --no-stream</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 清理测试容器</span></span><br><span class="line">    docker <span class="built_in">rm</span> -f cpu-limited memory-limited io-limited</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器网络管理</span></span><br><span class="line"><span class="function"><span class="title">container_network_management</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;4. 容器网络管理&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建自定义网络</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;创建自定义网络:&quot;</span></span><br><span class="line">    docker network create --driver bridge my-network</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 在自定义网络中运行容器</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;在自定义网络中运行容器:&quot;</span></span><br><span class="line">    docker run -d --name web1 --network my-network nginx:latest</span><br><span class="line">    docker run -d --name web2 --network my-network nginx:latest</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查看网络信息</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;网络信息:&quot;</span></span><br><span class="line">    docker network <span class="built_in">ls</span></span><br><span class="line">    docker network inspect my-network</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 容器间通信测试</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;容器间通信测试:&quot;</span></span><br><span class="line">    docker <span class="built_in">exec</span> web1 ping -c 3 web2</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 清理</span></span><br><span class="line">    docker <span class="built_in">rm</span> -f web1 web2</span><br><span class="line">    docker network <span class="built_in">rm</span> my-network</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">container_lifecycle</span><br><span class="line">container_state_management</span><br><span class="line">container_resource_limits</span><br><span class="line">container_network_management</span><br></pre></td></tr></table></figure>

<h3 id="3-2-容器监控和调试"><a href="#3-2-容器监控和调试" class="headerlink" title="3.2 容器监控和调试"></a>3.2 容器监控和调试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 容器监控和调试脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 容器监控和调试 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器性能监控</span></span><br><span class="line"><span class="function"><span class="title">container_monitoring</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. 容器性能监控&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 实时监控所有容器</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;实时监控所有容器:&quot;</span></span><br><span class="line">    docker stats --format <span class="string">&quot;table &#123;&#123;.Container&#125;&#125;\t&#123;&#123;.CPUPerc&#125;&#125;\t&#123;&#123;.MemUsage&#125;&#125;\t&#123;&#123;.NetIO&#125;&#125;\t&#123;&#123;.BlockIO&#125;&#125;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 监控特定容器</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;监控特定容器: <span class="variable">$1</span>&quot;</span></span><br><span class="line">        docker stats <span class="variable">$1</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器日志管理</span></span><br><span class="line"><span class="function"><span class="title">container_log_management</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;2. 容器日志管理&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">local</span> container_name=<span class="string">&quot;log-test&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建测试容器</span></span><br><span class="line">    docker run -d --name <span class="variable">$container_name</span> \</span><br><span class="line">        --log-driver json-file \</span><br><span class="line">        --log-opt max-size=10m \</span><br><span class="line">        --log-opt max-file=3 \</span><br><span class="line">        nginx:latest</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查看日志</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;查看容器日志:&quot;</span></span><br><span class="line">    docker logs <span class="variable">$container_name</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 实时跟踪日志</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;实时跟踪日志(10秒):&quot;</span></span><br><span class="line">    <span class="built_in">timeout</span> 10 docker logs -f <span class="variable">$container_name</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查看日志文件位置</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;日志文件位置:&quot;</span></span><br><span class="line">    docker inspect <span class="variable">$container_name</span> | grep LogPath</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 清理</span></span><br><span class="line">    docker <span class="built_in">rm</span> -f <span class="variable">$container_name</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器故障排查</span></span><br><span class="line"><span class="function"><span class="title">container_troubleshooting</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;3. 容器故障排查&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查容器状态</span></span><br><span class="line">    <span class="function"><span class="title">check_container_status</span></span>() &#123;</span><br><span class="line">        <span class="built_in">local</span> container=<span class="variable">$1</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;检查容器状态: <span class="variable">$container</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 容器基本信息</span></span><br><span class="line">        docker ps -a --filter name=<span class="variable">$container</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 容器详细状态</span></span><br><span class="line">        docker inspect <span class="variable">$container</span> --format=<span class="string">&#x27;&#123;&#123;.State.Status&#125;&#125;&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 容器退出码</span></span><br><span class="line">        docker inspect <span class="variable">$container</span> --format=<span class="string">&#x27;&#123;&#123;.State.ExitCode&#125;&#125;&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 容器错误信息</span></span><br><span class="line">        docker inspect <span class="variable">$container</span> --format=<span class="string">&#x27;&#123;&#123;.State.Error&#125;&#125;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查容器资源使用</span></span><br><span class="line">    <span class="function"><span class="title">check_container_resources</span></span>() &#123;</span><br><span class="line">        <span class="built_in">local</span> container=<span class="variable">$1</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;检查容器资源使用: <span class="variable">$container</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># CPU和内存使用</span></span><br><span class="line">        docker stats --no-stream <span class="variable">$container</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 容器进程</span></span><br><span class="line">        docker top <span class="variable">$container</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 容器文件系统使用</span></span><br><span class="line">        docker <span class="built_in">exec</span> <span class="variable">$container</span> <span class="built_in">df</span> -h</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 网络连接检查</span></span><br><span class="line">    <span class="function"><span class="title">check_container_network</span></span>() &#123;</span><br><span class="line">        <span class="built_in">local</span> container=<span class="variable">$1</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;检查容器网络: <span class="variable">$container</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 容器IP地址</span></span><br><span class="line">        docker inspect <span class="variable">$container</span> --format=<span class="string">&#x27;&#123;&#123;range .NetworkSettings.Networks&#125;&#125;&#123;&#123;.IPAddress&#125;&#125;&#123;&#123;end&#125;&#125;&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 端口映射</span></span><br><span class="line">        docker port <span class="variable">$container</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 网络连接测试</span></span><br><span class="line">        docker <span class="built_in">exec</span> <span class="variable">$container</span> netstat -tlnp</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;故障排查函数已定义，使用方法:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;check_container_status &lt;容器名&gt;&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;check_container_resources &lt;容器名&gt;&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;check_container_network &lt;容器名&gt;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器健康检查</span></span><br><span class="line"><span class="function"><span class="title">container_health_check</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;4. 容器健康检查&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建带健康检查的容器</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span> &gt; /tmp/Dockerfile.health</span><br><span class="line">FROM nginx:latest</span><br><span class="line">HEALTHCHECK --interval=30s --<span class="built_in">timeout</span>=3s --start-period=5s --retries=3 \</span><br><span class="line">    CMD curl -f http://localhost/ || <span class="built_in">exit</span> 1</span><br><span class="line">EOF</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 构建镜像</span></span><br><span class="line">    docker build -t nginx-health -f /tmp/Dockerfile.health /tmp/</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 运行容器</span></span><br><span class="line">    docker run -d --name health-test nginx-health</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查看健康状态</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;查看健康状态:&quot;</span></span><br><span class="line">    <span class="built_in">sleep</span> 10</span><br><span class="line">    docker inspect health-test --format=<span class="string">&#x27;&#123;&#123;.State.Health.Status&#125;&#125;&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查看健康检查历史</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;健康检查历史:&quot;</span></span><br><span class="line">    docker inspect health-test --format=<span class="string">&#x27;&#123;&#123;range .State.Health.Log&#125;&#125;&#123;&#123;.Output&#125;&#125;&#123;&#123;end&#125;&#125;&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 清理</span></span><br><span class="line">    docker <span class="built_in">rm</span> -f health-test</span><br><span class="line">    docker rmi nginx-health</span><br><span class="line">    <span class="built_in">rm</span> -f /tmp/Dockerfile.health</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">container_monitoring</span><br><span class="line">container_log_management</span><br><span class="line">container_troubleshooting</span><br><span class="line">container_health_check</span><br></pre></td></tr></table></figure>

<h2 id="四、Docker镜像管理"><a href="#四、Docker镜像管理" class="headerlink" title="四、Docker镜像管理"></a>四、Docker镜像管理</h2><h3 id="4-1-镜像构建与优化"><a href="#4-1-镜像构建与优化" class="headerlink" title="4.1 镜像构建与优化"></a>4.1 镜像构建与优化</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Docker镜像构建与优化脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Docker镜像构建与优化 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建优化的Dockerfile示例</span></span><br><span class="line"><span class="function"><span class="title">create_optimized_dockerfile</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. 创建优化的Dockerfile&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">mkdir</span> -p /tmp/docker-build</span><br><span class="line">    <span class="built_in">cd</span> /tmp/docker-build</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 多阶段构建示例</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span> &gt; Dockerfile.multistage</span><br><span class="line"><span class="comment"># 多阶段构建示例 - 构建阶段</span></span><br><span class="line">FROM node:16-alpine AS builder</span><br><span class="line">WORKDIR /app</span><br><span class="line">COPY package*.json ./</span><br><span class="line">RUN npm ci --only=production</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行阶段</span></span><br><span class="line">FROM node:16-alpine AS runtime</span><br><span class="line">WORKDIR /app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建非root用户</span></span><br><span class="line">RUN addgroup -g 1001 -S nodejs &amp;&amp; \</span><br><span class="line">    adduser -S nextjs -u 1001</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制构建产物</span></span><br><span class="line">COPY --from=builder /app/node_modules ./node_modules</span><br><span class="line">COPY . .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置用户</span></span><br><span class="line">USER nextjs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 健康检查</span></span><br><span class="line">HEALTHCHECK --interval=30s --<span class="built_in">timeout</span>=3s --start-period=5s --retries=3 \</span><br><span class="line">    CMD curl -f http://localhost:3000/health || <span class="built_in">exit</span> 1</span><br><span class="line"></span><br><span class="line">EXPOSE 3000</span><br><span class="line">CMD [<span class="string">&quot;npm&quot;</span>, <span class="string">&quot;start&quot;</span>]</span><br><span class="line">EOF</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 优化的Python应用Dockerfile</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span> &gt; Dockerfile.python</span><br><span class="line">FROM python:3.9-slim AS base</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line">ENV PYTHONUNBUFFERED=1 \</span><br><span class="line">    PYTHONDONTWRITEBYTECODE=1 \</span><br><span class="line">    PIP_NO_CACHE_DIR=1 \</span><br><span class="line">    PIP_DISABLE_PIP_VERSION_CHECK=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装系统依赖</span></span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y \</span><br><span class="line">    gcc \</span><br><span class="line">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建应用用户</span></span><br><span class="line">RUN useradd --create-home --shell /bin/bash app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置工作目录</span></span><br><span class="line">WORKDIR /app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制依赖文件</span></span><br><span class="line">COPY requirements.txt .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装Python依赖</span></span><br><span class="line">RUN pip install --no-cache-dir -r requirements.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制应用代码</span></span><br><span class="line">COPY . .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置权限</span></span><br><span class="line">RUN <span class="built_in">chown</span> -R app:app /app</span><br><span class="line">USER app</span><br><span class="line"></span><br><span class="line">EXPOSE 8000</span><br><span class="line">CMD [<span class="string">&quot;python&quot;</span>, <span class="string">&quot;app.py&quot;</span>]</span><br><span class="line">EOF</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Dockerfile示例已创建&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 镜像构建最佳实践</span></span><br><span class="line"><span class="function"><span class="title">image_build_best_practices</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;2. 镜像构建最佳实践&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># .dockerignore文件</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span> &gt; .dockerignore</span><br><span class="line"><span class="comment"># Git相关</span></span><br><span class="line">.git</span><br><span class="line">.gitignore</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文档</span></span><br><span class="line">*.md</span><br><span class="line">README*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志文件</span></span><br><span class="line">*.<span class="built_in">log</span></span><br><span class="line">logs/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 临时文件</span></span><br><span class="line">*.tmp</span><br><span class="line">*.temp</span><br><span class="line"></span><br><span class="line"><span class="comment"># IDE文件</span></span><br><span class="line">.vscode/</span><br><span class="line">.idea/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 依赖目录</span></span><br><span class="line">node_modules/</span><br><span class="line">__pycache__/</span><br><span class="line">*.pyc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试文件</span></span><br><span class="line">tests/</span><br><span class="line">*.test.js</span><br><span class="line">EOF</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;.dockerignore文件已创建&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 构建脚本</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span> &gt; build.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 镜像构建脚本</span></span><br><span class="line"></span><br><span class="line">IMAGE_NAME=<span class="string">&quot;myapp&quot;</span></span><br><span class="line">IMAGE_TAG=<span class="string">&quot;latest&quot;</span></span><br><span class="line">DOCKERFILE=<span class="string">&quot;Dockerfile&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建参数</span></span><br><span class="line">BUILD_ARGS=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$BUILD_ENV</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    BUILD_ARGS=<span class="string">&quot;--build-arg ENV=<span class="variable">$BUILD_ENV</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建镜像</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;构建镜像: <span class="variable">$IMAGE_NAME</span>:<span class="variable">$IMAGE_TAG</span>&quot;</span></span><br><span class="line">docker build <span class="variable">$BUILD_ARGS</span> -t <span class="variable">$IMAGE_NAME</span>:<span class="variable">$IMAGE_TAG</span> -f <span class="variable">$DOCKERFILE</span> .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查镜像大小</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;镜像大小:&quot;</span></span><br><span class="line">docker images <span class="variable">$IMAGE_NAME</span>:<span class="variable">$IMAGE_TAG</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 镜像安全扫描(如果有工具)</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">command</span> -v trivy &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;安全扫描:&quot;</span></span><br><span class="line">    trivy image <span class="variable">$IMAGE_NAME</span>:<span class="variable">$IMAGE_TAG</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 镜像层分析</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;镜像层分析:&quot;</span></span><br><span class="line">docker <span class="built_in">history</span> <span class="variable">$IMAGE_NAME</span>:<span class="variable">$IMAGE_TAG</span></span><br><span class="line">EOF</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">chmod</span> +x build.sh</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;构建脚本已创建&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 镜像优化技巧</span></span><br><span class="line"><span class="function"><span class="title">image_optimization_tips</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;3. 镜像优化技巧&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 镜像大小分析</span></span><br><span class="line">    <span class="function"><span class="title">analyze_image_size</span></span>() &#123;</span><br><span class="line">        <span class="built_in">local</span> image=<span class="variable">$1</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;分析镜像大小: <span class="variable">$image</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 显示镜像层</span></span><br><span class="line">        docker <span class="built_in">history</span> <span class="variable">$image</span> --format <span class="string">&quot;table &#123;&#123;.CreatedBy&#125;&#125;\t&#123;&#123;.Size&#125;&#125;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 使用dive工具分析(如果安装)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">command</span> -v dive &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">            dive <span class="variable">$image</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;安装dive工具进行详细分析: https://github.com/wagoodman/dive&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 镜像清理</span></span><br><span class="line">    <span class="function"><span class="title">cleanup_images</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;清理无用镜像:&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 删除悬空镜像</span></span><br><span class="line">        docker image prune -f</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 删除未使用的镜像</span></span><br><span class="line">        docker image prune -a -f</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 显示镜像使用情况</span></span><br><span class="line">        docker system <span class="built_in">df</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;镜像优化函数已定义:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;analyze_image_size &lt;镜像名&gt;&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;cleanup_images&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">create_optimized_dockerfile</span><br><span class="line">image_build_best_practices</span><br><span class="line">image_optimization_tips</span><br></pre></td></tr></table></figure>

<h3 id="4-2-镜像仓库管理"><a href="#4-2-镜像仓库管理" class="headerlink" title="4.2 镜像仓库管理"></a>4.2 镜像仓库管理</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Docker镜像仓库管理脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Docker镜像仓库管理 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Docker Hub操作</span></span><br><span class="line"><span class="function"><span class="title">dockerhub_operations</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. Docker Hub操作&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 登录Docker Hub</span></span><br><span class="line">    <span class="function"><span class="title">docker_login</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;登录Docker Hub:&quot;</span></span><br><span class="line">        <span class="built_in">read</span> -p <span class="string">&quot;输入Docker Hub用户名: &quot;</span> username</span><br><span class="line">        docker login -u <span class="variable">$username</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 推送镜像</span></span><br><span class="line">    <span class="function"><span class="title">push_image</span></span>() &#123;</span><br><span class="line">        <span class="built_in">local</span> image=<span class="variable">$1</span></span><br><span class="line">        <span class="built_in">local</span> tag=<span class="variable">$&#123;2:-latest&#125;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$image</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;用法: push_image &lt;镜像名&gt; [标签]&quot;</span></span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;推送镜像: <span class="variable">$image</span>:<span class="variable">$tag</span>&quot;</span></span><br><span class="line">        docker tag <span class="variable">$image</span>:<span class="variable">$tag</span> <span class="variable">$DOCKER_USERNAME</span>/<span class="variable">$image</span>:<span class="variable">$tag</span></span><br><span class="line">        docker push <span class="variable">$DOCKER_USERNAME</span>/<span class="variable">$image</span>:<span class="variable">$tag</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 拉取镜像</span></span><br><span class="line">    <span class="function"><span class="title">pull_image</span></span>() &#123;</span><br><span class="line">        <span class="built_in">local</span> image=<span class="variable">$1</span></span><br><span class="line">        <span class="built_in">local</span> tag=<span class="variable">$&#123;2:-latest&#125;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$image</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;用法: pull_image &lt;镜像名&gt; [标签]&quot;</span></span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;拉取镜像: <span class="variable">$image</span>:<span class="variable">$tag</span>&quot;</span></span><br><span class="line">        docker pull <span class="variable">$image</span>:<span class="variable">$tag</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Docker Hub函数已定义:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;docker_login&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;push_image &lt;镜像名&gt; [标签]&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;pull_image &lt;镜像名&gt; [标签]&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 私有仓库搭建</span></span><br><span class="line"><span class="function"><span class="title">setup_private_registry</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;2. 搭建私有Docker仓库&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建仓库目录</span></span><br><span class="line">    <span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /opt/docker-registry/&#123;data,certs,auth&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 生成自签名证书</span></span><br><span class="line">    <span class="function"><span class="title">generate_certs</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;生成自签名证书:&quot;</span></span><br><span class="line">        </span><br><span class="line">        openssl req -newkey rsa:4096 -nodes -sha256 \</span><br><span class="line">            -keyout /opt/docker-registry/certs/domain.key \</span><br><span class="line">            -x509 -days 365 \</span><br><span class="line">            -out /opt/docker-registry/certs/domain.crt \</span><br><span class="line">            -subj <span class="string">&quot;/C=CN/ST=Beijing/L=Beijing/O=Company/CN=registry.local&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建认证文件</span></span><br><span class="line">    <span class="function"><span class="title">create_auth</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;创建认证文件:&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">read</span> -p <span class="string">&quot;输入用户名: &quot;</span> username</span><br><span class="line">        <span class="built_in">read</span> -s -p <span class="string">&quot;输入密码: &quot;</span> password</span><br><span class="line">        <span class="built_in">echo</span></span><br><span class="line">        </span><br><span class="line">        docker run --<span class="built_in">rm</span> --entrypoint htpasswd \</span><br><span class="line">            httpd:2 -Bbn <span class="variable">$username</span> <span class="variable">$password</span> &gt; /opt/docker-registry/auth/htpasswd</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 启动私有仓库</span></span><br><span class="line">    <span class="function"><span class="title">start_registry</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;启动私有Docker仓库:&quot;</span></span><br><span class="line">        </span><br><span class="line">        docker run -d \</span><br><span class="line">            --restart=always \</span><br><span class="line">            --name registry \</span><br><span class="line">            -p 5000:5000 \</span><br><span class="line">            -v /opt/docker-registry/data:/var/lib/registry \</span><br><span class="line">            -v /opt/docker-registry/certs:/certs \</span><br><span class="line">            -v /opt/docker-registry/auth:/auth \</span><br><span class="line">            -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \</span><br><span class="line">            -e REGISTRY_HTTP_TLS_PRIVATE_KEY=/certs/domain.key \</span><br><span class="line">            -e REGISTRY_AUTH=htpasswd \</span><br><span class="line">            -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \</span><br><span class="line">            -e REGISTRY_AUTH_HTPASSWD_REALM=<span class="string">&quot;Registry Realm&quot;</span> \</span><br><span class="line">            registry:2</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;私有仓库函数已定义:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;generate_certs&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;create_auth&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;start_registry&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Harbor仓库管理</span></span><br><span class="line"><span class="function"><span class="title">harbor_management</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;3. Harbor企业级仓库管理&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Harbor安装脚本</span></span><br><span class="line">    <span class="function"><span class="title">install_harbor</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;安装Harbor:&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 下载Harbor</span></span><br><span class="line">        HARBOR_VERSION=<span class="string">&quot;v2.5.0&quot;</span></span><br><span class="line">        wget https://github.com/goharbor/harbor/releases/download/<span class="variable">$&#123;HARBOR_VERSION&#125;</span>/harbor-offline-installer-<span class="variable">$&#123;HARBOR_VERSION&#125;</span>.tgz</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 解压</span></span><br><span class="line">        tar xvf harbor-offline-installer-<span class="variable">$&#123;HARBOR_VERSION&#125;</span>.tgz</span><br><span class="line">        <span class="built_in">cd</span> harbor</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 配置Harbor</span></span><br><span class="line">        <span class="built_in">cp</span> harbor.yml.tmpl harbor.yml</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 修改配置文件</span></span><br><span class="line">        sed -i <span class="string">&#x27;s/hostname: reg.mydomain.com/hostname: harbor.local/&#x27;</span> harbor.yml</span><br><span class="line">        sed -i <span class="string">&#x27;s/harbor_admin_password: Harbor12345/harbor_admin_password: YourPassword/&#x27;</span> harbor.yml</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 安装Harbor</span></span><br><span class="line">        <span class="built_in">sudo</span> ./install.sh</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Harbor备份</span></span><br><span class="line">    <span class="function"><span class="title">backup_harbor</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;备份Harbor数据:&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">local</span> backup_dir=<span class="string">&quot;/opt/harbor-backup/<span class="subst">$(date +%Y%m%d_%H%M%S)</span>&quot;</span></span><br><span class="line">        <span class="built_in">mkdir</span> -p <span class="variable">$backup_dir</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 停止Harbor</span></span><br><span class="line">        <span class="built_in">cd</span> /opt/harbor</span><br><span class="line">        docker-compose down</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 备份数据</span></span><br><span class="line">        <span class="built_in">cp</span> -r /data/database <span class="variable">$backup_dir</span>/</span><br><span class="line">        <span class="built_in">cp</span> -r /data/registry <span class="variable">$backup_dir</span>/</span><br><span class="line">        <span class="built_in">cp</span> harbor.yml <span class="variable">$backup_dir</span>/</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 重启Harbor</span></span><br><span class="line">        docker-compose up -d</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;备份完成: <span class="variable">$backup_dir</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Harbor函数已定义:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;install_harbor&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;backup_harbor&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dockerhub_operations</span><br><span class="line">setup_private_registry</span><br><span class="line">harbor_management</span><br></pre></td></tr></table></figure>

<h2 id="五、容器数据管理与备份"><a href="#五、容器数据管理与备份" class="headerlink" title="五、容器数据管理与备份"></a>五、容器数据管理与备份</h2><h3 id="5-1-数据卷管理"><a href="#5-1-数据卷管理" class="headerlink" title="5.1 数据卷管理"></a>5.1 数据卷管理</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Docker数据卷管理脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Docker数据卷管理 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据卷基本操作</span></span><br><span class="line"><span class="function"><span class="title">volume_basic_operations</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. 数据卷基本操作&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建数据卷</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;创建数据卷:&quot;</span></span><br><span class="line">    docker volume create my-volume</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查看数据卷</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;查看数据卷列表:&quot;</span></span><br><span class="line">    docker volume <span class="built_in">ls</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查看数据卷详细信息</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;数据卷详细信息:&quot;</span></span><br><span class="line">    docker volume inspect my-volume</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 使用数据卷运行容器</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;使用数据卷运行容器:&quot;</span></span><br><span class="line">    docker run -d --name volume-test \</span><br><span class="line">        -v my-volume:/data \</span><br><span class="line">        nginx:latest</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 在容器中写入数据</span></span><br><span class="line">    docker <span class="built_in">exec</span> volume-test sh -c <span class="string">&#x27;echo &quot;Hello Volume&quot; &gt; /data/test.txt&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 验证数据持久性</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;验证数据持久性:&quot;</span></span><br><span class="line">    docker <span class="built_in">rm</span> -f volume-test</span><br><span class="line">    docker run --<span class="built_in">rm</span> -v my-volume:/data alpine <span class="built_in">cat</span> /data/test.txt</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 清理</span></span><br><span class="line">    docker volume <span class="built_in">rm</span> my-volume</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绑定挂载管理</span></span><br><span class="line"><span class="function"><span class="title">bind_mount_management</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;2. 绑定挂载管理&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建主机目录</span></span><br><span class="line">    <span class="built_in">local</span> host_dir=<span class="string">&quot;/tmp/docker-bind-mount&quot;</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p <span class="variable">$host_dir</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Host data&quot;</span> &gt; <span class="variable">$host_dir</span>/host-file.txt</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 绑定挂载</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;绑定挂载示例:&quot;</span></span><br><span class="line">    docker run -d --name bind-test \</span><br><span class="line">        -v <span class="variable">$host_dir</span>:/app/data \</span><br><span class="line">        nginx:latest</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 在容器中创建文件</span></span><br><span class="line">    docker <span class="built_in">exec</span> bind-test sh -c <span class="string">&#x27;echo &quot;Container data&quot; &gt; /app/data/container-file.txt&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 验证主机上的文件</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;主机上的文件:&quot;</span></span><br><span class="line">    <span class="built_in">ls</span> -la <span class="variable">$host_dir</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 只读挂载</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;只读挂载示例:&quot;</span></span><br><span class="line">    docker run --<span class="built_in">rm</span> \</span><br><span class="line">        -v <span class="variable">$host_dir</span>:/app/data:ro \</span><br><span class="line">        alpine sh -c <span class="string">&#x27;ls -la /app/data &amp;&amp; echo &quot;尝试写入...&quot; &amp;&amp; touch /app/data/readonly-test.txt || echo &quot;写入失败(预期行为)&quot;&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 清理</span></span><br><span class="line">    docker <span class="built_in">rm</span> -f bind-test</span><br><span class="line">    <span class="built_in">rm</span> -rf <span class="variable">$host_dir</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># tmpfs挂载</span></span><br><span class="line"><span class="function"><span class="title">tmpfs_mount</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;3. tmpfs挂载(内存文件系统)&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建tmpfs挂载</span></span><br><span class="line">    docker run -d --name tmpfs-test \</span><br><span class="line">        --tmpfs /tmp:rw,noexec,nosuid,size=100m \</span><br><span class="line">        nginx:latest</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 测试tmpfs</span></span><br><span class="line">    docker <span class="built_in">exec</span> tmpfs-test sh -c <span class="string">&#x27;</span></span><br><span class="line"><span class="string">        echo &quot;写入tmpfs&quot; &gt; /tmp/tmpfs-test.txt</span></span><br><span class="line"><span class="string">        df -h /tmp</span></span><br><span class="line"><span class="string">        ls -la /tmp/</span></span><br><span class="line"><span class="string">    &#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 清理</span></span><br><span class="line">    docker <span class="built_in">rm</span> -f tmpfs-test</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据卷备份和恢复</span></span><br><span class="line"><span class="function"><span class="title">volume_backup_restore</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;4. 数据卷备份和恢复&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建测试数据卷和容器</span></span><br><span class="line">    docker volume create backup-test-volume</span><br><span class="line">    docker run -d --name data-container \</span><br><span class="line">        -v backup-test-volume:/data \</span><br><span class="line">        alpine sh -c <span class="string">&#x27;while true; do echo &quot;$(date): Data entry&quot; &gt;&gt; /data/log.txt; sleep 60; done&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待一些数据写入</span></span><br><span class="line">    <span class="built_in">sleep</span> 5</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 备份数据卷</span></span><br><span class="line">    <span class="function"><span class="title">backup_volume</span></span>() &#123;</span><br><span class="line">        <span class="built_in">local</span> volume_name=<span class="variable">$1</span></span><br><span class="line">        <span class="built_in">local</span> backup_file=<span class="variable">$2</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$volume_name</span>&quot;</span> ] || [ -z <span class="string">&quot;<span class="variable">$backup_file</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;用法: backup_volume &lt;数据卷名&gt; &lt;备份文件路径&gt;&quot;</span></span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;备份数据卷: <span class="variable">$volume_name</span> -&gt; <span class="variable">$backup_file</span>&quot;</span></span><br><span class="line">        docker run --<span class="built_in">rm</span> \</span><br><span class="line">            -v <span class="variable">$volume_name</span>:/data \</span><br><span class="line">            -v $(<span class="built_in">dirname</span> <span class="variable">$backup_file</span>):/backup \</span><br><span class="line">            alpine tar czf /backup/$(<span class="built_in">basename</span> <span class="variable">$backup_file</span>) -C /data .</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 恢复数据卷</span></span><br><span class="line">    <span class="function"><span class="title">restore_volume</span></span>() &#123;</span><br><span class="line">        <span class="built_in">local</span> volume_name=<span class="variable">$1</span></span><br><span class="line">        <span class="built_in">local</span> backup_file=<span class="variable">$2</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$volume_name</span>&quot;</span> ] || [ -z <span class="string">&quot;<span class="variable">$backup_file</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;用法: restore_volume &lt;数据卷名&gt; &lt;备份文件路径&gt;&quot;</span></span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;恢复数据卷: <span class="variable">$backup_file</span> -&gt; <span class="variable">$volume_name</span>&quot;</span></span><br><span class="line">        docker run --<span class="built_in">rm</span> \</span><br><span class="line">            -v <span class="variable">$volume_name</span>:/data \</span><br><span class="line">            -v $(<span class="built_in">dirname</span> <span class="variable">$backup_file</span>):/backup \</span><br><span class="line">            alpine sh -c <span class="string">&#x27;rm -rf /data/* &amp;&amp; tar xzf /backup/$(basename $backup_file) -C /data&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 执行备份</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p /tmp/volume-backup</span><br><span class="line">    backup_volume backup-test-volume /tmp/volume-backup/backup.tar.gz</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建新数据卷并恢复</span></span><br><span class="line">    docker volume create restore-test-volume</span><br><span class="line">    restore_volume restore-test-volume /tmp/volume-backup/backup.tar.gz</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 验证恢复</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;验证恢复的数据:&quot;</span></span><br><span class="line">    docker run --<span class="built_in">rm</span> -v restore-test-volume:/data alpine <span class="built_in">cat</span> /data/log.txt</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 清理</span></span><br><span class="line">    docker <span class="built_in">rm</span> -f data-container</span><br><span class="line">    docker volume <span class="built_in">rm</span> backup-test-volume restore-test-volume</span><br><span class="line">    <span class="built_in">rm</span> -rf /tmp/volume-backup</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;数据卷备份恢复函数已定义:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;backup_volume &lt;数据卷名&gt; &lt;备份文件路径&gt;&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;restore_volume &lt;数据卷名&gt; &lt;备份文件路径&gt;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">volume_basic_operations</span><br><span class="line">bind_mount_management</span><br><span class="line">tmpfs_mount</span><br><span class="line">volume_backup_restore</span><br></pre></td></tr></table></figure>

<h3 id="5-2-容器备份与恢复"><a href="#5-2-容器备份与恢复" class="headerlink" title="5.2 容器备份与恢复"></a>5.2 容器备份与恢复</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 容器备份与恢复脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 容器备份与恢复 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器镜像备份</span></span><br><span class="line"><span class="function"><span class="title">container_image_backup</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. 容器镜像备份&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 备份运行中的容器为镜像</span></span><br><span class="line">    <span class="function"><span class="title">backup_container_to_image</span></span>() &#123;</span><br><span class="line">        <span class="built_in">local</span> container_name=<span class="variable">$1</span></span><br><span class="line">        <span class="built_in">local</span> image_name=<span class="variable">$2</span></span><br><span class="line">        <span class="built_in">local</span> image_tag=<span class="variable">$&#123;3:-latest&#125;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$container_name</span>&quot;</span> ] || [ -z <span class="string">&quot;<span class="variable">$image_name</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;用法: backup_container_to_image &lt;容器名&gt; &lt;镜像名&gt; [标签]&quot;</span></span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;备份容器 <span class="variable">$container_name</span> 为镜像 <span class="variable">$image_name</span>:<span class="variable">$image_tag</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 暂停容器以确保数据一致性</span></span><br><span class="line">        docker pause <span class="variable">$container_name</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建镜像</span></span><br><span class="line">        docker commit -p <span class="variable">$container_name</span> <span class="variable">$image_name</span>:<span class="variable">$image_tag</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 恢复容器</span></span><br><span class="line">        docker unpause <span class="variable">$container_name</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;备份完成&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 导出镜像为tar文件</span></span><br><span class="line">    <span class="function"><span class="title">export_image_to_tar</span></span>() &#123;</span><br><span class="line">        <span class="built_in">local</span> image_name=<span class="variable">$1</span></span><br><span class="line">        <span class="built_in">local</span> tar_file=<span class="variable">$2</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$image_name</span>&quot;</span> ] || [ -z <span class="string">&quot;<span class="variable">$tar_file</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;用法: export_image_to_tar &lt;镜像名&gt; &lt;tar文件路径&gt;&quot;</span></span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;导出镜像 <span class="variable">$image_name</span> 到 <span class="variable">$tar_file</span>&quot;</span></span><br><span class="line">        docker save -o <span class="variable">$tar_file</span> <span class="variable">$image_name</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 压缩tar文件</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">command</span> -v gzip &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">            gzip <span class="variable">$tar_file</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;已压缩为 <span class="variable">$&#123;tar_file&#125;</span>.gz&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 从tar文件导入镜像</span></span><br><span class="line">    <span class="function"><span class="title">import_image_from_tar</span></span>() &#123;</span><br><span class="line">        <span class="built_in">local</span> tar_file=<span class="variable">$1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$tar_file</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;用法: import_image_from_tar &lt;tar文件路径&gt;&quot;</span></span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;从 <span class="variable">$tar_file</span> 导入镜像&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果是压缩文件，先解压</span></span><br><span class="line">        <span class="keyword">if</span> [[ <span class="variable">$tar_file</span> == *.gz ]]; <span class="keyword">then</span></span><br><span class="line">            gunzip <span class="variable">$tar_file</span></span><br><span class="line">            tar_file=<span class="variable">$&#123;tar_file%.gz&#125;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        docker load -i <span class="variable">$tar_file</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;导入完成&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;容器镜像备份函数已定义:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;backup_container_to_image &lt;容器名&gt; &lt;镜像名&gt; [标签]&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;export_image_to_tar &lt;镜像名&gt; &lt;tar文件路径&gt;&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;import_image_from_tar &lt;tar文件路径&gt;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器文件系统备份</span></span><br><span class="line"><span class="function"><span class="title">container_filesystem_backup</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;2. 容器文件系统备份&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 导出容器文件系统</span></span><br><span class="line">    <span class="function"><span class="title">export_container_filesystem</span></span>() &#123;</span><br><span class="line">        <span class="built_in">local</span> container_name=<span class="variable">$1</span></span><br><span class="line">        <span class="built_in">local</span> tar_file=<span class="variable">$2</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$container_name</span>&quot;</span> ] || [ -z <span class="string">&quot;<span class="variable">$tar_file</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;用法: export_container_filesystem &lt;容器名&gt; &lt;tar文件路径&gt;&quot;</span></span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;导出容器 <span class="variable">$container_name</span> 文件系统到 <span class="variable">$tar_file</span>&quot;</span></span><br><span class="line">        docker <span class="built_in">export</span> -o <span class="variable">$tar_file</span> <span class="variable">$container_name</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 压缩</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">command</span> -v gzip &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">            gzip <span class="variable">$tar_file</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;已压缩为 <span class="variable">$&#123;tar_file&#125;</span>.gz&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 从文件系统备份创建镜像</span></span><br><span class="line">    <span class="function"><span class="title">import_filesystem_to_image</span></span>() &#123;</span><br><span class="line">        <span class="built_in">local</span> tar_file=<span class="variable">$1</span></span><br><span class="line">        <span class="built_in">local</span> image_name=<span class="variable">$2</span></span><br><span class="line">        <span class="built_in">local</span> image_tag=<span class="variable">$&#123;3:-latest&#125;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$tar_file</span>&quot;</span> ] || [ -z <span class="string">&quot;<span class="variable">$image_name</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;用法: import_filesystem_to_image &lt;tar文件路径&gt; &lt;镜像名&gt; [标签]&quot;</span></span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;从 <span class="variable">$tar_file</span> 创建镜像 <span class="variable">$image_name</span>:<span class="variable">$image_tag</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果是压缩文件，使用管道解压并导入</span></span><br><span class="line">        <span class="keyword">if</span> [[ <span class="variable">$tar_file</span> == *.gz ]]; <span class="keyword">then</span></span><br><span class="line">            gunzip -c <span class="variable">$tar_file</span> | docker import - <span class="variable">$image_name</span>:<span class="variable">$image_tag</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            docker import <span class="variable">$tar_file</span> <span class="variable">$image_name</span>:<span class="variable">$image_tag</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;导入完成&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;容器文件系统备份函数已定义:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;export_container_filesystem &lt;容器名&gt; &lt;tar文件路径&gt;&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;import_filesystem_to_image &lt;tar文件路径&gt; &lt;镜像名&gt; [标签]&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增量备份策略</span></span><br><span class="line"><span class="function"><span class="title">incremental_backup_strategy</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;3. 增量备份策略&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建增量备份脚本</span></span><br><span class="line">    <span class="function"><span class="title">create_incremental_backup_script</span></span>() &#123;</span><br><span class="line">        <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span> &gt; /tmp/incremental_backup.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Docker增量备份脚本</span></span><br><span class="line"></span><br><span class="line">BACKUP_DIR=<span class="string">&quot;/opt/docker-backups&quot;</span></span><br><span class="line">CONTAINER_NAME=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">BACKUP_TYPE=<span class="string">&quot;<span class="variable">$&#123;2:-incremental&#125;</span>&quot;</span>  <span class="comment"># full, incremental</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$CONTAINER_NAME</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;用法: <span class="variable">$0</span> &lt;容器名&gt; [backup_type]&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建备份目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$BACKUP_DIR</span>/<span class="variable">$CONTAINER_NAME</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取当前时间戳</span></span><br><span class="line">TIMESTAMP=$(<span class="built_in">date</span> +%Y%m%d_%H%M%S)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全量备份</span></span><br><span class="line"><span class="function"><span class="title">full_backup</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;执行全量备份...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 备份容器为镜像</span></span><br><span class="line">    docker commit -p <span class="string">&quot;<span class="variable">$CONTAINER_NAME</span>&quot;</span> <span class="string">&quot;backup-<span class="variable">$CONTAINER_NAME</span>:<span class="variable">$TIMESTAMP</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 导出镜像</span></span><br><span class="line">    docker save -o <span class="string">&quot;<span class="variable">$BACKUP_DIR</span>/<span class="variable">$CONTAINER_NAME</span>/full_<span class="variable">$TIMESTAMP</span>.tar&quot;</span> \</span><br><span class="line">        <span class="string">&quot;backup-<span class="variable">$CONTAINER_NAME</span>:<span class="variable">$TIMESTAMP</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 压缩</span></span><br><span class="line">    gzip <span class="string">&quot;<span class="variable">$BACKUP_DIR</span>/<span class="variable">$CONTAINER_NAME</span>/full_<span class="variable">$TIMESTAMP</span>.tar&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 记录备份信息</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$TIMESTAMP</span>:full&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$BACKUP_DIR</span>/<span class="variable">$CONTAINER_NAME</span>/backup.log&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;全量备份完成: full_<span class="variable">$TIMESTAMP</span>.tar.gz&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增量备份(基于数据卷)</span></span><br><span class="line"><span class="function"><span class="title">incremental_backup</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;执行增量备份...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 获取上次备份时间</span></span><br><span class="line">    LAST_BACKUP=$(<span class="built_in">tail</span> -1 <span class="string">&quot;<span class="variable">$BACKUP_DIR</span>/<span class="variable">$CONTAINER_NAME</span>/backup.log&quot;</span> 2&gt;/dev/null | <span class="built_in">cut</span> -d: -f1)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$LAST_BACKUP</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;未找到上次备份记录，执行全量备份&quot;</span></span><br><span class="line">        full_backup</span><br><span class="line">        <span class="built_in">return</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查找容器的数据卷</span></span><br><span class="line">    VOLUMES=$(docker inspect <span class="string">&quot;<span class="variable">$CONTAINER_NAME</span>&quot;</span> --format <span class="string">&#x27;&#123;&#123;range .Mounts&#125;&#125;&#123;&#123;.Source&#125;&#125;:&#123;&#123;.Destination&#125;&#125; &#123;&#123;end&#125;&#125;&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$VOLUMES</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;容器无数据卷，执行全量备份&quot;</span></span><br><span class="line">        full_backup</span><br><span class="line">        <span class="built_in">return</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 备份变更的文件</span></span><br><span class="line">    <span class="keyword">for</span> VOLUME <span class="keyword">in</span> <span class="variable">$VOLUMES</span>; <span class="keyword">do</span></span><br><span class="line">        SOURCE=$(<span class="built_in">echo</span> <span class="variable">$VOLUME</span> | <span class="built_in">cut</span> -d: -f1)</span><br><span class="line">        DEST=$(<span class="built_in">echo</span> <span class="variable">$VOLUME</span> | <span class="built_in">cut</span> -d: -f2)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [ -d <span class="string">&quot;<span class="variable">$SOURCE</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="comment"># 查找自上次备份以来修改的文件</span></span><br><span class="line">            find <span class="string">&quot;<span class="variable">$SOURCE</span>&quot;</span> -newer <span class="string">&quot;<span class="variable">$BACKUP_DIR</span>/<span class="variable">$CONTAINER_NAME</span>/full_<span class="variable">$&#123;LAST_BACKUP&#125;</span>.tar.gz&quot;</span> \</span><br><span class="line">                -<span class="built_in">type</span> f -<span class="built_in">exec</span> tar -czf <span class="string">&quot;<span class="variable">$BACKUP_DIR</span>/<span class="variable">$CONTAINER_NAME</span>/incremental_<span class="variable">$TIMESTAMP</span>.tar.gz&quot;</span> &#123;&#125; +</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 记录备份信息</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$TIMESTAMP</span>:incremental&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$BACKUP_DIR</span>/<span class="variable">$CONTAINER_NAME</span>/backup.log&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;增量备份完成: incremental_<span class="variable">$TIMESTAMP</span>.tar.gz&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行备份</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$BACKUP_TYPE</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">    full)</span><br><span class="line">        full_backup</span><br><span class="line">        ;;</span><br><span class="line">    incremental)</span><br><span class="line">        incremental_backup</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;不支持的备份类型: <span class="variable">$BACKUP_TYPE</span>&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">        ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line">EOF</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">chmod</span> +x /tmp/incremental_backup.sh</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;增量备份脚本已创建: /tmp/incremental_backup.sh&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    create_incremental_backup_script</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动化备份调度</span></span><br><span class="line"><span class="function"><span class="title">automated_backup_scheduling</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;4. 自动化备份调度&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建备份调度脚本</span></span><br><span class="line">    <span class="function"><span class="title">create_backup_scheduler</span></span>() &#123;</span><br><span class="line">        <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span> &gt; /tmp/backup_scheduler.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Docker备份调度脚本</span></span><br><span class="line"></span><br><span class="line">BACKUP_CONFIG=<span class="string">&quot;/etc/docker-backup.conf&quot;</span></span><br><span class="line">LOG_FILE=<span class="string">&quot;/var/log/docker-backup.log&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志函数</span></span><br><span class="line"><span class="function"><span class="title">log_message</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)</span> - <span class="variable">$1</span>&quot;</span> | <span class="built_in">tee</span> -a <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取配置文件</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$BACKUP_CONFIG</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">source</span> <span class="string">&quot;<span class="variable">$BACKUP_CONFIG</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    log_message <span class="string">&quot;配置文件不存在: <span class="variable">$BACKUP_CONFIG</span>&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行备份</span></span><br><span class="line"><span class="keyword">for</span> CONTAINER <span class="keyword">in</span> <span class="variable">$CONTAINERS_TO_BACKUP</span>; <span class="keyword">do</span></span><br><span class="line">    log_message <span class="string">&quot;开始备份容器: <span class="variable">$CONTAINER</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查容器是否运行</span></span><br><span class="line">    <span class="keyword">if</span> ! docker ps --format <span class="string">&#x27;&#123;&#123;.Names&#125;&#125;&#x27;</span> | grep -q <span class="string">&quot;^$CONTAINER$&quot;</span>; <span class="keyword">then</span></span><br><span class="line">        log_message <span class="string">&quot;警告: 容器 <span class="variable">$CONTAINER</span> 未运行&quot;</span></span><br><span class="line">        <span class="built_in">continue</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 执行备份</span></span><br><span class="line">    <span class="keyword">if</span> /tmp/incremental_backup.sh <span class="string">&quot;<span class="variable">$CONTAINER</span>&quot;</span> <span class="string">&quot;<span class="variable">$BACKUP_TYPE</span>&quot;</span>; <span class="keyword">then</span></span><br><span class="line">        log_message <span class="string">&quot;容器 <span class="variable">$CONTAINER</span> 备份成功&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        log_message <span class="string">&quot;错误: 容器 <span class="variable">$CONTAINER</span> 备份失败&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理旧备份</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$RETENTION_DAYS</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    log_message <span class="string">&quot;清理 <span class="variable">$RETENTION_DAYS</span> 天前的备份&quot;</span></span><br><span class="line">    find <span class="string">&quot;<span class="variable">$BACKUP_DIR</span>&quot;</span> -name <span class="string">&quot;*.tar.gz&quot;</span> -mtime +<span class="variable">$RETENTION_DAYS</span> -delete</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">log_message <span class="string">&quot;备份调度完成&quot;</span></span><br><span class="line">EOF</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">chmod</span> +x /tmp/backup_scheduler.sh</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建配置文件模板</span></span><br><span class="line">        <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span> &gt; /tmp/docker-backup.conf</span><br><span class="line"><span class="comment"># Docker备份配置文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 要备份的容器列表(空格分隔)</span></span><br><span class="line">CONTAINERS_TO_BACKUP=<span class="string">&quot;web-server database redis&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份类型: full, incremental</span></span><br><span class="line">BACKUP_TYPE=<span class="string">&quot;incremental&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份目录</span></span><br><span class="line">BACKUP_DIR=<span class="string">&quot;/opt/docker-backups&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份保留天数</span></span><br><span class="line">RETENTION_DAYS=30</span><br><span class="line">EOF</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建crontab条目</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;添加到crontab的示例条目:&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;# 每天凌晨2点执行增量备份&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;0 2 * * * /tmp/backup_scheduler.sh&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;# 每周日凌晨1点执行全量备份&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;0 1 * * 0 BACKUP_TYPE=full /tmp/backup_scheduler.sh&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;备份调度脚本已创建: /tmp/backup_scheduler.sh&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;配置文件模板: /tmp/docker-backup.conf&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    create_backup_scheduler</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">container_image_backup</span><br><span class="line">container_filesystem_backup</span><br><span class="line">incremental_backup_strategy</span><br><span class="line">automated_backup_scheduling</span><br></pre></td></tr></table></figure>

<h2 id="六、Docker网络配置"><a href="#六、Docker网络配置" class="headerlink" title="六、Docker网络配置"></a>六、Docker网络配置</h2><h3 id="6-1-网络驱动和模式"><a href="#6-1-网络驱动和模式" class="headerlink" title="6.1 网络驱动和模式"></a>6.1 网络驱动和模式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Docker网络配置脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Docker网络配置 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 网络驱动介绍</span></span><br><span class="line"><span class="function"><span class="title">network_drivers_overview</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. Docker网络驱动概览&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查看可用网络驱动</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;可用网络驱动:&quot;</span></span><br><span class="line">    docker network <span class="built_in">ls</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 默认网络详情</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\n默认bridge网络详情:&quot;</span></span><br><span class="line">    docker network inspect bridge</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\n网络驱动类型说明:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;- bridge: 默认网络驱动，适用于单主机容器通信&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;- host: 容器直接使用主机网络栈&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;- none: 禁用容器网络&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;- overlay: 用于跨主机容器通信(Swarm模式)&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;- macvlan: 为容器分配MAC地址，使其看起来像物理设备&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Bridge网络配置</span></span><br><span class="line"><span class="function"><span class="title">bridge_network_configuration</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;2. Bridge网络配置&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建自定义bridge网络</span></span><br><span class="line">    <span class="function"><span class="title">create_custom_bridge</span></span>() &#123;</span><br><span class="line">        <span class="built_in">local</span> network_name=<span class="string">&quot;custom-bridge&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;创建自定义bridge网络: <span class="variable">$network_name</span>&quot;</span></span><br><span class="line">        docker network create \</span><br><span class="line">            --driver bridge \</span><br><span class="line">            --subnet=172.20.0.0/16 \</span><br><span class="line">            --ip-range=172.20.240.0/20 \</span><br><span class="line">            --gateway=172.20.0.1 \</span><br><span class="line">            --opt <span class="string">&quot;com.docker.network.bridge.name&quot;</span>=<span class="string">&quot;docker1&quot;</span> \</span><br><span class="line">            --opt <span class="string">&quot;com.docker.network.driver.mtu&quot;</span>=<span class="string">&quot;1500&quot;</span> \</span><br><span class="line">            <span class="variable">$network_name</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 在自定义网络中运行容器</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;在自定义网络中运行容器:&quot;</span></span><br><span class="line">        docker run -d --name web1 --network <span class="variable">$network_name</span> nginx:latest</span><br><span class="line">        docker run -d --name web2 --network <span class="variable">$network_name</span> nginx:latest</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 测试容器间通信</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;测试容器间通信:&quot;</span></span><br><span class="line">        docker <span class="built_in">exec</span> web1 ping -c 3 web2</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 查看网络详情</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;网络详情:&quot;</span></span><br><span class="line">        docker network inspect <span class="variable">$network_name</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 清理</span></span><br><span class="line">        docker <span class="built_in">rm</span> -f web1 web2</span><br><span class="line">        docker network <span class="built_in">rm</span> <span class="variable">$network_name</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    create_custom_bridge</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Host网络模式</span></span><br><span class="line"><span class="function"><span class="title">host_network_mode</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;3. Host网络模式&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 使用host网络运行容器</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;使用host网络运行nginx:&quot;</span></span><br><span class="line">    docker run -d --name nginx-host --network host nginx:latest</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查网络配置</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;容器网络配置:&quot;</span></span><br><span class="line">    docker <span class="built_in">exec</span> nginx-host ip addr show</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查端口监听</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;端口监听情况:&quot;</span></span><br><span class="line">    docker <span class="built_in">exec</span> nginx-host netstat -tlnp</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 从主机访问服务</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;从主机访问服务:&quot;</span></span><br><span class="line">    curl -I http://localhost:80 || <span class="built_in">echo</span> <span class="string">&quot;nginx可能未在80端口监听&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 清理</span></span><br><span class="line">    docker <span class="built_in">rm</span> -f nginx-host</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器网络连接管理</span></span><br><span class="line"><span class="function"><span class="title">container_network_connection</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;4. 容器网络连接管理&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建多个网络</span></span><br><span class="line">    docker network create frontend</span><br><span class="line">    docker network create backend</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 运行容器</span></span><br><span class="line">    docker run -d --name web --network frontend nginx:latest</span><br><span class="line">    docker run -d --name app --network backend alpine <span class="built_in">sleep</span> 3600</span><br><span class="line">    docker run -d --name db --network backend postgres:13 \</span><br><span class="line">        -e POSTGRES_PASSWORD=password</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将web容器连接到backend网络</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;将web容器连接到backend网络:&quot;</span></span><br><span class="line">    docker network connect backend web</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查看容器网络连接</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;web容器网络连接:&quot;</span></span><br><span class="line">    docker inspect web --format=<span class="string">&#x27;&#123;&#123;range $net, $conf := .NetworkSettings.Networks&#125;&#125;&#123;&#123;$net&#125;&#125;: &#123;&#123;$conf.IPAddress&#125;&#125; &#123;&#123;end&#125;&#125;&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 测试跨网络通信</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;测试跨网络通信:&quot;</span></span><br><span class="line">    docker <span class="built_in">exec</span> web ping -c 3 app</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 断开网络连接</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;断开web容器与backend网络的连接:&quot;</span></span><br><span class="line">    docker network disconnect backend web</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 清理</span></span><br><span class="line">    docker <span class="built_in">rm</span> -f web app db</span><br><span class="line">    docker network <span class="built_in">rm</span> frontend backend</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">network_drivers_overview</span><br><span class="line">bridge_network_configuration</span><br><span class="line">host_network_mode</span><br><span class="line">container_network_connection</span><br></pre></td></tr></table></figure>

<h3 id="6-2-网络安全和隔离"><a href="#6-2-网络安全和隔离" class="headerlink" title="6.2 网络安全和隔离"></a>6.2 网络安全和隔离</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Docker网络安全和隔离脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Docker网络安全和隔离 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 网络隔离策略</span></span><br><span class="line"><span class="function"><span class="title">network_isolation_strategy</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. 网络隔离策略&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建隔离的网络环境</span></span><br><span class="line">    <span class="function"><span class="title">create_isolated_environment</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;创建隔离的网络环境:&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建前端网络(DMZ)</span></span><br><span class="line">        docker network create \</span><br><span class="line">            --driver bridge \</span><br><span class="line">            --subnet=172.30.1.0/24 \</span><br><span class="line">            --opt <span class="string">&quot;com.docker.network.bridge.enable_icc&quot;</span>=<span class="string">&quot;false&quot;</span> \</span><br><span class="line">            frontend-dmz</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建后端网络(内部)</span></span><br><span class="line">        docker network create \</span><br><span class="line">            --driver bridge \</span><br><span class="line">            --subnet=172.30.2.0/24 \</span><br><span class="line">            --internal \</span><br><span class="line">            backend-internal</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建数据库网络(高度隔离)</span></span><br><span class="line">        docker network create \</span><br><span class="line">            --driver bridge \</span><br><span class="line">            --subnet=172.30.3.0/24 \</span><br><span class="line">            --internal \</span><br><span class="line">            database-secure</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;隔离网络创建完成&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 部署分层应用</span></span><br><span class="line">    <span class="function"><span class="title">deploy_layered_application</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;部署分层应用:&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Web层(前端DMZ)</span></span><br><span class="line">        docker run -d --name web-tier \</span><br><span class="line">            --network frontend-dmz \</span><br><span class="line">            -p 80:80 \</span><br><span class="line">            nginx:latest</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 应用层(后端内部)</span></span><br><span class="line">        docker run -d --name app-tier \</span><br><span class="line">            --network backend-internal \</span><br><span class="line">            alpine <span class="built_in">sleep</span> 3600</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 数据库层(高度隔离)</span></span><br><span class="line">        docker run -d --name db-tier \</span><br><span class="line">            --network database-secure \</span><br><span class="line">            -e POSTGRES_PASSWORD=securepassword \</span><br><span class="line">            postgres:13</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 连接web到backend(受控访问)</span></span><br><span class="line">        docker network connect backend-internal web-tier</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 连接app到database(受控访问)</span></span><br><span class="line">        docker network connect database-secure app-tier</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;分层应用部署完成&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    create_isolated_environment</span><br><span class="line">    deploy_layered_application</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 防火墙规则配置</span></span><br><span class="line"><span class="function"><span class="title">firewall_rules_configuration</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;2. 防火墙规则配置&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># iptables规则管理</span></span><br><span class="line">    <span class="function"><span class="title">configure_iptables_rules</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;配置iptables规则:&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 备份现有规则</span></span><br><span class="line">        <span class="built_in">sudo</span> iptables-save &gt; /tmp/iptables-backup-$(<span class="built_in">date</span> +%Y%m%d_%H%M%S)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Docker链规则</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Docker相关iptables规则:&quot;</span></span><br><span class="line">        <span class="built_in">sudo</span> iptables -L DOCKER -n</span><br><span class="line">        <span class="built_in">sudo</span> iptables -L DOCKER-USER -n</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 自定义规则示例</span></span><br><span class="line">        <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment"># 限制容器对外访问的iptables规则示例:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 阻止容器访问主机敏感端口</span></span><br><span class="line"><span class="built_in">sudo</span> iptables -I DOCKER-USER -p tcp --dport 22 -j DROP</span><br><span class="line"><span class="built_in">sudo</span> iptables -I DOCKER-USER -p tcp --dport 3306 -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许特定容器访问外部服务</span></span><br><span class="line"><span class="built_in">sudo</span> iptables -I DOCKER-USER -s 172.30.1.0/24 -p tcp --dport 443 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 阻止容器间未授权通信</span></span><br><span class="line"><span class="built_in">sudo</span> iptables -I DOCKER-USER -s 172.30.1.0/24 -d 172.30.3.0/24 -j DROP</span><br><span class="line">EOF</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    configure_iptables_rules</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器安全扫描</span></span><br><span class="line"><span class="function"><span class="title">container_security_scanning</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;3. 容器安全扫描&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 镜像安全扫描</span></span><br><span class="line">    <span class="function"><span class="title">scan_image_vulnerabilities</span></span>() &#123;</span><br><span class="line">        <span class="built_in">local</span> image=<span class="variable">$1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$image</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;用法: scan_image_vulnerabilities &lt;镜像名&gt;&quot;</span></span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;扫描镜像安全漏洞: <span class="variable">$image</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 使用Trivy扫描(如果安装)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">command</span> -v trivy &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">            trivy image <span class="variable">$image</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;安装Trivy进行安全扫描:&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 使用Docker Bench Security(如果可用)</span></span><br><span class="line">        <span class="keyword">if</span> [ -f <span class="string">&quot;/opt/docker-bench-security/docker-bench-security.sh&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;运行Docker Bench Security:&quot;</span></span><br><span class="line">            <span class="built_in">sudo</span> /opt/docker-bench-security/docker-bench-security.sh</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;安装Docker Bench Security:&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;git clone https://github.com/docker/docker-bench-security.git /opt/docker-bench-security&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;安全扫描函数已定义:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;scan_image_vulnerabilities &lt;镜像名&gt;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">network_isolation_strategy</span><br><span class="line">firewall_rules_configuration</span><br><span class="line">container_security_scanning</span><br></pre></td></tr></table></figure>

<h2 id="七、Docker-Compose多容器编排"><a href="#七、Docker-Compose多容器编排" class="headerlink" title="七、Docker Compose多容器编排"></a>七、Docker Compose多容器编排</h2><h3 id="7-1-Compose文件编写"><a href="#7-1-Compose文件编写" class="headerlink" title="7.1 Compose文件编写"></a>7.1 Compose文件编写</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml - 完整的Web应用栈示例</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="comment"># 反向代理</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">web-proxy</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;443:443&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx/nginx.conf:/etc/nginx/nginx.conf:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx/ssl:/etc/nginx/ssl:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">web-static:/var/www/html</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost/health&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Web应用</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./web</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">NODE_ENV=production</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">web-app</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NODE_ENV=production</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DATABASE_URL=postgresql://user:password@db:5432/appdb</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REDIS_URL=redis://redis:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">web-static:/app/public</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logs:/app/logs</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="attr">db:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">service_healthy</span></span><br><span class="line">      <span class="attr">redis:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">service_started</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">frontend</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">cpus:</span> <span class="string">&#x27;1.0&#x27;</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">512M</span></span><br><span class="line">        <span class="attr">reservations:</span></span><br><span class="line">          <span class="attr">cpus:</span> <span class="string">&#x27;0.5&#x27;</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">256M</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 数据库</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:13-alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">database</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_DB=appdb</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_USER=user</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_PASSWORD_FILE=/run/secrets/db_password</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db-data:/var/lib/postgresql/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./db/init:/docker-entrypoint-initdb.d:ro</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">secrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db_password</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD-SHELL&quot;</span>, <span class="string">&quot;pg_isready -U user -d appdb&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 缓存</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:6-alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">cache</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--appendonly</span> <span class="literal">yes</span> <span class="string">--requirepass</span> <span class="string">$&#123;REDIS_PASSWORD&#125;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-data:/data</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;redis-cli&quot;</span>, <span class="string">&quot;ping&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">3s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 监控</span></span><br><span class="line">  <span class="attr">prometheus:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">prom/prometheus:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">monitoring</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9090:9090&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">prometheus-data:/prometheus</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;--config.file=/etc/prometheus/prometheus.yml&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;--storage.tsdb.path=/prometheus&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;--web.console.libraries=/etc/prometheus/console_libraries&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;--web.console.templates=/etc/prometheus/consoles&#x27;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">monitoring</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">frontend:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line">    <span class="attr">ipam:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">subnet:</span> <span class="number">172.20</span><span class="number">.1</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">  <span class="attr">backend:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line">    <span class="attr">internal:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">ipam:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">subnet:</span> <span class="number">172.20</span><span class="number">.2</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">  <span class="attr">monitoring:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line">    <span class="attr">ipam:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">subnet:</span> <span class="number">172.20</span><span class="number">.3</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">db-data:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">redis-data:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">web-static:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">prometheus-data:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line"></span><br><span class="line"><span class="attr">secrets:</span></span><br><span class="line">  <span class="attr">db_password:</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">./secrets/db_password.txt</span></span><br></pre></td></tr></table></figure>

<h3 id="7-2-Compose管理脚本"><a href="#7-2-Compose管理脚本" class="headerlink" title="7.2 Compose管理脚本"></a>7.2 Compose管理脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Docker Compose管理脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Docker Compose管理 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Compose项目管理</span></span><br><span class="line"><span class="function"><span class="title">compose_project_management</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. Compose项目管理&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 项目初始化</span></span><br><span class="line">    <span class="function"><span class="title">init_compose_project</span></span>() &#123;</span><br><span class="line">        <span class="built_in">local</span> project_name=<span class="variable">$1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$project_name</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;用法: init_compose_project &lt;项目名&gt;&quot;</span></span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;初始化Compose项目: <span class="variable">$project_name</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建项目目录结构</span></span><br><span class="line">        <span class="built_in">mkdir</span> -p <span class="variable">$project_name</span>/&#123;web,db,nginx,monitoring,secrets,logs&#125;</span><br><span class="line">        <span class="built_in">cd</span> <span class="variable">$project_name</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建环境变量文件</span></span><br><span class="line">        <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span> &gt; .<span class="built_in">env</span></span><br><span class="line"><span class="comment"># 项目配置</span></span><br><span class="line">COMPOSE_PROJECT_NAME=myapp</span><br><span class="line">COMPOSE_FILE=docker-compose.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库配置</span></span><br><span class="line">POSTGRES_DB=appdb</span><br><span class="line">POSTGRES_USER=user</span><br><span class="line">POSTGRES_PASSWORD=changeme</span><br><span class="line"></span><br><span class="line"><span class="comment"># Redis配置</span></span><br><span class="line">REDIS_PASSWORD=changeme</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用配置</span></span><br><span class="line">NODE_ENV=production</span><br><span class="line">APP_PORT=3000</span><br><span class="line">EOF</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建密钥文件</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;supersecretpassword&quot;</span> &gt; secrets/db_password.txt</span><br><span class="line">        <span class="built_in">chmod</span> 600 secrets/db_password.txt</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建基本的docker-compose.yml</span></span><br><span class="line">        <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span> &gt; docker-compose.yml</span><br><span class="line">version: <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  web:</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    restart: unless-stopped</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  default:</span><br><span class="line">    name: <span class="variable">$&#123;COMPOSE_PROJECT_NAME&#125;</span>_network</span><br><span class="line">EOF</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;项目初始化完成: <span class="variable">$project_name</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 项目部署</span></span><br><span class="line">    <span class="function"><span class="title">deploy_compose_project</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;部署Compose项目:&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查配置文件</span></span><br><span class="line">        <span class="keyword">if</span> [ ! -f <span class="string">&quot;docker-compose.yml&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;错误: 未找到docker-compose.yml文件&quot;</span></span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 验证配置</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;验证Compose配置:&quot;</span></span><br><span class="line">        docker-compose config</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 拉取镜像</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;拉取所需镜像:&quot;</span></span><br><span class="line">        docker-compose pull</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 构建自定义镜像</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;构建自定义镜像:&quot;</span></span><br><span class="line">        docker-compose build</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 启动服务</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;启动服务:&quot;</span></span><br><span class="line">        docker-compose up -d</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查服务状态</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;检查服务状态:&quot;</span></span><br><span class="line">        docker-compose ps</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 查看日志</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;查看服务日志:&quot;</span></span><br><span class="line">        docker-compose logs --<span class="built_in">tail</span>=50</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Compose项目管理函数已定义:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;init_compose_project &lt;项目名&gt;&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;deploy_compose_project&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务扩缩容管理</span></span><br><span class="line"><span class="function"><span class="title">service_scaling_management</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;2. 服务扩缩容管理&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 服务扩容</span></span><br><span class="line">    <span class="function"><span class="title">scale_service</span></span>() &#123;</span><br><span class="line">        <span class="built_in">local</span> service_name=<span class="variable">$1</span></span><br><span class="line">        <span class="built_in">local</span> replicas=<span class="variable">$2</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$service_name</span>&quot;</span> ] || [ -z <span class="string">&quot;<span class="variable">$replicas</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;用法: scale_service &lt;服务名&gt; &lt;副本数&gt;&quot;</span></span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;扩容服务 <span class="variable">$service_name</span> 到 <span class="variable">$replicas</span> 个副本&quot;</span></span><br><span class="line">        docker-compose up -d --scale <span class="variable">$service_name</span>=<span class="variable">$replicas</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查扩容结果</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;扩容后的服务状态:&quot;</span></span><br><span class="line">        docker-compose ps <span class="variable">$service_name</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 负载均衡配置</span></span><br><span class="line">    <span class="function"><span class="title">configure_load_balancer</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;配置负载均衡:&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建nginx负载均衡配置</span></span><br><span class="line">        <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span> &gt; nginx/nginx.conf</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    upstream web_backend &#123;</span><br><span class="line">        server web_1:3000;</span><br><span class="line">        server web_2:3000;</span><br><span class="line">        server web_3:3000;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        </span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://web_backend;</span><br><span class="line">            proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">            proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        location /health &#123;</span><br><span class="line">            access_log off;</span><br><span class="line">            <span class="built_in">return</span> 200 <span class="string">&quot;healthy\n&quot;</span>;</span><br><span class="line">            add_header Content-Type text/plain;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;负载均衡配置已创建&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;服务扩缩容函数已定义:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;scale_service &lt;服务名&gt; &lt;副本数&gt;&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;configure_load_balancer&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 环境管理</span></span><br><span class="line"><span class="function"><span class="title">environment_management</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;3. 环境管理&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 多环境配置</span></span><br><span class="line">    <span class="function"><span class="title">setup_multi_environment</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;设置多环境配置:&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 开发环境</span></span><br><span class="line">        <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span> &gt; docker-compose.dev.yml</span><br><span class="line">version: <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  web:</span><br><span class="line">    build:</span><br><span class="line">      context: ./web</span><br><span class="line">      target: development</span><br><span class="line">    volumes:</span><br><span class="line">      - ./web:/app</span><br><span class="line">      - /app/node_modules</span><br><span class="line">    environment:</span><br><span class="line">      - NODE_ENV=development</span><br><span class="line">      - DEBUG=*</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;3000:3000&quot;</span></span><br><span class="line">      - <span class="string">&quot;9229:9229&quot;</span>  <span class="comment"># Debug port</span></span><br><span class="line">EOF</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 测试环境</span></span><br><span class="line">        <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span> &gt; docker-compose.test.yml</span><br><span class="line">version: <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  web:</span><br><span class="line">    build:</span><br><span class="line">      context: ./web</span><br><span class="line">      target: <span class="built_in">test</span></span><br><span class="line">    environment:</span><br><span class="line">      - NODE_ENV=<span class="built_in">test</span></span><br><span class="line">      - CI=<span class="literal">true</span></span><br><span class="line">    <span class="built_in">command</span>: npm <span class="built_in">test</span></span><br><span class="line">EOF</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 生产环境</span></span><br><span class="line">        <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span> &gt; docker-compose.prod.yml</span><br><span class="line">version: <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  web:</span><br><span class="line">    build:</span><br><span class="line">      context: ./web</span><br><span class="line">      target: production</span><br><span class="line">    environment:</span><br><span class="line">      - NODE_ENV=production</span><br><span class="line">    deploy:</span><br><span class="line">      replicas: 3</span><br><span class="line">      resources:</span><br><span class="line">        limits:</span><br><span class="line">          cpus: <span class="string">&#x27;0.5&#x27;</span></span><br><span class="line">          memory: 512M</span><br><span class="line">      restart_policy:</span><br><span class="line">        condition: on-failure</span><br><span class="line">        delay: 5s</span><br><span class="line">        max_attempts: 3</span><br><span class="line">EOF</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;多环境配置文件已创建&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 环境切换</span></span><br><span class="line">    <span class="function"><span class="title">switch_environment</span></span>() &#123;</span><br><span class="line">        <span class="built_in">local</span> <span class="built_in">env</span>=<span class="variable">$1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$env</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">            dev|development)</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;切换到开发环境&quot;</span></span><br><span class="line">                <span class="built_in">export</span> COMPOSE_FILE=<span class="string">&quot;docker-compose.yml:docker-compose.dev.yml&quot;</span></span><br><span class="line">                ;;</span><br><span class="line">            <span class="built_in">test</span>)</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;切换到测试环境&quot;</span></span><br><span class="line">                <span class="built_in">export</span> COMPOSE_FILE=<span class="string">&quot;docker-compose.yml:docker-compose.test.yml&quot;</span></span><br><span class="line">                ;;</span><br><span class="line">            prod|production)</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;切换到生产环境&quot;</span></span><br><span class="line">                <span class="built_in">export</span> COMPOSE_FILE=<span class="string">&quot;docker-compose.yml:docker-compose.prod.yml&quot;</span></span><br><span class="line">                ;;</span><br><span class="line">            *)</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;不支持的环境: <span class="variable">$env</span>&quot;</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;支持的环境: dev, test, prod&quot;</span></span><br><span class="line">                <span class="built_in">return</span> 1</span><br><span class="line">                ;;</span><br><span class="line">        <span class="keyword">esac</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;当前Compose文件: <span class="variable">$COMPOSE_FILE</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    setup_multi_environment</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;环境管理函数已定义:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;switch_environment &lt;环境名&gt;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">compose_project_management</span><br><span class="line">service_scaling_management</span><br><span class="line">environment_management</span><br></pre></td></tr></table></figure>

<h2 id="八、生产环境部署与运维"><a href="#八、生产环境部署与运维" class="headerlink" title="八、生产环境部署与运维"></a>八、生产环境部署与运维</h2><h3 id="8-1-生产环境最佳实践"><a href="#8-1-生产环境最佳实践" class="headerlink" title="8.1 生产环境最佳实践"></a>8.1 生产环境最佳实践</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 生产环境Docker部署脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 生产环境Docker部署 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生产环境安全配置</span></span><br><span class="line"><span class="function"><span class="title">production_security_setup</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. 生产环境安全配置&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Docker守护进程安全配置</span></span><br><span class="line">    <span class="function"><span class="title">configure_docker_daemon_security</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;配置Docker守护进程安全:&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建安全的daemon.json</span></span><br><span class="line">        <span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line">        <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;hosts&quot;</span>: [<span class="string">&quot;unix:///var/run/docker.sock&quot;</span>],</span><br><span class="line">  <span class="string">&quot;tls&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;tlscert&quot;</span>: <span class="string">&quot;/etc/docker/certs/server-cert.pem&quot;</span>,</span><br><span class="line">  <span class="string">&quot;tlskey&quot;</span>: <span class="string">&quot;/etc/docker/certs/server-key.pem&quot;</span>,</span><br><span class="line">  <span class="string">&quot;tlsverify&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;tlscacert&quot;</span>: <span class="string">&quot;/etc/docker/certs/ca.pem&quot;</span>,</span><br><span class="line">  <span class="string">&quot;storage-driver&quot;</span>: <span class="string">&quot;overlay2&quot;</span>,</span><br><span class="line">  <span class="string">&quot;log-driver&quot;</span>: <span class="string">&quot;json-file&quot;</span>,</span><br><span class="line">  <span class="string">&quot;log-opts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;max-size&quot;</span>: <span class="string">&quot;10m&quot;</span>,</span><br><span class="line">    <span class="string">&quot;max-file&quot;</span>: <span class="string">&quot;3&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;live-restore&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;userland-proxy&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;no-new-privileges&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;seccomp-profile&quot;</span>: <span class="string">&quot;/etc/docker/seccomp.json&quot;</span>,</span><br><span class="line">  <span class="string">&quot;userns-remap&quot;</span>: <span class="string">&quot;default&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 重启Docker服务</span></span><br><span class="line">        <span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line">        <span class="built_in">sudo</span> systemctl restart docker</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Docker守护进程安全配置完成&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 容器运行时安全</span></span><br><span class="line">    <span class="function"><span class="title">configure_container_runtime_security</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;配置容器运行时安全:&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建安全的容器运行脚本</span></span><br><span class="line">        <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span> &gt; /tmp/secure_container_run.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 安全的容器运行脚本</span></span><br><span class="line"></span><br><span class="line">IMAGE=<span class="variable">$1</span></span><br><span class="line">CONTAINER_NAME=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$IMAGE</span>&quot;</span> ] || [ -z <span class="string">&quot;<span class="variable">$CONTAINER_NAME</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;用法: <span class="variable">$0</span> &lt;镜像名&gt; &lt;容器名&gt;&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安全参数运行容器</span></span><br><span class="line">docker run -d \</span><br><span class="line">    --name <span class="string">&quot;<span class="variable">$CONTAINER_NAME</span>&quot;</span> \</span><br><span class="line">    --read-only \</span><br><span class="line">    --tmpfs /tmp:rw,noexec,nosuid,size=100m \</span><br><span class="line">    --tmpfs /var/run:rw,noexec,nosuid,size=50m \</span><br><span class="line">    --no-new-privileges \</span><br><span class="line">    --cap-drop ALL \</span><br><span class="line">    --cap-add NET_BIND_SERVICE \</span><br><span class="line">    --security-opt no-new-privileges:<span class="literal">true</span> \</span><br><span class="line">    --security-opt seccomp=unconfined \</span><br><span class="line">    --user 1000:1000 \</span><br><span class="line">    --memory 512m \</span><br><span class="line">    --cpus 0.5 \</span><br><span class="line">    --restart unless-stopped \</span><br><span class="line">    <span class="string">&quot;<span class="variable">$IMAGE</span>&quot;</span></span><br><span class="line">EOF</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">chmod</span> +x /tmp/secure_container_run.sh</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;安全容器运行脚本已创建: /tmp/secure_container_run.sh&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    configure_docker_daemon_security</span><br><span class="line">    configure_container_runtime_security</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控和日志配置</span></span><br><span class="line"><span class="function"><span class="title">monitoring_logging_setup</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;2. 监控和日志配置&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 容器监控配置</span></span><br><span class="line">    <span class="function"><span class="title">setup_container_monitoring</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;设置容器监控:&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建监控docker-compose.yml</span></span><br><span class="line">        <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span> &gt; monitoring-stack.yml</span><br><span class="line">version: <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  prometheus:</span><br><span class="line">    image: prom/prometheus:latest</span><br><span class="line">    container_name: prometheus</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;9090:9090&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro</span><br><span class="line">      - prometheus-data:/prometheus</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - <span class="string">&#x27;--config.file=/etc/prometheus/prometheus.yml&#x27;</span></span><br><span class="line">      - <span class="string">&#x27;--storage.tsdb.path=/prometheus&#x27;</span></span><br><span class="line">      - <span class="string">&#x27;--web.console.libraries=/etc/prometheus/console_libraries&#x27;</span></span><br><span class="line">      - <span class="string">&#x27;--web.console.templates=/etc/prometheus/consoles&#x27;</span></span><br><span class="line">      - <span class="string">&#x27;--storage.tsdb.retention.time=30d&#x27;</span></span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    networks:</span><br><span class="line">      - monitoring</span><br><span class="line"></span><br><span class="line">  grafana:</span><br><span class="line">    image: grafana/grafana:latest</span><br><span class="line">    container_name: grafana</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;3000:3000&quot;</span></span><br><span class="line">    environment:</span><br><span class="line">      - GF_SECURITY_ADMIN_PASSWORD=admin123</span><br><span class="line">      - GF_USERS_ALLOW_SIGN_UP=<span class="literal">false</span></span><br><span class="line">    volumes:</span><br><span class="line">      - grafana-data:/var/lib/grafana</span><br><span class="line">      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro</span><br><span class="line">      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    networks:</span><br><span class="line">      - monitoring</span><br><span class="line"></span><br><span class="line">  node-exporter:</span><br><span class="line">    image: prom/node-exporter:latest</span><br><span class="line">    container_name: node-exporter</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;9100:9100&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /proc:/host/proc:ro</span><br><span class="line">      - /sys:/host/sys:ro</span><br><span class="line">      - /:/rootfs:ro</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - <span class="string">&#x27;--path.procfs=/host/proc&#x27;</span></span><br><span class="line">      - <span class="string">&#x27;--path.sysfs=/host/sys&#x27;</span></span><br><span class="line">      - <span class="string">&#x27;--collector.filesystem.ignored-mount-points=^/(sys|proc|dev|host|etc)($$|/)&#x27;</span></span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    networks:</span><br><span class="line">      - monitoring</span><br><span class="line"></span><br><span class="line">  cadvisor:</span><br><span class="line">    image: gcr.io/cadvisor/cadvisor:latest</span><br><span class="line">    container_name: cadvisor</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /:/rootfs:ro</span><br><span class="line">      - /var/run:/var/run:rw</span><br><span class="line">      - /sys:/sys:ro</span><br><span class="line">      - /var/lib/docker/:/var/lib/docker:ro</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    networks:</span><br><span class="line">      - monitoring</span><br><span class="line"></span><br><span class="line">volumes:</span><br><span class="line">  prometheus-data:</span><br><span class="line">  grafana-data:</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  monitoring:</span><br><span class="line">    driver: bridge</span><br><span class="line">EOF</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;监控栈配置已创建&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 日志聚合配置</span></span><br><span class="line">    <span class="function"><span class="title">setup_log_aggregation</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;设置日志聚合:&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ELK Stack配置</span></span><br><span class="line">        <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span> &gt; logging-stack.yml</span><br><span class="line">version: <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  elasticsearch:</span><br><span class="line">    image: docker.elastic.co/elasticsearch/elasticsearch:7.15.0</span><br><span class="line">    container_name: elasticsearch</span><br><span class="line">    environment:</span><br><span class="line">      - discovery.type=single-node</span><br><span class="line">      - <span class="string">&quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - elasticsearch-data:/usr/share/elasticsearch/data</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;9200:9200&quot;</span></span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    networks:</span><br><span class="line">      - logging</span><br><span class="line"></span><br><span class="line">  logstash:</span><br><span class="line">    image: docker.elastic.co/logstash/logstash:7.15.0</span><br><span class="line">    container_name: logstash</span><br><span class="line">    volumes:</span><br><span class="line">      - ./logging/logstash.conf:/usr/share/logstash/pipeline/logstash.conf:ro</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;5044:5044&quot;</span></span><br><span class="line">    depends_on:</span><br><span class="line">      - elasticsearch</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    networks:</span><br><span class="line">      - logging</span><br><span class="line"></span><br><span class="line">  kibana:</span><br><span class="line">    image: docker.elastic.co/kibana/kibana:7.15.0</span><br><span class="line">    container_name: kibana</span><br><span class="line">    environment:</span><br><span class="line">      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;5601:5601&quot;</span></span><br><span class="line">    depends_on:</span><br><span class="line">      - elasticsearch</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    networks:</span><br><span class="line">      - logging</span><br><span class="line"></span><br><span class="line">  filebeat:</span><br><span class="line">    image: docker.elastic.co/beats/filebeat:7.15.0</span><br><span class="line">    container_name: filebeat</span><br><span class="line">    user: root</span><br><span class="line">    volumes:</span><br><span class="line">      - ./logging/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro</span><br><span class="line">      - /var/lib/docker/containers:/var/lib/docker/containers:ro</span><br><span class="line">      - /var/run/docker.sock:/var/run/docker.sock:ro</span><br><span class="line">    depends_on:</span><br><span class="line">      - logstash</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    networks:</span><br><span class="line">      - logging</span><br><span class="line"></span><br><span class="line">volumes:</span><br><span class="line">  elasticsearch-data:</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  logging:</span><br><span class="line">    driver: bridge</span><br><span class="line">EOF</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;日志聚合配置已创建&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    setup_container_monitoring</span><br><span class="line">    setup_log_aggregation</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">production_security_setup</span><br><span class="line">monitoring_logging_setup</span><br></pre></td></tr></table></figure>

<h3 id="8-2-故障排查与维护"><a href="#8-2-故障排查与维护" class="headerlink" title="8.2 故障排查与维护"></a>8.2 故障排查与维护</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Docker故障排查与维护脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Docker故障排查与维护 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 常见问题诊断</span></span><br><span class="line"><span class="function"><span class="title">common_issues_diagnosis</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. 常见问题诊断&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 系统资源检查</span></span><br><span class="line">    <span class="function"><span class="title">check_system_resources</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;检查系统资源:&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 磁盘空间</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;磁盘空间使用情况:&quot;</span></span><br><span class="line">        <span class="built_in">df</span> -h</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Docker磁盘使用</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Docker磁盘使用情况:&quot;</span></span><br><span class="line">        docker system <span class="built_in">df</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 内存使用</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;内存使用情况:&quot;</span></span><br><span class="line">        free -h</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># CPU使用</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;CPU使用情况:&quot;</span></span><br><span class="line">        top -bn1 | <span class="built_in">head</span> -5</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Docker守护进程状态</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Docker守护进程状态:&quot;</span></span><br><span class="line">        systemctl status docker</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 容器健康检查</span></span><br><span class="line">    <span class="function"><span class="title">check_container_health</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;检查容器健康状态:&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 运行中的容器</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;运行中的容器:&quot;</span></span><br><span class="line">        docker ps --format <span class="string">&quot;table &#123;&#123;.Names&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.Ports&#125;&#125;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 退出的容器</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;退出的容器:&quot;</span></span><br><span class="line">        docker ps -a --filter <span class="string">&quot;status=exited&quot;</span> --format <span class="string">&quot;table &#123;&#123;.Names&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.ExitCode&#125;&#125;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 容器资源使用</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;容器资源使用:&quot;</span></span><br><span class="line">        docker stats --no-stream --format <span class="string">&quot;table &#123;&#123;.Container&#125;&#125;\t&#123;&#123;.CPUPerc&#125;&#125;\t&#123;&#123;.MemUsage&#125;&#125;\t&#123;&#123;.NetIO&#125;&#125;\t&#123;&#123;.BlockIO&#125;&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 网络连接检查</span></span><br><span class="line">    <span class="function"><span class="title">check_network_connectivity</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;检查网络连接:&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Docker网络列表</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Docker网络列表:&quot;</span></span><br><span class="line">        docker network <span class="built_in">ls</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 端口监听</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;端口监听情况:&quot;</span></span><br><span class="line">        netstat -tlnp | grep docker</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># DNS解析测试</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;DNS解析测试:&quot;</span></span><br><span class="line">        nslookup google.com</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    check_system_resources</span><br><span class="line">    check_container_health</span><br><span class="line">    check_network_connectivity</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志分析</span></span><br><span class="line"><span class="function"><span class="title">log_analysis</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;2. 日志分析&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Docker守护进程日志</span></span><br><span class="line">    <span class="function"><span class="title">analyze_docker_daemon_logs</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;分析Docker守护进程日志:&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 系统日志中的Docker信息</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;最近的Docker守护进程日志:&quot;</span></span><br><span class="line">        journalctl -u docker.service --since <span class="string">&quot;1 hour ago&quot;</span> --no-pager</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 错误日志</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Docker错误日志:&quot;</span></span><br><span class="line">        journalctl -u docker.service -p err --since <span class="string">&quot;1 day ago&quot;</span> --no-pager</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 容器日志分析</span></span><br><span class="line">    <span class="function"><span class="title">analyze_container_logs</span></span>() &#123;</span><br><span class="line">        <span class="built_in">local</span> container_name=<span class="variable">$1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$container_name</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;用法: analyze_container_logs &lt;容器名&gt;&quot;</span></span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;分析容器日志: <span class="variable">$container_name</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 最近的日志</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;最近的容器日志:&quot;</span></span><br><span class="line">        docker logs --since 1h <span class="variable">$container_name</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 错误日志</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;容器错误日志:&quot;</span></span><br><span class="line">        docker logs <span class="variable">$container_name</span> 2&gt;&amp;1 | grep -i error</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 日志统计</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;日志统计:&quot;</span></span><br><span class="line">        docker logs <span class="variable">$container_name</span> 2&gt;&amp;1 | <span class="built_in">wc</span> -l</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    analyze_docker_daemon_logs</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;容器日志分析函数已定义:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;analyze_container_logs &lt;容器名&gt;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 性能优化</span></span><br><span class="line"><span class="function"><span class="title">performance_optimization</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;3. 性能优化&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 镜像优化</span></span><br><span class="line">    <span class="function"><span class="title">optimize_images</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;镜像优化建议:&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 查找大镜像</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;最大的镜像:&quot;</span></span><br><span class="line">        docker images --format <span class="string">&quot;table &#123;&#123;.Repository&#125;&#125;\t&#123;&#123;.Tag&#125;&#125;\t&#123;&#123;.Size&#125;&#125;&quot;</span> | <span class="built_in">sort</span> -k3 -hr | <span class="built_in">head</span> -10</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 查找悬空镜像</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;悬空镜像:&quot;</span></span><br><span class="line">        docker images -f <span class="string">&quot;dangling=true&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 清理建议</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;清理建议:&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;1. 删除悬空镜像: docker image prune&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;2. 删除未使用镜像: docker image prune -a&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;3. 使用多阶段构建减小镜像大小&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;4. 使用.dockerignore文件&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 容器优化</span></span><br><span class="line">    <span class="function"><span class="title">optimize_containers</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;容器优化建议:&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 资源限制检查</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;检查容器资源限制:&quot;</span></span><br><span class="line">        docker ps --format <span class="string">&quot;table &#123;&#123;.Names&#125;&#125;&quot;</span> | <span class="built_in">tail</span> -n +2 | <span class="keyword">while</span> <span class="built_in">read</span> container; <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;容器: <span class="variable">$container</span>&quot;</span></span><br><span class="line">            docker inspect <span class="variable">$container</span> --format <span class="string">&#x27;&#123;&#123;.HostConfig.Memory&#125;&#125;&#x27;</span> | sed <span class="string">&#x27;s/0/无内存限制/&#x27;</span></span><br><span class="line">            docker inspect <span class="variable">$container</span> --format <span class="string">&#x27;&#123;&#123;.HostConfig.CpuShares&#125;&#125;&#x27;</span> | sed <span class="string">&#x27;s/0/无CPU限制/&#x27;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;优化建议:&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;1. 为容器设置适当的资源限制&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;2. 使用健康检查&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;3. 配置重启策略&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;4. 避免在容器中运行多个进程&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    optimize_images</span><br><span class="line">    optimize_containers</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">common_issues_diagnosis</span><br><span class="line">log_analysis</span><br><span class="line">performance_optimization</span><br></pre></td></tr></table></figure>

<h2 id="九、Docker最佳实践总结"><a href="#九、Docker最佳实践总结" class="headerlink" title="九、Docker最佳实践总结"></a>九、Docker最佳实践总结</h2><h3 id="9-1-开发最佳实践"><a href="#9-1-开发最佳实践" class="headerlink" title="9.1 开发最佳实践"></a>9.1 开发最佳实践</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Docker开发最佳实践脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Docker开发最佳实践 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Dockerfile最佳实践</span></span><br><span class="line"><span class="function"><span class="title">dockerfile_best_practices</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. Dockerfile最佳实践&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">Dockerfile编写最佳实践:</span><br><span class="line"></span><br><span class="line">1. 使用官方基础镜像</span><br><span class="line">   FROM node:16-alpine</span><br><span class="line"></span><br><span class="line">2. 合并RUN指令减少层数</span><br><span class="line">   RUN apt-get update &amp;&amp; apt-get install -y \</span><br><span class="line">       package1 \</span><br><span class="line">       package2 &amp;&amp; \</span><br><span class="line">       <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span><br><span class="line"></span><br><span class="line">3. 利用构建缓存</span><br><span class="line">   COPY package*.json ./</span><br><span class="line">   RUN npm install</span><br><span class="line">   COPY . .</span><br><span class="line"></span><br><span class="line">4. 使用多阶段构建</span><br><span class="line">   FROM node:16 AS builder</span><br><span class="line">   <span class="comment"># 构建阶段</span></span><br><span class="line">   FROM node:16-alpine AS runtime</span><br><span class="line">   <span class="comment"># 运行阶段</span></span><br><span class="line"></span><br><span class="line">5. 设置非root用户</span><br><span class="line">   RUN addgroup -g 1001 -S nodejs</span><br><span class="line">   RUN adduser -S nextjs -u 1001</span><br><span class="line">   USER nextjs</span><br><span class="line"></span><br><span class="line">6. 使用.dockerignore</span><br><span class="line">   node_modules</span><br><span class="line">   .git</span><br><span class="line">   *.md</span><br><span class="line"></span><br><span class="line">7. 添加健康检查</span><br><span class="line">   HEALTHCHECK --interval=30s --<span class="built_in">timeout</span>=3s \</span><br><span class="line">     CMD curl -f http://localhost/ || <span class="built_in">exit</span> 1</span><br><span class="line"></span><br><span class="line">8. 设置适当的标签</span><br><span class="line">   LABEL maintainer=<span class="string">&quot;your-email@example.com&quot;</span></span><br><span class="line">   LABEL version=<span class="string">&quot;1.0&quot;</span></span><br><span class="line">EOF</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安全最佳实践</span></span><br><span class="line"><span class="function"><span class="title">security_best_practices</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;2. 安全最佳实践&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">Docker安全最佳实践:</span><br><span class="line"></span><br><span class="line">1. 使用最新的基础镜像</span><br><span class="line">   - 定期更新基础镜像</span><br><span class="line">   - 使用官方镜像</span><br><span class="line">   - 扫描镜像漏洞</span><br><span class="line"></span><br><span class="line">2. 最小权限原则</span><br><span class="line">   - 不使用root用户运行容器</span><br><span class="line">   - 删除不必要的权限</span><br><span class="line">   - 使用只读文件系统</span><br><span class="line"></span><br><span class="line">3. 网络安全</span><br><span class="line">   - 使用自定义网络</span><br><span class="line">   - 限制容器间通信</span><br><span class="line">   - 配置防火墙规则</span><br><span class="line"></span><br><span class="line">4. 密钥管理</span><br><span class="line">   - 使用Docker secrets</span><br><span class="line">   - 不在镜像中存储密钥</span><br><span class="line">   - 使用环境变量注入密钥</span><br><span class="line"></span><br><span class="line">5. 资源限制</span><br><span class="line">   - 设置内存限制</span><br><span class="line">   - 设置CPU限制</span><br><span class="line">   - 限制文件描述符数量</span><br><span class="line"></span><br><span class="line">6. 日志安全</span><br><span class="line">   - 不在日志中记录敏感信息</span><br><span class="line">   - 配置日志轮转</span><br><span class="line">   - 集中化日志管理</span><br><span class="line">EOF</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 性能最佳实践</span></span><br><span class="line"><span class="function"><span class="title">performance_best_practices</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;3. 性能最佳实践&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">Docker性能最佳实践:</span><br><span class="line"></span><br><span class="line">1. 镜像优化</span><br><span class="line">   - 使用Alpine Linux基础镜像</span><br><span class="line">   - 多阶段构建</span><br><span class="line">   - 删除不必要的文件</span><br><span class="line">   - 压缩镜像层</span><br><span class="line"></span><br><span class="line">2. 容器配置</span><br><span class="line">   - 设置适当的资源限制</span><br><span class="line">   - 使用健康检查</span><br><span class="line">   - 配置重启策略</span><br><span class="line">   - 避免特权模式</span><br><span class="line"></span><br><span class="line">3. 存储优化</span><br><span class="line">   - 使用数据卷存储持久数据</span><br><span class="line">   - 选择合适的存储驱动</span><br><span class="line">   - 定期清理无用数据</span><br><span class="line">   - 使用tmpfs存储临时数据</span><br><span class="line"></span><br><span class="line">4. 网络优化</span><br><span class="line">   - 使用host网络模式(适当时)</span><br><span class="line">   - 优化网络驱动选择</span><br><span class="line">   - 减少网络跳数</span><br><span class="line">   - 使用负载均衡</span><br><span class="line"></span><br><span class="line">5. 监控和调优</span><br><span class="line">   - 监控容器资源使用</span><br><span class="line">   - 分析性能瓶颈</span><br><span class="line">   - 优化应用程序</span><br><span class="line">   - 使用性能分析工具</span><br><span class="line">EOF</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dockerfile_best_practices</span><br><span class="line">security_best_practices</span><br><span class="line">performance_best_practices</span><br></pre></td></tr></table></figure>

<h3 id="9-2-运维最佳实践"><a href="#9-2-运维最佳实践" class="headerlink" title="9.2 运维最佳实践"></a>9.2 运维最佳实践</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Docker运维最佳实践脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Docker运维最佳实践 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署策略</span></span><br><span class="line"><span class="function"><span class="title">deployment_strategies</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. 部署策略&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">Docker部署策略:</span><br><span class="line"></span><br><span class="line">1. 蓝绿部署</span><br><span class="line">   - 维护两个相同的生产环境</span><br><span class="line">   - 零停机时间部署</span><br><span class="line">   - 快速回滚能力</span><br><span class="line"></span><br><span class="line">2. 滚动更新</span><br><span class="line">   - 逐步替换旧版本容器</span><br><span class="line">   - 保持服务可用性</span><br><span class="line">   - 渐进式部署</span><br><span class="line"></span><br><span class="line">3. 金丝雀部署</span><br><span class="line">   - 小规模测试新版本</span><br><span class="line">   - 风险控制</span><br><span class="line">   - 逐步扩大部署范围</span><br><span class="line"></span><br><span class="line">4. A/B测试部署</span><br><span class="line">   - 同时运行多个版本</span><br><span class="line">   - 基于用户特征路由</span><br><span class="line">   - 数据驱动决策</span><br><span class="line">EOF</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控策略</span></span><br><span class="line"><span class="function"><span class="title">monitoring_strategies</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;2. 监控策略&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">Docker监控策略:</span><br><span class="line"></span><br><span class="line">1. 基础设施监控</span><br><span class="line">   - 主机资源监控</span><br><span class="line">   - Docker守护进程监控</span><br><span class="line">   - 网络监控</span><br><span class="line">   - 存储监控</span><br><span class="line"></span><br><span class="line">2. 容器监控</span><br><span class="line">   - 容器资源使用</span><br><span class="line">   - 容器健康状态</span><br><span class="line">   - 容器生命周期</span><br><span class="line">   - 容器性能指标</span><br><span class="line"></span><br><span class="line">3. 应用监控</span><br><span class="line">   - 应用性能监控(APM)</span><br><span class="line">   - 业务指标监控</span><br><span class="line">   - 用户体验监控</span><br><span class="line">   - 错误率监控</span><br><span class="line"></span><br><span class="line">4. 日志监控</span><br><span class="line">   - 集中化日志收集</span><br><span class="line">   - 日志分析和告警</span><br><span class="line">   - 日志保留策略</span><br><span class="line">   - 安全日志审计</span><br><span class="line">EOF</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份策略</span></span><br><span class="line"><span class="function"><span class="title">backup_strategies</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;3. 备份策略&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">Docker备份策略:</span><br><span class="line"></span><br><span class="line">1. 数据备份</span><br><span class="line">   - 数据卷备份</span><br><span class="line">   - 数据库备份</span><br><span class="line">   - 配置文件备份</span><br><span class="line">   - 定期备份验证</span><br><span class="line"></span><br><span class="line">2. 镜像备份</span><br><span class="line">   - 镜像仓库备份</span><br><span class="line">   - 镜像版本管理</span><br><span class="line">   - 跨区域备份</span><br><span class="line">   - 备份加密</span><br><span class="line"></span><br><span class="line">3. 配置备份</span><br><span class="line">   - Docker Compose文件</span><br><span class="line">   - 环境变量</span><br><span class="line">   - 网络配置</span><br><span class="line">   - 密钥和证书</span><br><span class="line"></span><br><span class="line">4. 恢复测试</span><br><span class="line">   - 定期恢复演练</span><br><span class="line">   - 恢复时间目标(RTO)</span><br><span class="line">   - 恢复点目标(RPO)</span><br><span class="line">   - 灾难恢复计划</span><br><span class="line">EOF</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">deployment_strategies</span><br><span class="line">monitoring_strategies</span><br><span class="line">backup_strategies</span><br></pre></td></tr></table></figure>

<h2 id="十、总结"><a href="#十、总结" class="headerlink" title="十、总结"></a>十、总结</h2><p>Docker容器化技术已经成为现代应用程序开发和部署的标准实践。通过本文的深入探讨，我们涵盖了从Docker基础概念到生产环境部署的完整知识体系：</p>
<h3 id="核心收获"><a href="#核心收获" class="headerlink" title="核心收获"></a>核心收获</h3><ol>
<li><strong>容器化基础</strong>：掌握了Docker的核心概念、架构组件和基本操作</li>
<li><strong>镜像管理</strong>：学会了镜像构建、优化和仓库管理的最佳实践</li>
<li><strong>容器编排</strong>：深入了解了Docker Compose多容器应用编排</li>
<li><strong>网络配置</strong>：掌握了容器网络管理和安全隔离策略</li>
<li><strong>数据管理</strong>：学会了数据卷管理、备份恢复和持久化存储</li>
<li><strong>生产部署</strong>：了解了生产环境的安全配置、监控和运维实践</li>
</ol>
<h3 id="实践要点"><a href="#实践要点" class="headerlink" title="实践要点"></a>实践要点</h3><ul>
<li><strong>安全第一</strong>：始终遵循最小权限原则，定期更新镜像，配置适当的安全策略</li>
<li><strong>性能优化</strong>：合理设置资源限制，优化镜像大小，监控容器性能</li>
<li><strong>可维护性</strong>：编写清晰的Dockerfile，使用标准化的部署流程，建立完善的监控体系</li>
<li><strong>可扩展性</strong>：设计支持水平扩展的架构，使用负载均衡和服务发现</li>
</ul>
<h3 id="发展趋势"><a href="#发展趋势" class="headerlink" title="发展趋势"></a>发展趋势</h3><p>随着云原生技术的发展，Docker容器化技术将继续演进：</p>
<ul>
<li><strong>Kubernetes集成</strong>：容器编排向Kubernetes生态发展</li>
<li><strong>无服务器容器</strong>：Serverless容器服务的兴起</li>
<li><strong>安全增强</strong>：更强的容器安全和隔离技术</li>
<li><strong>边缘计算</strong>：容器在边缘计算场景的应用</li>
</ul>
<p>掌握Docker容器化技术不仅能提高开发效率，还能为云原生架构转型奠定坚实基础。在实际应用中，建议结合具体业务场景，逐步实施容器化改造，持续优化和完善容器化解决方案。</p>
<hr>
<p><em>本文提供的所有脚本和配置仅供学习参考，在生产环境使用前请根据实际需求进行适当调整和测试。</em></p>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/Docker/">Docker</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E5%AE%B9%E5%99%A8%E5%8C%96/">容器化</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/">备份恢复</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/">数据管理</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/">虚拟化</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2023/thinkphp/thinkphp6-middleware-auth-system/"
                                   title="ThinkPHP6/8 中间件开发与权限控制系统实战"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">ThinkPHP6/8 中间件开发与权限控制系统实战</span>
                                        <span class="post-nav-item">上一篇</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2023/mysql/mysql-triggers-events-automation/"
                                   title="MySQL触发器与事件调度器自动化实战"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">MySQL触发器与事件调度器自动化实战</span>
                                        <span class="post-nav-item">下一篇</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    






                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Linux%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF%E4%B8%8EDocker%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97%EF%BC%9A%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E7%9A%84%E5%AE%8C%E6%95%B4%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-text">Linux容器化技术与Docker实战指南：从入门到生产环境的完整解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81Docker%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E4%B8%8E%E6%9E%B6%E6%9E%84"><span class="nav-text">一、Docker基础概念与架构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-Docker%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-text">1.1 Docker核心概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-Docker%E6%9E%B6%E6%9E%84%E7%BB%84%E4%BB%B6"><span class="nav-text">1.2 Docker架构组件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81Docker%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="nav-text">二、Docker安装与配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-Docker%E5%AE%89%E8%A3%85%E8%84%9A%E6%9C%AC"><span class="nav-text">2.1 Docker安装脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Docker-Compose%E5%AE%89%E8%A3%85"><span class="nav-text">2.2 Docker Compose安装</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E5%AE%B9%E5%99%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86"><span class="nav-text">三、容器生命周期管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E5%AE%B9%E5%99%A8%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="nav-text">3.1 容器基本操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%92%8C%E8%B0%83%E8%AF%95"><span class="nav-text">3.2 容器监控和调试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81Docker%E9%95%9C%E5%83%8F%E7%AE%A1%E7%90%86"><span class="nav-text">四、Docker镜像管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E4%B8%8E%E4%BC%98%E5%8C%96"><span class="nav-text">4.1 镜像构建与优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E7%AE%A1%E7%90%86"><span class="nav-text">4.2 镜像仓库管理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86%E4%B8%8E%E5%A4%87%E4%BB%BD"><span class="nav-text">五、容器数据管理与备份</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E6%95%B0%E6%8D%AE%E5%8D%B7%E7%AE%A1%E7%90%86"><span class="nav-text">5.1 数据卷管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E5%AE%B9%E5%99%A8%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D"><span class="nav-text">5.2 容器备份与恢复</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81Docker%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE"><span class="nav-text">六、Docker网络配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E7%BD%91%E7%BB%9C%E9%A9%B1%E5%8A%A8%E5%92%8C%E6%A8%A1%E5%BC%8F"><span class="nav-text">6.1 网络驱动和模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%92%8C%E9%9A%94%E7%A6%BB"><span class="nav-text">6.2 网络安全和隔离</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%83%E3%80%81Docker-Compose%E5%A4%9A%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92"><span class="nav-text">七、Docker Compose多容器编排</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-Compose%E6%96%87%E4%BB%B6%E7%BC%96%E5%86%99"><span class="nav-text">7.1 Compose文件编写</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-Compose%E7%AE%A1%E7%90%86%E8%84%9A%E6%9C%AC"><span class="nav-text">7.2 Compose管理脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AB%E3%80%81%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%BF%90%E7%BB%B4"><span class="nav-text">八、生产环境部署与运维</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-text">8.1 生产环境最佳实践</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E4%B8%8E%E7%BB%B4%E6%8A%A4"><span class="nav-text">8.2 故障排查与维护</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B9%9D%E3%80%81Docker%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93"><span class="nav-text">九、Docker最佳实践总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-%E5%BC%80%E5%8F%91%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-text">9.1 开发最佳实践</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-%E8%BF%90%E7%BB%B4%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-text">9.2 运维最佳实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-text">十、总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%94%B6%E8%8E%B7"><span class="nav-text">核心收获</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5%E8%A6%81%E7%82%B9"><span class="nav-text">实践要点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E5%B1%95%E8%B6%8B%E5%8A%BF"><span class="nav-text">发展趋势</span></a></li></ol></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
    &copy;&nbsp;2025
    
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">Orion K</a>
        
    </div>


    
        
        <div class="deploy-info info-item">
            
            本站由 <span class="tooltip" data-tooltip-content="GitHub Pages"><img src="/images/brands/github.png"></span> 提供部署服务
            
        </div>
    

    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Linux%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF%E4%B8%8EDocker%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97%EF%BC%9A%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E7%9A%84%E5%AE%8C%E6%95%B4%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-text">Linux容器化技术与Docker实战指南：从入门到生产环境的完整解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81Docker%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E4%B8%8E%E6%9E%B6%E6%9E%84"><span class="nav-text">一、Docker基础概念与架构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-Docker%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-text">1.1 Docker核心概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-Docker%E6%9E%B6%E6%9E%84%E7%BB%84%E4%BB%B6"><span class="nav-text">1.2 Docker架构组件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81Docker%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="nav-text">二、Docker安装与配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-Docker%E5%AE%89%E8%A3%85%E8%84%9A%E6%9C%AC"><span class="nav-text">2.1 Docker安装脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Docker-Compose%E5%AE%89%E8%A3%85"><span class="nav-text">2.2 Docker Compose安装</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E5%AE%B9%E5%99%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86"><span class="nav-text">三、容器生命周期管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E5%AE%B9%E5%99%A8%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="nav-text">3.1 容器基本操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%92%8C%E8%B0%83%E8%AF%95"><span class="nav-text">3.2 容器监控和调试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81Docker%E9%95%9C%E5%83%8F%E7%AE%A1%E7%90%86"><span class="nav-text">四、Docker镜像管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E4%B8%8E%E4%BC%98%E5%8C%96"><span class="nav-text">4.1 镜像构建与优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E7%AE%A1%E7%90%86"><span class="nav-text">4.2 镜像仓库管理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86%E4%B8%8E%E5%A4%87%E4%BB%BD"><span class="nav-text">五、容器数据管理与备份</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E6%95%B0%E6%8D%AE%E5%8D%B7%E7%AE%A1%E7%90%86"><span class="nav-text">5.1 数据卷管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E5%AE%B9%E5%99%A8%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D"><span class="nav-text">5.2 容器备份与恢复</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81Docker%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE"><span class="nav-text">六、Docker网络配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E7%BD%91%E7%BB%9C%E9%A9%B1%E5%8A%A8%E5%92%8C%E6%A8%A1%E5%BC%8F"><span class="nav-text">6.1 网络驱动和模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%92%8C%E9%9A%94%E7%A6%BB"><span class="nav-text">6.2 网络安全和隔离</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%83%E3%80%81Docker-Compose%E5%A4%9A%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92"><span class="nav-text">七、Docker Compose多容器编排</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-Compose%E6%96%87%E4%BB%B6%E7%BC%96%E5%86%99"><span class="nav-text">7.1 Compose文件编写</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-Compose%E7%AE%A1%E7%90%86%E8%84%9A%E6%9C%AC"><span class="nav-text">7.2 Compose管理脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AB%E3%80%81%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%BF%90%E7%BB%B4"><span class="nav-text">八、生产环境部署与运维</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-text">8.1 生产环境最佳实践</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E4%B8%8E%E7%BB%B4%E6%8A%A4"><span class="nav-text">8.2 故障排查与维护</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B9%9D%E3%80%81Docker%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93"><span class="nav-text">九、Docker最佳实践总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-%E5%BC%80%E5%8F%91%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-text">9.1 开发最佳实践</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-%E8%BF%90%E7%BB%B4%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-text">9.2 运维最佳实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-text">十、总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%94%B6%E8%8E%B7"><span class="nav-text">核心收获</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5%E8%A6%81%E7%82%B9"><span class="nav-text">实践要点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E5%B1%95%E8%B6%8B%E5%8A%BF"><span class="nav-text">发展趋势</span></a></li></ol></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->

<script src="/js/utils.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/toggle-theme.js"></script>

<script src="/js/code-block.js"></script>

<script src="/js/main.js"></script>

<script src="/js/libs/anime.min.js"></script>


<!-- local search -->

    
<script src="/js/local-search.js"></script>



<!-- lazyload -->


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        
<script src="/js/post/post-helper.js"></script>


        <!-- toc -->
        
            
<script src="/js/post/toc.js"></script>

        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
