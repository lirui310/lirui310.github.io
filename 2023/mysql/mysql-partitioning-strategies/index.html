<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="深入解析MySQL分区表的设计原理、分区策略选择和实战应用，助力大数据量场景下的性能优化">
    <meta name="author" content="Orion K">
    
    <title>
        
            MySQL分区表策略与实战应用 |
        
        Orion K Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/logo.svg">
    
    
<link rel="stylesheet" href="/font/css/fontawesome.min.css">

    
<link rel="stylesheet" href="/font/css/regular.min.css">

    
<link rel="stylesheet" href="/font/css/solid.min.css">

    
<link rel="stylesheet" href="/font/css/brands.min.css">

    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"Orion K Blog","author":"Orion K","avatar":"/images/avatar.svg","logo":"/images/logo.svg","favicon":"/images/logo.svg"},"menu":{"home":"/                        || fa-solid fa-home","archives":"/archives            || fa-solid fa-box-archive","categories":"/categories        || fa-solid fa-layer-group"},"first_screen":{"enable":false,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":false,"hide_header":true},"home":{"announcement":"欢迎来到 Orion K 的博客，这是一个分享互联网技术的博客。联系：wxmm686800@gmail.com","category":true,"tag":true,"post_datetime":"created"},"post":{"author_badge":{"enable":true,"level_badge":true,"custom_badge":["One","Two","Three"]},"word_count":{"wordcount":false,"min2read":false},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false,"reward":{"enable":false,"img_link":null,"text":null,"icon":null}},"code_block":{"tools":{"enable":false,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":false,"site_uv":false,"site_pv":false,"page_pv":false}},"local_search":{"enable":true,"preload":true},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.39"},"waline":{"server_url":null,"reaction":false,"version":"3.3.2"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":false},"lazyload":{"enable":false},"cdn":{"enable":false,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2025,"word_count":false,"site_deploy":{"enable":true,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.5"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/logo.svg">
                </a>
            
            <a class="site-name border-box" href="/">
               Orion K Blog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-home"></i>
                                
                                首页
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                
                                归档
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-layer-group"></i>
                                
                                分类
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-home"></i>
                                </span>
                            
                            首页
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                </span>
                            
                            归档
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-layer-group"></i>
                                </span>
                            
                            分类
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        MySQL分区表策略与实战应用
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/avatar.svg">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">Orion K</span>
                                
                                    <span class="author-badge">Lv6</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2023-11-08 10:20:00</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/mysql/">mysql</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/mysql/">mysql</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E5%88%86%E5%8C%BA%E8%A1%A8/">分区表</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9E%B6%E6%9E%84/">数据库架构</a></li>
                        
                    
                </ul>
            </span>
        

        
        
        
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <h1 id="MySQL分区表策略与实战应用"><a href="#MySQL分区表策略与实战应用" class="headerlink" title="MySQL分区表策略与实战应用"></a>MySQL分区表策略与实战应用</h1><p>在处理大数据量的MySQL数据库时，分区表是提升查询性能、优化存储管理的重要技术。本文将通过实战案例详细介绍MySQL分区表的各种策略和最佳实践。</p>
<h2 id="分区表基础概念"><a href="#分区表基础概念" class="headerlink" title="分区表基础概念"></a>分区表基础概念</h2><h3 id="1-分区表原理"><a href="#1-分区表原理" class="headerlink" title="1. 分区表原理"></a>1. 分区表原理</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看MySQL分区支持情况</span></span><br><span class="line"><span class="keyword">SHOW</span> PLUGINS;</span><br><span class="line"><span class="keyword">SELECT</span> PLUGIN_NAME, PLUGIN_STATUS </span><br><span class="line"><span class="keyword">FROM</span> information_schema.PLUGINS </span><br><span class="line"><span class="keyword">WHERE</span> PLUGIN_NAME <span class="operator">=</span> <span class="string">&#x27;partition&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看分区相关变量</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%partition%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建简单的分区表示例</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> sales_data (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT,</span><br><span class="line">    sale_date <span class="type">DATE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    product_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    customer_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    region <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (id, sale_date)</span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (<span class="keyword">YEAR</span>(sale_date)) (</span><br><span class="line">    <span class="keyword">PARTITION</span> p2020 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2021</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p2021 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2022</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p2022 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2023</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p2023 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2024</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_future <span class="keyword">VALUES</span> LESS THAN MAXVALUE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看分区信息</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    TABLE_SCHEMA,</span><br><span class="line">    TABLE_NAME,</span><br><span class="line">    PARTITION_NAME,</span><br><span class="line">    PARTITION_ORDINAL_POSITION,</span><br><span class="line">    PARTITION_METHOD,</span><br><span class="line">    PARTITION_EXPRESSION,</span><br><span class="line">    PARTITION_DESCRIPTION,</span><br><span class="line">    TABLE_ROWS,</span><br><span class="line">    DATA_LENGTH,</span><br><span class="line">    INDEX_LENGTH</span><br><span class="line"><span class="keyword">FROM</span> information_schema.PARTITIONS </span><br><span class="line"><span class="keyword">WHERE</span> TABLE_SCHEMA <span class="operator">=</span> DATABASE() </span><br><span class="line">    <span class="keyword">AND</span> TABLE_NAME <span class="operator">=</span> <span class="string">&#x27;sales_data&#x27;</span></span><br><span class="line">    <span class="keyword">AND</span> PARTITION_NAME <span class="keyword">IS</span> <span class="keyword">NOT NULL</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-分区类型详解"><a href="#2-分区类型详解" class="headerlink" title="2. 分区类型详解"></a>2. 分区类型详解</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1. RANGE分区 - 按范围分区</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders_range (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT,</span><br><span class="line">    order_date <span class="type">DATE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    customer_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    total_amount <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (id, order_date)</span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (<span class="keyword">YEAR</span>(order_date)) (</span><br><span class="line">    <span class="keyword">PARTITION</span> p2022 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2023</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p2023 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2024</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p2024 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2025</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_max <span class="keyword">VALUES</span> LESS THAN MAXVALUE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. LIST分区 - 按列表值分区</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users_list (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    region <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (id, region)</span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> LIST COLUMNS(region) (</span><br><span class="line">    <span class="keyword">PARTITION</span> p_north <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="string">&#x27;北京&#x27;</span>, <span class="string">&#x27;天津&#x27;</span>, <span class="string">&#x27;河北&#x27;</span>, <span class="string">&#x27;山西&#x27;</span>, <span class="string">&#x27;内蒙古&#x27;</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_east <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="string">&#x27;上海&#x27;</span>, <span class="string">&#x27;江苏&#x27;</span>, <span class="string">&#x27;浙江&#x27;</span>, <span class="string">&#x27;安徽&#x27;</span>, <span class="string">&#x27;福建&#x27;</span>, <span class="string">&#x27;江西&#x27;</span>, <span class="string">&#x27;山东&#x27;</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_south <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="string">&#x27;河南&#x27;</span>, <span class="string">&#x27;湖北&#x27;</span>, <span class="string">&#x27;湖南&#x27;</span>, <span class="string">&#x27;广东&#x27;</span>, <span class="string">&#x27;广西&#x27;</span>, <span class="string">&#x27;海南&#x27;</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_west <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="string">&#x27;重庆&#x27;</span>, <span class="string">&#x27;四川&#x27;</span>, <span class="string">&#x27;贵州&#x27;</span>, <span class="string">&#x27;云南&#x27;</span>, <span class="string">&#x27;西藏&#x27;</span>, <span class="string">&#x27;陕西&#x27;</span>, <span class="string">&#x27;甘肃&#x27;</span>, <span class="string">&#x27;青海&#x27;</span>, <span class="string">&#x27;宁夏&#x27;</span>, <span class="string">&#x27;新疆&#x27;</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_northeast <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="string">&#x27;辽宁&#x27;</span>, <span class="string">&#x27;吉林&#x27;</span>, <span class="string">&#x27;黑龙江&#x27;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. HASH分区 - 按哈希值分区</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> user_activities_hash (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT,</span><br><span class="line">    user_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    activity_type <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    activity_time <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (id, user_id)</span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> HASH(user_id) PARTITIONS <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 4. KEY分区 - 按主键哈希分区</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> sessions_key (</span><br><span class="line">    session_id <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    user_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    ip_address <span class="type">VARCHAR</span>(<span class="number">45</span>),</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    expires_at <span class="type">TIMESTAMP</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (session_id)</span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> KEY() PARTITIONS <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 5. 复合分区 - RANGE和HASH组合</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> logs_composite (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT,</span><br><span class="line">    log_date <span class="type">DATE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    user_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    log_level ENUM(<span class="string">&#x27;INFO&#x27;</span>, <span class="string">&#x27;WARN&#x27;</span>, <span class="string">&#x27;ERROR&#x27;</span>),</span><br><span class="line">    message TEXT,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (id, log_date, user_id)</span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (<span class="keyword">YEAR</span>(log_date))</span><br><span class="line">SUBPARTITION <span class="keyword">BY</span> HASH(user_id) SUBPARTITIONS <span class="number">4</span> (</span><br><span class="line">    <span class="keyword">PARTITION</span> p2022 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2023</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p2023 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2024</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p2024 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2025</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h2 id="实战分区策略"><a href="#实战分区策略" class="headerlink" title="实战分区策略"></a>实战分区策略</h2><h3 id="1-时间序列数据分区"><a href="#1-时间序列数据分区" class="headerlink" title="1. 时间序列数据分区"></a>1. 时间序列数据分区</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建日志表的时间分区</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> system_logs (</span><br><span class="line">    id <span class="type">BIGINT</span> AUTO_INCREMENT,</span><br><span class="line">    log_time <span class="type">TIMESTAMP</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    log_level ENUM(<span class="string">&#x27;DEBUG&#x27;</span>, <span class="string">&#x27;INFO&#x27;</span>, <span class="string">&#x27;WARN&#x27;</span>, <span class="string">&#x27;ERROR&#x27;</span>, <span class="string">&#x27;FATAL&#x27;</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    <span class="keyword">module</span> <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    message TEXT <span class="keyword">NOT NULL</span>,</span><br><span class="line">    user_id <span class="type">INT</span>,</span><br><span class="line">    ip_address <span class="type">VARCHAR</span>(<span class="number">45</span>),</span><br><span class="line">    request_id <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (id, log_time),</span><br><span class="line">    INDEX idx_module_time (<span class="keyword">module</span>, log_time),</span><br><span class="line">    INDEX idx_user_time (user_id, log_time),</span><br><span class="line">    INDEX idx_level_time (log_level, log_time)</span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (TO_DAYS(log_time)) (</span><br><span class="line">    <span class="keyword">PARTITION</span> p20230801 <span class="keyword">VALUES</span> LESS THAN (TO_DAYS(<span class="string">&#x27;2023-08-02&#x27;</span>)),</span><br><span class="line">    <span class="keyword">PARTITION</span> p20230802 <span class="keyword">VALUES</span> LESS THAN (TO_DAYS(<span class="string">&#x27;2023-08-03&#x27;</span>)),</span><br><span class="line">    <span class="keyword">PARTITION</span> p20230803 <span class="keyword">VALUES</span> LESS THAN (TO_DAYS(<span class="string">&#x27;2023-08-04&#x27;</span>)),</span><br><span class="line">    <span class="keyword">PARTITION</span> p20230804 <span class="keyword">VALUES</span> LESS THAN (TO_DAYS(<span class="string">&#x27;2023-08-05&#x27;</span>)),</span><br><span class="line">    <span class="keyword">PARTITION</span> p20230805 <span class="keyword">VALUES</span> LESS THAN (TO_DAYS(<span class="string">&#x27;2023-08-06&#x27;</span>)),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_future <span class="keyword">VALUES</span> LESS THAN MAXVALUE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入测试数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> system_logs (log_time, log_level, <span class="keyword">module</span>, message, user_id, ip_address) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;2023-08-01 10:00:00&#x27;</span>, <span class="string">&#x27;INFO&#x27;</span>, <span class="string">&#x27;auth&#x27;</span>, <span class="string">&#x27;用户登录成功&#x27;</span>, <span class="number">1001</span>, <span class="string">&#x27;192.168.1.100&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;2023-08-01 10:05:00&#x27;</span>, <span class="string">&#x27;WARN&#x27;</span>, <span class="string">&#x27;payment&#x27;</span>, <span class="string">&#x27;支付超时&#x27;</span>, <span class="number">1002</span>, <span class="string">&#x27;192.168.1.101&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;2023-08-02 09:30:00&#x27;</span>, <span class="string">&#x27;ERROR&#x27;</span>, <span class="string">&#x27;database&#x27;</span>, <span class="string">&#x27;连接失败&#x27;</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;192.168.1.102&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;2023-08-03 14:20:00&#x27;</span>, <span class="string">&#x27;INFO&#x27;</span>, <span class="string">&#x27;order&#x27;</span>, <span class="string">&#x27;订单创建&#x27;</span>, <span class="number">1003</span>, <span class="string">&#x27;192.168.1.103&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;2023-08-04 16:45:00&#x27;</span>, <span class="string">&#x27;FATAL&#x27;</span>, <span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;系统崩溃&#x27;</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;192.168.1.104&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询特定日期的日志（分区裁剪）</span></span><br><span class="line">EXPLAIN PARTITIONS </span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> system_logs </span><br><span class="line"><span class="keyword">WHERE</span> log_time <span class="operator">&gt;=</span> <span class="string">&#x27;2023-08-02 00:00:00&#x27;</span> </span><br><span class="line">    <span class="keyword">AND</span> log_time <span class="operator">&lt;</span> <span class="string">&#x27;2023-08-03 00:00:00&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看分区数据分布</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    PARTITION_NAME,</span><br><span class="line">    TABLE_ROWS,</span><br><span class="line">    ROUND(DATA_LENGTH<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="string">&#x27;DATA_SIZE_MB&#x27;</span>,</span><br><span class="line">    ROUND(INDEX_LENGTH<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="string">&#x27;INDEX_SIZE_MB&#x27;</span></span><br><span class="line"><span class="keyword">FROM</span> information_schema.PARTITIONS </span><br><span class="line"><span class="keyword">WHERE</span> TABLE_SCHEMA <span class="operator">=</span> DATABASE() </span><br><span class="line">    <span class="keyword">AND</span> TABLE_NAME <span class="operator">=</span> <span class="string">&#x27;system_logs&#x27;</span></span><br><span class="line">    <span class="keyword">AND</span> PARTITION_NAME <span class="keyword">IS</span> <span class="keyword">NOT NULL</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-用户数据分区策略"><a href="#2-用户数据分区策略" class="headerlink" title="2. 用户数据分区策略"></a>2. 用户数据分区策略</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 按用户ID范围分区的用户行为表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> user_behaviors (</span><br><span class="line">    id <span class="type">BIGINT</span> AUTO_INCREMENT,</span><br><span class="line">    user_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    behavior_type ENUM(<span class="string">&#x27;view&#x27;</span>, <span class="string">&#x27;click&#x27;</span>, <span class="string">&#x27;purchase&#x27;</span>, <span class="string">&#x27;share&#x27;</span>, <span class="string">&#x27;favorite&#x27;</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    target_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    target_type <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    behavior_time <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    session_id <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">    device_type <span class="type">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (id, user_id),</span><br><span class="line">    INDEX idx_user_behavior_time (user_id, behavior_time),</span><br><span class="line">    INDEX idx_target (target_type, target_id),</span><br><span class="line">    INDEX idx_behavior_time (behavior_type, behavior_time)</span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (user_id) (</span><br><span class="line">    <span class="keyword">PARTITION</span> p_user_1_10000 <span class="keyword">VALUES</span> LESS THAN (<span class="number">10001</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_user_10001_20000 <span class="keyword">VALUES</span> LESS THAN (<span class="number">20001</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_user_20001_30000 <span class="keyword">VALUES</span> LESS THAN (<span class="number">30001</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_user_30001_40000 <span class="keyword">VALUES</span> LESS THAN (<span class="number">40001</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_user_40001_50000 <span class="keyword">VALUES</span> LESS THAN (<span class="number">50001</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_user_max <span class="keyword">VALUES</span> LESS THAN MAXVALUE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 按地区分区的用户表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users_by_region (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span> <span class="keyword">UNIQUE</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    region_code <span class="type">VARCHAR</span>(<span class="number">10</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    city <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    registration_time <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    last_login_time <span class="type">TIMESTAMP</span>,</span><br><span class="line">    status TINYINT <span class="keyword">DEFAULT</span> <span class="number">1</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (id, region_code),</span><br><span class="line">    <span class="keyword">UNIQUE</span> KEY uk_username_region (username, region_code),</span><br><span class="line">    INDEX idx_email (email),</span><br><span class="line">    INDEX idx_registration_time (registration_time)</span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> LIST COLUMNS(region_code) (</span><br><span class="line">    <span class="keyword">PARTITION</span> p_beijing <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="string">&#x27;BJ&#x27;</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_shanghai <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="string">&#x27;SH&#x27;</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_guangdong <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="string">&#x27;GD&#x27;</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_jiangsu <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="string">&#x27;JS&#x27;</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_zhejiang <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="string">&#x27;ZJ&#x27;</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_shandong <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="string">&#x27;SD&#x27;</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_others <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="keyword">DEFAULT</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入测试数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> user_behaviors (user_id, behavior_type, target_id, target_type, session_id, device_type) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">5000</span>, <span class="string">&#x27;view&#x27;</span>, <span class="number">1001</span>, <span class="string">&#x27;product&#x27;</span>, <span class="string">&#x27;sess_001&#x27;</span>, <span class="string">&#x27;mobile&#x27;</span>),</span><br><span class="line">(<span class="number">15000</span>, <span class="string">&#x27;click&#x27;</span>, <span class="number">2001</span>, <span class="string">&#x27;ad&#x27;</span>, <span class="string">&#x27;sess_002&#x27;</span>, <span class="string">&#x27;desktop&#x27;</span>),</span><br><span class="line">(<span class="number">25000</span>, <span class="string">&#x27;purchase&#x27;</span>, <span class="number">3001</span>, <span class="string">&#x27;product&#x27;</span>, <span class="string">&#x27;sess_003&#x27;</span>, <span class="string">&#x27;mobile&#x27;</span>),</span><br><span class="line">(<span class="number">35000</span>, <span class="string">&#x27;share&#x27;</span>, <span class="number">4001</span>, <span class="string">&#x27;article&#x27;</span>, <span class="string">&#x27;sess_004&#x27;</span>, <span class="string">&#x27;tablet&#x27;</span>),</span><br><span class="line">(<span class="number">45000</span>, <span class="string">&#x27;favorite&#x27;</span>, <span class="number">5001</span>, <span class="string">&#x27;product&#x27;</span>, <span class="string">&#x27;sess_005&#x27;</span>, <span class="string">&#x27;mobile&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询特定用户范围的行为（利用分区裁剪）</span></span><br><span class="line">EXPLAIN PARTITIONS </span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user_behaviors </span><br><span class="line"><span class="keyword">WHERE</span> user_id <span class="keyword">BETWEEN</span> <span class="number">10000</span> <span class="keyword">AND</span> <span class="number">20000</span> </span><br><span class="line">    <span class="keyword">AND</span> behavior_time <span class="operator">&gt;=</span> DATE_SUB(NOW(), <span class="type">INTERVAL</span> <span class="number">7</span> <span class="keyword">DAY</span>);</span><br></pre></td></tr></table></figure>

<h3 id="3-订单数据分区实战"><a href="#3-订单数据分区实战" class="headerlink" title="3. 订单数据分区实战"></a>3. 订单数据分区实战</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建按月分区的订单表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders_monthly (</span><br><span class="line">    id <span class="type">BIGINT</span> AUTO_INCREMENT,</span><br><span class="line">    order_no <span class="type">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT NULL</span> <span class="keyword">UNIQUE</span>,</span><br><span class="line">    user_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    product_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    quantity <span class="type">INT</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>,</span><br><span class="line">    unit_price <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    total_amount <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    order_status TINYINT <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>,</span><br><span class="line">    payment_method <span class="type">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">    shipping_address TEXT,</span><br><span class="line">    order_time <span class="type">TIMESTAMP</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    payment_time <span class="type">TIMESTAMP</span> <span class="keyword">NULL</span>,</span><br><span class="line">    shipping_time <span class="type">TIMESTAMP</span> <span class="keyword">NULL</span>,</span><br><span class="line">    completed_time <span class="type">TIMESTAMP</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (id, order_time),</span><br><span class="line">    <span class="keyword">UNIQUE</span> KEY uk_order_no_time (order_no, order_time),</span><br><span class="line">    INDEX idx_user_order_time (user_id, order_time),</span><br><span class="line">    INDEX idx_status_time (order_status, order_time),</span><br><span class="line">    INDEX idx_product_time (product_id, order_time)</span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (<span class="keyword">YEAR</span>(order_time) <span class="operator">*</span> <span class="number">100</span> <span class="operator">+</span> <span class="keyword">MONTH</span>(order_time)) (</span><br><span class="line">    <span class="keyword">PARTITION</span> p202301 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202302</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202302 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202303</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202303 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202304</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202304 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202305</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202305 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202306</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202306 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202307</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202307 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202308</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202308 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202309</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202309 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202310</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202310 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202311</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202311 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202312</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202312 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202401</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_future <span class="keyword">VALUES</span> LESS THAN MAXVALUE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建订单详情的复合分区表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> order_details_composite (</span><br><span class="line">    id <span class="type">BIGINT</span> AUTO_INCREMENT,</span><br><span class="line">    order_id <span class="type">BIGINT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    product_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    product_name <span class="type">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    sku <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    quantity <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    unit_price <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    discount_amount <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    total_price <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    order_time <span class="type">TIMESTAMP</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (id, order_time, order_id),</span><br><span class="line">    INDEX idx_order_id (order_id),</span><br><span class="line">    INDEX idx_product_id (product_id),</span><br><span class="line">    INDEX idx_sku (sku)</span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (<span class="keyword">YEAR</span>(order_time))</span><br><span class="line">SUBPARTITION <span class="keyword">BY</span> HASH(order_id) SUBPARTITIONS <span class="number">4</span> (</span><br><span class="line">    <span class="keyword">PARTITION</span> p2022 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2023</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p2023 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2024</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p2024 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2025</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_future <span class="keyword">VALUES</span> LESS THAN MAXVALUE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入测试订单数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders_monthly (</span><br><span class="line">    order_no, user_id, product_id, quantity, unit_price, total_amount, </span><br><span class="line">    order_status, payment_method, order_time</span><br><span class="line">) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;ORD202308001&#x27;</span>, <span class="number">1001</span>, <span class="number">2001</span>, <span class="number">2</span>, <span class="number">99.99</span>, <span class="number">199.98</span>, <span class="number">2</span>, <span class="string">&#x27;alipay&#x27;</span>, <span class="string">&#x27;2023-08-01 10:30:00&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;ORD202308002&#x27;</span>, <span class="number">1002</span>, <span class="number">2002</span>, <span class="number">1</span>, <span class="number">299.00</span>, <span class="number">299.00</span>, <span class="number">1</span>, <span class="string">&#x27;wechat&#x27;</span>, <span class="string">&#x27;2023-08-15 14:20:00&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;ORD202309001&#x27;</span>, <span class="number">1003</span>, <span class="number">2003</span>, <span class="number">3</span>, <span class="number">49.99</span>, <span class="number">149.97</span>, <span class="number">3</span>, <span class="string">&#x27;credit_card&#x27;</span>, <span class="string">&#x27;2023-09-05 09:15:00&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;ORD202309002&#x27;</span>, <span class="number">1004</span>, <span class="number">2004</span>, <span class="number">1</span>, <span class="number">599.00</span>, <span class="number">599.00</span>, <span class="number">2</span>, <span class="string">&#x27;alipay&#x27;</span>, <span class="string">&#x27;2023-09-20 16:45:00&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询特定月份的订单（分区裁剪）</span></span><br><span class="line">EXPLAIN PARTITIONS </span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    order_no,</span><br><span class="line">    user_id,</span><br><span class="line">    total_amount,</span><br><span class="line">    order_status,</span><br><span class="line">    order_time</span><br><span class="line"><span class="keyword">FROM</span> orders_monthly </span><br><span class="line"><span class="keyword">WHERE</span> order_time <span class="operator">&gt;=</span> <span class="string">&#x27;2023-08-01 00:00:00&#x27;</span> </span><br><span class="line">    <span class="keyword">AND</span> order_time <span class="operator">&lt;</span> <span class="string">&#x27;2023-09-01 00:00:00&#x27;</span></span><br><span class="line">    <span class="keyword">AND</span> order_status <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 统计各分区的数据量</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    PARTITION_NAME <span class="keyword">as</span> <span class="string">&#x27;分区名&#x27;</span>,</span><br><span class="line">    TABLE_ROWS <span class="keyword">as</span> <span class="string">&#x27;行数&#x27;</span>,</span><br><span class="line">    ROUND(DATA_LENGTH<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="string">&#x27;数据大小MB&#x27;</span>,</span><br><span class="line">    ROUND(INDEX_LENGTH<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="string">&#x27;索引大小MB&#x27;</span>,</span><br><span class="line">    ROUND((DATA_LENGTH <span class="operator">+</span> INDEX_LENGTH)<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="string">&#x27;总大小MB&#x27;</span></span><br><span class="line"><span class="keyword">FROM</span> information_schema.PARTITIONS </span><br><span class="line"><span class="keyword">WHERE</span> TABLE_SCHEMA <span class="operator">=</span> DATABASE() </span><br><span class="line">    <span class="keyword">AND</span> TABLE_NAME <span class="operator">=</span> <span class="string">&#x27;orders_monthly&#x27;</span></span><br><span class="line">    <span class="keyword">AND</span> PARTITION_NAME <span class="keyword">IS</span> <span class="keyword">NOT NULL</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> PARTITION_ORDINAL_POSITION;</span><br></pre></td></tr></table></figure>

<h2 id="分区管理操作"><a href="#分区管理操作" class="headerlink" title="分区管理操作"></a>分区管理操作</h2><h3 id="1-动态分区管理"><a href="#1-动态分区管理" class="headerlink" title="1. 动态分区管理"></a>1. 动态分区管理</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 添加新分区</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> orders_monthly </span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">PARTITION</span> (</span><br><span class="line">    <span class="keyword">PARTITION</span> p202401 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202402</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202402 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202403</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除旧分区（注意：会删除数据）</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> orders_monthly <span class="keyword">DROP</span> <span class="keyword">PARTITION</span> p202301;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 重组分区（分割分区）</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> orders_monthly </span><br><span class="line">REORGANIZE <span class="keyword">PARTITION</span> p_future <span class="keyword">INTO</span> (</span><br><span class="line">    <span class="keyword">PARTITION</span> p202403 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202404</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202404 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202405</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_future <span class="keyword">VALUES</span> LESS THAN MAXVALUE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 合并分区</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> orders_monthly </span><br><span class="line">REORGANIZE <span class="keyword">PARTITION</span> p202401, p202402 <span class="keyword">INTO</span> (</span><br><span class="line">    <span class="keyword">PARTITION</span> p2024_q1 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202403</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 交换分区（用于数据迁移）</span></span><br><span class="line"><span class="comment">-- 首先创建相同结构的临时表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders_temp <span class="keyword">LIKE</span> orders_monthly;</span><br><span class="line"><span class="keyword">ALTER TABLE</span> orders_temp REMOVE PARTITIONING;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 将分区数据交换到临时表</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> orders_monthly </span><br><span class="line">EXCHANGE <span class="keyword">PARTITION</span> p202308 <span class="keyword">WITH</span> <span class="keyword">TABLE</span> orders_temp;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看交换结果</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">as</span> temp_table_rows <span class="keyword">FROM</span> orders_temp;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">as</span> partition_rows <span class="keyword">FROM</span> orders_monthly <span class="keyword">PARTITION</span>(p202308);</span><br></pre></td></tr></table></figure>

<h3 id="2-分区维护存储过程"><a href="#2-分区维护存储过程" class="headerlink" title="2. 分区维护存储过程"></a>2. 分区维护存储过程</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建自动分区管理存储过程</span></span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> ManagePartitions(</span><br><span class="line">    <span class="keyword">IN</span> table_name <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">    <span class="keyword">IN</span> partition_type ENUM(<span class="string">&#x27;monthly&#x27;</span>, <span class="string">&#x27;daily&#x27;</span>),</span><br><span class="line">    <span class="keyword">IN</span> keep_months <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">12</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> done <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="literal">FALSE</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> partition_name <span class="type">VARCHAR</span>(<span class="number">64</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> partition_desc <span class="type">VARCHAR</span>(<span class="number">64</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> cutoff_date <span class="type">DATE</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> next_month_start <span class="type">DATE</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> partition_sql TEXT;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 计算保留数据的截止日期</span></span><br><span class="line">    <span class="keyword">SET</span> cutoff_date <span class="operator">=</span> DATE_SUB(CURDATE(), <span class="type">INTERVAL</span> keep_months <span class="keyword">MONTH</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 删除过期分区</span></span><br><span class="line">    <span class="keyword">CASE</span> partition_type</span><br><span class="line">        <span class="keyword">WHEN</span> <span class="string">&#x27;monthly&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">            <span class="comment">-- 查找需要删除的月度分区</span></span><br><span class="line">            <span class="keyword">BEGIN</span></span><br><span class="line">                <span class="keyword">DECLARE</span> partition_cursor <span class="keyword">CURSOR</span> <span class="keyword">FOR</span></span><br><span class="line">                    <span class="keyword">SELECT</span> PARTITION_NAME, PARTITION_DESCRIPTION</span><br><span class="line">                    <span class="keyword">FROM</span> information_schema.PARTITIONS </span><br><span class="line">                    <span class="keyword">WHERE</span> TABLE_SCHEMA <span class="operator">=</span> DATABASE()</span><br><span class="line">                        <span class="keyword">AND</span> TABLE_NAME <span class="operator">=</span> table_name</span><br><span class="line">                        <span class="keyword">AND</span> PARTITION_NAME <span class="keyword">IS</span> <span class="keyword">NOT NULL</span></span><br><span class="line">                        <span class="keyword">AND</span> PARTITION_NAME <span class="operator">!=</span> <span class="string">&#x27;p_future&#x27;</span></span><br><span class="line">                        <span class="keyword">AND</span> <span class="built_in">CAST</span>(<span class="built_in">SUBSTRING</span>(PARTITION_NAME, <span class="number">2</span>) <span class="keyword">AS</span> UNSIGNED) <span class="operator">&lt;</span> </span><br><span class="line">                            (<span class="keyword">YEAR</span>(cutoff_date) <span class="operator">*</span> <span class="number">100</span> <span class="operator">+</span> <span class="keyword">MONTH</span>(cutoff_date));</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">DECLARE</span> CONTINUE HANDLER <span class="keyword">FOR</span> <span class="keyword">NOT</span> FOUND <span class="keyword">SET</span> done <span class="operator">=</span> <span class="literal">TRUE</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">OPEN</span> partition_cursor;</span><br><span class="line">                </span><br><span class="line">                drop_loop: LOOP</span><br><span class="line">                    <span class="keyword">FETCH</span> partition_cursor <span class="keyword">INTO</span> partition_name, partition_desc;</span><br><span class="line">                    IF done <span class="keyword">THEN</span> LEAVE drop_loop; <span class="keyword">END</span> IF;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">SET</span> partition_sql <span class="operator">=</span> CONCAT(<span class="string">&#x27;ALTER TABLE &#x27;</span>, table_name, </span><br><span class="line">                                             <span class="string">&#x27; DROP PARTITION &#x27;</span>, partition_name);</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">SET</span> <span class="variable">@sql</span> <span class="operator">=</span> partition_sql;</span><br><span class="line">                    <span class="keyword">PREPARE</span> stmt <span class="keyword">FROM</span> <span class="variable">@sql</span>;</span><br><span class="line">                    <span class="keyword">EXECUTE</span> stmt;</span><br><span class="line">                    <span class="keyword">DEALLOCATE</span> <span class="keyword">PREPARE</span> stmt;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">INSERT INTO</span> partition_management_log (</span><br><span class="line">                        table_name, operation, partition_name, executed_at</span><br><span class="line">                    ) <span class="keyword">VALUES</span> (</span><br><span class="line">                        table_name, <span class="string">&#x27;DROP&#x27;</span>, partition_name, NOW()</span><br><span class="line">                    );</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">END</span> LOOP;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">CLOSE</span> partition_cursor;</span><br><span class="line">            <span class="keyword">END</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">WHEN</span> <span class="string">&#x27;daily&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">            <span class="comment">-- 类似的日度分区处理逻辑</span></span><br><span class="line">            <span class="keyword">SELECT</span> <span class="string">&#x27;日度分区管理功能待实现&#x27;</span> <span class="keyword">as</span> message;</span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">CASE</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 添加未来分区</span></span><br><span class="line">    IF partition_type <span class="operator">=</span> <span class="string">&#x27;monthly&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> next_month_start <span class="operator">=</span> DATE_ADD(DATE_FORMAT(CURDATE(), <span class="string">&#x27;%Y-%m-01&#x27;</span>), <span class="type">INTERVAL</span> <span class="number">2</span> <span class="keyword">MONTH</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">-- 检查是否需要添加新分区</span></span><br><span class="line">        IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> (</span><br><span class="line">            <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> information_schema.PARTITIONS </span><br><span class="line">            <span class="keyword">WHERE</span> TABLE_SCHEMA <span class="operator">=</span> DATABASE()</span><br><span class="line">                <span class="keyword">AND</span> TABLE_NAME <span class="operator">=</span> table_name</span><br><span class="line">                <span class="keyword">AND</span> PARTITION_NAME <span class="operator">=</span> CONCAT(<span class="string">&#x27;p&#x27;</span>, DATE_FORMAT(next_month_start, <span class="string">&#x27;%Y%m&#x27;</span>))</span><br><span class="line">        ) <span class="keyword">THEN</span></span><br><span class="line">            <span class="keyword">SET</span> partition_sql <span class="operator">=</span> CONCAT(</span><br><span class="line">                <span class="string">&#x27;ALTER TABLE &#x27;</span>, table_name, </span><br><span class="line">                <span class="string">&#x27; REORGANIZE PARTITION p_future INTO (&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;PARTITION p&#x27;</span>, DATE_FORMAT(next_month_start, <span class="string">&#x27;%Y%m&#x27;</span>),</span><br><span class="line">                <span class="string">&#x27; VALUES LESS THAN (&#x27;</span>, <span class="keyword">YEAR</span>(next_month_start) <span class="operator">*</span> <span class="number">100</span> <span class="operator">+</span> <span class="keyword">MONTH</span>(next_month_start) <span class="operator">+</span> <span class="number">1</span>, <span class="string">&#x27;),&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;PARTITION p_future VALUES LESS THAN MAXVALUE)&#x27;</span></span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">SET</span> <span class="variable">@sql</span> <span class="operator">=</span> partition_sql;</span><br><span class="line">            <span class="keyword">PREPARE</span> stmt <span class="keyword">FROM</span> <span class="variable">@sql</span>;</span><br><span class="line">            <span class="keyword">EXECUTE</span> stmt;</span><br><span class="line">            <span class="keyword">DEALLOCATE</span> <span class="keyword">PREPARE</span> stmt;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">INSERT INTO</span> partition_management_log (</span><br><span class="line">                table_name, operation, partition_name, executed_at</span><br><span class="line">            ) <span class="keyword">VALUES</span> (</span><br><span class="line">                table_name, <span class="string">&#x27;ADD&#x27;</span>, CONCAT(<span class="string">&#x27;p&#x27;</span>, DATE_FORMAT(next_month_start, <span class="string">&#x27;%Y%m&#x27;</span>)), NOW()</span><br><span class="line">            );</span><br><span class="line">        <span class="keyword">END</span> IF;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">SELECT</span> <span class="string">&#x27;分区管理完成&#x27;</span> <span class="keyword">as</span> <span class="keyword">result</span>;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建分区管理日志表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> partition_management_log (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    table_name <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    operation ENUM(<span class="string">&#x27;ADD&#x27;</span>, <span class="string">&#x27;DROP&#x27;</span>, <span class="string">&#x27;REORGANIZE&#x27;</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    partition_name <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">    executed_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    INDEX idx_table_time (table_name, executed_at)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用分区管理存储过程</span></span><br><span class="line"><span class="keyword">CALL</span> ManagePartitions(<span class="string">&#x27;orders_monthly&#x27;</span>, <span class="string">&#x27;monthly&#x27;</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看管理日志</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> partition_management_log </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> executed_at <span class="keyword">DESC</span> </span><br><span class="line">LIMIT <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-分区性能监控"><a href="#3-分区性能监控" class="headerlink" title="3. 分区性能监控"></a>3. 分区性能监控</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建分区性能监控视图</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> partition_performance_stats <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    p.TABLE_SCHEMA <span class="keyword">as</span> <span class="string">&#x27;数据库&#x27;</span>,</span><br><span class="line">    p.TABLE_NAME <span class="keyword">as</span> <span class="string">&#x27;表名&#x27;</span>,</span><br><span class="line">    p.PARTITION_NAME <span class="keyword">as</span> <span class="string">&#x27;分区名&#x27;</span>,</span><br><span class="line">    p.PARTITION_ORDINAL_POSITION <span class="keyword">as</span> <span class="string">&#x27;分区序号&#x27;</span>,</span><br><span class="line">    p.TABLE_ROWS <span class="keyword">as</span> <span class="string">&#x27;行数&#x27;</span>,</span><br><span class="line">    ROUND(p.DATA_LENGTH<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="string">&#x27;数据大小MB&#x27;</span>,</span><br><span class="line">    ROUND(p.INDEX_LENGTH<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="string">&#x27;索引大小MB&#x27;</span>,</span><br><span class="line">    ROUND((p.DATA_LENGTH <span class="operator">+</span> p.INDEX_LENGTH)<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="string">&#x27;总大小MB&#x27;</span>,</span><br><span class="line">    ROUND(p.DATA_LENGTH<span class="operator">/</span><span class="built_in">NULLIF</span>(p.TABLE_ROWS, <span class="number">0</span>), <span class="number">2</span>) <span class="keyword">as</span> <span class="string">&#x27;平均行大小&#x27;</span>,</span><br><span class="line">    p.PARTITION_METHOD <span class="keyword">as</span> <span class="string">&#x27;分区方法&#x27;</span>,</span><br><span class="line">    p.PARTITION_EXPRESSION <span class="keyword">as</span> <span class="string">&#x27;分区表达式&#x27;</span>,</span><br><span class="line">    p.PARTITION_DESCRIPTION <span class="keyword">as</span> <span class="string">&#x27;分区描述&#x27;</span></span><br><span class="line"><span class="keyword">FROM</span> information_schema.PARTITIONS p</span><br><span class="line"><span class="keyword">WHERE</span> p.TABLE_SCHEMA <span class="operator">=</span> DATABASE()</span><br><span class="line">    <span class="keyword">AND</span> p.PARTITION_NAME <span class="keyword">IS</span> <span class="keyword">NOT NULL</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> p.TABLE_NAME, p.PARTITION_ORDINAL_POSITION;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看分区性能统计</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> partition_performance_stats;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 分区查询性能测试</span></span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> TestPartitionPerformance(</span><br><span class="line">    <span class="keyword">IN</span> table_name <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">    <span class="keyword">IN</span> test_queries TEXT</span><br><span class="line">)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> start_time <span class="type">DECIMAL</span>(<span class="number">20</span>,<span class="number">6</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> end_time <span class="type">DECIMAL</span>(<span class="number">20</span>,<span class="number">6</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> execution_time <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">6</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 记录开始时间</span></span><br><span class="line">    <span class="keyword">SET</span> start_time <span class="operator">=</span> UNIX_TIMESTAMP(NOW(<span class="number">6</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 执行测试查询</span></span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@sql</span> <span class="operator">=</span> test_queries;</span><br><span class="line">    <span class="keyword">PREPARE</span> stmt <span class="keyword">FROM</span> <span class="variable">@sql</span>;</span><br><span class="line">    <span class="keyword">EXECUTE</span> stmt;</span><br><span class="line">    <span class="keyword">DEALLOCATE</span> <span class="keyword">PREPARE</span> stmt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 记录结束时间</span></span><br><span class="line">    <span class="keyword">SET</span> end_time <span class="operator">=</span> UNIX_TIMESTAMP(NOW(<span class="number">6</span>));</span><br><span class="line">    <span class="keyword">SET</span> execution_time <span class="operator">=</span> end_time <span class="operator">-</span> start_time;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 记录性能测试结果</span></span><br><span class="line">    <span class="keyword">INSERT INTO</span> partition_performance_log (</span><br><span class="line">        table_name, query_text, execution_time, test_time</span><br><span class="line">    ) <span class="keyword">VALUES</span> (</span><br><span class="line">        table_name, test_queries, execution_time, NOW()</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">SELECT</span> </span><br><span class="line">        table_name <span class="keyword">as</span> <span class="string">&#x27;表名&#x27;</span>,</span><br><span class="line">        execution_time <span class="keyword">as</span> <span class="string">&#x27;执行时间(秒)&#x27;</span>,</span><br><span class="line">        test_queries <span class="keyword">as</span> <span class="string">&#x27;测试查询&#x27;</span></span><br><span class="line">    ;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建性能测试日志表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> partition_performance_log (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    table_name <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    query_text TEXT <span class="keyword">NOT NULL</span>,</span><br><span class="line">    execution_time <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">6</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    test_time <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    INDEX idx_table_time (table_name, test_time)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 测试分区查询性能</span></span><br><span class="line"><span class="keyword">CALL</span> TestPartitionPerformance(</span><br><span class="line">    <span class="string">&#x27;orders_monthly&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;SELECT COUNT(*) FROM orders_monthly WHERE order_time &gt;= &quot;2023-08-01&quot; AND order_time &lt; &quot;2023-09-01&quot;&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 对比分区表和非分区表的性能</span></span><br><span class="line"><span class="comment">-- 创建相同结构的非分区表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders_no_partition <span class="keyword">LIKE</span> orders_monthly;</span><br><span class="line"><span class="keyword">ALTER TABLE</span> orders_no_partition REMOVE PARTITIONING;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入相同的测试数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders_no_partition <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders_monthly;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 性能对比测试</span></span><br><span class="line"><span class="keyword">CALL</span> TestPartitionPerformance(</span><br><span class="line">    <span class="string">&#x27;orders_no_partition&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;SELECT COUNT(*) FROM orders_no_partition WHERE order_time &gt;= &quot;2023-08-01&quot; AND order_time &lt; &quot;2023-09-01&quot;&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看性能对比结果</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    table_name,</span><br><span class="line">    <span class="built_in">AVG</span>(execution_time) <span class="keyword">as</span> avg_execution_time,</span><br><span class="line">    <span class="built_in">MIN</span>(execution_time) <span class="keyword">as</span> min_execution_time,</span><br><span class="line">    <span class="built_in">MAX</span>(execution_time) <span class="keyword">as</span> max_execution_time,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">as</span> test_count</span><br><span class="line"><span class="keyword">FROM</span> partition_performance_log </span><br><span class="line"><span class="keyword">WHERE</span> test_time <span class="operator">&gt;=</span> DATE_SUB(NOW(), <span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">HOUR</span>)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> table_name;</span><br></pre></td></tr></table></figure>

<h2 id="分区优化技巧"><a href="#分区优化技巧" class="headerlink" title="分区优化技巧"></a>分区优化技巧</h2><h3 id="1-分区裁剪优化"><a href="#1-分区裁剪优化" class="headerlink" title="1. 分区裁剪优化"></a>1. 分区裁剪优化</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建测试表验证分区裁剪</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> sales_partition_test (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT,</span><br><span class="line">    sale_date <span class="type">DATE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    product_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    customer_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    region_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (id, sale_date, region_id)</span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (<span class="keyword">YEAR</span>(sale_date))</span><br><span class="line">SUBPARTITION <span class="keyword">BY</span> HASH(region_id) SUBPARTITIONS <span class="number">4</span> (</span><br><span class="line">    <span class="keyword">PARTITION</span> p2022 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2023</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p2023 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2024</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p2024 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2025</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入测试数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> sales_partition_test (sale_date, product_id, customer_id, amount, region_id) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;2022-06-15&#x27;</span>, <span class="number">1001</span>, <span class="number">2001</span>, <span class="number">299.99</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="string">&#x27;2022-12-20&#x27;</span>, <span class="number">1002</span>, <span class="number">2002</span>, <span class="number">199.99</span>, <span class="number">2</span>),</span><br><span class="line">(<span class="string">&#x27;2023-03-10&#x27;</span>, <span class="number">1003</span>, <span class="number">2003</span>, <span class="number">399.99</span>, <span class="number">3</span>),</span><br><span class="line">(<span class="string">&#x27;2023-08-25&#x27;</span>, <span class="number">1004</span>, <span class="number">2004</span>, <span class="number">499.99</span>, <span class="number">4</span>),</span><br><span class="line">(<span class="string">&#x27;2024-01-05&#x27;</span>, <span class="number">1005</span>, <span class="number">2005</span>, <span class="number">599.99</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 好的查询：能够利用分区裁剪</span></span><br><span class="line">EXPLAIN PARTITIONS </span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> sales_partition_test </span><br><span class="line"><span class="keyword">WHERE</span> sale_date <span class="operator">&gt;=</span> <span class="string">&#x27;2023-01-01&#x27;</span> </span><br><span class="line">    <span class="keyword">AND</span> sale_date <span class="operator">&lt;</span> <span class="string">&#x27;2024-01-01&#x27;</span></span><br><span class="line">    <span class="keyword">AND</span> region_id <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 不好的查询：无法利用分区裁剪</span></span><br><span class="line">EXPLAIN PARTITIONS </span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> sales_partition_test </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">MONTH</span>(sale_date) <span class="operator">=</span> <span class="number">8</span>;  <span class="comment">-- 函数包装导致无法分区裁剪</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 优化后的查询</span></span><br><span class="line">EXPLAIN PARTITIONS </span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> sales_partition_test </span><br><span class="line"><span class="keyword">WHERE</span> sale_date <span class="operator">&gt;=</span> <span class="string">&#x27;2023-08-01&#x27;</span> </span><br><span class="line">    <span class="keyword">AND</span> sale_date <span class="operator">&lt;</span> <span class="string">&#x27;2023-09-01&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 分区裁剪效果分析</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="string">&#x27;查询类型&#x27;</span> <span class="keyword">as</span> query_type,</span><br><span class="line">    <span class="string">&#x27;是否分区裁剪&#x27;</span> <span class="keyword">as</span> partition_pruning,</span><br><span class="line">    <span class="string">&#x27;扫描分区数&#x27;</span> <span class="keyword">as</span> partitions_scanned,</span><br><span class="line">    <span class="string">&#x27;性能影响&#x27;</span> <span class="keyword">as</span> performance_impact</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;日期范围查询&#x27;</span>, <span class="string">&#x27;是&#x27;</span>, <span class="string">&#x27;1个主分区&#x27;</span>, <span class="string">&#x27;最优&#x27;</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;日期函数查询&#x27;</span>, <span class="string">&#x27;否&#x27;</span>, <span class="string">&#x27;所有分区&#x27;</span>, <span class="string">&#x27;最差&#x27;</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;复合条件查询&#x27;</span>, <span class="string">&#x27;部分&#x27;</span>, <span class="string">&#x27;部分分区&#x27;</span>, <span class="string">&#x27;中等&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-索引策略优化"><a href="#2-索引策略优化" class="headerlink" title="2. 索引策略优化"></a>2. 索引策略优化</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 分区表索引设计最佳实践</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> user_actions_optimized (</span><br><span class="line">    id <span class="type">BIGINT</span> AUTO_INCREMENT,</span><br><span class="line">    user_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    action_type <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    action_time <span class="type">TIMESTAMP</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    target_id <span class="type">INT</span>,</span><br><span class="line">    target_type <span class="type">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">    ip_address <span class="type">VARCHAR</span>(<span class="number">45</span>),</span><br><span class="line">    user_agent TEXT,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (id, action_time),  <span class="comment">-- 包含分区键</span></span><br><span class="line">    INDEX idx_user_action_time (user_id, action_time),  <span class="comment">-- 本地索引</span></span><br><span class="line">    INDEX idx_action_type_time (action_type, action_time),  <span class="comment">-- 本地索引</span></span><br><span class="line">    INDEX idx_target (target_type, target_id, action_time)  <span class="comment">-- 复合索引</span></span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (TO_DAYS(action_time)) (</span><br><span class="line">    <span class="keyword">PARTITION</span> p20230801 <span class="keyword">VALUES</span> LESS THAN (TO_DAYS(<span class="string">&#x27;2023-08-02&#x27;</span>)),</span><br><span class="line">    <span class="keyword">PARTITION</span> p20230802 <span class="keyword">VALUES</span> LESS THAN (TO_DAYS(<span class="string">&#x27;2023-08-03&#x27;</span>)),</span><br><span class="line">    <span class="keyword">PARTITION</span> p20230803 <span class="keyword">VALUES</span> LESS THAN (TO_DAYS(<span class="string">&#x27;2023-08-04&#x27;</span>)),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_future <span class="keyword">VALUES</span> LESS THAN MAXVALUE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 索引使用效果测试</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> user_actions_optimized (user_id, action_type, target_id, target_type) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1001</span>, <span class="string">&#x27;view&#x27;</span>, <span class="number">2001</span>, <span class="string">&#x27;product&#x27;</span>),</span><br><span class="line">(<span class="number">1002</span>, <span class="string">&#x27;click&#x27;</span>, <span class="number">2002</span>, <span class="string">&#x27;ad&#x27;</span>),</span><br><span class="line">(<span class="number">1003</span>, <span class="string">&#x27;purchase&#x27;</span>, <span class="number">2003</span>, <span class="string">&#x27;product&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 测试索引效果</span></span><br><span class="line">EXPLAIN PARTITIONS </span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user_actions_optimized </span><br><span class="line"><span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">1001</span> </span><br><span class="line">    <span class="keyword">AND</span> action_time <span class="operator">&gt;=</span> <span class="string">&#x27;2023-08-01 00:00:00&#x27;</span></span><br><span class="line">    <span class="keyword">AND</span> action_time <span class="operator">&lt;</span> <span class="string">&#x27;2023-08-02 00:00:00&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-分区表查询优化"><a href="#3-分区表查询优化" class="headerlink" title="3. 分区表查询优化"></a>3. 分区表查询优化</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建查询优化示例表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> order_analytics (</span><br><span class="line">    id <span class="type">BIGINT</span> AUTO_INCREMENT,</span><br><span class="line">    order_id <span class="type">BIGINT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    user_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    product_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    order_date <span class="type">DATE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    order_amount <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    payment_status TINYINT <span class="keyword">NOT NULL</span>,</span><br><span class="line">    region_code <span class="type">VARCHAR</span>(<span class="number">10</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (id, order_date),</span><br><span class="line">    INDEX idx_user_date (user_id, order_date),</span><br><span class="line">    INDEX idx_product_date (product_id, order_date),</span><br><span class="line">    INDEX idx_region_status (region_code, payment_status, order_date)</span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (<span class="keyword">YEAR</span>(order_date) <span class="operator">*</span> <span class="number">100</span> <span class="operator">+</span> <span class="keyword">MONTH</span>(order_date)) (</span><br><span class="line">    <span class="keyword">PARTITION</span> p202301 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202302</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202302 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202303</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202303 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202304</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202304 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202305</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202305 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202306</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202306 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202307</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202307 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202308</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202308 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202309</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_future <span class="keyword">VALUES</span> LESS THAN MAXVALUE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 优化的聚合查询</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    DATE_FORMAT(order_date, <span class="string">&#x27;%Y-%m&#x27;</span>) <span class="keyword">as</span> <span class="keyword">month</span>,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">as</span> order_count,</span><br><span class="line">    <span class="built_in">SUM</span>(order_amount) <span class="keyword">as</span> total_amount,</span><br><span class="line">    <span class="built_in">AVG</span>(order_amount) <span class="keyword">as</span> avg_amount</span><br><span class="line"><span class="keyword">FROM</span> order_analytics </span><br><span class="line"><span class="keyword">WHERE</span> order_date <span class="operator">&gt;=</span> <span class="string">&#x27;2023-06-01&#x27;</span> </span><br><span class="line">    <span class="keyword">AND</span> order_date <span class="operator">&lt;</span> <span class="string">&#x27;2023-09-01&#x27;</span></span><br><span class="line">    <span class="keyword">AND</span> payment_status <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> DATE_FORMAT(order_date, <span class="string">&#x27;%Y-%m&#x27;</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 跨分区JOIN优化</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    o.order_date,</span><br><span class="line">    o.order_amount,</span><br><span class="line">    u.username,</span><br><span class="line">    p.product_name</span><br><span class="line"><span class="keyword">FROM</span> order_analytics o</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> users u <span class="keyword">ON</span> o.user_id <span class="operator">=</span> u.id</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> products p <span class="keyword">ON</span> o.product_id <span class="operator">=</span> p.id</span><br><span class="line"><span class="keyword">WHERE</span> o.order_date <span class="operator">&gt;=</span> <span class="string">&#x27;2023-08-01&#x27;</span></span><br><span class="line">    <span class="keyword">AND</span> o.order_date <span class="operator">&lt;</span> <span class="string">&#x27;2023-08-02&#x27;</span></span><br><span class="line">    <span class="keyword">AND</span> o.payment_status <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h2 id="分区表最佳实践"><a href="#分区表最佳实践" class="headerlink" title="分区表最佳实践"></a>分区表最佳实践</h2><h3 id="1-分区设计原则"><a href="#1-分区设计原则" class="headerlink" title="1. 分区设计原则"></a>1. 分区设计原则</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 分区设计检查清单</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> partition_design_checklist <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="string">&#x27;设计原则&#x27;</span> <span class="keyword">as</span> principle,</span><br><span class="line">    <span class="string">&#x27;说明&#x27;</span> <span class="keyword">as</span> description,</span><br><span class="line">    <span class="string">&#x27;示例&#x27;</span> <span class="keyword">as</span> example</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;选择合适的分区键&#x27;</span>, <span class="string">&#x27;分区键应该是查询中经常使用的条件&#x27;</span>, <span class="string">&#x27;时间字段、用户ID、地区等&#x27;</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;分区数量控制&#x27;</span>, <span class="string">&#x27;分区数量不宜过多，建议不超过1000个&#x27;</span>, <span class="string">&#x27;按月分区而不是按天&#x27;</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;分区大小均衡&#x27;</span>, <span class="string">&#x27;各分区数据量应该相对均衡&#x27;</span>, <span class="string">&#x27;避免热点分区&#x27;</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;索引策略&#x27;</span>, <span class="string">&#x27;主键必须包含分区键&#x27;</span>, <span class="string">&#x27;PRIMARY KEY (id, partition_key)&#x27;</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;查询优化&#x27;</span>, <span class="string">&#x27;查询条件应包含分区键以利用分区裁剪&#x27;</span>, <span class="string">&#x27;WHERE date_col &gt;= &quot;2023-01-01&quot;&#x27;</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;维护策略&#x27;</span>, <span class="string">&#x27;制定分区的创建、删除和维护计划&#x27;</span>, <span class="string">&#x27;定期清理历史分区&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> partition_design_checklist;</span><br></pre></td></tr></table></figure>

<h3 id="2-分区监控和告警"><a href="#2-分区监控和告警" class="headerlink" title="2. 分区监控和告警"></a>2. 分区监控和告警</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建分区监控表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> partition_monitoring (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    table_name <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    partition_name <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    table_rows <span class="type">BIGINT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    data_size_mb <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    index_size_mb <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    check_time <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    INDEX idx_table_time (table_name, check_time)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 分区监控存储过程</span></span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> MonitorPartitions()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> done <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="literal">FALSE</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_table_name <span class="type">VARCHAR</span>(<span class="number">64</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> v_partition_name <span class="type">VARCHAR</span>(<span class="number">64</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> v_table_rows <span class="type">BIGINT</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_data_length <span class="type">BIGINT</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_index_length <span class="type">BIGINT</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">DECLARE</span> partition_cursor <span class="keyword">CURSOR</span> <span class="keyword">FOR</span></span><br><span class="line">        <span class="keyword">SELECT</span> </span><br><span class="line">            TABLE_NAME,</span><br><span class="line">            PARTITION_NAME,</span><br><span class="line">            TABLE_ROWS,</span><br><span class="line">            DATA_LENGTH,</span><br><span class="line">            INDEX_LENGTH</span><br><span class="line">        <span class="keyword">FROM</span> information_schema.PARTITIONS </span><br><span class="line">        <span class="keyword">WHERE</span> TABLE_SCHEMA <span class="operator">=</span> DATABASE()</span><br><span class="line">            <span class="keyword">AND</span> PARTITION_NAME <span class="keyword">IS</span> <span class="keyword">NOT NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">DECLARE</span> CONTINUE HANDLER <span class="keyword">FOR</span> <span class="keyword">NOT</span> FOUND <span class="keyword">SET</span> done <span class="operator">=</span> <span class="literal">TRUE</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 清空当前监控数据</span></span><br><span class="line">    <span class="keyword">DELETE</span> <span class="keyword">FROM</span> partition_monitoring <span class="keyword">WHERE</span> <span class="type">DATE</span>(check_time) <span class="operator">=</span> CURDATE();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">OPEN</span> partition_cursor;</span><br><span class="line">    </span><br><span class="line">    monitor_loop: LOOP</span><br><span class="line">        <span class="keyword">FETCH</span> partition_cursor <span class="keyword">INTO</span> </span><br><span class="line">            v_table_name, v_partition_name, v_table_rows, v_data_length, v_index_length;</span><br><span class="line">        </span><br><span class="line">        IF done <span class="keyword">THEN</span> LEAVE monitor_loop; <span class="keyword">END</span> IF;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">INSERT INTO</span> partition_monitoring (</span><br><span class="line">            table_name, partition_name, table_rows, </span><br><span class="line">            data_size_mb, index_size_mb</span><br><span class="line">        ) <span class="keyword">VALUES</span> (</span><br><span class="line">            v_table_name, v_partition_name, v_table_rows,</span><br><span class="line">            ROUND(v_data_length<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>, <span class="number">2</span>),</span><br><span class="line">            ROUND(v_index_length<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>, <span class="number">2</span>)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">END</span> LOOP;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">CLOSE</span> partition_cursor;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 检查异常分区</span></span><br><span class="line">    <span class="keyword">SELECT</span> </span><br><span class="line">        table_name,</span><br><span class="line">        partition_name,</span><br><span class="line">        table_rows,</span><br><span class="line">        data_size_mb,</span><br><span class="line">        <span class="string">&#x27;分区过大&#x27;</span> <span class="keyword">as</span> alert_type</span><br><span class="line">    <span class="keyword">FROM</span> partition_monitoring </span><br><span class="line">    <span class="keyword">WHERE</span> check_time <span class="operator">&gt;=</span> CURDATE()</span><br><span class="line">        <span class="keyword">AND</span> (data_size_mb <span class="operator">&gt;</span> <span class="number">1000</span> <span class="keyword">OR</span> table_rows <span class="operator">&gt;</span> <span class="number">1000000</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">SELECT</span> </span><br><span class="line">        table_name,</span><br><span class="line">        partition_name,</span><br><span class="line">        table_rows,</span><br><span class="line">        data_size_mb,</span><br><span class="line">        <span class="string">&#x27;空分区&#x27;</span> <span class="keyword">as</span> alert_type</span><br><span class="line">    <span class="keyword">FROM</span> partition_monitoring </span><br><span class="line">    <span class="keyword">WHERE</span> check_time <span class="operator">&gt;=</span> CURDATE()</span><br><span class="line">        <span class="keyword">AND</span> table_rows <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">AND</span> partition_name <span class="operator">!=</span> <span class="string">&#x27;p_future&#x27;</span>;</span><br><span class="line">        </span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 定期执行监控</span></span><br><span class="line"><span class="comment">-- 可以配合事件调度器定期执行</span></span><br><span class="line"><span class="keyword">CALL</span> MonitorPartitions();</span><br></pre></td></tr></table></figure>

<h3 id="3-分区迁移和重构"><a href="#3-分区迁移和重构" class="headerlink" title="3. 分区迁移和重构"></a>3. 分区迁移和重构</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 分区重构示例：从按年分区改为按月分区</span></span><br><span class="line"><span class="comment">-- 1. 创建新的按月分区表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders_monthly_new (</span><br><span class="line">    id <span class="type">BIGINT</span> AUTO_INCREMENT,</span><br><span class="line">    order_no <span class="type">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    user_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    order_amount <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    order_date <span class="type">DATE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    status TINYINT <span class="keyword">NOT NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (id, order_date),</span><br><span class="line">    <span class="keyword">UNIQUE</span> KEY uk_order_no_date (order_no, order_date),</span><br><span class="line">    INDEX idx_user_date (user_id, order_date)</span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (<span class="keyword">YEAR</span>(order_date) <span class="operator">*</span> <span class="number">100</span> <span class="operator">+</span> <span class="keyword">MONTH</span>(order_date)) (</span><br><span class="line">    <span class="keyword">PARTITION</span> p202301 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202302</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202302 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202303</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202303 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202304</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202304 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202305</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202305 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202306</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202306 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202307</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202307 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202308</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p202308 <span class="keyword">VALUES</span> LESS THAN (<span class="number">202309</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_future <span class="keyword">VALUES</span> LESS THAN MAXVALUE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 数据迁移存储过程</span></span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> MigratePartitionData(</span><br><span class="line">    <span class="keyword">IN</span> source_table <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">    <span class="keyword">IN</span> target_table <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">    <span class="keyword">IN</span> batch_size <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">10000</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> done <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="literal">FALSE</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> total_migrated <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> batch_count <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 分批迁移数据</span></span><br><span class="line">    REPEAT</span><br><span class="line">        <span class="keyword">SET</span> <span class="variable">@sql</span> <span class="operator">=</span> CONCAT(</span><br><span class="line">            <span class="string">&#x27;INSERT INTO &#x27;</span>, target_table, </span><br><span class="line">            <span class="string">&#x27; SELECT * FROM &#x27;</span>, source_table, </span><br><span class="line">            <span class="string">&#x27; LIMIT &#x27;</span>, batch_size, <span class="string">&#x27; OFFSET &#x27;</span>, batch_count <span class="operator">*</span> batch_size</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">PREPARE</span> stmt <span class="keyword">FROM</span> <span class="variable">@sql</span>;</span><br><span class="line">        <span class="keyword">EXECUTE</span> stmt;</span><br><span class="line">        <span class="keyword">DEALLOCATE</span> <span class="keyword">PREPARE</span> stmt;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">SET</span> batch_count <span class="operator">=</span> batch_count <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">SET</span> total_migrated <span class="operator">=</span> total_migrated <span class="operator">+</span> ROW_COUNT();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">-- 避免长时间锁表</span></span><br><span class="line">        <span class="keyword">SELECT</span> SLEEP(<span class="number">0.1</span>);</span><br><span class="line">        </span><br><span class="line">    UNTIL ROW_COUNT() <span class="operator">=</span> <span class="number">0</span> <span class="keyword">END</span> REPEAT;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">SELECT</span> CONCAT(<span class="string">&#x27;迁移完成，共迁移 &#x27;</span>, total_migrated, <span class="string">&#x27; 条记录&#x27;</span>) <span class="keyword">as</span> <span class="keyword">result</span>;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 执行迁移</span></span><br><span class="line"><span class="comment">-- CALL MigratePartitionData(&#x27;orders_yearly&#x27;, &#x27;orders_monthly_new&#x27;, 5000);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 4. 验证数据一致性</span></span><br><span class="line"><span class="comment">-- SELECT COUNT(*) FROM orders_yearly;</span></span><br><span class="line"><span class="comment">-- SELECT COUNT(*) FROM orders_monthly_new;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 5. 切换表名</span></span><br><span class="line"><span class="comment">-- RENAME TABLE orders_yearly TO orders_yearly_backup;</span></span><br><span class="line"><span class="comment">-- RENAME TABLE orders_monthly_new TO orders_monthly;</span></span><br></pre></td></tr></table></figure>

<h3 id="4-性能基准测试"><a href="#4-性能基准测试" class="headerlink" title="4. 性能基准测试"></a>4. 性能基准测试</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建性能测试框架</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> partition_benchmark_results (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    test_name <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    table_type ENUM(<span class="string">&#x27;partitioned&#x27;</span>, <span class="string">&#x27;non_partitioned&#x27;</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    query_type <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    execution_time <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">6</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    rows_examined <span class="type">BIGINT</span>,</span><br><span class="line">    rows_returned <span class="type">BIGINT</span>,</span><br><span class="line">    test_timestamp <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    INDEX idx_test_name (test_name),</span><br><span class="line">    INDEX idx_table_type (table_type),</span><br><span class="line">    INDEX idx_timestamp (test_timestamp)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 性能测试存储过程</span></span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> BenchmarkPartitionPerformance(</span><br><span class="line">    <span class="keyword">IN</span> test_name <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    <span class="keyword">IN</span> partitioned_table <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">    <span class="keyword">IN</span> non_partitioned_table <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">    <span class="keyword">IN</span> test_query_template TEXT,</span><br><span class="line">    <span class="keyword">IN</span> iterations <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">10</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> start_time <span class="type">DECIMAL</span>(<span class="number">20</span>,<span class="number">6</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> end_time <span class="type">DECIMAL</span>(<span class="number">20</span>,<span class="number">6</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> execution_time <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">6</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> query_sql TEXT;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 测试分区表</span></span><br><span class="line">    WHILE i <span class="operator">&lt;</span> iterations DO</span><br><span class="line">        <span class="keyword">SET</span> query_sql <span class="operator">=</span> REPLACE(test_query_template, <span class="string">&#x27;&#123;TABLE&#125;&#x27;</span>, partitioned_table);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">SET</span> start_time <span class="operator">=</span> UNIX_TIMESTAMP(NOW(<span class="number">6</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">SET</span> <span class="variable">@sql</span> <span class="operator">=</span> query_sql;</span><br><span class="line">        <span class="keyword">PREPARE</span> stmt <span class="keyword">FROM</span> <span class="variable">@sql</span>;</span><br><span class="line">        <span class="keyword">EXECUTE</span> stmt;</span><br><span class="line">        <span class="keyword">DEALLOCATE</span> <span class="keyword">PREPARE</span> stmt;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">SET</span> end_time <span class="operator">=</span> UNIX_TIMESTAMP(NOW(<span class="number">6</span>));</span><br><span class="line">        <span class="keyword">SET</span> execution_time <span class="operator">=</span> end_time <span class="operator">-</span> start_time;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">INSERT INTO</span> partition_benchmark_results (</span><br><span class="line">            test_name, table_type, query_type, execution_time</span><br><span class="line">        ) <span class="keyword">VALUES</span> (</span><br><span class="line">            test_name, <span class="string">&#x27;partitioned&#x27;</span>, <span class="string">&#x27;SELECT&#x27;</span>, execution_time</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">END</span> WHILE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 测试非分区表</span></span><br><span class="line">    <span class="keyword">SET</span> i <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    WHILE i <span class="operator">&lt;</span> iterations DO</span><br><span class="line">        <span class="keyword">SET</span> query_sql <span class="operator">=</span> REPLACE(test_query_template, <span class="string">&#x27;&#123;TABLE&#125;&#x27;</span>, non_partitioned_table);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">SET</span> start_time <span class="operator">=</span> UNIX_TIMESTAMP(NOW(<span class="number">6</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">SET</span> <span class="variable">@sql</span> <span class="operator">=</span> query_sql;</span><br><span class="line">        <span class="keyword">PREPARE</span> stmt <span class="keyword">FROM</span> <span class="variable">@sql</span>;</span><br><span class="line">        <span class="keyword">EXECUTE</span> stmt;</span><br><span class="line">        <span class="keyword">DEALLOCATE</span> <span class="keyword">PREPARE</span> stmt;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">SET</span> end_time <span class="operator">=</span> UNIX_TIMESTAMP(NOW(<span class="number">6</span>));</span><br><span class="line">        <span class="keyword">SET</span> execution_time <span class="operator">=</span> end_time <span class="operator">-</span> start_time;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">INSERT INTO</span> partition_benchmark_results (</span><br><span class="line">            test_name, table_type, query_type, execution_time</span><br><span class="line">        ) <span class="keyword">VALUES</span> (</span><br><span class="line">            test_name, <span class="string">&#x27;non_partitioned&#x27;</span>, <span class="string">&#x27;SELECT&#x27;</span>, execution_time</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">END</span> WHILE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 输出测试结果</span></span><br><span class="line">    <span class="keyword">SELECT</span> </span><br><span class="line">        table_type,</span><br><span class="line">        <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">as</span> test_count,</span><br><span class="line">        ROUND(<span class="built_in">AVG</span>(execution_time), <span class="number">6</span>) <span class="keyword">as</span> avg_time,</span><br><span class="line">        ROUND(<span class="built_in">MIN</span>(execution_time), <span class="number">6</span>) <span class="keyword">as</span> min_time,</span><br><span class="line">        ROUND(<span class="built_in">MAX</span>(execution_time), <span class="number">6</span>) <span class="keyword">as</span> max_time,</span><br><span class="line">        ROUND(STDDEV(execution_time), <span class="number">6</span>) <span class="keyword">as</span> stddev_time</span><br><span class="line">    <span class="keyword">FROM</span> partition_benchmark_results </span><br><span class="line">    <span class="keyword">WHERE</span> test_name <span class="operator">=</span> test_name</span><br><span class="line">        <span class="keyword">AND</span> test_timestamp <span class="operator">&gt;=</span> DATE_SUB(NOW(), <span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">HOUR</span>)</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> table_type;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行性能测试</span></span><br><span class="line"><span class="keyword">CALL</span> BenchmarkPartitionPerformance(</span><br><span class="line">    <span class="string">&#x27;date_range_query&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;orders_monthly&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;orders_no_partition&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;SELECT COUNT(*) FROM &#123;TABLE&#125; WHERE order_date &gt;= &quot;2023-08-01&quot; AND order_date &lt; &quot;2023-09-01&quot;&#x27;</span>,</span><br><span class="line">    <span class="number">5</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看测试结果汇总</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    test_name,</span><br><span class="line">    table_type,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">as</span> test_runs,</span><br><span class="line">    ROUND(<span class="built_in">AVG</span>(execution_time), <span class="number">6</span>) <span class="keyword">as</span> avg_execution_time,</span><br><span class="line">    ROUND(<span class="built_in">MIN</span>(execution_time), <span class="number">6</span>) <span class="keyword">as</span> min_execution_time,</span><br><span class="line">    ROUND(<span class="built_in">MAX</span>(execution_time), <span class="number">6</span>) <span class="keyword">as</span> max_execution_time,</span><br><span class="line">    ROUND(</span><br><span class="line">        (<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(execution_time) </span><br><span class="line">         <span class="keyword">FROM</span> partition_benchmark_results p2 </span><br><span class="line">         <span class="keyword">WHERE</span> p2.test_name <span class="operator">=</span> p1.test_name </span><br><span class="line">           <span class="keyword">AND</span> p2.table_type <span class="operator">=</span> <span class="string">&#x27;non_partitioned&#x27;</span>) <span class="operator">/</span> <span class="built_in">AVG</span>(execution_time), <span class="number">2</span></span><br><span class="line">    ) <span class="keyword">as</span> performance_ratio</span><br><span class="line"><span class="keyword">FROM</span> partition_benchmark_results p1</span><br><span class="line"><span class="keyword">WHERE</span> test_timestamp <span class="operator">&gt;=</span> DATE_SUB(NOW(), <span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">DAY</span>)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> test_name, table_type</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> test_name, table_type;</span><br></pre></td></tr></table></figure>

<h2 id="常见问题和解决方案"><a href="#常见问题和解决方案" class="headerlink" title="常见问题和解决方案"></a>常见问题和解决方案</h2><h3 id="1-分区表常见错误"><a href="#1-分区表常见错误" class="headerlink" title="1. 分区表常见错误"></a>1. 分区表常见错误</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 错误1：主键不包含分区键</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">CREATE TABLE error_example1 (</span></span><br><span class="line"><span class="comment">    id INT AUTO_INCREMENT PRIMARY KEY,  -- 错误：主键不包含分区键</span></span><br><span class="line"><span class="comment">    user_id INT NOT NULL,</span></span><br><span class="line"><span class="comment">    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span></span><br><span class="line"><span class="comment">) PARTITION BY RANGE (YEAR(created_at)) (</span></span><br><span class="line"><span class="comment">    PARTITION p2023 VALUES LESS THAN (2024)</span></span><br><span class="line"><span class="comment">);</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正确做法</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> correct_example1 (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT,</span><br><span class="line">    user_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (id, created_at)  <span class="comment">-- 主键包含分区键</span></span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (<span class="keyword">YEAR</span>(created_at)) (</span><br><span class="line">    <span class="keyword">PARTITION</span> p2023 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2024</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_future <span class="keyword">VALUES</span> LESS THAN MAXVALUE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 错误2：外键约束问题</span></span><br><span class="line"><span class="comment">-- 分区表不支持外键约束，需要在应用层处理</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 错误3：全文索引问题</span></span><br><span class="line"><span class="comment">-- 分区表不支持全文索引，需要使用其他搜索方案</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 分区表限制检查</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="string">&#x27;限制类型&#x27;</span> <span class="keyword">as</span> limitation_type,</span><br><span class="line">    <span class="string">&#x27;说明&#x27;</span> <span class="keyword">as</span> description,</span><br><span class="line">    <span class="string">&#x27;解决方案&#x27;</span> <span class="keyword">as</span> solution</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;主键约束&#x27;</span>, <span class="string">&#x27;主键必须包含分区键&#x27;</span>, <span class="string">&#x27;调整主键定义&#x27;</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;外键约束&#x27;</span>, <span class="string">&#x27;不支持外键约束&#x27;</span>, <span class="string">&#x27;应用层处理或使用触发器&#x27;</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;全文索引&#x27;</span>, <span class="string">&#x27;不支持FULLTEXT索引&#x27;</span>, <span class="string">&#x27;使用ElasticSearch等搜索引擎&#x27;</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;分区函数&#x27;</span>, <span class="string">&#x27;只支持特定的分区函数&#x27;</span>, <span class="string">&#x27;选择合适的分区函数&#x27;</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;分区数量&#x27;</span>, <span class="string">&#x27;最多支持8192个分区&#x27;</span>, <span class="string">&#x27;合理规划分区数量&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-分区维护最佳实践"><a href="#2-分区维护最佳实践" class="headerlink" title="2. 分区维护最佳实践"></a>2. 分区维护最佳实践</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建分区维护计划</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> partition_maintenance_plan (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    table_name <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    partition_type ENUM(<span class="string">&#x27;RANGE&#x27;</span>, <span class="string">&#x27;LIST&#x27;</span>, <span class="string">&#x27;HASH&#x27;</span>, <span class="string">&#x27;KEY&#x27;</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    maintenance_type ENUM(<span class="string">&#x27;ADD&#x27;</span>, <span class="string">&#x27;DROP&#x27;</span>, <span class="string">&#x27;REORGANIZE&#x27;</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    schedule_time <span class="type">TIME</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    retention_months <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">12</span>,</span><br><span class="line">    is_active TINYINT <span class="keyword">DEFAULT</span> <span class="number">1</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    INDEX idx_table_name (table_name),</span><br><span class="line">    INDEX idx_schedule (schedule_time, is_active)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入维护计划</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> partition_maintenance_plan (</span><br><span class="line">    table_name, partition_type, maintenance_type, schedule_time, retention_months</span><br><span class="line">) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;orders_monthly&#x27;</span>, <span class="string">&#x27;RANGE&#x27;</span>, <span class="string">&#x27;ADD&#x27;</span>, <span class="string">&#x27;02:00:00&#x27;</span>, <span class="number">12</span>),</span><br><span class="line">(<span class="string">&#x27;orders_monthly&#x27;</span>, <span class="string">&#x27;RANGE&#x27;</span>, <span class="string">&#x27;DROP&#x27;</span>, <span class="string">&#x27;03:00:00&#x27;</span>, <span class="number">12</span>),</span><br><span class="line">(<span class="string">&#x27;system_logs&#x27;</span>, <span class="string">&#x27;RANGE&#x27;</span>, <span class="string">&#x27;DROP&#x27;</span>, <span class="string">&#x27;01:00:00&#x27;</span>, <span class="number">3</span>),</span><br><span class="line">(<span class="string">&#x27;user_behaviors&#x27;</span>, <span class="string">&#x27;RANGE&#x27;</span>, <span class="string">&#x27;ADD&#x27;</span>, <span class="string">&#x27;02:30:00&#x27;</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 自动维护执行存储过程</span></span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> ExecutePartitionMaintenance()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> done <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="literal">FALSE</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_table_name <span class="type">VARCHAR</span>(<span class="number">64</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> v_maintenance_type <span class="type">VARCHAR</span>(<span class="number">20</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> v_retention_months <span class="type">INT</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">DECLARE</span> maintenance_cursor <span class="keyword">CURSOR</span> <span class="keyword">FOR</span></span><br><span class="line">        <span class="keyword">SELECT</span> table_name, maintenance_type, retention_months</span><br><span class="line">        <span class="keyword">FROM</span> partition_maintenance_plan </span><br><span class="line">        <span class="keyword">WHERE</span> is_active <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">            <span class="keyword">AND</span> <span class="type">TIME</span>(NOW()) <span class="keyword">BETWEEN</span> schedule_time <span class="keyword">AND</span> ADDTIME(schedule_time, <span class="string">&#x27;00:30:00&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">DECLARE</span> CONTINUE HANDLER <span class="keyword">FOR</span> <span class="keyword">NOT</span> FOUND <span class="keyword">SET</span> done <span class="operator">=</span> <span class="literal">TRUE</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">OPEN</span> maintenance_cursor;</span><br><span class="line">    </span><br><span class="line">    maintenance_loop: LOOP</span><br><span class="line">        <span class="keyword">FETCH</span> maintenance_cursor <span class="keyword">INTO</span> v_table_name, v_maintenance_type, v_retention_months;</span><br><span class="line">        </span><br><span class="line">        IF done <span class="keyword">THEN</span> LEAVE maintenance_loop; <span class="keyword">END</span> IF;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">CASE</span> v_maintenance_type</span><br><span class="line">            <span class="keyword">WHEN</span> <span class="string">&#x27;ADD&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">                <span class="keyword">CALL</span> AddFuturePartitions(v_table_name);</span><br><span class="line">            <span class="keyword">WHEN</span> <span class="string">&#x27;DROP&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">                <span class="keyword">CALL</span> DropOldPartitions(v_table_name, v_retention_months);</span><br><span class="line">            <span class="keyword">WHEN</span> <span class="string">&#x27;REORGANIZE&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">                <span class="keyword">CALL</span> ReorganizePartitions(v_table_name);</span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">CASE</span>;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">END</span> LOOP;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">CLOSE</span> maintenance_cursor;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>MySQL分区表是处理大数据量的有效解决方案，通过合理的分区策略可以显著提升查询性能：</p>
<h3 id="分区表优势："><a href="#分区表优势：" class="headerlink" title="分区表优势："></a>分区表优势：</h3><ol>
<li><strong>查询性能提升</strong>：通过分区裁剪减少扫描数据量</li>
<li><strong>维护效率</strong>：可以对单个分区进行维护操作</li>
<li><strong>并行处理</strong>：支持分区级别的并行查询</li>
<li><strong>存储管理</strong>：便于数据归档和清理</li>
</ol>
<h3 id="选择建议："><a href="#选择建议：" class="headerlink" title="选择建议："></a>选择建议：</h3><ol>
<li><strong>RANGE分区</strong>：适用于时间序列数据</li>
<li><strong>LIST分区</strong>：适用于有限枚举值的数据</li>
<li><strong>HASH分区</strong>：适用于数据均匀分布的场景</li>
<li><strong>KEY分区</strong>：适用于主键分区的场景</li>
</ol>
<h3 id="注意事项："><a href="#注意事项：" class="headerlink" title="注意事项："></a>注意事项：</h3><ol>
<li><strong>分区键选择</strong>：选择查询中经常使用的字段</li>
<li><strong>主键设计</strong>：必须包含分区键</li>
<li><strong>索引策略</strong>：合理设计本地索引</li>
<li><strong>维护计划</strong>：制定分区的创建和清理策略</li>
<li><strong>性能监控</strong>：定期监控分区性能和数据分布</li>
</ol>
<p>通过合理使用分区表技术，可以有效解决大数据量场景下的性能问题，提升数据库的整体处理能力。</p>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/mysql/">mysql</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E5%88%86%E5%8C%BA%E8%A1%A8/">分区表</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9E%B6%E6%9E%84/">数据库架构</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2023/mysql/mysql-backup-recovery-strategies/"
                                   title="MySQL备份与恢复完全指南：数据安全保障实战策略"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">MySQL备份与恢复完全指南：数据安全保障实战策略</span>
                                        <span class="post-nav-item">上一篇</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2023/thinkphp/thinkphp6-middleware-auth-system/"
                                   title="ThinkPHP6/8 中间件开发与权限控制系统实战"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">ThinkPHP6/8 中间件开发与权限控制系统实战</span>
                                        <span class="post-nav-item">下一篇</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    






                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#MySQL%E5%88%86%E5%8C%BA%E8%A1%A8%E7%AD%96%E7%95%A5%E4%B8%8E%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8"><span class="nav-text">MySQL分区表策略与实战应用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%8C%BA%E8%A1%A8%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="nav-text">分区表基础概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%88%86%E5%8C%BA%E8%A1%A8%E5%8E%9F%E7%90%86"><span class="nav-text">1. 分区表原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%86%E5%8C%BA%E7%B1%BB%E5%9E%8B%E8%AF%A6%E8%A7%A3"><span class="nav-text">2. 分区类型详解</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E6%88%98%E5%88%86%E5%8C%BA%E7%AD%96%E7%95%A5"><span class="nav-text">实战分区策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E6%95%B0%E6%8D%AE%E5%88%86%E5%8C%BA"><span class="nav-text">1. 时间序列数据分区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE%E5%88%86%E5%8C%BA%E7%AD%96%E7%95%A5"><span class="nav-text">2. 用户数据分区策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E8%AE%A2%E5%8D%95%E6%95%B0%E6%8D%AE%E5%88%86%E5%8C%BA%E5%AE%9E%E6%88%98"><span class="nav-text">3. 订单数据分区实战</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%8C%BA%E7%AE%A1%E7%90%86%E6%93%8D%E4%BD%9C"><span class="nav-text">分区管理操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%8A%A8%E6%80%81%E5%88%86%E5%8C%BA%E7%AE%A1%E7%90%86"><span class="nav-text">1. 动态分区管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%86%E5%8C%BA%E7%BB%B4%E6%8A%A4%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="nav-text">2. 分区维护存储过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%88%86%E5%8C%BA%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7"><span class="nav-text">3. 分区性能监控</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%8C%BA%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7"><span class="nav-text">分区优化技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%88%86%E5%8C%BA%E8%A3%81%E5%89%AA%E4%BC%98%E5%8C%96"><span class="nav-text">1. 分区裁剪优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E7%B4%A2%E5%BC%95%E7%AD%96%E7%95%A5%E4%BC%98%E5%8C%96"><span class="nav-text">2. 索引策略优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%88%86%E5%8C%BA%E8%A1%A8%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="nav-text">3. 分区表查询优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%8C%BA%E8%A1%A8%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-text">分区表最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%88%86%E5%8C%BA%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="nav-text">1. 分区设计原则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%86%E5%8C%BA%E7%9B%91%E6%8E%A7%E5%92%8C%E5%91%8A%E8%AD%A6"><span class="nav-text">2. 分区监控和告警</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%88%86%E5%8C%BA%E8%BF%81%E7%A7%BB%E5%92%8C%E9%87%8D%E6%9E%84"><span class="nav-text">3. 分区迁移和重构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%80%A7%E8%83%BD%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95"><span class="nav-text">4. 性能基准测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-text">常见问题和解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%88%86%E5%8C%BA%E8%A1%A8%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF"><span class="nav-text">1. 分区表常见错误</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%86%E5%8C%BA%E7%BB%B4%E6%8A%A4%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-text">2. 分区维护最佳实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%8C%BA%E8%A1%A8%E4%BC%98%E5%8A%BF%EF%BC%9A"><span class="nav-text">分区表优势：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%89%E6%8B%A9%E5%BB%BA%E8%AE%AE%EF%BC%9A"><span class="nav-text">选择建议：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%EF%BC%9A"><span class="nav-text">注意事项：</span></a></li></ol></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
    &copy;&nbsp;2025
    
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">Orion K</a>
        
    </div>


    
        
        <div class="deploy-info info-item">
            
            本站由 <span class="tooltip" data-tooltip-content="GitHub Pages"><img src="/images/brands/github.png"></span> 提供部署服务
            
        </div>
    

    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#MySQL%E5%88%86%E5%8C%BA%E8%A1%A8%E7%AD%96%E7%95%A5%E4%B8%8E%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8"><span class="nav-text">MySQL分区表策略与实战应用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%8C%BA%E8%A1%A8%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="nav-text">分区表基础概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%88%86%E5%8C%BA%E8%A1%A8%E5%8E%9F%E7%90%86"><span class="nav-text">1. 分区表原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%86%E5%8C%BA%E7%B1%BB%E5%9E%8B%E8%AF%A6%E8%A7%A3"><span class="nav-text">2. 分区类型详解</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E6%88%98%E5%88%86%E5%8C%BA%E7%AD%96%E7%95%A5"><span class="nav-text">实战分区策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E6%95%B0%E6%8D%AE%E5%88%86%E5%8C%BA"><span class="nav-text">1. 时间序列数据分区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE%E5%88%86%E5%8C%BA%E7%AD%96%E7%95%A5"><span class="nav-text">2. 用户数据分区策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E8%AE%A2%E5%8D%95%E6%95%B0%E6%8D%AE%E5%88%86%E5%8C%BA%E5%AE%9E%E6%88%98"><span class="nav-text">3. 订单数据分区实战</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%8C%BA%E7%AE%A1%E7%90%86%E6%93%8D%E4%BD%9C"><span class="nav-text">分区管理操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%8A%A8%E6%80%81%E5%88%86%E5%8C%BA%E7%AE%A1%E7%90%86"><span class="nav-text">1. 动态分区管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%86%E5%8C%BA%E7%BB%B4%E6%8A%A4%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="nav-text">2. 分区维护存储过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%88%86%E5%8C%BA%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7"><span class="nav-text">3. 分区性能监控</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%8C%BA%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7"><span class="nav-text">分区优化技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%88%86%E5%8C%BA%E8%A3%81%E5%89%AA%E4%BC%98%E5%8C%96"><span class="nav-text">1. 分区裁剪优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E7%B4%A2%E5%BC%95%E7%AD%96%E7%95%A5%E4%BC%98%E5%8C%96"><span class="nav-text">2. 索引策略优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%88%86%E5%8C%BA%E8%A1%A8%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="nav-text">3. 分区表查询优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%8C%BA%E8%A1%A8%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-text">分区表最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%88%86%E5%8C%BA%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="nav-text">1. 分区设计原则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%86%E5%8C%BA%E7%9B%91%E6%8E%A7%E5%92%8C%E5%91%8A%E8%AD%A6"><span class="nav-text">2. 分区监控和告警</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%88%86%E5%8C%BA%E8%BF%81%E7%A7%BB%E5%92%8C%E9%87%8D%E6%9E%84"><span class="nav-text">3. 分区迁移和重构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%80%A7%E8%83%BD%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95"><span class="nav-text">4. 性能基准测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-text">常见问题和解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%88%86%E5%8C%BA%E8%A1%A8%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF"><span class="nav-text">1. 分区表常见错误</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%86%E5%8C%BA%E7%BB%B4%E6%8A%A4%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-text">2. 分区维护最佳实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%8C%BA%E8%A1%A8%E4%BC%98%E5%8A%BF%EF%BC%9A"><span class="nav-text">分区表优势：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%89%E6%8B%A9%E5%BB%BA%E8%AE%AE%EF%BC%9A"><span class="nav-text">选择建议：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%EF%BC%9A"><span class="nav-text">注意事项：</span></a></li></ol></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->

<script src="/js/utils.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/toggle-theme.js"></script>

<script src="/js/code-block.js"></script>

<script src="/js/main.js"></script>

<script src="/js/libs/anime.min.js"></script>


<!-- local search -->

    
<script src="/js/local-search.js"></script>



<!-- lazyload -->


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        
<script src="/js/post/post-helper.js"></script>


        <!-- toc -->
        
            
<script src="/js/post/toc.js"></script>

        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
