<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Orion K">
    
    <title>
        
            Python异步编程实战指南：从入门到精通 |
        
        Orion K Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/logo.svg">
    
    
<link rel="stylesheet" href="/font/css/fontawesome.min.css">

    
<link rel="stylesheet" href="/font/css/regular.min.css">

    
<link rel="stylesheet" href="/font/css/solid.min.css">

    
<link rel="stylesheet" href="/font/css/brands.min.css">

    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"Orion K Blog","author":"Orion K","avatar":"/images/avatar.svg","logo":"/images/logo.svg","favicon":"/images/logo.svg"},"menu":{"home":"/                        || fa-solid fa-home","archives":"/archives            || fa-solid fa-box-archive","tags":"/tags                    || fa-solid fa-tags","categories":"/categories        || fa-solid fa-layer-group"},"first_screen":{"enable":false,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":false,"hide_header":true},"home":{"announcement":"欢迎来到 Orion K 的博客，这是一个分享互联网技术的博客。联系：wxmm686800@gmail.com","category":true,"tag":true,"post_datetime":"created"},"post":{"author_badge":{"enable":true,"level_badge":true,"custom_badge":["One","Two","Three"]},"word_count":{"wordcount":false,"min2read":false},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false,"reward":{"enable":false,"img_link":null,"text":null,"icon":null}},"code_block":{"tools":{"enable":false,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":false,"site_uv":false,"site_pv":false,"page_pv":false}},"local_search":{"enable":true,"preload":true},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.39"},"waline":{"server_url":null,"reaction":false,"version":"3.3.2"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":false},"lazyload":{"enable":false},"cdn":{"enable":false,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2025,"word_count":false,"site_deploy":{"enable":true,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.5"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/logo.svg">
                </a>
            
            <a class="site-name border-box" href="/">
               Orion K Blog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-home"></i>
                                
                                首页
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                
                                归档
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-tags"></i>
                                
                                标签
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-layer-group"></i>
                                
                                分类
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-home"></i>
                                </span>
                            
                            首页
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                </span>
                            
                            归档
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-tags"></i>
                                </span>
                            
                            标签
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-layer-group"></i>
                                </span>
                            
                            分类
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        Python异步编程实战指南：从入门到精通
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/avatar.svg">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">Orion K</span>
                                
                                    <span class="author-badge">Lv6</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2023-03-10 09:45:00</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/python/">python</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/">异步编程</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/asyncio/">asyncio</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E5%B9%B6%E5%8F%91/">并发</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E5%8D%8F%E7%A8%8B/">协程</a></li>
                        
                    
                </ul>
            </span>
        

        
        
        
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <h1 id="Python异步编程实战指南：从入门到精通"><a href="#Python异步编程实战指南：从入门到精通" class="headerlink" title="Python异步编程实战指南：从入门到精通"></a>Python异步编程实战指南：从入门到精通</h1><p>异步编程是现代Python开发中的一项关键技能，特别是在处理I&#x2F;O密集型应用时。Python的<code>asyncio</code>库提供了一套强大的工具来编写并发代码，而无需使用线程或多进程。在这篇文章中，我将带你从入门到精通Python的异步编程，分享实用技巧和最佳实践。</p>
<h2 id="异步编程基础"><a href="#异步编程基础" class="headerlink" title="异步编程基础"></a>异步编程基础</h2><h3 id="什么是异步编程？"><a href="#什么是异步编程？" class="headerlink" title="什么是异步编程？"></a>什么是异步编程？</h3><p>异步编程是一种编程范式，允许程序在等待某些操作完成（如I&#x2F;O操作）时继续执行其他任务，而不是被阻塞。在Python中，这主要通过<code>asyncio</code>库和<code>async</code>&#x2F;<code>await</code>语法实现。</p>
<h3 id="同步vs异步：一个简单的例子"><a href="#同步vs异步：一个简单的例子" class="headerlink" title="同步vs异步：一个简单的例子"></a>同步vs异步：一个简单的例子</h3><p>让我们通过一个简单的例子来理解同步和异步的区别：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 同步版本</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fetch_data</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;开始下载 <span class="subst">&#123;url&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment"># 模拟网络请求</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;完成下载 <span class="subst">&#123;url&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;数据来自 <span class="subst">&#123;url&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    start = time.time()</span><br><span class="line">    data1 = fetch_data(<span class="string">&quot;url1&quot;</span>)</span><br><span class="line">    data2 = fetch_data(<span class="string">&quot;url2&quot;</span>)</span><br><span class="line">    data3 = fetch_data(<span class="string">&quot;url3&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;总耗时: <span class="subst">&#123;time.time() - start:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br><span class="line"></span><br><span class="line">main()  <span class="comment"># 大约需要6秒</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 异步版本</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fetch_data</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;开始下载 <span class="subst">&#123;url&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment"># 模拟网络请求</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;完成下载 <span class="subst">&#123;url&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;数据来自 <span class="subst">&#123;url&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    start = time.time()</span><br><span class="line">    <span class="comment"># 并发执行三个任务</span></span><br><span class="line">    results = <span class="keyword">await</span> asyncio.gather(</span><br><span class="line">        fetch_data(<span class="string">&quot;url1&quot;</span>),</span><br><span class="line">        fetch_data(<span class="string">&quot;url2&quot;</span>),</span><br><span class="line">        fetch_data(<span class="string">&quot;url3&quot;</span>)</span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;总耗时: <span class="subst">&#123;time.time() - start:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(results)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())  <span class="comment"># 大约需要2秒</span></span><br></pre></td></tr></table></figure>

<p>在同步版本中，每个下载操作都会阻塞程序，直到完成。而在异步版本中，当一个任务在等待I&#x2F;O操作时，程序可以切换到其他任务，从而实现并发执行。</p>
<h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><h3 id="协程（Coroutines）"><a href="#协程（Coroutines）" class="headerlink" title="协程（Coroutines）"></a>协程（Coroutines）</h3><p>协程是Python异步编程的基础。使用<code>async def</code>定义的函数不是普通函数，而是返回一个协程对象：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello, World!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这不会执行函数，而是创建一个协程对象</span></span><br><span class="line">coro = hello()</span><br><span class="line"><span class="built_in">print</span>(coro)  <span class="comment"># &lt;coroutine object hello at 0x...&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 要运行协程，可以使用asyncio.run()</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line">result = asyncio.run(hello())</span><br><span class="line"><span class="built_in">print</span>(result)  <span class="comment"># Hello, World!</span></span><br></pre></td></tr></table></figure>

<h3 id="await表达式"><a href="#await表达式" class="headerlink" title="await表达式"></a>await表达式</h3><p><code>await</code>关键字用于暂停协程的执行，直到等待的对象完成：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;开始&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)  <span class="comment"># 暂停协程1秒</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;1秒后&quot;</span>)</span><br><span class="line">    </span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<p><code>await</code>只能在<code>async def</code>定义的函数内部使用。</p>
<h3 id="Tasks和Futures"><a href="#Tasks和Futures" class="headerlink" title="Tasks和Futures"></a>Tasks和Futures</h3><p><code>Task</code>是对协程的封装，表示一个正在执行的操作。<code>Future</code>是一个低级对象，表示异步操作的最终结果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 创建任务</span></span><br><span class="line">    task = asyncio.create_task(asyncio.sleep(<span class="number">1</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待任务完成</span></span><br><span class="line">    <span class="keyword">await</span> task</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 或者使用gather同时等待多个任务</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(</span><br><span class="line">        asyncio.sleep(<span class="number">1</span>),</span><br><span class="line">        asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<h2 id="实用技巧"><a href="#实用技巧" class="headerlink" title="实用技巧"></a>实用技巧</h2><h3 id="技巧1：使用aiohttp进行异步HTTP请求"><a href="#技巧1：使用aiohttp进行异步HTTP请求" class="headerlink" title="技巧1：使用aiohttp进行异步HTTP请求"></a>技巧1：使用aiohttp进行异步HTTP请求</h3><p><code>aiohttp</code>是一个异步HTTP客户端&#x2F;服务器库：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fetch</span>(<span class="params">session, url</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> response:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> response.text()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    urls = [</span><br><span class="line">        <span class="string">&quot;https://api.github.com/events&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://api.github.com/emojis&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://api.github.com/users/python&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    start = time.time()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        results = <span class="keyword">await</span> asyncio.gather(</span><br><span class="line">            *[fetch(session, url) <span class="keyword">for</span> url <span class="keyword">in</span> urls]</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;完成所有请求，耗时: <span class="subst">&#123;time.time() - start:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;获取了 <span class="subst">&#123;<span class="built_in">len</span>(results)&#125;</span> 个响应&quot;</span>)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<h3 id="技巧2：使用asyncio-as-completed处理先完成的任务"><a href="#技巧2：使用asyncio-as-completed处理先完成的任务" class="headerlink" title="技巧2：使用asyncio.as_completed处理先完成的任务"></a>技巧2：使用asyncio.as_completed处理先完成的任务</h3><p>有时我们希望按照任务完成的顺序处理结果，而不是等待所有任务完成：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">random_sleep</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    sleep_time = random.uniform(<span class="number">0.5</span>, <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(sleep_time)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;任务 <span class="subst">&#123;<span class="built_in">id</span>&#125;</span> 完成，耗时 <span class="subst">&#123;sleep_time:<span class="number">.2</span>f&#125;</span>秒&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    tasks = [random_sleep(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> future <span class="keyword">in</span> asyncio.as_completed(tasks):</span><br><span class="line">        result = <span class="keyword">await</span> future</span><br><span class="line">        <span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<h3 id="技巧3：使用超时控制"><a href="#技巧3：使用超时控制" class="headerlink" title="技巧3：使用超时控制"></a>技巧3：使用超时控制</h3><p>防止任务执行时间过长：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">long_operation</span>():</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;操作完成&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 设置3秒超时</span></span><br><span class="line">        result = <span class="keyword">await</span> asyncio.wait_for(long_operation(), timeout=<span class="number">3</span>)</span><br><span class="line">        <span class="built_in">print</span>(result)</span><br><span class="line">    <span class="keyword">except</span> asyncio.TimeoutError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;操作超时&quot;</span>)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<h3 id="技巧4：使用asyncio-shield保护任务不被取消"><a href="#技巧4：使用asyncio-shield保护任务不被取消" class="headerlink" title="技巧4：使用asyncio.shield保护任务不被取消"></a>技巧4：使用asyncio.shield保护任务不被取消</h3><p>有时我们希望某些任务即使在外部被取消也能继续执行：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">protected_operation</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;受保护的操作完成&quot;</span></span><br><span class="line">    <span class="keyword">except</span> asyncio.CancelledError:</span><br><span class="line">        <span class="comment"># 即使被取消也会继续执行清理工作</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;尝试取消操作，但我们会完成清理工作&quot;</span>)</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;清理工作完成&quot;</span>)</span><br><span class="line">        <span class="keyword">raise</span>  <span class="comment"># 重新抛出异常</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 创建受保护的任务</span></span><br><span class="line">    shielded = asyncio.shield(protected_operation())</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待1秒后取消任务</span></span><br><span class="line">    task = asyncio.create_task(shielded)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    task.cancel()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">await</span> task</span><br><span class="line">    <span class="keyword">except</span> asyncio.CancelledError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;主任务被取消&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># asyncio.run(main())</span></span><br></pre></td></tr></table></figure>

<h3 id="技巧5：使用asyncio-Queue实现生产者-消费者模式"><a href="#技巧5：使用asyncio-Queue实现生产者-消费者模式" class="headerlink" title="技巧5：使用asyncio.Queue实现生产者-消费者模式"></a>技巧5：使用asyncio.Queue实现生产者-消费者模式</h3><p><code>asyncio.Queue</code>是一个异步队列，适合实现生产者-消费者模式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">producer</span>(<span class="params">queue, <span class="built_in">id</span></span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        item = <span class="string">f&quot;Producer <span class="subst">&#123;<span class="built_in">id</span>&#125;</span> - Item <span class="subst">&#123;i&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">await</span> queue.put(item)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Produced: <span class="subst">&#123;item&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(random.uniform(<span class="number">0.1</span>, <span class="number">0.5</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 发送结束信号</span></span><br><span class="line">    <span class="keyword">await</span> queue.put(<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">consumer</span>(<span class="params">queue, <span class="built_in">id</span></span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        item = <span class="keyword">await</span> queue.get()</span><br><span class="line">        <span class="keyword">if</span> item <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            queue.task_done()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Consumer <span class="subst">&#123;<span class="built_in">id</span>&#125;</span> got: <span class="subst">&#123;item&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(random.uniform(<span class="number">0.2</span>, <span class="number">0.6</span>))</span><br><span class="line">        queue.task_done()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    queue = asyncio.Queue()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建生产者和消费者</span></span><br><span class="line">    producers = [producer(queue, i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>)]</span><br><span class="line">    consumers = [consumer(queue, i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 启动所有任务</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(*producers)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待所有生产者完成并发送结束信号</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(consumers)):</span><br><span class="line">        <span class="keyword">await</span> queue.put(<span class="literal">None</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待所有消费者完成</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(*consumers)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待队列处理完成</span></span><br><span class="line">    <span class="keyword">await</span> queue.join()</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<h2 id="高级技巧"><a href="#高级技巧" class="headerlink" title="高级技巧"></a>高级技巧</h2><h3 id="技巧6：使用asyncio-Semaphore限制并发"><a href="#技巧6：使用asyncio-Semaphore限制并发" class="headerlink" title="技巧6：使用asyncio.Semaphore限制并发"></a>技巧6：使用asyncio.Semaphore限制并发</h3><p>当我们需要限制并发任务的数量时，可以使用<code>asyncio.Semaphore</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fetch_with_semaphore</span>(<span class="params">semaphore, session, url</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> semaphore:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;开始下载: <span class="subst">&#123;url&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> response:</span><br><span class="line">            <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)  <span class="comment"># 模拟下载时间</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;完成下载: <span class="subst">&#123;url&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> response.text()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 限制最多3个并发请求</span></span><br><span class="line">    semaphore = asyncio.Semaphore(<span class="number">3</span>)</span><br><span class="line">    </span><br><span class="line">    urls = [<span class="string">f&quot;https://example.com/<span class="subst">&#123;i&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        tasks = [fetch_with_semaphore(semaphore, session, url) <span class="keyword">for</span> url <span class="keyword">in</span> urls]</span><br><span class="line">        <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<h3 id="技巧7：使用asyncio-Lock实现互斥访问"><a href="#技巧7：使用asyncio-Lock实现互斥访问" class="headerlink" title="技巧7：使用asyncio.Lock实现互斥访问"></a>技巧7：使用asyncio.Lock实现互斥访问</h3><p>当多个协程需要访问共享资源时，可以使用<code>asyncio.Lock</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SharedResource</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.value = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.lock = asyncio.Lock()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">self, worker_id</span>):</span><br><span class="line">        <span class="comment"># 获取锁</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> <span class="variable language_">self</span>.lock:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Worker <span class="subst">&#123;worker_id&#125;</span> 获取锁&quot;</span>)</span><br><span class="line">            current = <span class="variable language_">self</span>.value</span><br><span class="line">            <span class="keyword">await</span> asyncio.sleep(<span class="number">0.1</span>)  <span class="comment"># 模拟一些处理时间</span></span><br><span class="line">            <span class="variable language_">self</span>.value = current + <span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Worker <span class="subst">&#123;worker_id&#125;</span> 释放锁，值更新为 <span class="subst">&#123;self.value&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">worker</span>(<span class="params">resource, <span class="built_in">id</span></span>):</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        <span class="keyword">await</span> resource.update(<span class="built_in">id</span>)</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    resource = SharedResource()</span><br><span class="line">    workers = [worker(resource, i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(*workers)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;最终值: <span class="subst">&#123;resource.value&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<h3 id="技巧8：使用asyncio-Event进行任务协调"><a href="#技巧8：使用asyncio-Event进行任务协调" class="headerlink" title="技巧8：使用asyncio.Event进行任务协调"></a>技巧8：使用asyncio.Event进行任务协调</h3><p><code>asyncio.Event</code>可以用于协调多个协程的执行：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">waiter</span>(<span class="params">event, <span class="built_in">id</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Waiter <span class="subst">&#123;<span class="built_in">id</span>&#125;</span> 等待事件&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> event.wait()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Waiter <span class="subst">&#123;<span class="built_in">id</span>&#125;</span> 收到事件通知&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(random.uniform(<span class="number">0.5</span>, <span class="number">2</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Waiter <span class="subst">&#123;<span class="built_in">id</span>&#125;</span> 完成处理&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">trigger</span>(<span class="params">event</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Trigger 等待5秒后设置事件&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">5</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Trigger 设置事件&quot;</span>)</span><br><span class="line">    event.<span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    event = asyncio.Event()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建等待者和触发者</span></span><br><span class="line">    waiters = [waiter(event, i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line">    trigger_task = trigger(event)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 启动所有任务</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(trigger_task, *waiters)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<h3 id="技巧9：使用asyncio-gather和asyncio-wait的区别"><a href="#技巧9：使用asyncio-gather和asyncio-wait的区别" class="headerlink" title="技巧9：使用asyncio.gather和asyncio.wait的区别"></a>技巧9：使用asyncio.gather和asyncio.wait的区别</h3><p><code>asyncio.gather</code>和<code>asyncio.wait</code>都可以等待多个协程完成，但它们有不同的用途：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">task</span>(<span class="params"><span class="built_in">id</span>, seconds</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Task <span class="subst">&#123;<span class="built_in">id</span>&#125;</span> 开始&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(seconds)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Task <span class="subst">&#123;<span class="built_in">id</span>&#125;</span> 完成&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;Result <span class="subst">&#123;<span class="built_in">id</span>&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">demo_gather</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;使用 asyncio.gather:&quot;</span>)</span><br><span class="line">    <span class="comment"># gather 返回结果列表，按照任务提交顺序</span></span><br><span class="line">    results = <span class="keyword">await</span> asyncio.gather(</span><br><span class="line">        task(<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">        task(<span class="number">2</span>, <span class="number">1</span>),</span><br><span class="line">        task(<span class="number">3</span>, <span class="number">2</span>)</span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;结果: <span class="subst">&#123;results&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">demo_wait</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;使用 asyncio.wait:&quot;</span>)</span><br><span class="line">    <span class="comment"># wait 返回已完成和未完成的任务集合</span></span><br><span class="line">    tasks = [</span><br><span class="line">        asyncio.create_task(task(<span class="number">1</span>, <span class="number">3</span>)),</span><br><span class="line">        asyncio.create_task(task(<span class="number">2</span>, <span class="number">1</span>)),</span><br><span class="line">        asyncio.create_task(task(<span class="number">3</span>, <span class="number">2</span>))</span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待所有任务完成或第一个任务完成</span></span><br><span class="line">    done, pending = <span class="keyword">await</span> asyncio.wait(</span><br><span class="line">        tasks,</span><br><span class="line">        <span class="comment"># return_when=asyncio.ALL_COMPLETED  # 默认</span></span><br><span class="line">        return_when=asyncio.FIRST_COMPLETED</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;完成的任务: <span class="subst">&#123;<span class="built_in">len</span>(done)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;未完成的任务: <span class="subst">&#123;<span class="built_in">len</span>(pending)&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 取消未完成的任务</span></span><br><span class="line">    <span class="keyword">for</span> task <span class="keyword">in</span> pending:</span><br><span class="line">        task.cancel()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 获取已完成任务的结果</span></span><br><span class="line">    <span class="keyword">for</span> task <span class="keyword">in</span> done:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;结果: <span class="subst">&#123;task.result()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">await</span> demo_gather()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + <span class="string">&quot;-&quot;</span> * <span class="number">50</span> + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> demo_wait()</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<h3 id="技巧10：使用上下文管理器进行资源管理"><a href="#技巧10：使用上下文管理器进行资源管理" class="headerlink" title="技巧10：使用上下文管理器进行资源管理"></a>技巧10：使用上下文管理器进行资源管理</h3><p>异步上下文管理器可以确保资源正确释放：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AsyncResource</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">__aenter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;获取资源: <span class="subst">&#123;self.name&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)  <span class="comment"># 模拟资源获取</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">__aexit__</span>(<span class="params">self, exc_type, exc_val, exc_tb</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;释放资源: <span class="subst">&#123;self.name&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">0.5</span>)  <span class="comment"># 模拟资源释放</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">use</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;使用资源: <span class="subst">&#123;self.name&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 使用异步上下文管理器</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> AsyncResource(<span class="string">&quot;database&quot;</span>) <span class="keyword">as</span> resource:</span><br><span class="line">        <span class="keyword">await</span> resource.use()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;资源已释放&quot;</span>)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<h2 id="实际应用案例"><a href="#实际应用案例" class="headerlink" title="实际应用案例"></a>实际应用案例</h2><h3 id="案例1：异步Web爬虫"><a href="#案例1：异步Web爬虫" class="headerlink" title="案例1：异步Web爬虫"></a>案例1：异步Web爬虫</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fetch_html</span>(<span class="params">session, url</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(url, timeout=<span class="number">10</span>) <span class="keyword">as</span> response:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> response.text()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;获取 <span class="subst">&#123;url&#125;</span> 失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">parse_links</span>(<span class="params">html, base_url</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> html:</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    </span><br><span class="line">    soup = BeautifulSoup(html, <span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line">    links = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> a_tag <span class="keyword">in</span> soup.find_all(<span class="string">&#x27;a&#x27;</span>, href=<span class="literal">True</span>):</span><br><span class="line">        href = a_tag[<span class="string">&#x27;href&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> href.startswith(<span class="string">&#x27;http&#x27;</span>):</span><br><span class="line">            links.append(href)</span><br><span class="line">        <span class="keyword">elif</span> href.startswith(<span class="string">&#x27;/&#x27;</span>):</span><br><span class="line">            links.append(<span class="string">f&quot;<span class="subst">&#123;base_url&#125;</span><span class="subst">&#123;href&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> links</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">crawl</span>(<span class="params">url, max_depth=<span class="number">2</span>, current_depth=<span class="number">0</span>, visited=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> visited <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        visited = <span class="built_in">set</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> current_depth &gt; max_depth <span class="keyword">or</span> url <span class="keyword">in</span> visited:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    visited.add(url)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;爬取: <span class="subst">&#123;url&#125;</span> (深度: <span class="subst">&#123;current_depth&#125;</span>)&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        html = <span class="keyword">await</span> fetch_html(session, url)</span><br><span class="line">        links = <span class="keyword">await</span> parse_links(html, url)</span><br><span class="line">        </span><br><span class="line">        tasks = []</span><br><span class="line">        <span class="keyword">for</span> link <span class="keyword">in</span> links[:<span class="number">5</span>]:  <span class="comment"># 限制每页最多爬取5个链接</span></span><br><span class="line">            <span class="keyword">if</span> link <span class="keyword">not</span> <span class="keyword">in</span> visited:</span><br><span class="line">                task = asyncio.create_task(</span><br><span class="line">                    crawl(link, max_depth, current_depth + <span class="number">1</span>, visited)</span><br><span class="line">                )</span><br><span class="line">                tasks.append(task)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> tasks:</span><br><span class="line">            <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="keyword">await</span> crawl(<span class="string">&quot;https://python.org&quot;</span>, max_depth=<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;爬虫完成，耗时: <span class="subst">&#123;time.time() - start_time:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># asyncio.run(main())</span></span><br></pre></td></tr></table></figure>

<h3 id="案例2：异步API服务器"><a href="#案例2：异步API服务器" class="headerlink" title="案例2：异步API服务器"></a>案例2：异步API服务器</h3><p>使用<code>aiohttp.web</code>创建异步API服务器：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> aiohttp <span class="keyword">import</span> web</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟数据库</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AsyncDatabase</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.users = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.next_id = <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">self, user_id</span>):</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">0.1</span>)  <span class="comment"># 模拟数据库查询延迟</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.users.get(user_id)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_all_users</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">0.2</span>)  <span class="comment"># 模拟数据库查询延迟</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">list</span>(<span class="variable language_">self</span>.users.values())</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_user</span>(<span class="params">self, name, email</span>):</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">0.3</span>)  <span class="comment"># 模拟数据库写入延迟</span></span><br><span class="line">        user_id = <span class="built_in">str</span>(<span class="variable language_">self</span>.next_id)</span><br><span class="line">        <span class="variable language_">self</span>.next_id += <span class="number">1</span></span><br><span class="line">        user = &#123;<span class="string">&quot;id&quot;</span>: user_id, <span class="string">&quot;name&quot;</span>: name, <span class="string">&quot;email&quot;</span>: email&#125;</span><br><span class="line">        <span class="variable language_">self</span>.users[user_id] = user</span><br><span class="line">        <span class="keyword">return</span> user</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_user</span>(<span class="params">self, user_id, name=<span class="literal">None</span>, email=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">0.2</span>)  <span class="comment"># 模拟数据库更新延迟</span></span><br><span class="line">        user = <span class="variable language_">self</span>.users.get(user_id)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> name:</span><br><span class="line">            user[<span class="string">&quot;name&quot;</span>] = name</span><br><span class="line">        <span class="keyword">if</span> email:</span><br><span class="line">            user[<span class="string">&quot;email&quot;</span>] = email</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> user</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">delete_user</span>(<span class="params">self, user_id</span>):</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">0.1</span>)  <span class="comment"># 模拟数据库删除延迟</span></span><br><span class="line">        <span class="keyword">if</span> user_id <span class="keyword">in</span> <span class="variable language_">self</span>.users:</span><br><span class="line">            <span class="keyword">del</span> <span class="variable language_">self</span>.users[user_id]</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建数据库实例</span></span><br><span class="line">db = AsyncDatabase()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 路由处理函数</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_users</span>(<span class="params">request</span>):</span><br><span class="line">    users = <span class="keyword">await</span> db.get_all_users()</span><br><span class="line">    <span class="keyword">return</span> web.json_response(users)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">request</span>):</span><br><span class="line">    user_id = request.match_info[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">    user = <span class="keyword">await</span> db.get_user(user_id)</span><br><span class="line">    <span class="keyword">if</span> user:</span><br><span class="line">        <span class="keyword">return</span> web.json_response(user)</span><br><span class="line">    <span class="keyword">return</span> web.json_response(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;User not found&quot;</span>&#125;, status=<span class="number">404</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_user</span>(<span class="params">request</span>):</span><br><span class="line">    data = <span class="keyword">await</span> request.json()</span><br><span class="line">    name = data.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    email = data.get(<span class="string">&#x27;email&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> name <span class="keyword">or</span> <span class="keyword">not</span> email:</span><br><span class="line">        <span class="keyword">return</span> web.json_response(</span><br><span class="line">            &#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Name and email are required&quot;</span>&#125;, </span><br><span class="line">            status=<span class="number">400</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    user = <span class="keyword">await</span> db.create_user(name, email)</span><br><span class="line">    <span class="keyword">return</span> web.json_response(user, status=<span class="number">201</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_user</span>(<span class="params">request</span>):</span><br><span class="line">    user_id = request.match_info[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">    data = <span class="keyword">await</span> request.json()</span><br><span class="line">    </span><br><span class="line">    user = <span class="keyword">await</span> db.update_user(</span><br><span class="line">        user_id, </span><br><span class="line">        name=data.get(<span class="string">&#x27;name&#x27;</span>), </span><br><span class="line">        email=data.get(<span class="string">&#x27;email&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> user:</span><br><span class="line">        <span class="keyword">return</span> web.json_response(user)</span><br><span class="line">    <span class="keyword">return</span> web.json_response(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;User not found&quot;</span>&#125;, status=<span class="number">404</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">delete_user</span>(<span class="params">request</span>):</span><br><span class="line">    user_id = request.match_info[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">    success = <span class="keyword">await</span> db.delete_user(user_id)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> success:</span><br><span class="line">        <span class="keyword">return</span> web.json_response(&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;deleted&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">return</span> web.json_response(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;User not found&quot;</span>&#125;, status=<span class="number">404</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建应用和路由</span></span><br><span class="line">app = web.Application()</span><br><span class="line">app.add_routes([</span><br><span class="line">    web.get(<span class="string">&#x27;/users&#x27;</span>, get_users),</span><br><span class="line">    web.get(<span class="string">&#x27;/users/&#123;id&#125;&#x27;</span>, get_user),</span><br><span class="line">    web.post(<span class="string">&#x27;/users&#x27;</span>, create_user),</span><br><span class="line">    web.put(<span class="string">&#x27;/users/&#123;id&#125;&#x27;</span>, update_user),</span><br><span class="line">    web.delete(<span class="string">&#x27;/users/&#123;id&#125;&#x27;</span>, delete_user),</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务器</span></span><br><span class="line"><span class="comment"># web.run_app(app, port=8080)</span></span><br></pre></td></tr></table></figure>

<h2 id="常见陷阱和解决方案"><a href="#常见陷阱和解决方案" class="headerlink" title="常见陷阱和解决方案"></a>常见陷阱和解决方案</h2><h3 id="陷阱1：阻塞事件循环"><a href="#陷阱1：阻塞事件循环" class="headerlink" title="陷阱1：阻塞事件循环"></a>陷阱1：阻塞事件循环</h3><p>在异步代码中执行CPU密集型操作或阻塞I&#x2F;O会阻塞整个事件循环：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">good_practice</span>():</span><br><span class="line">    <span class="comment"># 使用asyncio.sleep进行非阻塞等待</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Good&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">bad_practice</span>():</span><br><span class="line">    <span class="comment"># 阻塞事件循环</span></span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Bad&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 这将顺序执行，总共需要2秒</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    <span class="keyword">await</span> bad_practice()</span><br><span class="line">    <span class="keyword">await</span> bad_practice()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Bad practice: <span class="subst">&#123;time.time() - start:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 这将并发执行，总共需要1秒</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(good_practice(), good_practice())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Good practice: <span class="subst">&#123;time.time() - start:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<p><strong>解决方案</strong>：对于CPU密集型任务，使用<code>concurrent.futures.ProcessPoolExecutor</code>和<code>asyncio.to_thread</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> concurrent.futures</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cpu_bound_task</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="comment"># 模拟CPU密集型任务</span></span><br><span class="line">    result = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        result += i * i</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 使用进程池执行CPU密集型任务</span></span><br><span class="line">    loop = asyncio.get_running_loop()</span><br><span class="line">    <span class="keyword">with</span> concurrent.futures.ProcessPoolExecutor() <span class="keyword">as</span> pool:</span><br><span class="line">        result = <span class="keyword">await</span> loop.run_in_executor(</span><br><span class="line">            pool, cpu_bound_task, <span class="number">10000000</span></span><br><span class="line">        )</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;计算结果: <span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Python 3.9+: 使用asyncio.to_thread执行阻塞I/O</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">blocking_io</span>():</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;完成I/O操作&quot;</span></span><br><span class="line">    </span><br><span class="line">    result = <span class="keyword">await</span> asyncio.to_thread(blocking_io)</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<h3 id="陷阱2：忘记await协程"><a href="#陷阱2：忘记await协程" class="headerlink" title="陷阱2：忘记await协程"></a>陷阱2：忘记await协程</h3><p>忘记await协程是一个常见错误，会导致协程不执行：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">say_hello</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Hello, World!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 错误: 协程未被等待</span></span><br><span class="line">    say_hello()  <span class="comment"># 这只会创建协程对象，不会执行</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 正确: 等待协程</span></span><br><span class="line">    <span class="keyword">await</span> say_hello()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 或者创建任务</span></span><br><span class="line">    task = asyncio.create_task(say_hello())</span><br><span class="line">    <span class="keyword">await</span> task</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<p><strong>解决方案</strong>：始终使用<code>await</code>或<code>asyncio.create_task()</code>来执行协程。</p>
<h3 id="陷阱3：嵌套事件循环"><a href="#陷阱3：嵌套事件循环" class="headerlink" title="陷阱3：嵌套事件循环"></a>陷阱3：嵌套事件循环</h3><p>在已有事件循环内创建新的事件循环会导致问题：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">inner</span>():</span><br><span class="line">    <span class="comment"># 错误: 在协程中创建新的事件循环</span></span><br><span class="line">    <span class="comment"># loop = asyncio.new_event_loop()</span></span><br><span class="line">    <span class="comment"># loop.run_until_complete(asyncio.sleep(1))</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 正确: 使用现有事件循环</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">await</span> inner()</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<p><strong>解决方案</strong>：在异步代码中，始终使用<code>await</code>而不是创建新的事件循环。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>Python的异步编程模型提供了一种强大的方式来处理并发操作，特别是I&#x2F;O密集型任务。通过掌握<code>asyncio</code>库和本文介绍的技巧，你可以编写高效、可维护的异步代码。</p>
<p>记住，异步编程不是万能的——它主要适用于I&#x2F;O密集型任务，而不是CPU密集型任务。对于后者，多进程仍然是更好的选择。</p>
<p>最后，随着Python异步生态系统的不断发展，越来越多的库开始支持异步操作，使得构建完全异步的应用变得更加容易。无论是Web服务器、数据库访问还是网络爬虫，异步编程都能帮助你构建更高效的应用。</p>
<p>你有什么关于Python异步编程的问题或经验吗？欢迎在评论中分享！</p>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/">异步编程</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/asyncio/">asyncio</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E5%B9%B6%E5%8F%91/">并发</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E5%8D%8F%E7%A8%8B/">协程</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2023/php/php8-performance-improvements-guide/"
                                   title="PHP 8 性能优化全面指南：JIT编译器与性能提升实战"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">PHP 8 性能优化全面指南：JIT编译器与性能提升实战</span>
                                        <span class="post-nav-item">上一篇</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2023/php/php-functions-practical-guide/"
                                   title="PHP函数编程实战指南：从基础到高级应用"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">PHP函数编程实战指南：从基础到高级应用</span>
                                        <span class="post-nav-item">下一篇</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    






                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Python%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97%EF%BC%9A%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A"><span class="nav-text">Python异步编程实战指南：从入门到精通</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80"><span class="nav-text">异步编程基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%EF%BC%9F"><span class="nav-text">什么是异步编程？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5vs%E5%BC%82%E6%AD%A5%EF%BC%9A%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BE%8B%E5%AD%90"><span class="nav-text">同步vs异步：一个简单的例子</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-text">核心概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%8F%E7%A8%8B%EF%BC%88Coroutines%EF%BC%89"><span class="nav-text">协程（Coroutines）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#await%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">await表达式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tasks%E5%92%8CFutures"><span class="nav-text">Tasks和Futures</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%94%A8%E6%8A%80%E5%B7%A7"><span class="nav-text">实用技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E5%B7%A71%EF%BC%9A%E4%BD%BF%E7%94%A8aiohttp%E8%BF%9B%E8%A1%8C%E5%BC%82%E6%AD%A5HTTP%E8%AF%B7%E6%B1%82"><span class="nav-text">技巧1：使用aiohttp进行异步HTTP请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E5%B7%A72%EF%BC%9A%E4%BD%BF%E7%94%A8asyncio-as-completed%E5%A4%84%E7%90%86%E5%85%88%E5%AE%8C%E6%88%90%E7%9A%84%E4%BB%BB%E5%8A%A1"><span class="nav-text">技巧2：使用asyncio.as_completed处理先完成的任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E5%B7%A73%EF%BC%9A%E4%BD%BF%E7%94%A8%E8%B6%85%E6%97%B6%E6%8E%A7%E5%88%B6"><span class="nav-text">技巧3：使用超时控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E5%B7%A74%EF%BC%9A%E4%BD%BF%E7%94%A8asyncio-shield%E4%BF%9D%E6%8A%A4%E4%BB%BB%E5%8A%A1%E4%B8%8D%E8%A2%AB%E5%8F%96%E6%B6%88"><span class="nav-text">技巧4：使用asyncio.shield保护任务不被取消</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E5%B7%A75%EF%BC%9A%E4%BD%BF%E7%94%A8asyncio-Queue%E5%AE%9E%E7%8E%B0%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="nav-text">技巧5：使用asyncio.Queue实现生产者-消费者模式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E7%BA%A7%E6%8A%80%E5%B7%A7"><span class="nav-text">高级技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E5%B7%A76%EF%BC%9A%E4%BD%BF%E7%94%A8asyncio-Semaphore%E9%99%90%E5%88%B6%E5%B9%B6%E5%8F%91"><span class="nav-text">技巧6：使用asyncio.Semaphore限制并发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E5%B7%A77%EF%BC%9A%E4%BD%BF%E7%94%A8asyncio-Lock%E5%AE%9E%E7%8E%B0%E4%BA%92%E6%96%A5%E8%AE%BF%E9%97%AE"><span class="nav-text">技巧7：使用asyncio.Lock实现互斥访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E5%B7%A78%EF%BC%9A%E4%BD%BF%E7%94%A8asyncio-Event%E8%BF%9B%E8%A1%8C%E4%BB%BB%E5%8A%A1%E5%8D%8F%E8%B0%83"><span class="nav-text">技巧8：使用asyncio.Event进行任务协调</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E5%B7%A79%EF%BC%9A%E4%BD%BF%E7%94%A8asyncio-gather%E5%92%8Casyncio-wait%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-text">技巧9：使用asyncio.gather和asyncio.wait的区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E5%B7%A710%EF%BC%9A%E4%BD%BF%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E5%99%A8%E8%BF%9B%E8%A1%8C%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86"><span class="nav-text">技巧10：使用上下文管理器进行资源管理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="nav-text">实际应用案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B1%EF%BC%9A%E5%BC%82%E6%AD%A5Web%E7%88%AC%E8%99%AB"><span class="nav-text">案例1：异步Web爬虫</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B2%EF%BC%9A%E5%BC%82%E6%AD%A5API%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-text">案例2：异步API服务器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%99%B7%E9%98%B1%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-text">常见陷阱和解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%B7%E9%98%B11%EF%BC%9A%E9%98%BB%E5%A1%9E%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF"><span class="nav-text">陷阱1：阻塞事件循环</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%B7%E9%98%B12%EF%BC%9A%E5%BF%98%E8%AE%B0await%E5%8D%8F%E7%A8%8B"><span class="nav-text">陷阱2：忘记await协程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%B7%E9%98%B13%EF%BC%9A%E5%B5%8C%E5%A5%97%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF"><span class="nav-text">陷阱3：嵌套事件循环</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA"><span class="nav-text">结论</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
    &copy;&nbsp;2025
    
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">Orion K</a>
        
    </div>


    
        
        <div class="deploy-info info-item">
            
            本站由 <span class="tooltip" data-tooltip-content="GitHub Pages"><img src="/images/brands/github.png"></span> 提供部署服务
            
        </div>
    

    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Python%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97%EF%BC%9A%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A"><span class="nav-text">Python异步编程实战指南：从入门到精通</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80"><span class="nav-text">异步编程基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%EF%BC%9F"><span class="nav-text">什么是异步编程？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5vs%E5%BC%82%E6%AD%A5%EF%BC%9A%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BE%8B%E5%AD%90"><span class="nav-text">同步vs异步：一个简单的例子</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-text">核心概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%8F%E7%A8%8B%EF%BC%88Coroutines%EF%BC%89"><span class="nav-text">协程（Coroutines）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#await%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">await表达式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tasks%E5%92%8CFutures"><span class="nav-text">Tasks和Futures</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%94%A8%E6%8A%80%E5%B7%A7"><span class="nav-text">实用技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E5%B7%A71%EF%BC%9A%E4%BD%BF%E7%94%A8aiohttp%E8%BF%9B%E8%A1%8C%E5%BC%82%E6%AD%A5HTTP%E8%AF%B7%E6%B1%82"><span class="nav-text">技巧1：使用aiohttp进行异步HTTP请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E5%B7%A72%EF%BC%9A%E4%BD%BF%E7%94%A8asyncio-as-completed%E5%A4%84%E7%90%86%E5%85%88%E5%AE%8C%E6%88%90%E7%9A%84%E4%BB%BB%E5%8A%A1"><span class="nav-text">技巧2：使用asyncio.as_completed处理先完成的任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E5%B7%A73%EF%BC%9A%E4%BD%BF%E7%94%A8%E8%B6%85%E6%97%B6%E6%8E%A7%E5%88%B6"><span class="nav-text">技巧3：使用超时控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E5%B7%A74%EF%BC%9A%E4%BD%BF%E7%94%A8asyncio-shield%E4%BF%9D%E6%8A%A4%E4%BB%BB%E5%8A%A1%E4%B8%8D%E8%A2%AB%E5%8F%96%E6%B6%88"><span class="nav-text">技巧4：使用asyncio.shield保护任务不被取消</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E5%B7%A75%EF%BC%9A%E4%BD%BF%E7%94%A8asyncio-Queue%E5%AE%9E%E7%8E%B0%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="nav-text">技巧5：使用asyncio.Queue实现生产者-消费者模式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E7%BA%A7%E6%8A%80%E5%B7%A7"><span class="nav-text">高级技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E5%B7%A76%EF%BC%9A%E4%BD%BF%E7%94%A8asyncio-Semaphore%E9%99%90%E5%88%B6%E5%B9%B6%E5%8F%91"><span class="nav-text">技巧6：使用asyncio.Semaphore限制并发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E5%B7%A77%EF%BC%9A%E4%BD%BF%E7%94%A8asyncio-Lock%E5%AE%9E%E7%8E%B0%E4%BA%92%E6%96%A5%E8%AE%BF%E9%97%AE"><span class="nav-text">技巧7：使用asyncio.Lock实现互斥访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E5%B7%A78%EF%BC%9A%E4%BD%BF%E7%94%A8asyncio-Event%E8%BF%9B%E8%A1%8C%E4%BB%BB%E5%8A%A1%E5%8D%8F%E8%B0%83"><span class="nav-text">技巧8：使用asyncio.Event进行任务协调</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E5%B7%A79%EF%BC%9A%E4%BD%BF%E7%94%A8asyncio-gather%E5%92%8Casyncio-wait%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-text">技巧9：使用asyncio.gather和asyncio.wait的区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E5%B7%A710%EF%BC%9A%E4%BD%BF%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E5%99%A8%E8%BF%9B%E8%A1%8C%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86"><span class="nav-text">技巧10：使用上下文管理器进行资源管理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="nav-text">实际应用案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B1%EF%BC%9A%E5%BC%82%E6%AD%A5Web%E7%88%AC%E8%99%AB"><span class="nav-text">案例1：异步Web爬虫</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B2%EF%BC%9A%E5%BC%82%E6%AD%A5API%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-text">案例2：异步API服务器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%99%B7%E9%98%B1%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-text">常见陷阱和解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%B7%E9%98%B11%EF%BC%9A%E9%98%BB%E5%A1%9E%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF"><span class="nav-text">陷阱1：阻塞事件循环</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%B7%E9%98%B12%EF%BC%9A%E5%BF%98%E8%AE%B0await%E5%8D%8F%E7%A8%8B"><span class="nav-text">陷阱2：忘记await协程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%B7%E9%98%B13%EF%BC%9A%E5%B5%8C%E5%A5%97%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF"><span class="nav-text">陷阱3：嵌套事件循环</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA"><span class="nav-text">结论</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->

<script src="/js/utils.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/toggle-theme.js"></script>

<script src="/js/code-block.js"></script>

<script src="/js/main.js"></script>

<script src="/js/libs/anime.min.js"></script>


<!-- local search -->

    
<script src="/js/local-search.js"></script>



<!-- lazyload -->


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        
<script src="/js/post/post-helper.js"></script>


        <!-- toc -->
        
            
<script src="/js/post/toc.js"></script>

        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
